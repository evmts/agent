{"type":"RunStarted","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","timestampMs":1770779902348}
{"type":"FrameCommitted","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","frameNo":1,"xmlHash":"fcdb1b40639443168c09dc221621c9c6db901ff0d1a4c9769390797530a76fa1","timestampMs":1770779902399}
{"type":"NodeStarted","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","nodeId":"discover-codex","iteration":0,"attempt":1,"timestampMs":1770779902411}
{"type":"NodeFinished","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","nodeId":"discover-codex","iteration":0,"attempt":1,"timestampMs":1770780231710}
{"type":"FrameCommitted","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","frameNo":2,"xmlHash":"779810f172b03db02346ffa2ac27bae800ae4b95662883745fb3e33fbead3295","timestampMs":1770780231731}
{"type":"NodeStarted","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","nodeId":"chat-streaming-bridge:research","iteration":0,"attempt":1,"timestampMs":1770780231743}
{"type":"NodeFinished","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","nodeId":"chat-streaming-bridge:research","iteration":0,"attempt":1,"timestampMs":1770780481726}
{"type":"FrameCommitted","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","frameNo":3,"xmlHash":"fe1c901fb0724acf4a9408fe622c447684138a0f3b69c5a127406c36f861f114","timestampMs":1770780481739}
{"type":"NodeStarted","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","nodeId":"chat-streaming-bridge:plan","iteration":0,"attempt":1,"timestampMs":1770780481752}
{"type":"NodeFinished","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","nodeId":"chat-streaming-bridge:plan","iteration":0,"attempt":1,"timestampMs":1770780691057}
{"type":"FrameCommitted","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","frameNo":4,"xmlHash":"fe1c901fb0724acf4a9408fe622c447684138a0f3b69c5a127406c36f861f114","timestampMs":1770780691074}
{"type":"NodeStarted","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","nodeId":"chat-streaming-bridge:implement","iteration":0,"attempt":1,"timestampMs":1770780691093}
{"type":"NodeFailed","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","nodeId":"chat-streaming-bridge:implement","iteration":0,"attempt":1,"error":{"name":"Error","message":"OpenAI Codex v0.99.0-alpha.13 (research preview)\n--------\nworkdir: /Users/williamcory/agent\nmodel: gpt-5.3-codex\nprovider: openai\napproval: never\nsandbox: danger-full-access\nreasoning effort: high\nreasoning summaries: auto\nsession id: 019c4ac1-0b30-7900-bae3-168baa07e7a7\n--------\nuser\nBuilding Smithers v2 ‚Äî ultimate UX for agentic coding.\n\nNative macOS IDE (Swift/SwiftUI) that feels like TUI but has GUI UX, with parallel SolidJS web app. Swift app for terminal power-users.\n\nV1 prototype: ../smithers/apps/desktop/ (symlinked as prototype0/). Use for reference in research steps.\n\nprototype1/ ‚Äî Next.js UI prototype (frozen design reference). Delete when done.\n\n# Spec Precedence &amp; Conflict Resolution\n\nWhen specs conflict, the higher-precedence rule wins. Agent or implementer MUST note the conflict and which rule took precedence.\n\n## Precedence (highest first)\n\n1. **Always Green** ‚Äî Build/tests passing. Nothing ships broken.\n2. **Architecture invariants** ‚Äî Zig source of truth, dependency injection, 5 interfaces, libghostty pattern.\n3. **Language rules** ‚Äî `zig-rules.md`, `swift-rules.md`, `ghostty-patterns.md`. Correct API usage, memory safety.\n4. **Current ticket** ‚Äî What the task actually requires. Ticket scope overrides general guidance.\n5. **Engineering spec** ‚Äî Implementation approach, data flow, module boundaries.\n6. **Design spec** ‚Äî UI/UX, tokens, layout, interactions.\n7. **Style guidance** ‚Äî &quot;Minimal comments&quot;, &quot;elegant code&quot;, &quot;DRY&quot;. Lowest priority ‚Äî never block shipping.\n\n## Rules\n\n- If two docs disagree on the same topic, the one listed as **canonical** in `spec-index.md` wins.\n- If a conflict is detected during implementation, explicitly note it in the ticket output (plan, implement, or review) and pick the higher-precedence rule.\n- Dependent docs MUST reference the canonical doc and not redefine its rules. If they add context, they must not contradict.\n- When in doubt: ask &quot;does this break the build?&quot; (precedence 1), &quot;does this violate architecture?&quot; (precedence 2), &quot;does this use wrong API?&quot; (precedence 3). If none apply, use judgment.\n\n# Spec Index &amp; Ownership\n\nEvery topic has ONE canonical doc. Dependent docs may reference but MUST NOT redefine.\n\n## Topic Ownership\n\n| Topic | Canonical Doc | Dependent Docs |\n|-------|--------------|----------------|\n| **Window architecture** | `design/principles.md` ¬ß1 | `eng/window-management.md` (impl details) |\n| **Chat UI** | `design/chat-window.md` | `eng/chat-implementation.md` (impl details) |\n| **IDE UI** | `design/ide-window.md` | `eng/ide-implementation.md` (impl details) |\n| **Keyboard shortcuts** | `design/keyboard-shortcuts.md` | `eng/keyboard-input.md` (impl details) |\n| **Design tokens** | `design/system-tokens.md` | `eng/design-system-impl.md` (impl details) |\n| **Skills system** | `eng/skills-system.md` | `design/overlays.md` (UI only) |\n| **AI integration** | `eng/ai-integration.md` | `design/chat-window.md` (UI only) |\n| **Terminal** | `eng/terminal-subsystem.md` | `design/ide-window.md` (UI only) |\n| **Editor** | `eng/editor-subsystem.md` | `design/ide-window.md` (UI only) |\n| **JJ/VCS** | `eng/jj-integration.md` | `design/chat-window.md` (sidebar UI only) |\n| **State architecture** | `eng/state-architecture.md` | ‚Äî |\n| **Build/repo** | `eng/repo-build.md` | `CLAUDE.md` (summary) |\n| **Testing** | `eng/testing.md` | `always-green.md` (policy) |\n| **Phases** | `eng/implementation-phases.md` | `mvp-scope.md` (gating) |\n| **Web app** | `eng/web-app.md` | ‚Äî |\n| **Code style (Zig)** | `zig-rules.md` + `ghostty-patterns.md` | ‚Äî |\n| **Code style (Swift)** | `swift-rules.md` | ‚Äî |\n| **Font/typography** | `design/system-tokens.md` ¬ß2.5 | `swift-rules.md` (must reference, not redefine) |\n| **Security posture** | `eng/security-posture.md` | `eng/web-app.md` (references) |\n| **MVP scope** | `mvp-scope.md` | `eng/implementation-phases.md` (references) |\n| **Conflict resolution** | `spec-precedence.md` | ‚Äî |\n\n## Rules\n\n- **Canonical doc** defines the truth. Other docs may add implementation detail but must link back.\n- If you find a contradiction between canonical and dependent docs, the canonical doc wins.\n- When updating a topic, update the canonical doc first; dependent docs only if they add impl detail.\n- New topics should be added to this index before writing specs.\n\n# MVP Scope Gating\n\nPrevents agents from implementing post-MVP features prematurely.\n\n## P0 ‚Äî Must Ship\n\n- Scaffold: repo structure, build.zig, libsmithers stub, C API, xcframework pipeline\n- Design system: tokens, shared components, theme\n- Chat window: sidebar (chats/source/agents modes), messages, composer, streaming\n- Codex integration: in-process Zig API, send/receive/stream\n- Chat persistence: SQLite, session CRUD\n- IDE window: file tree, editor (TreeSitter syntax), tabs, breadcrumbs, status bar\n- Cross-window: &quot;Open in Editor&quot; from chat, AI diff preview\n- Terminal: GhosttyKit embedded surfaces, terminal tabs\n- JJ: bundled binary, working copy status, commit, undo, snapshot\n- Agent orchestration: sub-agent spawn, status tracking, jj branch per agent\n- Command palette: Cmd+P file open, Cmd+Shift+P commands, Cmd+/ shortcuts\n- Web app: SolidJS parity for all P0 features, Playwright e2e tests\n- Keyboard: all core actions keyboard-accessible, tmux-compat prefix\n- Settings: core prefs (theme, font size, keybindings, agent config)\n\n## P1 ‚Äî Nice to Have\n\n- Background/scheduled agents (issue 007)\n- Multiple agent backends beyond Codex (issue 004 ‚Äî Claude Code, OpenCode)\n- Neovim modal editing mode\n- Image paste/drop + fullscreen viewer\n- Search: workspace-wide Cmd+Shift+F (ripgrep)\n- Light theme\n- Diff viewer (tabs + sheets)\n- Toast notifications, progress indicators\n- Auto-update (Sparkle)\n\n## P2 ‚Äî Stubs/Reserved UI OK, No Implementation\n\n- Skills system (scanner, registry, installer)\n- URL scheme deep linking\n- IPC server (Unix socket)\n- Menu bar background mode with agent status\n\n## Post-MVP ‚Äî Do Not Implement\n\n- Multi-workspace / Conductor parity (issue 038)\n- Workflow Studio (issue 039)\n- Workspace tools sidebar panels (issue 020)\n- MiniApps (issue 013)\n- Telegram agent bridge (issue 010)\n- Remote development (issue 033)\n- JJ merge queue UI\n- LSP integration\n- Cross-platform (Linux/iOS)\n\n## Gating Rule\n\nWhen Discover compares &quot;what SHOULD exist vs what does&quot;, it MUST check this scope:\n- P0 items that are incomplete = valid tickets\n- P1 items = valid tickets only after all P0 complete\n- P2 items = stubs only, no full implementation\n- Post-MVP items = NEVER create tickets for these\n\n# CRITICAL: ALWAYS GREEN\n\nCodebase MUST be green. ZERO tolerance for failures (even pre-existing).\n\n## Canonical Command\n\n**`zig build all`** ‚Äî Run after EVERY change. Runs ALL checks wired in `build.zig` in parallel.\nDo NOT commit until passes with zero errors.\n\n## Individual Checks\n\n`zig build all` is canonical, but individual checks:\n\n### 1. Build\n- `zig build` ‚Äî zero errors, zero warnings\n- When `build.zig` defines them: `zig build dev`, `zig build web`, `zig build codex`, `zig build jj`\n\n### 2. Tests\n- `zig build test` ‚Äî ALL Zig unit tests pass (use std.testing.allocator for leak detection)\n- When defined: `zig build playwright`, `zig build xcode-test`, `zig build ui-test`\n- If those steps are not yet wired, run the equivalent manual commands (e.g., `xcodebuild test`, `pnpm exec playwright test`)\n- ANY failure (even pre-existing) ‚Äî fix before moving on\n\n### 3. Formatting\n- `zig fmt --check .` ‚Äî all Zig formatted (run `zig fmt .` to fix)\n- `prettier --check .` ‚Äî JSON/YAML/Markdown/JS/TS formatted\n- Swift: Xcode default (4-space indent)\n\n### 4. Linting\n- Zero Zig warnings (treat as errors)\n- Zero Swift concurrency warnings (Swift 6 strict)\n- `shellcheck --severity=warning` on shell scripts\n- `typos` ‚Äî spell check (configure typos.toml for domain words)\n\n### 5. Memory Safety\n- std.testing.allocator ‚Äî zero leaks\n- errdefer on every failable allocation ‚Äî no resource leaks on error paths\n- `self.* = undefined` after deinit (poison use-after-free)\n\n### 6. Correctness\n- Exhaustive switches (no `else` for unknown variants)\n- Explicit error sets (never `anyerror`)\n- Public APIs must have tests\n\n## Rules\n- NEVER accept failing test (even pre-existing)\n- NEVER leave build broken\n- NEVER commit code that doesn&#x27;t compile\n- Pre-existing failure ‚Üí fix as part of current work WHEN TRIVIAL\n- Run full check suite after EVERY change; failures ‚Üí fix before moving on\n- When in doubt, run more checks, not fewer\n\n## Escape Hatch for Pre-Existing Failures\nIf `zig build all` fails due to unrelated pre-existing failures AND fixing them is non-trivial (would significantly expand ticket scope):\n1. Document the failure in `docs/triage/preexisting-failures.md` (append, don&#x27;t overwrite)\n2. Note it in the validation failingSummary so a dedicated ticket is created in the next Discover pass\n3. Continue with the current ticket ‚Äî do NOT go down unrelated rabbit holes\nThis keeps the workflow from stalling on issues orthogonal to the current work.\n\n# Architecture\n\n- **libsmithers** (Zig core) ‚Äî 5 interfaces: C API (Swift), MCP server (Codex), CLI (smithers-ctl), HTTP/WS (web app), Zig API (internal)\n- **Codex fork** (`submodules/codex/`) ‚Äî wraps entire Codex in Zig API, static lib linked into libsmithers. NO child process, NO JSON-RPC. Storage callbacks = Zig function pointers.\n- **JJ fork** (`submodules/jj/`) ‚Äî version control. No code changes, Zig build wrapper only.\n- **SolidJS Vite PWA** (`web/`) ‚Äî visual parity with native. shadcn-solid + Tailwind + Monaco + xterm.js.\n- **SQLite** (`pkg/sqlite/`) ‚Äî persistence. GRDB.swift on Swift side. WAL mode. Same database.\n- **Zap** (`pkg/zap/`) ‚Äî HTTP server wraps facil.io. No auth (localhost).\n- **TreeSitter** (`pkg/`) ‚Äî syntax parsing.\n- **build.zig** ‚Äî builds EVERYTHING: Zig, C deps, Rust submodules, Swift app, web app.\n- **libsmithers = PLATFORM AGNOSTIC** ‚Äî theoretically compiles to WASM. Use DEPENDENCY INJECTION for platform-specific (SQLite, HTTP, filesystem).\n- **Zig library = single source of truth** for all business logic.\n\n# Zig Rules (LLMs get these wrong)\n\nTarget: Zig 0.15. NOT 0.11, 0.12, 0.13, 0.14.\n\n## Common Mistakes\n- **ArrayList**: 0.14 prefers ArrayListUnmanaged (pass allocator to every method). std.ArrayList transitional.\n- **JSON**: `std.json.parseFromSlice(T, allocator, input, .{})` returns `Parsed(T)` with `.value` + `.deinit()`. NEVER forget `defer parsed.deinit()`.\n- **HashMap**: AutoHashMap for integer keys, StringHashMap for `[]const u8`. NEVER AutoHashMap with string keys.\n- **Type introspection**: 0.14+ uses `.int`, `.@&quot;struct&quot;`, `.@&quot;enum&quot;` (lowercase + @ prefix for keywords). NOT `.Int`, `.Struct`, `.Enum`.\n- `std.mem.page_size` ‚Üí `std.heap.pageSize()` or `page_size_min`/`page_size_max`\n- `std.rand` ‚Üí `std.Random`\n- `std.TailQueue` ‚Üí `std.DoublyLinkedList`\n- `std.ChildProcess` ‚Üí `std.process.Child`\n- `@setCold(true)` ‚Üí `@branchHint(.cold)`\n\n## Allocator Patterns\n- Pass explicitly. NO global state.\n- ArenaAllocator for batch allocations with shared lifetime (request-scoped, JSON parsing).\n- `std.testing.allocator` in ALL tests (leak detection).\n- `defer`/`errdefer` immediately after allocation.\n\n## Error Handling\n- Explicit error sets. NEVER `anyerror`.\n- Handle all cases. NEVER `catch {}` or `catch |_| {}`.\n- `errdefer` for cleanup on error paths.\n\n## Comptime\n- `comptime T: type` (NOT `anytype`) for generics.\n- Use for dependency injection (vtable like `src/host.zig`).\n\n## Style\n- `const` over `var`; slices over raw pointers\n- `std.log.scoped` for namespaced loggers\n- Exhaustive switches\n\n## Stdlib API Help\nZig stdlib changes frequently. Unsure ‚Üí read source.\nmacOS Homebrew: `/opt/homebrew/lib/zig/std/`\nCheck: `std/json.zig`, `std/array_list.zig`, `std/hash_map.zig`, `std/io.zig`, `std/heap.zig`\n\n# Swift/SwiftUI Rules (LLMs get these wrong)\n\n## Modern Patterns Only\n- `@Observable` (NOT ObservableObject) for models\n- `@State` (NOT @StateObject) as owning wrapper\n- `@Environment(Type.self)` (NOT @EnvironmentObject)\n- `NavigationStack` (NOT NavigationView)\n- `.foregroundStyle()` (NOT .foregroundColor())\n- `.clipShape(.rect(cornerRadius:))` (NOT .cornerRadius())\n- `navigationDestination(for:)` type-safe routing (NOT inline NavigationLink)\n- `async/await` structured concurrency (NO DispatchQueue, NO completion handlers)\n- `@Bindable` for bindings to @Observable\n\n## Concurrency\n- Swift 6 strict. NEVER ignore warnings.\n- `@MainActor` for UI.\n- `actor` for shared mutable state.\n- NEVER `@unchecked Sendable` as quick fix.\n- NEVER DispatchQueue.\n\n## UI\n- SF Symbols for icons\n- No arbitrary font literals ‚Äî use design tokens (`type.xs`, `type.base`, etc.) from `design/system-tokens.md`. Prefer SwiftUI text styles (`.caption`, `.body`) where appropriate. macOS does not have iOS Dynamic Type, but support user-configurable font scaling via preferences.\n- `Button` (NOT onTapGesture) for tappables\n- Extract views &gt;100 lines\n- `guard` for early exits\n\n## Testing\n- Swift Testing (`@Test`, `#expect`) for new unit tests\n- XCUITest + Page Object Model for e2e\n- `.accessibilityIdentifier()` on interactive elements\n- NEVER `Thread.sleep()` ‚Äî use `waitForExistence(timeout:)`\n\n# Ghostty Reference ‚Äî Follow These Patterns\n\nSmithers mirrors Ghostty repo/code style. When unsure, read Ghostty source at `../smithers/ghostty/`.\n\n## Zig File Naming\n- **PascalCase.zig** = struct-as-file (file IS struct): `App.zig`, `Surface.zig`, `Terminal.zig`\n- **snake_case.zig** = namespace/module: `config.zig`, `apprt.zig`, `renderer.zig`\n- Subsystem = directory + namespace: `terminal/` + `terminal.zig` (or `terminal/main.zig`)\n\n## Struct-as-File Pattern\n\n```zig\n//! Module-level doc ‚Äî explain purpose.\nconst MyType = @This();\n\nconst std = @import(&quot;std&quot;);\nconst Allocator = std.mem.Allocator;\nconst log = std.log.scoped(.my_module);\n\n/// Field doc\nalloc: Allocator,\nsurfaces: SurfaceList,\nfocused: bool = true,\n\npub const CreateError = Allocator.Error || OtherError;\n\npub fn create(alloc: Allocator) CreateError!*MyType {\n    var self = try alloc.create(MyType);\n    errdefer alloc.destroy(self);\n    try self.init(alloc);\n    return self;\n}\n\npub fn init(self: *MyType, alloc: Allocator) CreateError!void {\n    self.* = .{ .alloc = alloc, .surfaces = .{}, .focused = true };\n}\n\npub fn deinit(self: *MyType) void {\n    self.surfaces.deinit(self.alloc);\n    self.* = undefined; // Poison\n}\n\npub fn destroy(self: *MyType) void {\n    const alloc = self.alloc;\n    self.deinit();\n    alloc.destroy(self);\n}\n```\n\n## Namespace/Module Pattern\n\n```zig\n// Private imports (no pub)\nconst charsets = @import(&quot;charsets.zig&quot;);\n// Public re-exports\npub const apc = @import(&quot;apc.zig&quot;);\npub const Terminal = @import(&quot;Terminal.zig&quot;);\n// Test discovery\ntest { @import(&quot;std&quot;).testing.refAllDecls(@This()); }\n```\n\n## Import Order (strict)\n1. std library: `const std = @import(&quot;std&quot;);`\n2. std aliases: `const Allocator = std.mem.Allocator;`\n3. Internal: `const configpkg = @import(&quot;config.zig&quot;);`\n4. External: `const oni = @import(&quot;oniguruma&quot;);`\n5. Logger: `const log = std.log.scoped(.module_name);`\n6. Type aliases\n\n## Module Naming\nShadow avoidance ‚Äî suffix `pkg`:\n```zig\nconst configpkg = @import(&quot;config.zig&quot;);\nconst Config = configpkg.Config;\n```\n\n## Lifecycle Pattern\n- `create(alloc)` ‚Äî alloc on heap, call init, return pointer. Use errdefer.\n- `init(self, alloc)` ‚Äî initialize struct. `self.* = .{ ... }`.\n- `deinit(self)` ‚Äî free resources. NOT self. Poison: `self.* = undefined`.\n- `destroy(self)` ‚Äî save allocator, call deinit(), free self.\n\n## Error Pattern\n- Per-operation: `pub const OpenError = error{OpenFailed};`\n- Union: `pub const Error = OpenError || GetModeError || SetSizeError;`\n- errdefer immediately after failable allocation\n- Log: `catch |err| { log.warn(&quot;failed err={}&quot;, .{err}); ... }`\n\n## Generic Type Pattern\n```zig\npub fn BlockingQueue(comptime T: type, comptime capacity: usize) type {\n    return struct {\n        const Self = @This();\n        // ...\n    };\n}\n```\n\n## Platform Abstraction (comptime)\n```zig\npub const Pty = switch (builtin.os.tag) {\n    .windows =&gt; WindowsPty,\n    .ios =&gt; NullPty,\n    else =&gt; PosixPty,\n};\n```\n\n## Labeled Blocks\n```zig\nself.gpa = gpa: {\n    if (condition) break :gpa null;\n    break :gpa GPA{};\n};\n```\n\n## Naming\n- Types/Structs: PascalCase (`App`, `Surface`, `GlobalState`)\n- Functions: camelCase (`init`, `deinit`, `updateConfig`, `drainMailbox`)\n- Variables/fields/constants/enum fields/log scopes: snake_case (`font_grid_set`, `min_window_width_cells`, `.debug`, `.app`)\n\n## Comment Style\n- `//!` ‚Äî module-level doc at file top. WHY module exists, conceptual context.\n- `///` ‚Äî field/function doc. Behavioral contracts, not just types.\n- `//` ‚Äî inline notes. Consequences of alternatives.\n- Minimal. Code self-documents. Explain WHY, not WHAT. Delete if restates code.\n- First person, conversational. Honest about limits: &quot;hack because...&quot;, &quot;can&#x27;t do X because...&quot;\n\n### Field Documentation as Contracts\nBehavioral implications, not just type:\n```zig\n/// Font faces for rendering ‚Äî lookup for codepoints, fallback, etc.\n/// Replaced at runtime on config change.\nfont_grid_set: ?*font.SharedGridSet = null,\n\n/// Non-null = surface closed by host, ignore further interactions.\nclosed: ?*Surface = null,\n```\n\n### Self-Poisoning After Deinit\n`self.* = undefined` at end of `deinit()` ‚Äî use-after-free crashes instead of silent corruption:\n```zig\npub fn deinit(self: *MyType) void {\n    self.resource.deinit();\n    self.alloc.free(self.buffer);\n    self.* = undefined; // Poison\n}\n```\n\n## Test Pattern\n```zig\ntest &quot;CircBuf append&quot; {\n    const testing = std.testing;\n    const alloc = testing.allocator;\n    var buf = try CircBuf(u8, 0).init(alloc, 3);\n    defer buf.deinit(alloc);\n    try buf.append(1);\n    try testing.expectEqual(@as(u8, 1), buf.get(0));\n}\n```\n\n- `std.testing.allocator` (leak detection)\n- `defer` cleanup\n- Progressive complexity (simple ‚Üí edge cases)\n- Descriptive names: `&quot;CircBuf append wraps around&quot;`\n\n## C API Header (`include/libsmithers.h`)\n- Prefix: `smithers_`\n- Types: `_e` (enum), `_s` (struct), `_t` (opaque), `_cb` (callback)\n- Enum values: `SMITHERS_SCREAMING_SNAKE_CASE`\n- Functions: `smithers_snake_case`\n- Sections: `//-------------------------------------------------------------------`\n\n## Swift Organization\n- Feature-based: `macos/Sources/Features/{Chat,IDE,Terminal,Editor,...}`\n- Namespace: `Smithers.Action.swift`, `Smithers.App.swift` (enum as namespace)\n- Extensions: `TypeName+Extension.swift`\n- MARK: `// MARK: App Operations`\n- Guard-let: `guard let app = self.app else { return }`\n\n## build.zig\n- Root thin ‚Äî delegates to `src/build/main.zig`\n- Each artifact/step = `PascalCase.zig` in `src/build/`\n- `pkg/` deps have own `build.zig` wrapper\n\n# Git Commit Rules\n\n- **ALL commits go directly on `main`. NEVER create feature branches, fix branches, or any other branches. Stay on `main` at all times.**\n- Atomic commits (one logical change)\n- Emoji conventional: `EMOJI type(scope): description`\n  - ‚ú® feat ‚Äî new feature\n  - üß™ test ‚Äî add/update tests\n  - üêõ fix ‚Äî bug fix\n  - üìã docs ‚Äî documentation\n  - ‚ôªÔ∏è refactor ‚Äî restructure (no behavior change)\n  - ‚ö° perf ‚Äî performance\n  - üîß chore ‚Äî build/tooling/deps\n- Examples:\n  - `‚ú® feat(chat): add message streaming with WebSocket`\n  - `üß™ test(storage): add WAL mode concurrent access tests`\n  - `üêõ fix(terminal): correct cursor position after resize`\n  - `‚ôªÔ∏è refactor(host): extract platform abstraction to vtable`\n\n## Folder Structure\n\n# Smithers v2 Folder Structure\n\nMirrors Ghostty layout. Single `build.zig` builds all code.\n\n```\nsmithers-v2/\n‚îú‚îÄ‚îÄ build.zig              # Thin ‚Äî delegates to src/build/main.zig\n‚îú‚îÄ‚îÄ build.zig.zon          # Zig package manifest\n‚îú‚îÄ‚îÄ CLAUDE.md              # AI agent conventions\n‚îú‚îÄ‚îÄ docs/\n‚îÇ   ‚îú‚îÄ‚îÄ design.md          # UI/UX spec (~1400 lines)\n‚îÇ   ‚îú‚îÄ‚îÄ engineering.md     # Engineering spec (~2800 lines)\n‚îÇ   ‚îî‚îÄ‚îÄ folder-structure.md\n‚îú‚îÄ‚îÄ issues/*.md            # Feature specs (NOT implementation details)\n‚îú‚îÄ‚îÄ src/                   # Zig source (libsmithers ‚Äî portable logic)\n‚îÇ   ‚îú‚îÄ‚îÄ main.zig           # CLI entry (smithers-ctl)\n‚îÇ   ‚îú‚îÄ‚îÄ build/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.zig       # Build orchestration\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ *.zig          # Each artifact/step = PascalCase.zig\n‚îÇ   ‚îú‚îÄ‚îÄ storage.zig        # SQLite storage\n‚îÇ   ‚îú‚îÄ‚îÄ host.zig           # Platform abstraction (comptime vtable/DI)\n‚îÇ   ‚îî‚îÄ‚îÄ &lt;module&gt;/\n‚îÇ       ‚îú‚îÄ‚îÄ main.zig       # Namespace (re-exports, test discovery)\n‚îÇ       ‚îî‚îÄ‚îÄ *.zig          # PascalCase.zig=struct, snake_case.zig=module\n‚îú‚îÄ‚îÄ include/\n‚îÇ   ‚îî‚îÄ‚îÄ libsmithers.h      # C API ‚Äî contract between Zig/Swift\n‚îÇ                          # smithers_ prefix; _e(enum), _s(struct), _t(opaque), _cb(callback)\n‚îú‚îÄ‚îÄ pkg/                   # Vendored C/C++ deps + Zig wrappers\n‚îÇ   ‚îú‚îÄ‚îÄ sqlite/build.zig   # SQLite amalgamation\n‚îÇ   ‚îú‚îÄ‚îÄ zap/build.zig      # Zap HTTP (wraps facil.io)\n‚îÇ   ‚îî‚îÄ‚îÄ tree-sitter/build.zig\n‚îú‚îÄ‚îÄ submodules/            # Git submodules (Rust ‚Üí static libs)\n‚îÇ   ‚îú‚îÄ‚îÄ codex/build.zig    # EVMTS fork ‚Äî Codex as Zig API (cargo wrapper)\n‚îÇ   ‚îî‚îÄ‚îÄ jj/build.zig       # EVMTS fork ‚Äî Jujutsu (no code changes, cargo wrapper)\n‚îú‚îÄ‚îÄ macos/                 # Swift app (Xcode project, NOT Package.swift)\n‚îÇ   ‚îú‚îÄ‚îÄ Smithers.xcodeproj/\n‚îÇ   ‚îî‚îÄ‚îÄ Sources/Features/  # Feature-based: App/, Chat/, IDE/, Terminal/, Editor/\n‚îú‚îÄ‚îÄ web/                   # SolidJS Vite PWA (parity with native)\n‚îÇ   ‚îú‚îÄ‚îÄ package.json       # pnpm\n‚îÇ   ‚îú‚îÄ‚îÄ vite.config.ts\n‚îÇ   ‚îú‚îÄ‚îÄ src/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/    # SolidJS (shadcn-solid)\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stores/        # Plain SolidJS stores\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/         # SPA routes\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lib/           # Utils, API client\n‚îÇ   ‚îî‚îÄ‚îÄ tests/*.spec.ts    # Playwright e2e\n‚îú‚îÄ‚îÄ prototype0 -&gt; ../smithers/apps/desktop  # v1 reference\n‚îú‚îÄ‚îÄ prototype1/            # Next.js frozen reference (delete when done)\n‚îú‚îÄ‚îÄ scripts/smithers-workflow/  # 3 AI agents build product\n‚îî‚îÄ‚îÄ .github/workflows/     # CI: Zig tests‚ÜíRust‚ÜíSwift‚ÜíPlaywright‚Üíweb\n```\n\n## Naming Conventions\n\n### Zig\n- **PascalCase.zig** = struct-as-file (file IS struct, `const Self = @This();`). Ex: `App.zig`, `Surface.zig`, `Terminal.zig`, `Storage.zig`\n- **snake_case.zig** = namespace/module (re-exports, shared types). Ex: `config.zig`, `apprt.zig`, `renderer.zig`\n- Subsystem = **directory + namespace file**: `terminal/` + `terminal/main.zig`\n\n### Swift\n- **Feature-based**: `macos/Sources/Features/{FeatureName}/`\n- **Namespace**: `Smithers.Action.swift`, `Smithers.App.swift` (enum as namespace)\n- **Extensions**: `TypeName+Extension.swift`\n\n### Web\n- **Components**: `web/src/components/` (SolidJS, shadcn-solid)\n- **Stores**: `web/src/stores/` (SolidJS createStore)\n- **Tests**: `web/tests/*.spec.ts` (Playwright)\n\n## Build Commands\n\n```bash\nzig build              # Everything wired in build.zig\nzig build run          # Build + run CLI (current)\nzig build test         # Zig unit tests\nzig build all          # Build + tests + fmt/lint (canonical green check)\n\n# Planned (once build.zig defines these steps):\n# zig build dev          # Build + launch macOS\n# zig build web          # Web only\n# zig build playwright   # Web + server + Playwright e2e\n# zig build codex        # Codex static lib\n# zig build jj           # JJ only\n# zig build xcode-test   # Swift tests\n# zig build ui-test      # XCUITest e2e\n```\n\n## Key Principles\n\n1. **build.zig builds EVERYTHING** ‚Äî Zig, C deps, Rust (cargo), Swift, web\n2. **Vendor C/C++** in `pkg/` with Zig wrappers\n3. **Rust** as git submodules in `submodules/` ‚Üí static libs\n4. **Swift deps** via Xcode SPM (Sparkle, STTextView, GRDB.swift)\n5. **Web deps** via pnpm in `web/`\n6. **No Turborepo/Nx** ‚Äî `build.zig` = monorepo tool\n\n## JSON Output Requirement\n\nMUST end response with JSON object in code fence. Format specified in task prompt.\n\n```json\n{&quot;key&quot;: &quot;value&quot;, &quot;other&quot;: &quot;data&quot;}\n\n```\n\nREQUIRED. Workflow cannot continue without it.\n\n## Design Specification\n\n# Design Principles &amp; Window Architecture\n\n## Ultimate UX for Agentic Coding ‚Äî TUI to GUI\n\n**Goal: build ultimate UX for agentic coding evolving TUI to GUI.**\n\nTargets TUI power-users living in terminal ‚Äî Claude Code, vim, tmux users want better harness, NOT VS Code users seeking AI plugin. Must **feel like TUI, have GUI UX**:\n\n- **Keyboard first.** Every core action achievable without mouse. Tmux-style prefix, vim-compatible nav, command palette everything.\n- **Feels like terminal, built as GUI.** Native Swift app ‚Äî not terminal app. Designed to *feel* like terminal to power users. One keystroke from literal terminal (via **GhosttyKit** ‚Äî Ghostty&#x27;s emulator library embedded as terminal surfaces). Neovim mode makes file editing feel vim. Tmux shortcuts work everywhere. GUI adds value through things painful in raw terminal ‚Äî orchestrating multiple agents, visual diff review, quad-pane layouts ‚Äî without losing what terminal users love: speed, keyboard control, directness.\n- **Chat first.** Primary interaction conversational. Main chat window = &quot;pane 0&quot; ‚Äî always present. Everything else (editor, file tree, JJ panel, agents, terminals) attaches to and orchestrated from chat.\n\nNOT &quot;chat + IDE.&quot; A **chat-first agentic coding environment** where AI orchestrates work across multiple sub-agents, human monitors/steers/intervenes when needed.\n\n### Chat sidebar modes\n\nMain chat window sidebar not just chat history. Three modes (visible in `prototype1/`):\n\n1. **Chats** ‚Äî Top-level conversation history grouped by time, ability to **fork** any conversation at any point. User&#x27;s direct conversations with main agent.\n2. **Source** ‚Äî JJ (Jujutsu) version control panel: working copy changes, change log, bookmarks, operation log, snapshots.\n3. **Agents** ‚Äî Background sub-agent dashboard. **Separate from top-level chats.** Sub-agents = ephemeral background workers spawned by main agent. Run without human in loop, user monitors status here.\n\n**Top-level chats vs. sub-agents are different.** Top-level chat = user talking to orchestrator. Sub-agent = background worker delegated by orchestrator for specific task. Agent dashboard shows sub-agent status; chat history shows conversation threads.\n\n### Reference prototype\n\nTarget look/feel in `prototype1/` ‚Äî Next.js + TypeScript + Tailwind CSS mockup (&quot;Smithers v2 prototype&quot;). Also live v0: https://v0.app/chat/mac-os-ide-prototype-cEqmBbcomU7\n\n**Prototype = design reference for BOTH native macOS app and SolidJS web app.** Web app (`web/`) should look close to native ‚Äî same colors, spacing, layout, components. CSS custom properties (`--sm-*`) from prototype used directly in web app.\n\n---\n\n## Chat‚ÄëFirst Dual‚ÄëWindow macOS IDE (SwiftUI, macOS 14+)\n\nTranslates &quot;chat‚Äëas‚Äëprimary&quot; paradigm into implementable pixel‚Äëprecise UI system. Assumes all core capabilities remain functionally available (editor/terminal/JJ/agents/skills/search/diffs), reorganized into **two independent windows** sharing state.\n\n---\n\n## 0) Product principles\n\n1. **Chat default workspace.** User never opens IDE window, app still feels complete.\n2. **Secondary tools on-demand.** IDE window revealed only when human wants inspect/edit or AI produces work worth reviewing.\n3. **Least-noisy UI.** No persistent clutter. Observable constraints:\n   - Hover-only action bars appear within 100ms of hover\n   - No more than 3 persistent toolbar buttons in composer/footer\n   - Chrome controls hidden until hover or focus; no always-visible icons for actions used &lt;20% of the time\n4. **macOS-native behaviors.** Traffic lights, standard Cmd shortcuts, proper focus rings, contextual menus, draggable window background.\n5. **Performance-first rendering.** Observable constraints:\n   - Chat list uses `LazyVStack` (Swift) / virtualized list (web) ‚Äî no full DOM/view tree for off-screen messages\n   - No full markdown reparse on each streaming token delta ‚Äî append-only rendering\n   - File tree loads children on expand (lazy), no eager recursion of entire workspace\n   - Debounce search/filter inputs by 150ms\n   - No blur effects except small overlays (&lt;400x400px)\n6. **One design system shared.** Same tokens, same components. IDE chrome uses Nova-inspired syntax palette (see `system-tokens.md` ¬ß2.3). Chat density follows compact messaging app conventions (8-12px vertical padding between messages).\n7. **TUI-native feel.** Keyboard-first nav, tmux-compatible prefix keys, terminal always one keystroke away. GUI exists as harness making complex workflows possible ‚Äî orchestrating multiple agents, visual diff review, long-running parallel tasks ‚Äî things painful in raw terminal.\n\n---\n\n## 1) Window architecture &amp; lifecycle\n\n### 1.1 Windows\n\nTwo `NSWindow` instances, two SwiftUI roots, one shared app state.\n\n- **Chat Window (primary)**\n  - Created on launch\n  - Closing **hides window, does NOT quit app**. Smithers continues background with **menu bar icon** (like Slack, Discord). Required for scheduled agents fire on schedule. Menu bar shows agent status, allows quick access. Quitting explicit via Cmd+Q or menu &quot;Quit&quot;.\n  - Always shows chat detail\n\n- **IDE Window (secondary)**\n  - Created on demand\n  - Closing **hides** (doesn&#x27;t destroy state)\n  - Reopening restores last tab set, scroll positions, sidebar widths\n\n### 1.2 Default sizing &amp; placement\n\nPer workspace, persist both window frames independently (WindowFrameStore expanded to two keys).\n\nDefault Chat Window: width 45% screen visible frame, height 85%, origin center-left (x offset ‚àí6% screen width from center)\n\nDefault IDE Window: width 55%, height 85%, origin center-right (x offset +6%)\n\n### 1.3 Window chrome (both)\n\n`titlebarAppearsTransparent = true`, `.hiddenTitleBar` / &quot;full-size content view&quot;; Traffic lights standard position; Content extends behind titlebar; `isMovableByWindowBackground = true` ‚Äî ensure only non-interactive chrome regions participate drag\n\n### 1.4 Focus / activation rules\n\nOpening IDE from chat: brings IDE front; If invoked &quot;Open in Editor&quot; on diff/file path, IDE selects that file tab scrolls target line\n\nWhen AI finishes applying changes: chat window remains focused unless pref &quot;Auto-open IDE on file change&quot; enabled\n\n### 1.5 Menu bar icon &amp; background mode\n\nSmithers persists **menu bar app** even all windows closed. Menu bar icon (`NSStatusItem`) provides:\n\n- **Status indicator:** Idle (default icon), Working (animated dot/spinner), Completed (badge count finished agents)\n- **Click menu:** &quot;Show Smithers&quot; (reveal chat), &quot;New Chat&quot; (new session + reveal), &quot;Active Agents&quot; (submenu listing running agents + status), separator, &quot;Check for Updates‚Ä¶&quot;, &quot;Preferences‚Ä¶&quot;, &quot;Quit Smithers&quot; (‚åòQ)\n- **Notification badge:** background/scheduled agent completes, icon briefly pulses + macOS notification (if enabled)\n\nRequired **scheduled agents** feature (cron-like background tasks) + agents running while user switched to another app.\n\n### 1.6 URL scheme deep linking\n\nRegisters URL schemes Info.plist:\n\n- `smithers://` ‚Äî general deep linking\n- `smithers-open-file://&lt;path&gt;?line=N&amp;col=M` ‚Äî opens file at location. Used by external tools, terminal output, Finder.\n- `smithers-chat://&lt;session-id&gt;` ‚Äî opens specific chat session\n\nBehavior: all funnel through `ExternalOpenRequest` handler with batch support; Pending URL queue if files opened before workspace ready, process once workspace loads; Workspace root inference when opening file ‚Äî walk up directory hierarchy looking `.jj/`, `.git/`, or project files\n\n# Design System Tokens\n\n## 2) Design system\n\nNormalized token table + semantic/system tokens for all states.\n\n### 2.1 Color tokens (Dark default)\n\n#### Surfaces\n\n| Token | Purpose | Value |\n|-------|---------|-------|\n| `color.base` | Deepest background | `#0F111A` |\n| `color.surface1` | Primary panes | `#141826` |\n| `color.surface2` | Chrome (tab/status/sidebar headers) | `#1A2030` |\n| `color.border` | 1px separators | `white@8%` |\n\n#### Chat-specific surfaces\n\n| Token | Purpose | Value |\n|-------|---------|-------|\n| `chat.sidebar.bg` | Chat sidebar background | `#0C0E16` |\n| `chat.sidebar.hover` | Row hover | `white@4%` |\n| `chat.sidebar.selected` | Selected session | `accent@12%` |\n| `chat.pill.bg` | Category pill bg | `white@6%` |\n| `chat.pill.border` | Category pill border | `white@10%` |\n| `chat.pill.active` | Pill hover/active | `accent@15%` |\n| `titlebar.bg` | Titlebar background | `#141826` |\n| `titlebar.fg` | Titlebar text | `white@70%` |\n\n#### Chat bubbles\n\n| Token | Purpose | Value |\n|-------|---------|-------|\n| `chat.bubble.assistant` | Assistant bubble | `white@5%` |\n| `chat.bubble.user` | User bubble | `accent@12%` |\n| `chat.bubble.command` | Command bubble | `white@4%` |\n| `chat.bubble.status` | Status bubble | `white@4%` |\n| `chat.bubble.diff` | Diff preview bubble | `white@5%` |\n| `chat.input.bg` | Input field bg | `white@6%` |\n\n#### Accent &amp; semantic\n\n| Token | Purpose | Value |\n|-------|---------|-------|\n| `color.accent` | Primary accent | `#4C8DFF` |\n| `color.success` | Success (exit 0, applied) | `#34D399` (saturated not neon) |\n| `color.warning` | Warning (declined, conflicts) | `#FBBF24` |\n| `color.danger` | Error (exit !=0, failed) | `#F87171` |\n| `color.info` | Informational status | `#60A5FA` |\n\n&gt; Use semantic colors **sparingly**; most UI neutral. Semantic appears as small badges/indicators, not full-pane fills.\n\n### 2.2 Text opacity\n\n| Level | Token | Opacity | Usage |\n|-------|-------|---------|-------|\n| Primary | `text.primary` | 88% | main text |\n| Secondary | `text.secondary` | 60% | descriptions, inactive |\n| Tertiary | `text.tertiary` | 45% | timestamps, hints |\n\n### 2.3 Syntax palette (Nova-inspired)\n\n| Token type | Color |\n|------------|-------|\n| Keywords | `#FF5370` |\n| Strings | `#C3E88D` |\n| Functions | `#82AAFF` |\n| Comments | `#676E95` |\n| Types | `#FFCB6B` |\n| Variables/Props | `#F07178` |\n| Numbers/Constants | `#D4C26A` |\n| Operators | `#89DDFF` |\n| Punctuation | `gray@70%` |\n| Tags (JSX/HTML) | coral/red family |\n\n### 2.3.1 Token Math Contract\n\nTint shorthand (`white@X%`, `accent@X%`) is unambiguous across platforms:\n\n| Shorthand | Meaning | Swift | CSS |\n|-----------|---------|-------|-----|\n| `white@X%` | White with X% opacity | `NSColor.white.withAlphaComponent(X/100)` | `rgba(255, 255, 255, X/100)` |\n| `black@X%` | Black with X% opacity | `NSColor.black.withAlphaComponent(X/100)` | `rgba(0, 0, 0, X/100)` |\n| `accent@X%` | Accent (#4C8DFF) with X% opacity | `NSColor(accent).withAlphaComponent(X/100)` | `rgba(var(--sm-accent-rgb), X/100)` |\n| `gray@X%` | Mid-gray with X% opacity | `NSColor.gray.withAlphaComponent(X/100)` | `rgba(128, 128, 128, X/100)` |\n\n**Application method:** Direct background fill (NOT overlay compositing). These are background colors applied via `backgroundColor` / `background-color`, not blended on top of existing surfaces.\n\n**CSS variable convention:** `--sm-accent-rgb: 76, 141, 255;` (comma-separated for use in `rgba()`).\n\n**SwiftUI:** Use `.background(Color.white.opacity(0.06))` for `white@6%`.\n\n### 2.4 Light theme derivation\n\nDeterministic derivation so engineering not hand-tuning 30 colors.\n\n**Algorithm:**\n\n- Keep `accent` identical\n- Replace surface stack near-white neutrals: `base` ‚Üí `#F6F7FB`, `surface1` ‚Üí `#FFFFFF`, `surface2` ‚Üí `#EEF1F7`, `border` ‚Üí `black@10%`\n- Text opacities map black same opacities (primary 88%, etc.)\n- Chat bubbles: assistant ‚Üí `black@4%`, user ‚Üí `accent@12%` (unchanged tint logic)\n- Hover states `black@3‚Äì4%` instead white\n\n### 2.5 Typography\n\nSystem fonts; no custom files.\n\n#### UI font\n\nSystem UI `.system` (SF Pro); Weights: Regular body, Medium labels, Semibold headings\n\n#### Code font\n\nSystem monospace `.monospaced` / SF Mono; Default 13pt (code), 14pt if want closer current Smithers feel\n\n#### Scale\n\n| Token | Size | Usage |\n|-------|------|-------|\n| `type.xs` | 10 | timestamps, tiny labels, line numbers |\n| `type.s` | 11 | sidebar items, status bar |\n| `type.base` | 13 | default body, chat, code |\n| `type.l` | 15 | section headers |\n| `type.xl` | 20 | dialogs, empty state headings |\n| `type.chatHeading` | 28 | &quot;How can I help you?&quot; |\n| `type.chatSubheading` | 16 | project name under heading |\n| `type.chatSidebarTitle` | 12 | session title |\n| `type.chatTimestamp` | 10 | session timestamp |\n\nLine height multipliers: UI 1.35, chat messages 1.5, code 1.4\n\n### 2.6 Spacing &amp; sizing\n\n4pt grid. Primary component metrics:\n\n`space.4 = 4`, `space.6 = 6`, `space.8 = 8`, `space.10 = 10`, `space.12 = 12`, `space.16 = 16`, `space.24 = 24`, `space.32 = 32`\n\nCommon heights: sidebar mode bar 40pt, title bar zone 28pt, status bar 22pt, tab bar 32pt, input send button 32√ó32\n\n### 2.7 Corner radii\n\n| Token | Value | Usage |\n|-------|-------|-------|\n| `radius.4` | 4 | chat tail corner |\n| `radius.6` | 6 | buttons, small cards |\n| `radius.8` | 8 | pills, inputs, tabs |\n| `radius.10` | 10 | input bar container |\n| `radius.12` | 12 | chat bubbles |\n| `radius.16` | 16 | dialogs, large cards |\n\n### 2.8 Borders &amp; separators\n\n1px separators use `color.border` (`white@8%` / `black@10%` light); Avoid heavy strokes; use separators between structural panes only\n\n### 2.9 Shadows\n\nOnly overlays (command palette, image viewer, modals): shadow y=10 blur=30 color `black@35%` (dark) / `black@18%` (light)\n\n# Shared Components &amp; View Hierarchy\n\n## 3) Components library\n\nUsed in both windows. Keep in `DesignSystem` module with tokens + reusable views.\n\n### 3.1 `IconButton`\n\nSizes: Small 24√ó24 (toolbar), Medium 28√ó28, Large 32√ó32 (primary); Default: no bg, Hover `white@6%`, Active `white@10%`; Icon 14‚Äì16pt; Tooltip via `.help()`\n\n### 3.2 `PrimaryButton`\n\n32pt height, 12pt h padding, radius 8, `accent@90%` bg, white 92% text; Hover brighten +6% (or `white@6%` overlay); Disabled 45% opacity\n\n### 3.3 `PillButton`\n\nRadius 999, padding 14pt h / 8pt v, `chat.pill.bg`, border 1px `chat.pill.border`; Hover/active `chat.pill.active`\n\n### 3.4 `Panel`\n\nBg `surface2` (chrome) or `surface1` (content), border 1px `color.border`, radius 10‚Äì16\n\n### 3.5 `SidebarListRow`\n\n44pt (or 36pt dense); Hover `white@4%`, selected `accent@12%`; Title `type.chatSidebarTitle` 12pt primary, secondary 10pt tertiary\n\n### 3.6 `Badge`\n\n18‚Äì20pt, padding 6pt h / 2pt v, radius 6, semantic@18% bg, semantic@95% text (or white 88% contrast)\n\n---\n\n## 4) View hierarchy\n\n### 4.1 App root / scenes\n\n- `SmithersApp`\n  - `AppModel` (@State shared)\n  - `ChatWindowScene` ‚Üí `ChatWindowRootView`\n  - `IDEWindowScene` (hidden until opened) ‚Üí `IDEWindowRootView`\n  - `SettingsScene` ‚Üí `SettingsRootView` (standard macOS)\n\n# Chat Window Spec\n\n## 5.1 Layout\n\nRoot: `NavigationSplitView` ‚Äî sidebar 200‚Äì360pt (default 260pt), detail flexible\n\n`ChatWindowRootView` ‚Üí `ChatSidebarView` + `ChatDetailView`\n\n## 5.2 Sidebar hierarchy\n\n`ChatSidebarView` (VStack) ‚Üí `SidebarModeBar` (40pt) + Divider + `ChatSidebarContent`\n\nModes: Chats (NewChatButton + SearchField + SessionList), Source (JJPanelSidebar), Agents (AgentDashboardSidebar)\n\n### 5.2.1 Mode bar\n\n40pt height, 8pt padding, `chat.sidebar.bg`\n\n3 `ModeBarItemButton`: Chats (`bubble.left.and.bubble.right`), Source (`arrow.triangle.branch`), Agents (`person.3`)\n\nSelected: accent text, `accent@12%` pill (radius 8); Inactive: secondary text, no bg; Hover: `white@4%`\n\n### 5.2.2 Chats mode ‚Äî Session list\n\nGroups: Today / Yesterday / This Week / Older ‚Äî headers uppercase `type.xs` tertiary, padding 8pt top / 6pt bottom / 12pt h\n\n`ChatSessionRow`: 56pt, padding 10pt v / 12pt h; Title 12pt semibold primary, timestamp 10pt tertiary trailing, preview 10pt tertiary max 2 lines; Hover `chat.sidebar.hover`, selected `chat.sidebar.selected`; Context menu: Rename / Delete / Duplicate; Inline rename: Enter commits, Esc cancels\n\n### 5.2.3 Source mode ‚Äî JJ panel\n\nCompact JJ (Jujutsu) workflow: viewing changes, committing, branching, git remotes\n\n`JJPanelSidebar` sections: WorkingCopy, ChangeLog, Bookmarks, OpLog, Snapshots\n\nSection header (32pt): disclosure triangle, title 11pt medium, optional trailing action; Content rows 36‚Äì44pt\n\n**Working Copy:**\n\nAction buttons: Describe (pencil ‚Äî inline text field, `CommitStyleDetector` matches team style from last 30 commits), New (plus ‚Äî `jj new`), Snapshot (camera ‚Äî Describe + New)\n\nFile rows: status badge M/A/D/? (M=warning, A=success, D=danger, ?=tertiary), filename 11pt + path tertiary if not unique, `+N ‚àíM` monospace 10pt success/danger; Click opens diff (chat card or IDE tab per pref); Context: Reveal / Open / Copy Path / Revert\n\n**Change Log:**\n\nRows: change ID (short hash mono), description 11pt, author, relative time; Working copy highlighted accent; Context: Squash / Abandon (confirm) / Edit / Describe / Create bookmark / Copy ID\n\n**Bookmarks:**\n\nRows: name 11pt medium, tracking (local/remote), change ID; Context: Git Push (`jj git push -b &lt;name&gt;`) / Delete (confirm) / Rename / Copy Name\n\nFooter buttons: Push All Tracked (`jj git push --tracked`), Fetch (`jj git fetch`)\n\n**Operations Log:**\n\nRows: operation description, relative timestamp; Context: Restore (`jj op restore &lt;id&gt;`, confirm dialog), Undo (`jj undo`, recent only)\n\n**Snapshots:**\n\nRows: description, time, trigger (auto/manual/agent); Click: revert preview dialog + diff (confirm/cancel); AI turns auto-create (2s debounce), manual saves optional (pref)\n\n**Conflict indicator:** warning banner top of Source panel ‚Äî `warning@12%` bg, triangle icon, &quot;N conflicts in M files&quot;, click opens conflict list\n\n### 5.2.4 Agents mode ‚Äî Dashboard\n\n`AgentDashboardSidebar`: New Agent button (PrimaryButton full width) + ActiveAgentsList + PastAgentsList (collapsible) + MergeQueueList\n\n**Agent row:** status dot 8pt ‚Äî Idle (tertiary), Working (`color.info` pulse 0.8s), Completed (`color.success`), Failed (`color.danger`), Cancelled (tertiary strikethrough), Conflicted (`color.warning`), In Queue (tertiary + badge), Merged (`color.success` + checkmark); Title 11pt medium, subtitle 10pt tertiary 1 line truncated, files badge monospace `white@8%` radius 4; Hover actions 24√ó24: Open Chat (bubble ‚Äî unhides `.chat` tab in IDE), Open Diff (diff icon), Merge (merge icon, confirm + preview), Cancel (stop, confirm &quot;Changes preserved in JJ branch&quot;); Click row expands: task, start time, duration, file list\n\n**Config:** Concurrent limit (default 4, configurable, excess queued); Setup commands (optional shell per-workspace)\n\n**Lifecycle:** Each agent: JJ workspace branch (`jj workspace add`), Codex session (multiplexed), polls file changes, reports events; Complete: ready to merge or show conflicts\n\n**Merge queue (post-MVP, UI reserved):** entries show agent, priority (low/normal/high/urgent), status (waiting/testing/merging/merged/failed); drag reorder, test status spinner/badge, auto-merge toggle; MVP: simple Merge button\n\n---\n\n## 5.3 Detail view\n\n`ChatDetailView` (VStack spacing 0): TitleBarZone (28pt) + Divider + MessagesZone (fills) + Divider + ComposerZone\n\n### 5.3.1 Title bar\n\n28pt, `titlebar.bg`; HStack: leading spacer, center workspace name 11pt `titlebar.fg`, trailing OpenEditorButton (icon `rectangle.split.2x1`, tooltip &quot;Open Editor&quot;); Click: create &amp; show IDE or bring to front\n\n### 5.3.2 Messages zone\n\n`ScrollViewReader` + `ScrollView` + `LazyVStack` (spacing 10‚Äì12), padding 16pt h / 16pt top / 12pt bottom\n\nAuto-scroll: pin to bottom on new text if at bottom, else show &quot;Jump to latest&quot; button (bottom-right above composer, 36pt, radius 8)\n\n#### Message types\n\n1. **User bubble:** trailing, max 80% width, `UnevenRoundedRectangle` corners 12 tail 4 (bottom-right), `chat.bubble.user`, 13pt primary line-height 1.5, markdown (bold/italic/code)\n\n2. **Assistant bubble:** leading, tail bottom-left, `chat.bubble.assistant`; Headings 15pt semibold, code blocks mono `white@4%` radius 8 padding 10pt, inline code mono `white@6%`; File paths `path:line:col` clickable (underline hover, opens IDE)\n\n3. **Command bubble:** leading, max 90%, `chat.bubble.command`; Header `$ command` mono 13pt semibold + spinner/exit badge, CWD 10pt tertiary, output mono 12‚Äì13pt selectable h-scroll; Running: spinner &quot;Running‚Ä¶&quot; secondary, stream in place smooth height\n\n4. **Diff card:** leading, max 90%, `chat.bubble.diff`; Title &quot;N files changed&quot; or filename 13pt medium, file list (5 max then &quot;+N more&quot;), summary `+N ‚àíM` mono success/danger, preview 8 lines mono diff coloring; Footer: status badge (Applying/Applied/Failed/Declined) + &quot;Open in Editor&quot; button; Click: full diff viewer (sheet or IDE tab per pref); &quot;Open in Editor&quot; always opens IDE + selects diff/file\n\n5. **Status:** neutral pill centered/leading, `chat.bubble.status`, 11pt secondary\n\n6. **Starter prompt:** new/empty chats only, renders welcome (5.5)\n\n#### Message hover action bar\n\n150ms delay, floats above bubble edge; `black@30%` bg, `white@6%` border, radius 8\n\nButtons: Fork (branch ‚Äî new chat session inherits messages to this point, appears in sidebar + can open as `.chat` tab), Copy, Retry (assistant/last user), Edit &amp; Resend (user), Revert (if JJ snapshot), More (ellipsis ‚Üí &quot;Rollback to here&quot;); Dismiss on mouse leave\n\n### 5.3.3 Thinking\n\nLeading bubble, spinner + &quot;Thinking‚Ä¶&quot;, assistant bubble style, 8pt padding\n\n## 5.4 Composer\n\n`ChatComposerZone` (VStack spacing 8, padding 12‚Äì16): ComposerContainer (radius 10 ‚Äî TextField multiline 1‚Äì4 + optional AttachmentStrip) + FooterRow (hint text left tertiary, Send/Interrupt right)\n\nContainer: `chat.input.bg`, border 1px `white@6%`, padding 10pt; Drop: border accent, bg `accent@6%`\n\nAction buttons (left row): Attach (paperclip ‚Äî file picker/paste), @Mention (AtSign ‚Äî popup files/symbols, inserts `@filename`/`@symbol` context), Skills (sparkles ‚Äî popover toggles active skills); Always visible left of send\n\nSend: 32√ó32 radius 6 accent solid, up arrow, hover brighten +6%, disabled if empty + no attachments\n\nInterrupt: 32√ó32 `danger@25%` stop icon, visible only while AI processing\n\nSlash popup: `/` at start ‚Üí autocomplete `/plan` `/review` `/diff` `/fork` `/new` `/resume` `/status` `/compact` `/mention` `/init` `/model`; surface2 radius 8 shadow, max 8 rows, arrows + Enter/Esc; Accepts inline args\n\n@Mention popup: `@` ‚Üí file/symbol autocomplete filtered, inserts references; Same style as slash\n\nSteer mode (while agent running): composer active, Enter steers real-time, Tab queues follow-up, indicator shows Steer/Queue\n\nKeys: Return=Send (or Steer), Tab=Queue (if agent running), Shift+Return=newline, Cmd+Return=Send, Esc=interrupt or clear focus\n\n### 5.4.1 Images\n\nAccept paste/drag; `AttachmentStrip` 56‚Äì72pt: thumbnails 56√ó56 radius 8, h-scroll if &gt;4, hover x to remove\n\n### 5.4.2 Fullscreen viewer\n\nOverlay (not sheet), scrim `black@60%`, centered image max 90% window; Close: Esc or top-right X\n\n---\n\n## 5.5 Welcome screen\n\nShown: new chat or no messages; Centered VStack max width 640\n\n1. Heading 28pt semibold &quot;How can I help you?&quot;\n2. Subheading 16pt secondary project name (if workspace)\n3. Category pills (Create / Explore / Code / Learn)\n4. AI-generated prompts (4 rows): `white@6%` bg/border radius 8, padding 12pt, trailing arrow\n\nPrompts AI-generated workspace-aware (NOT hardcoded). `SuggestionService` analyzes: recent files/edits, JJ status (uncommitted/conflicts/commits), project type (language/framework), recent/repeated prompts; Cached per-workspace 5min refresh; Defaults if not ready: &quot;Explore codebase&quot; &quot;Review changes&quot; &quot;Fix bug&quot; &quot;Write docs&quot;\n\nInteraction: click pill filters, click suggestion inserts text + focuses composer\n\n# IDE Window Spec (Secondary)\n\n## 6.1 Layout\n\nRoot: `NavigationSplitView` ‚Äî sidebar 180‚Äì400pt (default 240pt), detail flexible\n\n`IDEWindowRootView` ‚Üí `FileTreeSidebar` + `IDEWorkspaceDetailView`\n\n## 6.2 File tree sidebar\n\n### Empty state\n\nCentered: folder icon, &quot;No Folder Open&quot;, &quot;Open Folder‚Ä¶&quot; button, &quot;‚åò‚áßO&quot; hint\n\n### Tree appearance\n\nBg `surface1`, root header `surface2`; Indent 16pt per level, guides 1px `border@35%`; Row height 28‚Äì32pt\n\n### Row spec\n\nHStack: disclosure chevron (folders, 12pt), file/folder icon 16pt colored (Swift orange, TS/JS blue/yellow, Python green, Rust red-brown, Zig orange-gold, JSON/YAML gray, Markdown light blue, folders accent when expanded, SF Symbols fallback `doc`), name 11pt, spacer, modified dot 6pt `color.warning` (unsaved)\n\nStates: Hover `white@4%`, selected accent capsule 3pt width radius 2 full height minus 6pt inset; Current file `accent@6%` bg + capsule\n\nContext: Folders (New File/Folder, Copy Path, Reveal, Rename, Delete), Files (Copy Path, Reveal, Open in Terminal, Rename, Delete); Inline rename Enter commits Esc cancels\n\n### Keyboard nav\n\nArrows Up/Down move; Right expands folder or first child; Left collapses or parent; Enter opens; Space quick-look; Delete confirms\n\n### Lazy loading &amp; auto-refresh\n\nExpand triggers children load, chevron rotates 90¬∞ 0.15s ease-in-out; Auto-refresh via `FSEvents` 250ms debounce; Respects `.gitignore`/`.jj/ignore`, toggle &quot;Show Hidden Files&quot; in context/palette\n\n---\n\n## 6.3 IDE detail\n\n`IDEWorkspaceDetailView` (VStack spacing 0): TabBar (32pt if tabs) + BreadcrumbBar (18‚Äì22pt if file) + Divider + ContentArea (fills) + Divider + StatusBar (22pt)\n\n### 6.3.1 Tab bar\n\nTypes: file, terminal, diff, webview, chat (sub-agents, forked chats ‚Äî any chat can open as tab)\n\nNova-like: bg `surface2`; Selected `white@6%` + accent underline 2pt; Unselected secondary text; Geometry 28‚Äì30pt in 32pt bar, radius 8, padding 10pt h, min 120pt max 220pt; Distribute evenly if fits else h-scroll\n\nContents: leading icon (colored), filename 11pt, modified dot OR close on hover; Tooltip shows path\n\nInteractions: Click selects, drag reorder (insertion highlight, animate swap), middle-click closes; Context: Close / Close Others / All / to Right, Copy Path, Reveal Finder/Sidebar\n\nRight: overflow menu (ellipsis ‚Äî &quot;Switch To&quot; list, close actions)\n\n### 6.3.2 Breadcrumb bar\n\nBg `surface1` (or `surface2`), 10pt font, clickable segments, last bold, opacity gradient (earlier tertiary, later secondary/primary)\n\n### 6.3.3 Content area\n\n#### A) Code editor\n\nBg `surface1`; Gutter 44‚Äì56pt line numbers, bg `surface1`, divider 1px `border`; Current line `white@6‚Äì10%`, matching bracket `white@16%`, indent guides 1px `border@35%`; Minimap optional 70pt + separator 1px; Scrollbar overlay (always/auto/never)\n\n**Multi-cursor:** Opt+Click add cursor, Opt+Shift+Up/Down adjacent line, Cmd+D next occurrence, Cmd+Shift+L all occurrences, Esc collapse; All cursors type/delete/select together, grouped undo, multi-clipboard; Each cursor identical blink/block per pref\n\n**Ghost text:** `GhostTextOverlayView` dim `white@35‚Äì45%` overlay at cursor, pass-through no hit; Fade in 0.12s ease-out, fade out 0.12s dismiss/accept; Tab accepts, Esc dismisses, typing advances or cancels; `CompletionService` 300ms debounce to codex-app-server, streaming updates, generation counter cancels previous; Not in Neovim mode\n\n**Pinch-to-zoom:** trackpad adjusts font 8‚Äì48pt real-time, persists on gesture end, smooth no flicker\n\n**Press-and-hold disable:** macOS accent popup disabled (`ApplePressAndHoldEnabled = false` scoped), ensures key repeat for vim (holding j/h/etc)\n\n**Smooth scrolling:** `SmoothScrollController` velocity-based easing (not jarring jumps); Terminal snaps to cell grid; Integrated with Neovim mouse scroll RPC; Respects natural/inverted system pref\n\n**Link detection:** File paths `path:line:col` clickable (accent underline hover, opens IDE via `showInEditor()`); URLs in chat/terminal clickable (browser or webview tab per pref); Terminal Cmd+Click paths/URLs, Ghostty handles URLs natively, add file path detection workspace-relative\n\n**Neovim mode parity:** When active, STTextView replaced by Ghostty terminal running embedded Neovim\n\n| Feature | Editor mode | Neovim mode |\n|---------|-------------|-------------|\n| Syntax highlight | TreeSitter Swift-side | Neovim built-in |\n| Multi-cursor | Custom | Plugins (vim-visual-multi) |\n| Ghost text | GhostTextOverlayView | N/A (Neovim completion) |\n| Auto-save | Editor interval | BufWritePost detected |\n| JJ auto-snapshot | On save | BufWritePost triggers |\n| Pinch-to-zoom | Trackpad gesture | N/A (terminal font) |\n| Line numbers | Editor gutter | `set number` |\n| Current line | Editor feature | `cursorline` |\n| Bracket matching | Editor feature | `matchparen` |\n| Find/replace | Command palette | `/` and `:%s` |\n| Undo/redo | Editor stack | Undo tree |\n\n**Loading:** skeleton lines shimmer pulse 0.8s autoreverse\n\n#### B) Terminal (Ghostty)\n\nFull terminal, tab title updates live; Same scrollbar overlay; Smooth scrolling velocity + grid snap; Link detection Cmd+Click URLs + workspace-relative file paths open editor\n\n#### C) Diff viewer\n\nStandalone for IDE tabs, chat sheets, inline cards\n\n**Header 32pt:** left filename 13pt medium + `+N ‚àíM` mono success/danger, right hunk arrows up/down + counter &quot;3/12&quot;, &quot;Open in Tab&quot; if inline/sheet\n\n**Content:** Syntax highlighting within diffs ‚Äî added/removed retain TreeSitter syntax under tint; Line bg: additions `success@12%`, deletions `danger@12%`, hunks `@@` `accent@8%` bg `info` text, context no tint; Line numbers dual gutter (old | new) mono 10pt tertiary; Long lines h-scroll (no wrap default)\n\n**Controls (toolbar trailing):** Wrap toggle (icon `text.word.spacing`), Compact toggle (hides context, icon `arrow.up.and.down.text.horizontal`), Full-screen (fills area, hides sidebar/tabs, Esc or button)\n\n**Keyboard:** `]c` / `[c` vim-style next/prev hunk; Arrows Up/Down scroll; Cmd+Up/Down next/prev file (multi-file)\n\n**Sources:** AI changes (Codex), JJ working copy diffs, JJ change-to-change, session diffs, manual `smithers-ctl diff show`\n\n**Multi-file:** left sidebar 200pt file list `+N ‚àíM` per-file; Click scrolls diff pane to file section; Order: modified &gt; added &gt; deleted\n\n#### D) Webview\n\n`WKWebView` title observation, tab uses page title; Back/forward hidden default (reduce noise, accessible via palette/context)\n\n---\n\n## 6.4 Status bar\n\n22pt, `surface2`, top divider 1px\n\nLeft: `Ln X, Col Y | UTF-8 | LF` mono 10pt secondary; Center: Skills &quot;Skills: a, b +N&quot; (click popover); Right: `Language | Spaces: 4` 10pt secondary\n\n**Additional indicators:**\n\n- **Neovim mode** (left after line/col): badge shows vim mode ‚Äî NORMAL `accent@15%` bg accent text, INSERT `success@15%` success text, VISUAL `warning@15%` warning text, COMMAND `info@15%` info text\n- **Tmux prefix** (left): &quot;PREFIX&quot; badge `accent@20%` bg when Ctrl+A pressed awaiting follow-up, auto-dismiss 1s\n\n---\n\n## 6.5 Neovim mode\n\nMajor feature ‚Äî many users spend most time here. When enabled, STTextView replaced by Ghostty terminal running embedded Neovim with full UI extensions.\n\n### 6.5.1 Activation\n\nToggle Cmd+Shift+N (global both windows); Switches `CodeEditorView` ‚Üî `NvimTerminalView`; File state (cursor, unsaved) preserved across transitions; Persisted per-workspace\n\n### 6.5.2 Architecture\n\n1. `NvimController` creates Unix socket `/tmp/smithers-nvim-&lt;uuid&gt;.sock`\n2. Launches Neovim hidden Ghostty terminal `--listen &lt;socket&gt;`\n3. Connects retry (10 attempts, 100ms backoff)\n4. Attaches UI extensions: `ext_multigrid`, `ext_cmdline`, `ext_popupmenu`, `ext_messages`, `ext_hlstate`\n5. Installs autocmds `BufEnter`/`BufLeave`/`BufWritePost` track file changes\n6. Starts notification loop handle events\n\n### 6.5.3 Bidirectional sync\n\n- User selects file sidebar ‚Üí NvimController `:edit &lt;path&gt;` RPC, Neovim opens\n- User opens file Neovim ‚Üí `BufEnter` autocmd ‚Üí update `TabModel` (ensure tab exists/selected) + `EditorStateModel`\n- User saves Neovim ‚Üí `BufWritePost` ‚Üí mark clean tab model, triggers JJ auto-snapshot (2s debounce same as editor)\n- Tab model changes ‚Üí switch tabs bar click/keyboard ‚Üí NvimController `:edit &lt;path&gt;` sync\n- File tree, terminal, tab model coordinate with NvimController as source of truth active file Neovim mode\n\n### 6.5.4 External UI overlays\n\nNeovim ext_ui render native SwiftUI overlays on terminal (not in char grid)\n\n**Cmdline (`NvimCmdlineOverlay`):** bottom editor area above status, `surface2` radius 8 1px `border`, shows current cmdline (`:` `/` `?` `!`), mono same font editor, cursor visible blinking, dismisses on exec/cancel\n\n**Popup menu (`NvimPopupMenuOverlay`):** anchored cursor position, `surface2` radius 8 shadow, completion candidates Neovim native; Rows icon (type) + text + detail (secondary trailing); Selected `accent@12%`; Max 10 rows scrollable; Arrows + Enter/Esc\n\n**Message (`NvimMessageOverlay`):** floating notifications top-right editor; Max 6 visible, oldest auto-expire 4s; `surface2` radius 8 shadow; Levels ‚Üí colors: error danger, warning warning, info/echo primary; Slide-in right, fade-out dismiss\n\n**Floating windows (`NvimFloatingWindowView`):** plugin floats (hover docs, signature help); Native views on terminal; Configurable: blur 0‚Äì30pt (pref default 10), shadow 0‚Äì30pt (pref default 8), corner radius 0‚Äì20pt (pref default 8); Bg `surface2` blur vibrancy, border 1px `border`\n\n### 6.5.5 Theme sync\n\nNeovim mode reads highlight groups derives `AppTheme`: `Normal.bg` ‚Üí `background`, `Normal.fg` ‚Üí `foreground`, `Visual.bg` ‚Üí `selectionBackground`, `CursorLine.bg` ‚Üí `lineHighlight`, `TabLine*` ‚Üí tab bars, `Pmenu*` ‚Üí popup/panels, `LineNr`/`CursorLineNr` ‚Üí line numbers; Missing derived via alpha blend bg+fg\n\nOverrides app theme while active, reverts on deactivate\n\n### 6.5.6 Mode indicator\n\nStatus bar (6.4) + cursor shape changes mode: bar (insert), block (normal), underline (replace) ‚Äî Ghostty handles via escape sequences; Real-time updates\n\n### 6.5.7 Input method (CJK)\n\n**Critical CJK.** `InputMethodSwitcher` auto: switches ASCII-capable input source entering normal mode (so j/k/dd work without IME), restores previous input source entering insert mode (type native language); Automatic no config\n\n### 6.5.8 Crash recovery\n\nIf Neovim dies, `NvimRecoveryView` instead silent fail: centered editor area, `surface1` bg; Warning icon large `color.warning`, title &quot;Neovim crashed unexpectedly&quot;, subtitle crash type (startup/runtime/unexpected exit); Actions: Restart Neovim (PrimaryButton ‚Äî attempts restart full state restoration same files/positions), Disable Neovim Mode (secondary ‚Äî switches standard editor preserves files), Reveal Crash Report (tertiary link ‚Äî opens Finder `~/Library/Application Support/Smithers/Nvim/Reports/`)\n\nCrash report: captures logs, workspace state, open files, last RPC messages ‚Üí `~/Library/Application Support/Smithers/Nvim/Reports/`; Neovim logs ‚Üí `~/Library/Application Support/Smithers/Nvim/Logs/`\n\n### 6.5.9 Settings\n\nNeovim category in Preferences:\n\n- Nvim binary path: text field + file picker, validates working `nvim`, default system PATH\n- Option-as-Meta: dropdown Left/Right/Both/None, controls Option‚ÜíMeta terminal (same as Terminal prefs)\n- Floating window blur: toggle + slider 0‚Äì30pt\n- Floating window shadow: toggle + slider 0‚Äì30pt\n- Floating window corner radius: slider 0‚Äì20pt\n\n# Overlays &amp; Panels\n\n## 7) Overlays &amp; panels\n\n### 7.1 Command palette (Cmd+P)\n\nIDE-only overlay (callable globally, see shortcuts)\n\nScrim `black@35%`; Panel: width 420‚Äì680px (65% window max 680), height 320‚Äì460px (55% window max 460), radius 10, `surface2`, shadow overlay spec\n\nLayout two-pane: left results list, right preview (first 20 lines, 8KB)\n\nModes: default file search, command mode prefix `&gt;` search commands\n\nKeys: Up/Down navigate, Enter open, Esc dismiss\n\nAnimation: appear scale 0.97 + opacity spring (0.25s bounce 0.15), dismiss 0.15s ease-in\n\n### 7.2 Search panel (Cmd+Shift+F)\n\nTop-anchored slide-down (IDE); Width 55% max 560px, height 65% max 520px, `surface2`, slide + opacity animation\n\n**Input row (HStack):** text field fills placeholder &quot;Search in files...&quot;, regex toggle (icon `.*` ‚Äî active accent bg), case-sensitive toggle (icon `Aa` ‚Äî active accent bg), close button trailing\n\n**Results area (two-pane):**\n\nLeft results list (grouped by file): file header icon + filename + match count badge (&quot;12 matches&quot;), match rows indented line number tertiary + highlighted match text + context; Click match opens file at line highlights match; Keys arrows navigate Enter opens\n\nRight preview pane: ~10 lines context around selected match, match highlighted `accent@20%`, syntax TreeSitter, file path + line number top\n\n**Summary bar (bottom):** &quot;N results in M files&quot; 11pt secondary, search time &quot;0.12s&quot;\n\nBackend ripgrep fast workspace search, respects `.gitignore`/`.jj/ignore`\n\n### 7.3 Toast notifications\n\nBottom-center above status bar (IDE) or composer (Chat); Auto dismiss 2‚Äì3s, slide up + fade, `surface2` radius 10\n\n### 7.4 Progress bar\n\nTop edge window; Height default 3pt (1‚Äì8 configurable), track `white@6%`, fill accent, auto-hide 0.45s after complete\n\n### 7.5 Keyboard shortcuts panel (Cmd+/)\n\nRight-side slide-in; Width 260‚Äì320pt, `surface2`, search field top, sections grouped by category\n\n### 7.6 Skills system\n\nSkills = reusable AI instruction packages (plugins) extend agent capabilities. Each skill = `SKILL.md` YAML frontmatter + markdown body.\n\n#### Skill discovery\n\nScanned priority order:\n\n1. `&lt;workspace&gt;/.agents/skills/` ‚Äî project-scoped (checked into repo)\n2. `~/.agents/skills/` ‚Äî user-scoped (personal cross-project)\n3. `/etc/codex/skills/` ‚Äî admin-scoped (organization-wide)\n4. `$CODEX_HOME/skills/.system/` ‚Äî system-scoped (bundled defaults)\n\nEach `SKILL.md` YAML frontmatter:\n\n```yaml\n---\nname: react-component\ndescription: Generate React components following project conventions\nauthor: team\nversion: 1.0.0\ntags: [react, frontend, components]\nallowedTools: [read_file, write_file, run_terminal]\nargumentHints: [component name, props interface]\n---\n```\n\nMarkdown body = AI instruction set, injected agent context when skill activated\n\n#### Skill activation\n\nPer-chat-session (not global); Active skills injected AI context system instructions; Invocation explicit (`$skill-name` composer) or implicit (AI recognizes relevant); Status bar shows active skills (6.4)\n\n#### Skill modals\n\nAvailable either window, presented sheets active window (radius 16 padding 16 `surface2`)\n\n**Skill Browser (`SkillBrowserView`):** search field top (filters name/description/tags), grid/list available skills remote registry; Each card: name, description, author, tags, install button; Installed show &quot;Installed&quot; badge\n\n**Skill List (`SkillListView`):** all installed grouped scope (Project/User/Admin/System); Each row: name, scope badge, description preview; Trailing toggle switch active/inactive current session; Context: Reveal Finder, Edit, Uninstall\n\n**Skill Detail (`SkillDetailView`):** full metadata (name, description, author, version, tags, allowed tools), instructions preview markdown scrollable; Actions: Activate, Edit, Uninstall\n\n**Create Skill Wizard (`CreateSkillWizardView`):** multi-step: 1) Name &amp; description text fields, 2) Scope (Project/User), 3) Allowed tools checkbox list, 4) Instructions markdown editor, 5) Review &amp; create preview + save; Optional `CodebaseAnalyzer` suggests templates based detected language/framework\n\n**Skill Use popover (composer):** triggered Sparkles button composer footer; Shows installed skills toggles activate/deactivate current session; Quick filter name; &quot;Browse Skills&quot; link opens full Browser\n\n# Cross-Window Workflow Rules\n\n## 8) Cross-window workflow\n\n### 8.1 &quot;Open in Editor&quot; contract\n\n`showInEditor(fileURL, line?, column?, highlightRange?)`\n\n1. Ensure IDE visible\n2. Ensure file tab open (or reuse)\n3. Select tab\n4. Scroll to line/col (0.2s ease-in-out)\n5. Pulse highlight `white@10%` on line 0.6s fade\n\n### 8.2 AI file changes\n\n1. Chat receives Diff Preview Card\n2. If `autoOpenIDEOnFileChange == true`: IDE opens + focuses first changed file (or diff tab); Chat remains front unless &quot;Focus editor on change&quot; enabled (default false)\n3. JJ snapshot created\n4. Message hover allows revert/rollback\n\n# Settings / Preferences Window\n\n## 9) Settings\n\nStandard macOS Settings window with sidebar list of categories.\n\n### Categories\n\n**Appearance:** Theme Dark/Light/System; Window transparency toggle + opacity slider 70‚Äì100%\n\n**Editor:** Font name, size 8‚Äì48; Ligatures; Line spacing, char spacing; Cursor shape bar/block/underline\n\n**Display:** Line numbers, current line highlight, indent guides, minimap, scrollbar mode\n\n**Terminal:** Option-as-Meta left/right/both/none\n\n**Neovim:** Binary path; Floating window blur/radius/shadow\n\n**Behavior:** Close warnings; Auto-save toggle + interval; Auto-open IDE on AI file change (new, default on)\n\n**Updates:** Stable/Snapshot channel picker (if channels); &quot;Check for Updates...&quot; button; Auto-check on launch toggle\n\n### Sparkle auto-update\n\nUses **Sparkle** (`SPUStandardUpdaterController`) for auto-updates.\n\n- **Update channels:** Release (stable) vs. Snapshot (pre-release/nightly). Persisted UserDefaults. Changing channels switches appcast feed URL.\n- **Manual check:** &quot;Check for Updates...&quot; in menu bar icon menu + Preferences.\n- **Auto-check:** on app launch (configurable, default on). Non-intrusive notification when update available.\n- **Feed URL:** configured per-channel Info.plist. Snapshot may include pre-release builds experimental features.\n- **Update flow:** standard Sparkle dialog ‚Äî shows release notes, &quot;Install Update&quot; / &quot;Remind Me Later&quot; / &quot;Skip This Version&quot;.\n\n# Keyboard Shortcuts\n\n## 10) Shortcuts\n\n### Global (both windows)\n\n| Shortcut | Action |\n|----------|--------|\n| ‚åòS | Save current file |\n| ‚åò‚áßS | Save all |\n| ‚åò‚áßO | Open folder |\n| ‚åòP | Go to file (opens IDE + palette if needed) |\n| ‚åò‚áßF | Search in files (opens IDE + search panel if needed) |\n| ‚åòK | Focus chat composer (any window) |\n| ‚åòQ | Quit Smithers (explicit, not window close) |\n\n### Chat window\n\n| Shortcut | Action |\n|----------|--------|\n| Return | Send (or Steer if agent running) |\n| Tab | Queue follow-up (if agent running) |\n| ‚áßReturn | New line |\n| ‚åòN | New chat |\n| ‚åòV | Paste image |\n| Esc | Interrupt (running) / defocus |\n| ‚åò‚Üë/‚åò‚Üì | Jump between messages |\n\n### IDE window\n\n| Shortcut | Action |\n|----------|--------|\n| ‚åòB | Toggle sidebar |\n| ‚åò` | New terminal |\n| ‚åò‚áßN | Toggle Neovim mode |\n| ‚åò/ | Toggle shortcuts panel |\n\n### Tmux-style prefix (Ctrl+A)\n\n`TmuxKeyHandler` monitors `NSEvent.addLocalMonitorForEvents`. Ctrl+A enters prefix mode awaits follow-up. **Critical TUI-native experience** ‚Äî tmux users expect identical keybindings.\n\n| Follow-up | Action |\n|-----------|--------|\n| c | New terminal |\n| n | Next tab |\n| p | Previous tab |\n| 1‚Äì9 | Select tab by index |\n| &amp; | Close current tab |\n| z | Toggle terminal zoom (full-pane) |\n| \\| | Split vertical |\n| - | Split horizontal |\n\nPrefix timeout 1s no follow-up cancels; &quot;PREFIX&quot; indicator status bar while active (6.4)\n\n**Terminal always one keystroke away:** Ctrl+A c opens terminal immediately any context, must feel instantaneous\n\n### TUI-native keyboard philosophy\n\nEvery core action achievable without mouse. Flow:\n\n- Ctrl+A c ‚Üí new terminal (always, any window)\n- Cmd+` ‚Üí new terminal (macOS-native alternative)\n- Cmd+P ‚Üí command palette (fuzzy find: files, commands, settings)\n- Cmd+K ‚Üí focus chat composer (any window)\n- Esc ‚Üí dismiss overlay / return previous context\n- Tab / Shift+Tab ‚Üí cycle panes within window\n\nGoal: user never touches mouse feels at home in Smithers\n\n# State Management, Animations, Responsive, Accessibility &amp; Implementation\n\n## 11) State management (shared across windows)\n\n### 11.1 Core model layers\n\nShared `AppModel` injected both window roots.\n\nRecommended structure:\n\n- `AppModel` (@Observable)\n  - `workspace: WorkspaceModel?`\n  - `preferences: PreferencesModel`\n  - `windowCoordinator: WindowCoordinator` (show/hide/focus IDE, routing)\n\n- `WorkspaceModel`\n  - `fileTreeModel`, `tabModel` (open tabs, selected), `editorModel` (per-file view state: scroll, selection), `chatModel` (sessions, selected, messages), `jjModel` (status/log/bookmarks/ops/snapshots), `agentModel` (orchestrator state), `skillsModel`\n  - `services`: `CodexService`, `JJService`, `SearchService`, etc.\n\n### 11.2 Window-local UI state\n\nEphemeral UI state per window:\n\n- `ChatWindowUIState`: sidebar mode, sidebar search query, message hover state, active action bar, composer draft + attachments\n- `IDEWindowUIState`: sidebar width/collapsed, active overlays (palette/search/shortcuts), command palette query + selection\n\nPersist only what improves &quot;return-to-work&quot;: window frames, open tabs + selected tab, editor per-file positions, selected chat session\n\n---\n\n## 12) Animations &amp; timing\n\nConsistent motion vocabulary (short, subtle).\n\n| Interaction | Duration | Curve |\n|-------------|----------|-------|\n| Chat message insert | 0.20s | ease-in-out |\n| Auto-scroll to bottom | 0.20s | ease-out |\n| Hover action bar appear | 0.15s delay + 0.12s fade | ease-out |\n| Folder disclosure rotate | 0.15s | ease-in-out |\n| Command palette appear | 0.25s | spring (bounce 0.15) |\n| Search panel slide | 0.20s | ease-in-out |\n| Toast appear | 0.25s | ease-out |\n| Toast dismiss | 0.15s | ease-in |\n| Progress bar value | 0.20s | ease-in-out |\n| Editor jump-to-line | 0.20s | ease-in-out |\n| Cursor blink | 0.53s interval | linear fade 0.22s |\n\n---\n\n## 13) Responsive behavior\n\n### Chat window\n\nSidebar min 200pt; collapses entirely below window width 680pt; Detail content: message bubble max 80‚Äì90% (lines not too long), composer sticks bottom always\n\n### IDE window\n\nSidebar collapsible: toggle ‚åòB, auto-collapse if window &lt;720pt wide (optional); Tab bar: if narrow hide subtitles, icons + filename only\n\n---\n\n## 14) Accessibility\n\nEvery interactive element: accessibility label, identifier (UI tests), tooltip via `.help()`\n\nFull keyboard nav: sidebar lists arrows + Enter select, command palette arrows + Enter, chat Cmd+Up/Down jump messages (optional recommended)\n\nVoiceOver: message bubbles grouped; action bar buttons explicit labels (&quot;Copy message&quot;, &quot;Fork from here&quot;, etc.)\n\n---\n\n## Implementation notes (non-visual, critical)\n\n**Chat rendering** highly optimized: `LazyVStack`, avoid reflow on streaming by appending attributed runs rather rerendering entire markdown tree each delta\n\n**File tree** virtualized lazy-loaded as already done\n\nCentralize tokens in `AppTheme`/`ThemeTokens`, never hardcode colors in views\n\n### Image storage &amp; management\n\nChat images (pasted/dropped/attached) stored disk, not inline database:\n\n- **Storage:** `~/Library/Application Support/Smithers/images/&lt;hash&gt;` ‚Äî content-addressed by hash\n- **Database ref:** `images` table stores `(id, message_id, filename, data_hash)`, hash references file on disk\n- **Thumbnails:** generated 56√ó56 for attachment strip + chat display, cached memory\n- **Full-size viewer:** clicking thumbnail opens fullscreen overlay (5.4.2)\n- **Cleanup:** unused images (not referenced any message) **pruned periodically** app launch or workspace close, prevents disk bloat deleted messages\n- **Size limits:** individual 20MB cap, total 1GB per workspace (configurable), oldest pruned when limit reached\n\n### Commit style detection\n\n`CommitStyleDetector` analyzes last 30 commits `jjService.log(limit: 30)` detects team conventions:\n\n- **Conventional commits:** `type(scope): description` (e.g., `feat(auth): add OAuth login`)\n- **Emoji prefixes:** messages starting emoji (e.g., `‚ú® Add new feature`)\n- **Freeform:** no consistent pattern detected\n\nDetected style used by AI generating commit descriptions (JJ panel &quot;Describe&quot; action or automatic snapshot descriptions). Ensures AI messages match team conventions without manual config.\n\n### IPC server &amp; smithers-ctl CLI\n\nSmithers runs **Unix socket IPC server** `~/Library/Application Support/Smithers/smithers.sock` (or `/tmp/smithers.sock`) for external tools.\n\n**`smithers-ctl` CLI commands:**\n\n| Command | Description |\n|---------|-------------|\n| `smithers-ctl open-file &lt;path&gt; [+line:col]` | Open file at location (vim-style `+line:col`) |\n| `smithers-ctl terminal [run] &lt;command&gt;` | Open terminal, optionally run command |\n| `smithers-ctl search &lt;query&gt;` | Trigger workspace search |\n| `smithers-ctl diff show` | Open diff viewer with piped diff content |\n| `smithers-ctl webview open &lt;url&gt;` | Open URL in webview tab |\n| `smithers-ctl webview eval &lt;js&gt;` | Execute JavaScript in active webview |\n| `smithers-ctl agent spawn &lt;task&gt;` | Spawn new sub-agent |\n| `smithers-ctl agent cancel &lt;id&gt;` | Cancel running agent |\n| `smithers-ctl agent status [id]` | Get agent status |\n| `smithers-ctl jj status` | Get JJ status |\n| `smithers-ctl status` | Get app/workspace status |\n| `smithers-ctl read &lt;path&gt;` | Read file contents |\n| `smithers-ctl write &lt;path&gt;` | Write file contents from stdin |\n| `smithers-ctl set &lt;key&gt; &lt;value&gt;` | Change setting |\n\n**Wait-for-close:** `smithers-ctl open-file --wait` blocks until file closed editor. Useful `$EDITOR` integration (e.g., `export EDITOR=&quot;smithers-ctl open-file --wait&quot;`)\n\n**Unified capability surface:** CLI provides same capabilities as command palette + MCP server. Adding capability to one surface must add to all three (see engineering spec capability matrix)\n\n## Engineering Specification\n\n# Goals &amp; Constraints\n\n## 1.1 What v2 Solves\n\nv1 has single 7,100-line `WorkspaceState` god object owning all state (files, editor, chat, terminals, VCS, themes, search, UI chrome). 2,500-line `ContentView` contains editor `NSViewRepresentable`, tab bar, breadcrumbs, status bar, overlays. One target, no module boundaries ‚Üí theme change recompiles entire app.\n\nv2 fixes:\n\n1. **Files split for findability, not isolation** ‚Äî NOT eliminating god object. Single centralized state tree (Flux-style) = fine, desirable. Fix: v1&#x27;s 7,100-line files. v2 splits code into smaller domain-organized files. Xcode project with a flat dependency graph ‚Äî no complex DAG. File needs import ‚Üí import it. Don&#x27;t overcomplicate.\n\n2. **Composed state model** ‚Äî Instead of massive class holding everything, top-level `AppModel` contains smaller sub-models: `ChatModel` (msgs/sessions), `FileTreeModel` (browser), `TabModel` (editor tabs), etc. Each ~100-250 lines, owns one domain. Navigable ‚Äî understand chat ‚Üí read `ChatModel`, not 7,000-line file. Compose into single god object (`AppModel`) ‚Äî by design.\n\n3. **Chrome DevTools window arch** ‚Äî Main chat = &quot;pane 0&quot; (always present; closing hides to menu bar, does NOT quit). MVP uses two windows (chat + single workspace panel). Architecture should expand to multiple workspace panels later. Everything = tabs. Secondary window shows editor/terminal/diff/chat tabs. Windows positioned/resized/managed independently, share data via model layer.\n\n4. **Workspace-optional** ‚Äî Works without workspace. Launch ‚Üí just chat, no folder needed. Create/open workspace via main agent or Cmd+Shift+O. Usually users open in workspace dir.\n\n5. **Zig as logic layer (libghostty model)** ‚Äî Ideal arch = libghostty pattern: Zig lib (`libsmithers`) handles business logic, Swift = thin UI syncing with it. Zig = source of truth (state, subprocess mgmt, agent orchestration, protocols). Swift observes Zig state, renders UI. Evaluated case-by-case ‚Äî some stays Swift (UI-adjacent: scroll positions, animation), but default direction = push to Zig. Key reason: **cross-platform portability**. Smithers on Linux eventually ‚Üí Zig core unchanged, only UI replatformed. See 2.6 for Zig ‚Üî Swift arch.\n\n6. **Testability** ‚Äî Models/services in own files with clear boundaries ‚Üí unit tests run instantly with `swift test` (no simulator, no Xcode). Zig logic tested with `zig build test`. v1: testing service = import entire app.\n\n## 1.2 Hard Constraints\n\n### macOS 14+ (Sonoma) + `@Observable` Macro\n\nTarget macOS 14 (Sonoma) min. Important: macOS 14 introduced **Observation framework** with `@Observable` macro ‚Äî fundamentally better than old approach.\n\n**Background ‚Äî SwiftUI updates:**\n\nSwiftUI = declarative. Describe UI given data, SwiftUI figures out changes, re-renders affected parts. Critical: how does SwiftUI know data changed?\n\n**Old way (v1): `ObservableObject` + `@Published` (Combine)**\n\n```swift\nclass WorkspaceState: ObservableObject {\n    @Published var editorText: String = &quot;&quot;\n    @Published var chatMessages: [ChatMessage] = []\n    @Published var selectedFileURL: URL?\n    // ... 100+ @Published properties\n}\n```\n\nProblem: when ANY `@Published` changes, SwiftUI re-evaluates EVERY view observing object. `chatMessages` changes ‚Üí editor (only reads `editorText`) still re-evaluated. 100+ published props on one object = constant unnecessary work.\n\n**New way (v2): `@Observable` macro (Observation framework)**\n\n```swift\n@Observable\nclass WorkspaceModel {\n    var editorText: String = &quot;&quot;\n    var chatMessages: [ChatMessage] = []\n    var selectedFileURL: URL?\n}\n```\n\n`@Observable` ‚Üí SwiftUI tracks which specific props each view reads during last render. View only reads `editorText` ‚Üí ONLY re-renders when `editorText` changes, not `chatMessages`. *Fine-grained observation* ‚Äî dramatically more efficient.\n\nSimpler syntax: no `@Published` wrapper, just plain `var`. `@Observable` macro generates tracking at compile time.\n\n### Other Constraints\n\n- **Same features as v1:** editor with TreeSitter syntax, Ghostty terminal, Neovim modal editing, JJ version control, Codex AI chat, skills plugins, agent orchestration (parallel AI workers), command palette, workspace search, diff viewer.\n- **JJ bundled.** `jj` binary built + included in `.app` bundle. Users don&#x27;t install separately ‚Äî Smithers ships it. Hard dependency: agent orchestration, snapshot system, VCS UI all depend on jj.\n- **TUI-native interaction.** Native GUI must feel familiar to TUI users: terminal one keystroke away (Ctrl+A c or Cmd+`), Neovim mode for editing, all actions have keyboard shortcuts, Tmux-compat prefix keys, no mouse required for core workflows. GUI adds value via visual diff review, multi-agent dashboards, quad-pane layouts, parallel workspace mgmt ‚Äî not replacing terminal.\n- **Native macOS:** Standard window chrome (traffic lights), standard keyboard shortcuts (Cmd+S, Cmd+C, etc.), proper window mgmt (resize, minimize, fullscreen), focus rings, right-click context menus, drag-drop.\n- **Bundled binaries (shipped inside `.app`):**\n  - **GhosttyKit** ‚Äî Terminal = C lib (Zig, compiled to C-compat framework). Pre-built `.xcframework` (Apple format for pre-compiled libs). Swift calls Ghostty C functions via C interop (FFI).\n  - **codex-app-server** ‚Äî Small fork of OpenAI Codex (Rust binary, git submodule in EVMTS org). Fork wraps Codex in **Zig API** ‚Äî ONLY thing it does. libsmithers calls Zig API directly (no JSON-RPC, no child process). Storage handlers (SQLite) passed as callbacks. Built from source by `build.zig`, linked as static lib into libsmithers.\n  - **jj** ‚Äî Jujutsu VCS binary. Pre-built, copied into `Contents/MacOS/` during build. Located at runtime via `Bundle.main.path(forAuxiliaryExecutable: &quot;jj&quot;)`. JJService always uses bundled binary, never user&#x27;s PATH version.\n\n## 1.3 Non-Goals\n\nExplicitly NOT doing in v2 (scope mgmt):\n\n- **Cross-platform (iOS, Linux) ‚Äî deferred, not abandoned.** v2 ships macOS-only. SwiftUI technically supports iOS, but heavy AppKit interop (native macOS UI framework) for editor/terminal has no iOS equivalent. **However**, cross-platform (esp Linux) = explicit future goal. Why libsmithers in Zig ‚Äî Zig core fully portable. Smithers on Linux ‚Üí only UI replatformed; entire Zig business logic unchanged. Architect libsmithers with portability in mind.\n- **Rewriting Ghostty or Neovim.** Wrap as black boxes. Manage lifecycle (start, stop, communicate), don&#x27;t modify internals. (Note: codex-app-server IS forked ‚Äî only for Zig API wrapper + storage callbacks. Codex internals not rewritten.)\n- **LSP integration (Language Server Protocol).** Powers &quot;go to definition&quot;, &quot;find references&quot;, rich autocompletion in VS Code. Deferred to v2.1+ ‚Äî large subsystem, can be added non-disruptively later.\n- **Native git support.** Use jj exclusively. jj &quot;colocated&quot; mode maintains `.git` alongside `.jj` ‚Üí users can `git push`/`pull` through jj. No separate git integration needed.\n- **Custom font bundling.** Use system monospace (SF Mono on macOS) + system UI font (SF Pro). No font files shipped.\n\n## 1.3.1 Features from Issues Directory\n\n`issues/` contains feature specs from v1 arch. **Take feature descriptions literally, NOT implementation details** ‚Äî stale, based on old arch. v2 impl follows this spec.\n\n**MVP features (from issues):**\n- **007** ‚Äî Background + scheduled agents (tab-based agents, cron schedules)\n- **004** ‚Äî Claude Code / OpenCode integration (multiple agent backends, not just Codex)\n\n**Post-MVP:**\n- **038** ‚Äî Multi-workspace + Conductor parity (workspace switcher, cross-workspace search)\n- **039** ‚Äî Workflow Studio (Bun workflow engine, AI-powered workflow creation)\n- **020** ‚Äî Workspace tools sidebar panels (buffer list, markdown preview, search results)\n- **013** ‚Äî MiniApps (local-first web apps with JS bridge to Smithers SDK)\n- **010** ‚Äî Telegram agent bridge (mobile access to coding agents)\n- **033** ‚Äî Remote development (SSH/TCP Neovim sessions)\n\n**Explicitly NOT MVP:**\n- JJ merge queue UI (agent work merges via simple jj ops, no dedicated queue view)\n- MiniApps\n- Multi-workspace\n- Remote development\n\n## 1.4 Key Terminology\n\n| Term | Meaning |\n|------|---------|\n| **SwiftUI** | Apple&#x27;s declarative UI framework (React for macOS/iOS). Describe views as function of state, framework handles render/updates. |\n| **AppKit** | Older imperative macOS UI framework. Needed for things SwiftUI can&#x27;t do well (custom text editors, terminal rendering). SwiftUI embeds AppKit via `NSViewRepresentable`. |\n| **NSViewRepresentable** | SwiftUI protocol wrapping AppKit `NSView` for use in SwiftUI layouts. `Coordinator` object = bridge between SwiftUI declarative world + AppKit delegate-based world. |\n| **NSWindow** | Native macOS window object. Each on-screen window = one `NSWindow`. Two: main chat (pane 0), workspace panel. Tabs can detach into additional windows. |\n| **@MainActor** | Swift annotation ensuring code runs on main thread (UI thread). All UI updates on main thread. Background work (file I/O, network, process spawn) on other threads, dispatch results to `@MainActor`. |\n| **async/await** | Swift structured concurrency. `async` functions can pause (e.g., wait for network) without blocking thread. `await` marks pause point. `Task { }` creates concurrent work unit. `Task.detached { }` creates one not inheriting current actor context (for blocking work off main thread). |\n| **SPM (Swift Package Manager)** | Swift&#x27;s built-in dependency mgr + build system (like npm/cargo). Config via `Package.swift`. Defines targets (libs/executables), source dirs, dependencies on other targets/external packages. |\n| **xcodegen** | Generates Xcode project files (`.xcodeproj`) from YAML config (`project.yml`). Needed because SPM alone can&#x27;t define XCUITest targets (Apple&#x27;s UI testing requires Xcode project). |\n| **xcframework** | Apple format for distributing pre-compiled libs across architectures (Intel + Apple Silicon). GhosttyKit distributed this way. |\n| **TreeSitter** | Parser generator producing fast, incremental parsers. Syntax highlighting ‚Äî parses code into syntax tree, map nodes to colors. Each language (Swift, Python, JS, etc.) has own TreeSitter grammar. |\n| **FFI (Foreign Function Interface)** | Calling functions written in one language from another. Call Ghostty C functions from Swift, Neovim MessagePack RPC from Swift. |\n| **JSON-RPC** | Protocol for remote procedure calls using JSON. For communication with secondary agent backends (Claude Code, OpenCode). Primary Codex integration = in-process via Zig API (no JSON-RPC). |\n| **MessagePack RPC** | Like JSON-RPC but uses MessagePack (binary serialization, like compressed JSON) instead of text JSON. Neovim&#x27;s native protocol. |\n| **Sendable** | Swift protocol marking type as safe to pass between concurrent threads. Value types (structs, enums) usually auto-Sendable. Ref types (classes) need explicit thread-safety. |\n| **UserDefaults** | macOS built-in key-value storage for app preferences. Simple, persistent across launches, only for small data (settings, window positions). Not for large data (chat history). |\n| **libsmithers** | Zig core lib. Contains business logic, agent orchestration, protocol handling. Swift calls via C FFI. Follows libghostty pattern. |\n| **Zig** | Systems programming language with no runtime, no GC, C-compatible ABI. Portable logic layer (like libghostty). Compiles to any target ‚Üí future cross-platform support. |\n| **C FFI** | Interface between Swift + Zig. Zig exposes C-compat functions Swift calls directly. State change notifications via callback function pointers with opaque `userdata` pointers (GhosttyKit pattern). |\n| **Orchestrator** | Main chat&#x27;s role. Answers simple questions directly (via MCP tools to read state), primarily delegates work tasks to sub-agents. Has full app state context, coordinates everything. All async ‚Äî delegate fast, respond immediately, process results as they come. |\n| **Sub-agent** | Ephemeral CodexService instance spawned by orchestrator for specific task. Appears as `.chat` tab in workspace panel. Has own jj workspace branch. |\n\n## 2. Repository &amp; Build\n\n### 2.1 Structure\n\n```\nsmithers/\n‚îú‚îÄ‚îÄ build.zig                  # THE makefile: Zig core, vendored C, Rust subs (Codex, JJ), xcframework, Swift, web\n‚îú‚îÄ‚îÄ build.zig.zon              # Zig package manifest\n‚îú‚îÄ‚îÄ AGENTS.md / CLAUDE.md      # Agent / Claude Code instructions\n‚îú‚îÄ‚îÄ docs/{design,engineering}.md\n‚îú‚îÄ‚îÄ issues/                    # Post-MVP feature specs\n‚îú‚îÄ‚îÄ prototype1/                # Next.js UI reference (frozen)\n‚îú‚îÄ‚îÄ include/libsmithers.h      # C API header ‚Äî THE Zig‚ÜîSwift contract\n‚îú‚îÄ‚îÄ src/                       # Zig (libsmithers logic)\n‚îÇ   ‚îú‚îÄ‚îÄ lib.zig               # Root: C API exports\n‚îÇ   ‚îú‚îÄ‚îÄ orchestrator.zig, agent.zig, codex_client.zig, jj.zig, search.zig\n‚îÇ   ‚îú‚îÄ‚îÄ file_watcher.zig, chat_state.zig, snapshot.zig, suggestion.zig\n‚îÇ   ‚îú‚îÄ‚îÄ ipc.zig, mcp_server.zig, http_server.zig, scheduler.zig\n‚îÇ   ‚îú‚îÄ‚îÄ storage.zig, memory.zig\n‚îÇ   ‚îî‚îÄ‚îÄ models/               # Zig structs ‚Üí C structs ‚Üí Swift\n‚îú‚îÄ‚îÄ pkg/                       # Vendored C/C++ + Zig wrappers\n‚îÇ   ‚îú‚îÄ‚îÄ sqlite/, zap/, tree-sitter/grammars/, macos/\n‚îú‚îÄ‚îÄ submodules/                # Git subs (Rust forks + Zig wrappers)\n‚îÇ   ‚îú‚îÄ‚îÄ codex/                # EVMTS fork: cargo ‚Üí static lib ‚Üí Zig API\n‚îÇ   ‚îî‚îÄ‚îÄ jj/                   # EVMTS fork: no code changes, Zig build wrapper\n‚îú‚îÄ‚îÄ macos/                     # Swift app (Ghostty pattern)\n‚îÇ   ‚îú‚îÄ‚îÄ Smithers.xcodeproj/   # Real Xcode (no Package.swift, no xcodegen)\n‚îÇ   ‚îú‚îÄ‚îÄ Smithers-Info.plist, Smithers.entitlements\n‚îÇ   ‚îú‚îÄ‚îÄ SmithersKit.xcframework/, GhosttyKit.xcframework/\n‚îÇ   ‚îú‚îÄ‚îÄ Assets.xcassets/\n‚îÇ   ‚îú‚îÄ‚îÄ Sources/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App/              # Entry, scenes, window coord\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Ghostty/SmithersCore.swift  # C FFI bridge\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Features/         # Chat, IDE, Terminal, Editor, Neovim, Agents, Skills, Settings, Command Palette, Search, Update\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Helpers/{Extensions, DesignSystem}\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Services/         # Thin over libsmithers C API\n‚îÇ   ‚îú‚îÄ‚îÄ Tests/, SmithersUITests/\n‚îú‚îÄ‚îÄ web/                       # SolidJS parallel app\n‚îÇ   ‚îú‚îÄ‚îÄ package.json          # SolidJS + shadcn-solid + Tailwind + Monaco\n‚îÇ   ‚îú‚îÄ‚îÄ src/{index.tsx, components/, features/, lib/, styles/}\n‚îî‚îÄ‚îÄ dist/                      # Packaging, signing\n```\n\n**Mirrors Ghostty:** `src/` Zig, `pkg/` vendored C + Zig wrappers, `include/` C API, `macos/` Swift + real Xcode, `build.zig` THE makefile, `submodules/` Rust forks, `web/` SolidJS (talks HTTP), feature-based `macos/Sources/Features/`.\n\n**No Package.Swift.** Real Xcode. SPM via Xcode (Sparkle, STTextView, GRDB.swift) ‚Äî Ghostty approach.\n\n**Vendor + Zig wrap:** C/C++ ‚Üí `pkg/` + Zig wrappers (SQLite, Zap/facil.io, TreeSitter). Rust ‚Üí `submodules/` forks + Zig wrappers calling `cargo build` (EVMTS org). Swift ‚Üí Xcode SPM. Web ‚Üí npm/pnpm.\n\n**Pattern:** Every dep has `build.zig` wrapper ‚Üí target is `zig build dev` builds all from source once wired. Until then, use `zig build` / `zig build all`.\n\n**Zig‚ÜíSwift migration:** MVP starts more Swift (v1 is Swift, proven). `src/` Zig grows, `Services/` shrinks. `Ghostty/` Swift wrapper thins as logic migrates.\n\n**Feature-based:** `macos/Sources/Features/` ‚Äî views+models+VMs per feature, not by arch layer. Findable.\n\n### 2.2 Xcode (no Package.swift)\n\nGhostty approach: real `Smithers.xcodeproj`, no SPM app target. SPM via Xcode: Sparkle (binary xcframework), STTextView, GRDB.swift.\n\nTreeSitter vendored `pkg/tree-sitter/` ‚Äî core + all grammars (Swift, JS, TS, Python, JSON, Bash, Markdown, Zig, Rust, Go) with C + `highlights.scm`. Zig builds ‚Üí static lib ‚Üí Swift links via SmithersKit.xcframework.\n\nGhosttyKit, SmithersKit = xcframeworks pre-built by build systems ‚Üí `macos/`, Xcode refs as binary.\n\ncodex-app-server, jj = submodules built by `build.zig` (`cargo build`) ‚Üí copied to `.app` bundle.\n\n### 2.3 Xcode project\n\n`Smithers.xcodeproj`: Smithers app, SmithersTests, SmithersUITests. No xcodegen ‚Äî maintained direct (Ghostty).\n\n### 2.4 Build pipeline\n\n`build.zig` THE makefile ‚Äî dependency graph (Ghostty pattern):\n\n1. Build vendored C (`pkg/sqlite/`, `pkg/tree-sitter/`, etc.)\n2. Build Rust subs (`submodules/codex/build.zig` ‚Üí `cargo build --release` codex; same for jj)\n3. Build libsmithers (`src/` ‚Üí `.a`, link vendored, gen `include/libsmithers.h`)\n4. Package SmithersKit.xcframework (`.a` + header ‚Üí xcframework)\n5. Build macOS (`xcodebuild build -project macos/Smithers.xcodeproj -scheme Smithers`)\n6. Copy binaries (codex-app-server, jj ‚Üí `.app/Contents/MacOS/`)\n7. Build web (optional: `cd web &amp;&amp; pnpm install &amp;&amp; pnpm build`)\n8. Launch (`open .build/xcode/Build/Products/Debug/Smithers.app`)\n\n**Commands (current build.zig):** `zig build`, `zig build run`, `zig build test`, `zig build all`, `zig build fmt-check`, `zig build prettier-check`, `zig build typos-check`, `zig build shellcheck`.\n\n**Planned (add to build.zig):** `zig build dev` (1-8 full+launch), `zig build web`, `zig build playwright` (web+HTTP+e2e), `zig build codex`, `zig build jj`, `zig build xcode-test` (Swift tests), `zig build ui-test` (XCUITest).\n\n### 2.5 Binary integration\n\n**GhosttyKit.xcframework** ‚Äî pre-built C, `macos/GhosttyKit.xcframework`, Xcode binary ref, `import GhosttyKit`.\n\n**SmithersKit.xcframework** ‚Äî `build.zig` from `src/` Zig ‚Üí `libsmithers.a` + `include/libsmithers.h`.\n\n**codex-app-server (EVMTS fork)** ‚Äî small OpenAI Codex fork, EVMTS org submodule `submodules/codex/`. **Wraps Codex in Zig API.** Compiles static lib (not binary), Zig API libsmithers calls direct. Storage handlers as Zig callbacks ‚Üí `src/storage.zig` writes SQLite (Codex doesn&#x27;t know SQLite). Fork `build.zig` wraps `cargo build --release --lib` ‚Üí static ‚Üí Zig API. Build pipeline (via `zig build dev` once wired) builds+links. Minimal fork rebased upstream. **No child process, no JSON-RPC, no pipes** ‚Äî in-process linked lib.\n\n**jj (EVMTS fork)** ‚Äî Jujutsu fork EVMTS org `submodules/jj/`. **No code changes** ‚Äî just Zig `build.zig` wrapper. Build pipeline (via `zig build dev` once wired) builds jj binary, copies `.app/Contents/MacOS/`. No user PATH dep.\n\n**SQLite (vendored)** ‚Äî `pkg/sqlite/` + Zig wrapper. Used `src/storage.zig`. Separate from GRDB.swift (Swift layer). Both access same db WAL mode concurrent.\n\n### 2.6 Zig‚ÜîSwift (libsmithers model)\n\n**libghostty pattern:** Zig business logic, Swift thin UI syncs.\n\n**Why Zig:** Cross-platform (Zig unchanged, UI replatformed Linux/Windows). Performance (no runtime, no GC). Testability (`zig build test` no Apple deps).\n\n**Split:**\n| Layer | Lang | Responsibilities |\n|-------|------|------------------|\n| libsmithers (Zig) | Zig | Agent orchestration, codex protocol, jj ops, file watch, IPC, chat state, suggestion, search, snapshot. Source of truth. |\n| SmithersUI (Swift) | Swift/SwiftUI | Render, animations, AppKit (STTextView, Ghostty surface, NSWindow), input, a11y. Observes libsmithers ‚Üí renders. |\n\n**Communication (libghostty exact patterns):**\n\n**1. C header contract:**\n\n```c\n// include/libsmithers.h ‚Äî THE Zig‚ÜîSwift contract\n\n// Opaque (Swift never sees Zig internals)\ntypedef struct smithers_app_s* smithers_app_t;\ntypedef struct smithers_surface_s* smithers_surface_t;  // per-workspace\n\n// Lifecycle\nsmithers_app_t smithers_app_new(const smithers_config_t* config);\nvoid smithers_app_free(smithers_app_t app);\n\n// Actions (Swift‚ÜíZig intent dispatch) ‚Äî tagged union, one fn many types\ntypedef enum {\n    SMITHERS_ACTION_CHAT_SEND, SMITHERS_ACTION_WORKSPACE_OPEN,\n    SMITHERS_ACTION_WORKSPACE_CLOSE, SMITHERS_ACTION_AGENT_SPAWN,\n    SMITHERS_ACTION_AGENT_CANCEL, SMITHERS_ACTION_FILE_SAVE,\n    SMITHERS_ACTION_FILE_OPEN, SMITHERS_ACTION_SEARCH,\n    SMITHERS_ACTION_JJ_COMMIT, SMITHERS_ACTION_JJ_UNDO,\n    SMITHERS_ACTION_SETTINGS_CHANGE, SMITHERS_ACTION_SUGGESTION_REFRESH,\n    // ... grows\n} smithers_action_tag_e;\n\ntypedef union { /* per-action payloads */ } smithers_action_payload_u;\n\nvoid smithers_app_action(smithers_app_t app, smithers_action_tag_e tag,\n                         smithers_action_payload_u payload);\n\n// Callbacks (Zig‚ÜíSwift) ‚Äî ghostty: fn ptr + opaque userdata\ntypedef void (*smithers_wakeup_cb)(void* userdata);\ntypedef void (*smithers_action_cb)(void* userdata, smithers_action_tag_e tag,\n                                   const void* data, size_t len);\n\ntypedef struct {\n    smithers_wakeup_cb wakeup;       // &quot;changed, re-read&quot;\n    smithers_action_cb action;       // &quot;specific event&quot;\n    void* userdata;                  // Unmanaged&lt;App&gt;.toOpaque()\n} smithers_runtime_config_s;\n```\n\n**2. Zig exports (ghostty CAPI):**\n\n```zig\n// src/lib.zig\nconst App = @import(&quot;app.zig&quot;).App;\n\npub const CAPI = struct {\n    pub export fn smithers_app_new(config: *const c.smithers_config_t) callconv(.c) ?*App {\n        return App.init(config) catch null;\n    }\n    pub export fn smithers_app_free(app: *App) callconv(.c) void {\n        app.deinit();\n    }\n    pub export fn smithers_app_action(\n        app: *App, tag: c.smithers_action_tag_e, payload: c.smithers_action_payload_u,\n    ) callconv(.c) void {\n        app.performAction(tag, payload);\n    }\n};\n\n// Force export all CAPI symbols\ncomptime {\n    for (@typeInfo(CAPI).@&quot;struct&quot;.decls) |decl| {\n        _ = &amp;@field(CAPI, decl.name);\n    }\n}\n```\n\n**3. Swift bridge (Unmanaged pattern):**\n\n```swift\n// Bridge/LibSmithers.swift\nfinal class SmithersCore {\n    private let app: smithers_app_t\n\n    init(config: SmithersConfig) throws {\n        var cConfig = config.toCConfig()\n        // Callbacks ‚Äî Unmanaged pattern\n        cConfig.runtime.userdata = Unmanaged.passUnretained(self).toOpaque()\n        cConfig.runtime.wakeup = { userdata in\n            let core = Unmanaged&lt;SmithersCore&gt;.fromOpaque(userdata!).takeUnretainedValue()\n            DispatchQueue.main.async { core.handleWakeup() }\n        }\n        cConfig.runtime.action = { userdata, tag, data, len in\n            let core = Unmanaged&lt;SmithersCore&gt;.fromOpaque(userdata!).takeUnretainedValue()\n            core.handleAction(tag, data: data, len: len)\n        }\n        guard let app = smithers_app_new(&amp;cConfig) else { throw SmithersError.initFailed }\n        self.app = app\n    }\n\n    deinit { smithers_app_free(app) }\n\n    // Actions ‚Üí Zig (Swift never mutates state)\n    func sendChatMessage(_ text: String) {\n        text.withCString { cStr in\n            var payload = smithers_action_payload_u()\n            payload.chat_send.message = cStr\n            smithers_app_action(app, SMITHERS_ACTION_CHAT_SEND, payload)\n        }\n    }\n\n    // Zig callbacks ‚Üí Swift NotificationCenter\n    private func handleAction(_ tag: smithers_action_tag_e, data: UnsafeRawPointer?, len: Int) {\n        switch tag {\n        case SMITHERS_ACTION_CHAT_DELTA:\n            NotificationCenter.default.post(name: .smithersChatDelta, object: /* decoded */)\n        case SMITHERS_ACTION_AGENT_STATUS:\n            NotificationCenter.default.post(name: .smithersAgentStatus, object: /* decoded */)\n        default: break\n        }\n    }\n\n    private func handleWakeup() {\n        NotificationCenter.default.post(name: .smithersWakeup, object: nil)\n    }\n}\n```\n\n**4. libsmithers interfaces (critical):**\n\n**Multiple consumers, same Zig API. Principle: CLI tools = command palette = MCP server. One capability, multiple access.**\n\n**Interfaces:**\n1. **C API** ‚Üí Swift UI (above). libghostty pattern.\n2. **MCP server** ‚Üí Codex orchestrator. **Inject libsmithers MCP into Codex runtime** ‚Äî how Codex controls Smithers. Exposes IDE tools (open files, terminals, search, spawn agents, etc.). Transport (stdio/socket/in-process) = engineering decision from Codex source study.\n3. **CLI** (`smithers-ctl`) ‚Üí external tools, scripts, shell. Same capability as palette+MCP.\n4. **HTTP/WS server** ‚Üí **SolidJS web app** (`web/`). Same capability C API, MCP, CLI over HTTP REST + WS real-time. Zig (`src/http_server.zig`) using **Zap** (vendored `pkg/zap/`, wraps facil.io ~3.2k stars, WebSocket). No auth (localhost). Serves web static, WS PTY for xterm.js. **Playwright primary consumer** ‚Äî e2e tests full Zig via web.\n5. **Zig API** ‚Üí internal.\n\nMCP exposes palette capabilities. Main Codex connects MCP. **Sub-agents NO MCP** ‚Äî only filesystem+terminal scoped to jj branch.\n\n**MCP‚ÜîCodex:** Figure best injection (stdio/socket/in-process). Study `codex-app-server` source.\n\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ                  libsmithers (Zig)                        ‚îÇ\n‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ\n‚îÇ ‚îÇZig API ‚îÇ ‚îÇ C API  ‚îÇ ‚îÇ MCP ‚îÇ ‚îÇ CLI ‚îÇ ‚îÇHTTP  ‚îÇ          ‚îÇ\n‚îÇ ‚îÇ(intern)‚îÇ ‚îÇ(Swift) ‚îÇ ‚îÇServ ‚îÇ ‚îÇstdio‚îÇ ‚îÇ /WS  ‚îÇ          ‚îÇ\n‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ\n‚îÇ     ‚Üë          ‚Üë         ‚Üë       ‚Üë        ‚Üë              ‚îÇ\n‚îÇ  [Zig mods] [Swift]  [Codex] [smithers-ctl] [SolidJS]   ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n**5. Zig memory (arenas):**\n\n**Rule: same lifetime ‚Üí same arena.** Eliminates individual frees, trivial cleanup.\n\n- **Lifetime allocation:** Shared lifetime = shared arena. Agent session = one arena (complete ‚Üí free all). Chat message = message arena. Workspace = workspace arena.\n- **Arena everywhere:** `std.heap.ArenaAllocator` default. App arena = process life. Workspace = until close. Agent = until complete. Request = MCP/CLI duration.\n- **Owned return:** Return owned data ‚Üí internal arena scratch, copy caller allocator before return. Predictable lifetimes, no dangling.\n- **No hidden allocs:** Every allocating fn takes explicit `Allocator` param. Idiomatic Zig, obvious ownership.\n\n```zig\n// Arena-per-agent\npub const Agent = struct {\n    arena: std.heap.ArenaAllocator,\n    messages: std.ArrayList(Message),\n    workspace_path: []const u8,\n    // All from arena\n\n    pub fn deinit(self: *Agent) void {\n        self.arena.deinit();  // One free kills all\n    }\n};\n\n// Owned return with caller alloc\npub fn getAgentListJson(app: *App, caller_alloc: Allocator) ![]const u8 {\n    var scratch = std.heap.ArenaAllocator.init(std.heap.page_allocator);\n    defer scratch.deinit();\n    const tmp = try buildJsonArray(scratch.allocator(), app.agents);\n    return try caller_alloc.dupe(u8, tmp);  // Caller owns\n}\n```\n\n**Build approach ‚Äî Zig TDD, UI parallel:**\n\nTDD ‚Äî `zig build test` instant, no Apple deps. Swift parallel using mocks.\n\n1. **Phase A (Zig):** `src/` modules + comprehensive `zig build test`. Mock Codex, recorded sessions.\n2. **Phase B (Swift parallel):** Views + `@Observable` using `MockSmithersCore` canned data. No Zig block.\n3. **Phase C (integration):** Replace Mock ‚Üí real `SmithersCore` wrapping `libsmithers.a`. Integration tests.\n\n**Build integration (`build.zig`):**\n1. Vendored C `pkg/` (SQLite, TreeSitter, etc.)\n2. Rust subs `cargo build --release` (codex, jj)\n3. Compile libsmithers `.a` + gen `include/libsmithers.h`\n4. Package SmithersKit.xcframework\n5. `zig build test`\n6. `xcodebuild` Swift (links SmithersKit+GhosttyKit)\n7. Copy Rust bins ‚Üí `.app/Contents/MacOS/`\n8. Web (optional): `cd web &amp;&amp; pnpm install &amp;&amp; pnpm build`\n9. Launch\n\n**Zig-wrapped deps:** Logic layer owns from day one:\n\n- **jj** ‚Äî Zig spawns bundled binary, parses JSON. `src/jj.zig` owns VCS.\n- **codex-app-server** ‚Äî Zig calls in-process Zig API. `src/codex_client.zig` wraps, `src/orchestrator.zig` dispatches.\n- **ripgrep** ‚Äî Zig wraps `rg`. `src/search.zig`.\n- **File watch** ‚Äî FSEvents macOS C API (`CoreServices`), inotify Linux later. `src/file_watcher.zig`.\n- **MCP** ‚Äî Zig implements protocol. `src/mcp_server.zig`.\n\n**Stay Swift:** UI render, STTextView/editor coord, Ghostty surface (Zig via GhosttyKit), Neovim RPC (deep AppKit), prefs UI, window mgmt, a11y.\n\n# Code Organization\n\n## Philosophy\n\n**Feature-based org** (Ghostty pattern). Code by feature, not layer. Chat ‚Üí `Features/Chat/`, editor ‚Üí `Features/Editor/`, etc. Makes features findable.\n\nNo complex module graph. Single Xcode app target, organized by dirs. Any file refs any other ‚Äî intentional. Dir structure provides findability, not isolation.\n\n**Principle:** &quot;Not avoiding god object. Breaking into smaller, findable files.&quot; Single god object with modular file split = correct architecture.\n\n## Directory Responsibilities\n\nAll within `macos/Sources/`. Files ref each other directly ‚Äî no imports between dirs.\n\n### App/\n\nEntry point, window coordination, app-wide state.\n\n```\nApp/\n‚îú‚îÄ‚îÄ SmithersApp.swift            ‚Äî @main, scenes, menu commands\n‚îú‚îÄ‚îÄ AppModel.swift               ‚Äî Composition root: single @Observable god object\n‚îú‚îÄ‚îÄ WorkspaceModel.swift         ‚Äî Per-workspace state\n‚îú‚îÄ‚îÄ WindowCoordinator.swift      ‚Äî Create, show, hide, focus workspace windows\n‚îú‚îÄ‚îÄ CloseGuard.swift             ‚Äî Unsaved changes prompts (tab/window/app close)\n‚îú‚îÄ‚îÄ TmuxKeyHandler.swift         ‚Äî Ctrl+A prefix system\n‚îî‚îÄ‚îÄ UpdateController.swift       ‚Äî Sparkle integration\n```\n\n### Ghostty/\n\nCore libsmithers Swift wrapper (like Ghostty&#x27;s dir). C FFI bridge.\n\n```\nGhostty/\n‚îú‚îÄ‚îÄ SmithersCore.swift          ‚Äî Thin wrapper around libsmithers C API (Unmanaged/callbacks)\n‚îú‚îÄ‚îÄ MockSmithersCore.swift      ‚Äî Mock for parallel UI dev\n‚îî‚îÄ‚îÄ Surface View/               ‚Äî If needed for terminal surface mgmt\n```\n\n### Features/\n\nFeature-based. Each dir contains views, models, feature logic.\n\n#### Features/Chat/\n\n```\nFeatures/Chat/\n‚îú‚îÄ‚îÄ Models/\n‚îÇ   ‚îú‚îÄ‚îÄ ChatMessage.swift        ‚Äî Message (role, kind, images, timestamps, turns)\n‚îÇ   ‚îú‚îÄ‚îÄ ChatSession.swift        ‚Äî Session metadata (id, title, creation, last preview)\n‚îÇ   ‚îî‚îÄ‚îÄ ChatModel.swift          ‚Äî Sessions, msgs, streaming (~250 lines)\n‚îú‚îÄ‚îÄ Views/\n‚îÇ   ‚îú‚îÄ‚îÄ ChatWindowRootView.swift ‚Äî NavigationSplitView (sidebar + detail)\n‚îÇ   ‚îú‚îÄ‚îÄ Sidebar/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatSidebarView.swift, SidebarModeBar.swift, ChatSessionList.swift,\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatSessionRow.swift, ChatSidebarSearchField.swift\n‚îÇ   ‚îú‚îÄ‚îÄ Detail/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatDetailView.swift, ChatTitleBarZone.swift, ChatMessagesZone.swift,\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MessageBubbles/ (User, Assistant, Command, Diff, Status)\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MessageHoverActionBar.swift, ChatComposerZone.swift,\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SlashCommandPopup.swift, MentionPopup.swift, ChatWelcomeScreen.swift\n‚îÇ   ‚îî‚îÄ‚îÄ DiffSheet/InlineDiffViewer.swift\n‚îî‚îÄ‚îÄ Services/\n    ‚îú‚îÄ‚îÄ CodexService.swift               ‚Äî Thin wrapper over libsmithers Codex C API (in-process)\n    ‚îú‚îÄ‚îÄ JSONRPCTransport.swift           ‚Äî JSON-RPC framing for non-Codex backends (Claude Code/OpenCode)\n    ‚îú‚îÄ‚îÄ SuggestionService.swift          ‚Äî AI-generated workspace suggestions\n    ‚îî‚îÄ‚îÄ ChatHistoryStore.swift           ‚Äî SQLite chat persistence\n```\n\n#### Features/IDE/\n\n```\nFeatures/IDE/\n‚îú‚îÄ‚îÄ IDEWindowRootView.swift      ‚Äî NavigationSplitView (sidebar + detail)\n‚îú‚îÄ‚îÄ Sidebar/ (FileTreeSidebar, FileTreeRow, FileTreeEmptyState)\n‚îú‚îÄ‚îÄ Detail/\n‚îÇ   ‚îú‚îÄ‚îÄ IDEWorkspaceDetailView.swift, IDETabBar.swift, IDETabItem.swift,\n‚îÇ   ‚îú‚îÄ‚îÄ BreadcrumbBar.swift, IDEContentArea.swift, IDEStatusBar.swift, IDEEmptyState.swift\n‚îú‚îÄ‚îÄ DiffViewer/DiffViewer.swift\n‚îî‚îÄ‚îÄ Models/\n    ‚îú‚îÄ‚îÄ FileItem.swift, TabItem.swift, TabModel.swift,\n    ‚îú‚îÄ‚îÄ FileTreeModel.swift, EditorStateModel.swift\n```\n\n### Helpers/\n\n```\nHelpers/\n‚îú‚îÄ‚îÄ Extensions/ (NSColor+Hex, View+Theme, etc.)\n‚îú‚îÄ‚îÄ DesignSystem/ (Tokens, AppTheme, shared components: IconButton, Badge, etc.)\n‚îî‚îÄ‚îÄ Protocols.swift\n```\n\n### Services/\n\nExternal integrations. All async. Classes (ref types) ‚Äî manage subprocess lifecycle, connections, caches.\n\n```\nServices/\n‚îú‚îÄ‚îÄ CodexService.swift (in-process), JSONRPCTransport.swift (external providers), CompletionService.swift,\n‚îú‚îÄ‚îÄ JJService.swift, JJSnapshotStore.swift, CommitStyleDetector.swift,\n‚îú‚îÄ‚îÄ AgentOrchestrator.swift, SearchService.swift, SuggestionService.swift,\n‚îú‚îÄ‚îÄ SkillScanner.swift, SkillRegistryClient.swift, SkillInstaller.swift,\n‚îú‚îÄ‚îÄ ChatHistoryStore.swift, SessionStore.swift, WindowFrameStore.swift,\n‚îú‚îÄ‚îÄ IPCServer.swift, SmithersCtlInterpreter.swift, FileWatcher.swift,\n‚îî‚îÄ‚îÄ ServiceContainer.swift (holds all service instances, created by AppModel)\n```\n\n### DesignSystem/\n\nTokens + shared SwiftUI components. No business logic.\n\n```\nDesignSystem/\n‚îú‚îÄ‚îÄ Tokens/ (ColorTokens, Typography, Spacing, Radii, Shadows)\n‚îú‚îÄ‚îÄ Theme/ (AppTheme, ThemeEnvironment, ThemeDerived)\n‚îú‚îÄ‚îÄ Components/ (IconButton, PrimaryButton, PillButton, Badge, Panel, SidebarListRow, DividerLine, ToastView)\n‚îî‚îÄ‚îÄ Extensions/ (NSColor+Hex, View+Theme)\n```\n\n### Editor/\n\nCode editor subsystem. STTextView, TreeSitter, design tokens. Access services (e.g., `CompletionService` for ghost text) + models.\n\n```\nEditor/\n‚îú‚îÄ‚îÄ CodeEditorView.swift, CodeEditorCoordinator.swift, MultiCursorTextView.swift,\n‚îú‚îÄ‚îÄ TreeSitterHighlighter.swift, SupportedLanguages.swift,\n‚îú‚îÄ‚îÄ EditorCursorView.swift, EditorCursorGroupView.swift, GhostTextOverlayView.swift,\n‚îú‚îÄ‚îÄ ScrollbarOverlayView.swift, ScrollbarHostingView.swift, IndentGuidesView.swift,\n‚îú‚îÄ‚îÄ MinimapView.swift, BracketMatcher.swift\n```\n\n### Terminal/\n\nGhostty integration. Thin wrapper around C lib.\n\n```\nTerminal/\n‚îú‚îÄ‚îÄ GhosttyApp.swift (singleton managing ghostty_app_t lifecycle)\n‚îú‚îÄ‚îÄ GhosttyTerminalView.swift (NSView wrapping ghostty_surface_t)\n‚îú‚îÄ‚îÄ GhosttyInput.swift (keyboard ‚Üí ghostty key mapping)\n‚îú‚îÄ‚îÄ GhosttyFrameScheduler.swift (display link for frame rendering)\n‚îî‚îÄ‚îÄ TerminalConfiguration.swift (config string builder)\n```\n\n### Neovim/\n\nNeovim mode. Subprocess + bidirectional sync (editor, file tree, tab model, terminal).\n\n```\nNeovim/\n‚îú‚îÄ‚îÄ NvimController.swift (subprocess lifecycle + RPC bridge)\n‚îú‚îÄ‚îÄ NvimRPC.swift (MessagePack encoder/decoder)\n‚îú‚îÄ‚îÄ NvimExtUIOverlay.swift (SwiftUI overlays: cmdline, popup, messages)\n‚îú‚îÄ‚îÄ NvimFloatingWindowEffects.swift, NvimUIState.swift, InputMethodSwitcher.swift\n```\n\n### Views/Chat/\n\nChat window view hierarchy.\n\n```\nViews/Chat/\n‚îú‚îÄ‚îÄ ChatWindowRootView.swift\n‚îú‚îÄ‚îÄ Sidebar/ (ChatSidebarView, SidebarModeBar, ChatSessionList, ChatSessionRow, ChatSidebarSearchField, JJPanelSidebar, AgentDashboardSidebar)\n‚îú‚îÄ‚îÄ Detail/\n‚îÇ   ‚îú‚îÄ‚îÄ ChatDetailView.swift, ChatTitleBarZone.swift, ChatMessagesZone.swift,\n‚îÇ   ‚îú‚îÄ‚îÄ MessageBubbles/ (User, Assistant, Command, DiffPreview, Status, StarterPrompt)\n‚îÇ   ‚îú‚îÄ‚îÄ MessageHoverActionBar.swift, ChatComposerZone.swift, AttachmentStrip.swift,\n‚îÇ   ‚îú‚îÄ‚îÄ FullscreenImageViewer.swift, ChatWelcomeScreen.swift\n‚îî‚îÄ‚îÄ DiffSheet/InlineDiffViewer.swift\n```\n\n### Views/IDE/\n\nIDE/workspace window hierarchy.\n\n```\nViews/IDE/\n‚îú‚îÄ‚îÄ IDEWindowRootView.swift\n‚îú‚îÄ‚îÄ Sidebar/ (FileTreeSidebar, FileTreeRow, FileTreeEmptyState)\n‚îú‚îÄ‚îÄ Detail/ (IDEWorkspaceDetailView, IDETabBar, IDETabItem, BreadcrumbBar, IDEContentArea, IDEStatusBar, IDEEmptyState)\n‚îî‚îÄ‚îÄ DiffViewer/DiffViewer.swift\n```\n\n### Views/Overlays/\n\nShared or IDE-specific overlays.\n\n```\nViews/Overlays/\n‚îú‚îÄ‚îÄ CommandPaletteView.swift (Cmd+P fuzzy finder)\n‚îú‚îÄ‚îÄ SearchPanelView.swift (Cmd+Shift+F workspace search)\n‚îú‚îÄ‚îÄ KeyboardShortcutsPanel.swift (Cmd+/ slide-in)\n‚îî‚îÄ‚îÄ ProgressBarView.swift (top-edge progress)\n```\n\n### App/\n\nEntry point, window coordination, app-wide concerns.\n\n```\nApp/\n‚îú‚îÄ‚îÄ SmithersApp.swift (@main, scenes, menus)\n‚îú‚îÄ‚îÄ WindowCoordinator.swift (create, show, hide, focus workspace windows)\n‚îú‚îÄ‚îÄ CloseGuard.swift (unsaved prompts: tab/window/app)\n‚îú‚îÄ‚îÄ TmuxKeyHandler.swift (Ctrl+A prefix)\n‚îú‚îÄ‚îÄ SettingsView.swift (preferences window)\n‚îî‚îÄ‚îÄ UpdateController.swift (Sparkle)\n```\n\n# State Architecture\n\n## Overview\n\nv2 uses `@Observable` (not Combine `ObservableObject`+`@Published`). SwiftUI tracks per-view property reads, invalidates only when those change.\n\n## Model Graph\n\n```\nAppModel (@Observable, @MainActor)\n‚îú‚îÄ‚îÄ workspace: WorkspaceModel?           ‚Äî nil until folder opened (single for MVP)\n‚îú‚îÄ‚îÄ chat: ChatModel                      ‚Äî works WITHOUT workspace\n‚îÇ   ‚îú‚îÄ‚îÄ sessions, messages, streaming state\n‚îÇ   ‚îî‚îÄ‚îÄ suggestions: [SuggestedPrompt]   ‚Äî AI-generated, workspace-aware\n‚îú‚îÄ‚îÄ preferences: PreferencesModel        ‚Äî all settings ‚Üí UserDefaults\n‚îú‚îÄ‚îÄ theme: AppTheme                      ‚Äî resolved tokens (from prefs + optional nvim override)\n‚îú‚îÄ‚îÄ windowCoordinator: WindowCoordinator ‚Äî manages workspace panel window\n‚îî‚îÄ‚îÄ services: ServiceContainer\n    ‚îú‚îÄ‚îÄ codex: CodexService?, completion: CompletionService?\n    ‚îú‚îÄ‚îÄ suggestion: SuggestionService    ‚Äî generates workspace-aware prompts\n    ‚îú‚îÄ‚îÄ jj: JJService?                   ‚Äî bundled binary from app bundle\n    ‚îú‚îÄ‚îÄ snapshotStore: JJSnapshotStore?, agentOrchestrator: AgentOrchestrator?\n    ‚îú‚îÄ‚îÄ searchService: SearchService, chatHistory: ChatHistoryStore\n    ‚îú‚îÄ‚îÄ sessionStore: SessionStore, windowFrames: WindowFrameStore\n    ‚îú‚îÄ‚îÄ ipcServer: IPCServer, skillScanner: SkillScanner\n    ‚îî‚îÄ‚îÄ nvim: NvimController?            ‚Äî nil unless nvim mode active\n\nWorkspaceModel (@Observable, @MainActor)\n‚îú‚îÄ‚îÄ rootDirectory: URL\n‚îú‚îÄ‚îÄ fileTree: FileTreeModel              ‚Äî root items, expansion, lazy loading\n‚îú‚îÄ‚îÄ tabs: TabModel                       ‚Äî open tabs, selected, ordering (EVERYTHING = tab)\n‚îú‚îÄ‚îÄ editorState: EditorStateModel        ‚Äî per-file (scroll, selection, cursors)\n‚îú‚îÄ‚îÄ jj: JJModel                          ‚Äî working copy, log, bookmarks, ops, snapshots\n‚îú‚îÄ‚îÄ agents: AgentModel                   ‚Äî active agents, merge queue\n‚îú‚îÄ‚îÄ skills: SkillsModel                  ‚Äî installed, active, registry cache\n‚îî‚îÄ‚îÄ search: SearchModel                  ‚Äî query, results, preview\n```\n\n## Key Decisions\n\n1. **Chat = global, not per-workspace.** Works without workspace. Sessions reference workspace but not tied. Workspace-aware but standalone.\n2. **Single workspace MVP.** `workspace: WorkspaceModel?` (0 or 1). Expands to `workspaces: [WorkspaceModel]` later.\n3. **Everything = tab.** Files, terminals, chats, diffs, webviews ‚Äî all `TabModel`. Detach/attach to windows.\n4. **AI-generated suggestions.** Welcome prompts NOT hardcoded. `SuggestionService` generates from workspace context.\n5. **Bundled deps.** `codex-app-server` + `jj` built from source, shipped in `.app` bundle.\n\n## AppModel ‚Äî Composition Root\n\n```swift\n@Observable @MainActor\nfinal class AppModel {\n    var workspace: WorkspaceModel?       // nil until folder opened\n    var chat: ChatModel, preferences: PreferencesModel, theme: AppTheme\n    let windowCoordinator: WindowCoordinator, services: ServiceContainer\n\n    var hasWorkspace: Bool { workspace != nil }\n    var workspaceName: String { workspace?.rootDirectory.lastPathComponent ?? &quot;Smithers&quot; }\n\n    func openDirectory(_ url: URL) async { ... }\n    func closeWorkspace() { ... }\n    func showInEditor(fileURL: URL, line: Int?, column: Int?) { ... }\n}\n```\n\nCreated once in `SmithersApp.init()`, injected via SwiftUI environment to all windows.\n\n## WorkspaceModel ‚Äî Per-Workspace State\n\nCreated on directory open. Destroyed on close. Does NOT contain chat.\n\n```swift\n@Observable @MainActor\nfinal class WorkspaceModel: Identifiable {\n    let id = UUID(), rootDirectory: URL\n    let fileTree: FileTreeModel, tabs: TabModel, editorState: EditorStateModel\n    let jj: JJModel, agents: AgentModel, skills: SkillsModel, search: SearchModel\n}\n```\n\n### Sub-Models\n\n**FileTreeModel** (~200 LOC):\n`items: [FileItem]`, `expandFolder(item:)`, `collapseFolder(item:)`, `reloadTree()`, `modifiedFiles: Set&lt;URL&gt;`\n\n**TabModel** (~200 LOC) ‚Äî everything = tab (files, terminals, diffs, webviews, sub-chats):\n`openTabs: [TabItem]`, `selectedTab: TabItem?`\n`openFile(_:)`, `closeTab(_:)`, `closeOtherTabs(keeping:)`, `reorderTab(from:to:)`\n`openTerminal(id:title:)`, `openDiff(id:title:)`, `openChat(id:title:)`, `openWebview(id:url:title:)`\n`detachTab(_:)`, `attachTab(_:)`\n\n**EditorStateModel** (~100 LOC):\n`viewStates: [URL: EditorViewState]`, `activeFileContent: String`, `activeLanguage: SupportedLanguage?`, `isLoading: Bool`\n\n**ChatModel** (~300 LOC) ‚Äî lives on AppModel, not WorkspaceModel. Main chat = orchestrator:\n`sessions: [ChatSession]`, `selectedSession: ChatSession?`, `messages: [ChatMessage]`\n`isTurnInProgress: Bool`, `streamingMessageId: UUID?`\n`composerText: String`, `composerAttachments: [ChatImage]`, `suggestions: [SuggestedPrompt]`\n`activeAgentChats: [AgentChatHandle]`\n`sendMessage()`, `appendDelta(text:toMessage:)`, `interruptTurn()`, `spawnAgent(task:)`\n\n**Main chat (orchestrator) vs sub-agents:**\n- Main (pane 0) = user assistant, full context\n- Sub-agents = ephemeral background workers, no human-in-loop, run to completion\n- Human-in-loop: sub-agent &quot;needs input&quot; ‚Üí orchestrator surfaces question ‚Üí user responds ‚Üí new sub-agent spawned\n- Sub-agents unhideable as `.chat` tabs in workspace panel\n\n**JJModel** (~100 LOC):\n`isAvailable`, `modifiedFiles`, `changeLog`, `bookmarks`, `operations`, `snapshots`, `conflicts`, `refresh()`\n\n**AgentModel** (~80 LOC):\n`activeAgents: [AgentWorkspace]`, `mergeQueue: [MergeQueueEntry]`, `createAgent(task:)`, `cancelAgent(id:)`, `processQueue()`\n\n**SkillsModel** (~100 LOC):\n`installedSkills`, `activeSkills`, `registrySkills`, `toggleSkill(_:)`, `installSkill(_:)`, `scanWorkspace()`\n\n**SearchModel** (~80 LOC):\n`query`, `results`, `isSearching`, `selectedResult`, `preview`, `search()` (debounced)\n\n## Window-Local UI State\n\nPer-window ephemeral `@State` (not persisted):\n**Chat:** `sidebarMode`, `sidebarSearchQuery`, `hoveredMessageId`, `showImageViewer`, `viewedImage`\n**Workspace:** `showCommandPalette`, `showSearchPanel`, `showShortcutsPanel`, `commandPaletteQuery`, `isSidebarCollapsed`\n\n## Persistence\n\nSQLite (GRDB.swift) = primary layer.\n\n| Data | Storage | When |\n|------|---------|------|\n| Preferences | UserDefaults | Immediate on change |\n| Window frames | UserDefaults | 250ms debounce post resize/move |\n| Chat sessions+messages | SQLite `~/Library/Application Support/Smithers/smithers.db` | 1s debounce |\n| Thread IDs | SQLite (sessions) | On creation |\n| Open tabs+sidebar widths | SQLite (keyed by workspace path) | Workspace close / app quit |\n| JJ snapshots | SQLite (snapshots) | On creation |\n| Scheduled agents | SQLite (schedules) | On create/edit |\n| Per-file editor state | In-memory dict | NOT persisted |\n| Chat images | File `~/Library/Application Support/Smithers/images/&lt;hash&gt;` | On attach |\n\n## Cross-Window Reactivity\n\nAll windows observe same `AppModel`. AI appends message ‚Üí only chat re-renders (workspace doesn&#x27;t read `messages`).\n\nAI changes file:\n1. `ChatModel` appends `DiffPreviewCard` ‚Üí chat re-renders\n2. If `preferences.autoOpenIDEOnFileChange` ‚Üí `AppModel.showInEditor()` called\n3. `WindowCoordinator` ensures workspace panel visible\n4. `TabModel` opens/selects file tab ‚Üí workspace re-renders\n5. `EditorStateModel.scrollToLine` set ‚Üí editor animates\n\nNo explicit cross-window messaging. Shared model = communication channel.\n\n## Agent Workspaces\n\nSingle user workspace, but `AgentOrchestrator` creates parallel agent workspaces via `jj workspace add` ‚Äî lightweight working copies, shared repo history, independent file trees.\n\nAgent workspaces NOT full `WorkspaceModel` ‚Äî managed internally by `AgentOrchestrator`, visualized via agent dashboard. Work enters merge queue, merged into user workspace when complete.\n\n# Window Management\n\n## Scene Definitions\n\nChat = fixed `Window`. Workspace panel = second `Window` (single workspace MVP).\n\n```swift\n@main\nstruct SmithersApp: App {\n    @State private var appModel = AppModel()\n\n    var body: some Scene {\n        // Chat (primary, pane 0 ‚Äî always present)\n        Window(&quot;Smithers&quot;, id: &quot;chat&quot;) {\n            ChatWindowRootView().environment(appModel)\n        }\n        .windowStyle(.hiddenTitleBar).windowResizability(.contentSize)\n        .defaultSize(width: 800, height: 900).commands { appMenuCommands }\n\n        // Workspace panel (on-demand, shows when workspace open)\n        Window(&quot;Smithers IDE&quot;, id: &quot;workspace&quot;) {\n            IDEWindowRootView().environment(appModel)\n        }\n        .windowStyle(.hiddenTitleBar).windowResizability(.contentSize)\n        .defaultSize(width: 1100, height: 900)\n\n        Settings { SettingsView().environment(appModel) }\n    }\n}\n```\n\nFuture multi-workspace: panel ‚Üí `WindowGroup(&quot;Workspace&quot;, id: &quot;workspace&quot;, for: UUID.self)`\n\n## WindowCoordinator\n\nManages workspace panel. Chat always present (SwiftUI scene lifecycle).\n\n```swift\n@Observable @MainActor\nfinal class WindowCoordinator {\n    private(set) var isWorkspacePanelVisible: Bool = false\n\n    func showWorkspacePanel() {\n        // NSApp.windows find by identifier ‚Üí if not found OpenWindowAction create\n        // If found but hidden ‚Üí orderFront+makeKey\n        isWorkspacePanelVisible = true\n    }\n\n    func hideWorkspacePanel() {\n        // Find+orderOut panel. Do NOT close (triggers scene teardown)\n        isWorkspacePanelVisible = false\n    }\n\n    func showInEditor(fileURL: URL, line: Int? = nil, column: Int? = nil) {\n        showWorkspacePanel()\n        // Route to workspace TabModel+EditorStateModel\n    }\n}\n```\n\n**Chrome DevTools analogy:** Chat = main Chrome, workspace panel = DevTools. Everything = tabs (chat, diff, editor, terminal, anything).\n\n**Window access:** `NSApp.windows.first { $0.identifier?.rawValue == &quot;workspace-\\(id)&quot; }` in `onAppear`. Retry-with-delay (SwiftUI creates async).\n\n## Window Chrome\n\nBoth windows:\n\n```swift\n.onAppear {\n    DispatchQueue.main.asyncAfter(deadline: .now() + 0.05) {\n        guard let window = NSApp.windows.first(where: { $0.identifier?.rawValue == windowId }) else { return }\n        window.titlebarAppearsTransparent = true\n        window.isMovableByWindowBackground = true\n        window.titleVisibility = .hidden\n        // Install NSWindowDelegate for close guards + frame persistence\n    }\n}\n```\n\n## Close Behavior\n\n**Chat close ‚Üí background (not quit):**\n`NSWindowDelegate.windowShouldClose` hides, does NOT quit. Smithers continues w/ menu bar icon (scheduled agents). Quit = explicit Cmd+Q or menu &quot;Quit&quot;.\n\n**Workspace close ‚Üí hide:**\n`windowShouldClose` returns `false`, calls `windowCoordinator.hideWorkspacePanel()`. Hidden not destroyed. Tab state, scroll, sidebar width preserved in memory.\n\n**App termination:**\n`NSApplicationDelegate.applicationShouldTerminate` returns `.terminateLater`, runs close guard, persists session state ‚Üí `NSApp.reply(toApplicationShouldTerminate: true)`\n\n## Frame Persistence\n\n`WindowFrameStore` saves frames keyed by type+workspace path:\n\n```swift\nenum WindowFrameStore {\n    private static let frameMapKey = &quot;smithers.windowFrames&quot;\n\n    static func saveFrame(_ frame: NSRect, window: WindowKind, workspace: URL?) { ... }\n    static func loadFrame(window: WindowKind, workspace: URL?) -&gt; NSRect? { ... }\n\n    enum WindowKind: String { case chat, workspacePanel }\n}\n```\n\n250ms debounce on `windowDidResize`/`windowDidMove`. Validates vs screen geometry on load.\n\n## Default Sizing\n\n```swift\nstatic func defaultFrame(for kind: WindowKind, screen: NSScreen) -&gt; NSRect {\n    let vis = screen.visibleFrame\n    switch kind {\n    case .chat:\n        let w = vis.width * 0.45, h = vis.height * 0.85\n        let x = vis.midX - (vis.width * 0.06) - (w / 2), y = vis.midY - (h / 2)\n        return NSRect(x: x, y: y, width: w, height: h)\n    case .workspacePanel:\n        let w = vis.width * 0.55, h = vis.height * 0.85\n        let x = vis.midX + (vis.width * 0.06) - (w / 2), y = vis.midY - (h / 2)\n        return NSRect(x: x, y: y, width: w, height: h)\n    }\n}\n```\n\n# Chat Implementation\n\n## Root Structure\n\n```swift\nstruct ChatWindowRootView: View {\n    @Environment(AppModel.self) private var appModel\n    @State private var sidebarMode: SidebarMode = .chats\n\n    var body: some View {\n        NavigationSplitView {\n            ChatSidebarView(mode: $sidebarMode)\n        } detail: {\n            ChatDetailView()\n        }\n        .navigationSplitViewColumnWidth(min: 200, ideal: 260, max: 360)\n    }\n}\n```\n\n## Sidebar\n\n**Mode bar:** 3 buttons in HStack. `ModeBarItemButton` ‚Äî icon + label, selected = accent pill. Animation: `.spring(duration: 0.2)`.\n\n**Session list:** `List(selection:)` bound to `chat.selectedSession`. Sections from timestamps. `ChatSessionRow`: title (12pt semibold), trailing timestamp (10pt tertiary), 2-line preview (10pt tertiary). Context menu: Rename (inline), Delete (confirmation).\n\n**JJ panel:** `DisclosureGroup` sections. Working copy rows with M/A/D badges. Change log rows + context menus (View Diff, Describe, Squash, Abandon). Bookmarks, Op log, Snapshots.\n\n**Agent dashboard:**\n\nKey monitoring surface. Active visible; past toggleable.\n\n- **&quot;ACTIVE AGENTS&quot; header** ‚Äî 10px uppercase tracking, tertiary\n- **Agent rows:**\n  - Status dot (8px) ‚Äî blue working (glow), green completed, red failed, gray idle\n  - Agent name ‚Äî 11px semibold primary (e.g., &quot;CodeReview&quot;, &quot;TestWriter&quot;)\n  - Task desc ‚Äî 10px tertiary, truncated\n  - Change count badge ‚Äî pill if changes &gt; 0\n- **Sort** ‚Äî Active/working top\n- **Past toggle** ‚Äî Show/hide completed/failed\n- **Click to unhide** ‚Äî Opens `.chat` tab in workspace panel\n- **Hover** ‚Äî `sidebar-hover` bg\n- **&quot;New Agent&quot; button** ‚Äî Accent, spawns sub-agent via orchestrator\n\n## Detail Area\n\n**Title bar (28pt):** Centered workspace name, trailing &quot;Open Editor&quot; `IconButton` ‚Üí `appModel.windowCoordinator.showWorkspacePanel()`.\n\n**Messages zone:** `ScrollViewReader` + `ScrollView` + `LazyVStack(spacing: 10)`. Each msg `.id(message.id)`. Auto-scroll when near bottom (`.easeOut(duration: 0.2)`). &quot;Jump to latest&quot; when scrolled up.\n\n**Message bubbles:**\n\n- `UserMessageBubble` ‚Äî trailing align, `UnevenRoundedRectangle(topLeading: 12, bottomLeading: 12, bottomTrailing: 4, topTrailing: 12)`, `chat.bubble.user` bg, max width 80%\n- `AssistantMessageBubble` ‚Äî leading, `chat.bubble.assistant` bg. Markdown. File paths matching `path:line:col` ‚Üí links calling `appModel.showInEditor()`\n- `CommandBubble` ‚Äî leading, 90% width, monospaced cmd + streaming output + exit badge\n- `DiffPreviewCard` ‚Äî leading, 90%, file list + summary + 8-line preview + status badge + &quot;Open in Editor&quot;\n- `StatusMessageBubble` ‚Äî centered, small muted pill\n\n**Hover action bar:** After 150ms hover. Above bubble. Dark bg (`black@30%`), icon buttons: Fork, Copy, Retry, Edit, Revert, More.\n\n**Streaming:** When `chat.isTurnInProgress`, last assistant msg live-updates via `chat.appendDelta()`. Mutate text in-place. Avoid re-parsing full markdown ‚Äî append new run, re-parse affected tail only.\n\n## Composer\n\n`ChatComposerZone`:\n\n- `ComposerContainer` ‚Äî rounded rect (10pt), `chat.input.bg` bg, `white@6%` border\n- Multiline `TextField(axis: .vertical)`, `.lineLimit(1...4)`, 10pt padding\n- `AttachmentStrip` ‚Äî 56pt thumbnails, horizontal scroll, X to remove\n- Footer: Send (32x32, accent, up-arrow) when idle, Interrupt (32x32, danger, stop) when streaming\n- Keyboard: Return sends, Shift+Return newline, Esc interrupts\n- Drop target: `.dropDestination(for: Data.self)` with accent border highlight\n- Paste images: `.onPasteCommand(of: [UTType.image])`\n\n## Welcome Screen\n\nShown when `chat.messages.isEmpty`:\n\n- Centered `VStack(spacing: 24)`, max width 640\n- &quot;How can I help you?&quot; ‚Äî 28pt semibold\n- Project name ‚Äî 16pt secondary (if workspace open)\n- Category pills: HStack of `PillButton`s (Create, Explore, Code, Learn) with SF symbols\n- **AI-generated suggested prompts:** 4 cards from `SuggestionService`, NOT hardcoded\n  - First launch (no workspace): polished defaults\n  - Subsequent: `SuggestionService` analyzes workspace, updates in-place\n  - Impl: calls `codex-app-server` with suggestion prompt, cached per-workspace, refreshed on workspace change or 5min idle\n  - Cards: white@6% bg, 8pt radius, 12pt padding, text + trailing arrow\n- Clicking pill fills composer with prefix. Clicking suggestion fills + sends.\n\n# IDE Window Implementation\n\n## 7. IDE Window\n\n### 7.1 Root\n\n```swift\nstruct IDEWindowRootView: View {\n    @Environment(AppModel.self) private var appModel\n    @State private var showCommandPalette = false\n    @State private var showSearchPanel = false\n    @State private var showShortcutsPanel = false\n\n    var body: some View {\n        NavigationSplitView {\n            FileTreeSidebar()\n        } detail: {\n            IDEWorkspaceDetailView(\n                showCommandPalette: $showCommandPalette,\n                showSearchPanel: $showSearchPanel,\n                showShortcutsPanel: $showShortcutsPanel\n            )\n        }\n        .navigationSplitViewColumnWidth(min: 180, ideal: 240, max: 400)\n        .overlay { if showCommandPalette { CommandPaletteView(...) } }\n        .overlay { if showSearchPanel { SearchPanelView(...) } }\n    }\n}\n```\n\n### 7.2 File tree\n\n**Rendering:** `List(selection:)` + manual recursive `FileTreeRow` (NOT `OutlineGroup` ‚Äî manual = lazy loading + indent control).\n\n**Lazy loading:** Children start `nil` (unexpanded) or `[.lazyPlaceholder]` (loading). On expand ‚Üí `FileTreeModel.expandFolder(item:)` loads on bg thread. Chevron rotates 90¬∞ `.rotationEffect` 0.15s ease-in-out.\n\n**Row:** `HStack`: optional chevron (12pt, folders) ‚Üí icon (16pt, colored) ‚Üí name (11pt) ‚Üí spacer ‚Üí optional modified dot (5pt circle, accent).\n\n**Selection:** Accent `Capsule` overlay 3pt wide, row height - 6pt, leading edge.\n\n**Context menus:** `.contextMenu { }`. Folders: New File, New Folder, Copy Path, Reveal in Finder, Rename, Delete. Files: Copy Path, Reveal in Finder, Open in Terminal, Rename, Delete.\n\n**Empty:** Centered `VStack`: folder icon, &quot;No Folder Open&quot;, `PrimaryButton` &quot;Open Folder...&quot;, &quot;‚åò‚áßO&quot; hint.\n\n### 7.3 Tab bar\n\n`IDETabBar` ‚Äî horizontal `ScrollView(.horizontal)` of `IDETabItem`.\n\nBackground `surface2`. Geometry: 120-220pt width, 30pt height. If fits ‚Üí distribute evenly. Selected: white@6% bg + 2pt accent underline capsule. Unselected: secondary text. Content: icon (colored) + filename (11pt) + modified dot (non-hover) OR close btn (hover). Drag reorder: `.draggable` + `.dropDestination` with insertion highlight. Middle-click = close. Context: Close, Close Others, Close All, Close to Right, Copy Path, Reveal in Finder, Reveal in Sidebar. Overflow: trailing ellipsis.circle menu.\n\n**Tab types:** `.file(URL)`, `.terminal(id, title)`, `.diff(id, title)`, `.webview(id, title)`, `.chat(id, title)`. **Chat tabs first-class** ‚Äî sub-agents, forks, any session opens as `.chat` tab. Main chat (pane 0) NOT a tab ‚Äî window primary content. Others = tabs.\n\n### 7.4 Breadcrumb\n\nFile tabs only. `HStack` path segments separated by `Image(systemName: &quot;chevron.right&quot;)` 10pt tertiary. Last segment primary opacity, earlier tertiary.\n\n### 7.5 Content area\n\n`IDEContentArea` switches tab kind: `.file` ‚Üí `CodeEditorView`, `.terminal` ‚Üí `GhosttyTerminalView`, `.diff` ‚Üí `DiffViewer`, `.webview` ‚Üí `WebView`, `nil` ‚Üí `IDEEmptyState`. Transition: `.opacity` 0.1s crossfade.\n\n### 7.6 Status bar\n\n22pt, `surface2` bg, 1px top divider. Left: `Ln X, Col Y | UTF-8 | LF` (mono 10pt, secondary). Center: skills indicator (click ‚Üí popover). Right: language + &quot;Spaces: 4&quot; (10pt secondary).\n\n### 7.7 Command palette (Cmd+P)\n\nOverlay dark scrim `black@35%`. Panel centered 65% width (420-680px), 55% height (320-460px), radius 10, surface2.\n\nTwo-pane: results (left) + preview (right, first 20 lines).\n\n**Modes:** Default = fuzzy file (recent edits, views, index). Command = prefix `&gt;` triggers command list with icons + shortcuts.\n\n**Fuzzy:** substring &gt; subsequence. Highlight matches accent. Keys: arrows navigate, Enter opens, Esc dismisses. Animation: scale 0.97 + opacity, spring (0.25s, bounce 0.15) appear, 0.15s ease-in dismiss.\n\n### 7.8 Search panel (Cmd+Shift+F)\n\nTop slide-down 55% width (max 560px), 65% height (max 520px), surface2. Search field top. Results grouped by file, highlighted matches. Preview pane bottom (120-240px) with context. Click ‚Üí open + scroll. Backed by `SearchService` spawning `rg`.\n\n### 7.9 Shortcuts panel (Cmd+/)\n\nRight slide-in 260-320pt. Surface2. Search top. Grouped: General, Tabs, Command Palette, Search, Neovim.\n\n# Editor Subsystem\n\n## 8.1 CodeEditorView (NSViewRepresentable)\n\n`NSViewRepresentable` wrapping `MultiCursorTextView` (subclass of `STTextView`). Most complex view in app.\n\n**Inputs (bindings/params):**\n- `text: Binding&lt;String&gt;`, `language: SupportedLanguage?`, `theme: AppTheme`, `font: NSFont`, `lineSpacing: CGFloat`, `characterSpacing: CGFloat`, `ligaturesEnabled: Bool`, `cursorStyle: CursorStyle`, `showLineNumbers: Bool`, `highlightCurrentLine: Bool`, `showIndentGuides: Bool`, `showMinimap: Bool`, `scrollbarMode: ScrollbarVisibilityMode`, `scrollToRequest: ScrollToRequest?` (line/col, set by showInEditor), `ghostText: String?` (AI completion), `onTextChange: (String) -&gt; Void`, `onCursorChange: (Int, Int) -&gt; Void`\n\n**makeNSView:** Creates STTextView via `MultiCursorTextView.scrollableTextView()`, extracts text view + scroll view, creates line number ruler (`STLineNumberRulerView`), custom `ScrollbarOverlayView`, `GhostTextOverlayView`, wraps in `ScrollbarHostingView`.\n\n**Coordinator:** Weak refs to subviews. Caches highlighters per language. `STTextViewDelegate` for text change notifications. Manages highlight ‚Üí apply cycle. Tracks file URL changes ‚Üí save/restore view state (scroll, selection).\n\n**updateNSView:** Handles theme changes (reapply colors), font changes (reload with new attrs), text changes from outside (AI wrote file), scroll requests (animate to line/col).\n\n## 8.2 TreeSitter Highlighting Pipeline\n\n```\nUser types ‚Üí onTextChange callback\n‚Üí EditorStateModel updates activeFileContent\n‚Üí CodeEditorView.updateNSView detects change\n‚Üí Coordinator.scheduleHighlight()\n‚Üí 250ms debounce (cancels previous)\n‚Üí Increment requestID\n‚Üí Dispatch to parseQueue (background, .userInitiated QoS)\n‚Üí Parse with TreeSitter\n‚Üí Run highlight query, collect captures\n‚Üí Map captures to colors via syntax palette\n‚Üí Check requestID still matches (not stale)\n‚Üí Dispatch to main thread\n‚Üí Apply attrs to NSTextStorage via setAttributes(_:range:)\n```\n\n**Cancellation:** Increment `requestID`. Before apply, check `currentID == self.requestID`. Stale discarded.\n\n**Size limit:** Skip highlighting if &gt; 200,000 chars. Plain foreground only.\n\n**Language registry:** `SupportedLanguages.swift` maps extensions to TreeSitter `Language`:\n\n| Ext | Language |\n|-----|----------|\n| `.swift` | TreeSitterSwift |\n| `.js` | TreeSitterJavaScript |\n| `.ts` | TreeSitterTypeScript |\n| `.tsx` | TreeSitterTypeScript (TSX) |\n| `.py` | TreeSitterPython |\n| `.json` | TreeSitterJSON |\n| `.sh`, `.bash`, `.zsh` | TreeSitterBash |\n| `.md`, `.markdown` | TreeSitterMarkdown (block + inline) |\n| `.zig` | TreeSitterZig |\n| `.rs` | TreeSitterRust |\n| `.go` | TreeSitterGo |\n\n## 8.3 Multi-Cursor Support\n\n`MultiCursorTextView` subclasses `STTextView`. Overrides `mouseDown`, `keyDown`, `insertText`, delete, `doCommand`.\n\n- **Option+Click:** Add insertion at click\n- **Option+Shift+Up/Down:** Add cursor on adjacent line\n- **Cmd+D:** Select next occurrence\n- **Cmd+Shift+L:** Select all occurrences\n- **Escape:** Collapse to single cursor\n\nAll edits grouped into single undo via `groupedUndoIfNeeded`.\n\nCopy/paste with multi-cursor: one pasteboard item per selection. Paste distributes across cursors.\n\n## 8.4 Ghost Text (AI Completions)\n\n`GhostTextOverlayView` = `NSView` subclass over editor. Renders dimmed preview at cursor using `NSTextStorage` + `NSLayoutManager` + `NSTextContainer`.\n\n- Visibility: fade in/out with `NSAnimationContext` (0.12s)\n- Hit testing: always nil (pass-through)\n- Tab accepts (inserts into editor)\n- Escape dismisses\n- Typing advances through suggestion or cancels if diverges\n\nPipeline: `CompletionService` sends requests to codex-app-server after 300ms debounce. Streaming partial results update ghost text real-time. Each keystroke cancels previous, starts new.\n\n## 8.5 Scrollbar Overlay\n\n`ScrollbarOverlayView` ‚Äî custom `NSView`, manual drawing. Replaces native macOS scrollbar.\n\n- Modes: always (visible), automatic (shows on scroll, fades after 1.5s), never (hidden)\n- Knob sizing: proportional to viewport/content ratio, min 24pt\n- Interaction: click track for page scroll, drag knob for continuous\n- Drawing: filled rounded rect (4pt radius), alpha varies (0.38 idle, 0.55 hover/drag)\n- Hit testing: nil when invisible (alpha &lt; 0.01)\n\n## 8.6 Bracket Matching\n\n`BracketMatcher` scans outward from cursor for matching pairs: `()`, `[]`, `{}`, `&lt;&gt;`. Scans up to 10,000 chars each direction. Matching bracket highlighted with `white@16%` bg.\n\n## 8.7 Neovim Mode\n\nToggled via Cmd+Shift+N. When enabled, `CodeEditorView` replaced by `GhosttyTerminalView` running embedded Neovim.\n\n**NvimController** (in SmithersApp, not SmithersEditor):\n\n1. Creates Unix socket `/tmp/smithers-nvim-&lt;uuid&gt;.sock`\n2. Launches Neovim in hidden Ghostty terminal with `--listen &lt;socket&gt;`\n3. Connects with retry (10 attempts, 100ms backoff)\n4. Attaches UI with ext_multigrid, ext_cmdline, ext_popupmenu, ext_messages, ext_hlstate\n5. Installs autocmds for BufEnter/BufLeave ‚Üí track file changes\n6. Starts notification loop for Neovim events\n\n**Bidirectional sync:**\n- User selects file in sidebar ‚Üí NvimController sends `:edit &lt;path&gt;` via RPC\n- User opens in Neovim ‚Üí BufEnter autocmd ‚Üí NvimController updates `TabModel` + `EditorStateModel`\n- User saves in Neovim ‚Üí BufWritePost ‚Üí NvimController marks clean\n\n**External UI overlays** (`NvimExtUIOverlay`):\n- Cmdline: SwiftUI overlay at bottom\n- Popup menu: SwiftUI list at cursor\n- Messages: floating notifications (max 6, auto-expire 4s)\n- Floating windows: plugin popups with blur, rounded corners, shadow\n\n**Theme derivation:** On UI attach, NvimController reads highlight groups (Normal, Visual, CursorLine, TabLine, etc.), derives `AppTheme` via `ThemeDerived.fromNvimHighlights()`. Overrides default theme while Neovim active.\n\n**Crash recovery:** If Neovim dies ‚Üí recovery view: Restart Neovim, Disable Neovim Mode, Reveal Crash Report.\n\n# Terminal Subsystem\n\n## 9. Terminal Subsystem\n\n### 9.1 GhosttyApp Singleton\n\n```swift\nfinal class GhosttyApp {\n    static let shared = GhosttyApp()\n    private(set) var app: ghostty_app_t?\n    private var config: ghostty_config_t?, tickScheduled = false\n\n    private init() {\n        ghostty_init(...)\n        // Create config, load defaults, finalize\n        // Create runtime w/ callbacks (wakeup, action, clipboard, close_surface)\n        // Create app handle\n    }\n\n    func scheduleTick() {\n        // Coalesced: one tick per main queue cycle\n        guard !tickScheduled else { return }\n        tickScheduled = true\n        DispatchQueue.main.async { [weak self] in\n            self?.tickScheduled = false\n            ghostty_app_tick(self?.app)\n        }\n    }\n}\n```\n\n**Callback pattern:** C callbacks = static funcs. Extract Swift obj via `Unmanaged&lt;GhosttyApp&gt;.fromOpaque(userdata).takeUnretainedValue()`. Dispatch main queue for UI.\n\n**Focus tracking:** Observes `NSApplication.didBecomeActiveNotification`/`didResignActive` ‚Üí calls `ghostty_app_set_focus()`.\n\n### 9.2 GhosttyTerminalView\n\n`NSView` subclass, conforms `NSTextInputClient`.\n\n**Lifecycle:**\n1. `init(app:workingDirectory:command:optionAsMeta:)` ‚Äî creates surface via `ghostty_surface_new()`, stores `self` as userdata\n2. `shutdown()` ‚Äî frees surface (main thread) via `ghostty_surface_free()`, stops frame scheduler\n\n**Surface access:** Static `from(surface:) -&gt; GhosttyTerminalView?` extracts Swift obj from C surface userdata.\n\n**Frame scheduling:** `GhosttyFrameScheduler` uses display link ‚Üí `setNeedsDisplay()` at refresh rate. Visibility-aware, pauses when not visible.\n\n**Input:** `GhosttyInput.swift` maps `NSEvent` keycodes ‚Üí Ghostty constants. Handles modifiers, Option-as-Meta, IME via `NSTextInputClient`.\n\n### 9.3 Terminal Tabs\n\nTerminal tabs = `TabItem` kind `.terminal(id:title:)`. Each has `GhosttyTerminalView` stored in dict on `AppModel` (or `TerminalManager`). Title updates (shell escape sequences) ‚Üí tab title via Ghostty action callback.\n\nWorking directory defaults to workspace root.\n\n# AI Integration\n\n## 10.0 Orchestrator Architecture\n\nMain chat = orchestrator (&quot;top agent&quot;). Has full app state context (workspace, running agents, settings, file tree). Answers directly OR delegates to sub-agents.\n\n**Core flow:**\n1. User msg ‚Üí main chat (pane 0)\n2. Orchestrator Codex interprets intent. Has **libsmithers MCP server** (injected at runtime) ‚Äî same capabilities as command palette + CLI: open files, run terminals, search, read tree, spawn agents, change settings, etc.\n3. Simple queries (&quot;what&#x27;s in this file?&quot;, &quot;change theme to dark&quot;) ‚Üí responds directly via MCP tools\n4. Work tasks (&quot;fix login bug&quot;, &quot;add API tests&quot;) ‚Üí spawns **sub-agent** (ephemeral Codex process, workspace-scoped tools only: filesystem + terminal, **NO MCP**)\n5. **Sub-agents run YOLO (no approvals) to completion.** Execute task, apply to jj branch, complete.\n6. **HITL = sub-agent completes ‚Üí orchestrator asks ‚Üí new sub-agent.** No pause/resume ‚Äî complete ‚Üí ask ‚Üí new agent with updated context.\n7. Sub-agent runs **hidden by default.** Status in agent dashboard. Work in background.\n8. User can **unhide** ‚Üí opens `.chat` tab in workspace panel (attach to background process).\n9. Main chat sidebar dashboard shows all agent statuses. Active sorted top, past below (toggleable).\n10. Sub-agent completes ‚Üí changes enter merge queue (jj).\n\n**Sub-agents hidden by default.** User&#x27;s primary interaction = main chat. Sub-agents = background workers. Monitor via dashboard, open any to see full conversation.\n\n**Codex session multiplexing.** Share **one Codex session** with multiplexed sub-sessions. Single `codex-app-server` process, orchestrator + all sub-agents communicate through it. Reduces overhead, enables context caching, simplifies lifecycle. Each sub-agent = logical session ID within shared connection.\n\n**Orchestrator toolset = command palette = CLI = MCP server.** Unified capability surface.\n\n| Tool | MCP method | CLI command | Command palette |\n|------|-----------|-------------|-----------------|\n| Open file | `open_file(path, line, col)` | `smithers-ctl open-file &lt;path&gt; --line N` | Cmd+P ‚Üí select |\n| Search workspace | `search_workspace(query)` | `smithers-ctl search &lt;query&gt;` | Cmd+Shift+F |\n| Run terminal | `run_terminal(command, cwd)` | `smithers-ctl terminal --cwd PATH` | Cmd+` ‚Üí type |\n| Read file | `read_file(path)` | `smithers-ctl read &lt;path&gt;` | Open in editor |\n| Write file | `write_file(path, content)` | `smithers-ctl write &lt;path&gt;` | Edit + Cmd+S |\n| Get workspace state | `get_workspace_state()` | `smithers-ctl status` | Look at tree |\n| Get JJ status | `get_jj_status()` | `smithers-ctl jj status` | Source tab |\n| Spawn agent | `spawn_agent(task)` | `smithers-ctl agent spawn &lt;task&gt;` | &quot;New Agent&quot; |\n| Cancel agent | `cancel_agent(id)` | `smithers-ctl agent cancel &lt;id&gt;` | Cancel row |\n| Change setting | `change_setting(key, value)` | `smithers-ctl set &lt;key&gt; &lt;value&gt;` | Preferences |\n| Get agent status | `get_agent_status(id)` | `smithers-ctl agent status &lt;id&gt;` | Dashboard |\n| Show diff | `show_diff(content)` | `smithers-ctl diff show` | Open diff tab |\n\nSub-agents NO MCP ‚Äî only standard Codex tools (file r/w, terminal) scoped to jj branch.\n\n**Multiple sub-agents run in parallel.** Each gets own jj branch, multiplexed Codex session, hidden conversation. Orchestrator has global visibility via MCP.\n\n**Project config files.** On workspace open, reads/respects:\n- `AGENTS.md` ‚Äî project agent instructions (Codex compat), injected into orchestrator\n- `CLAUDE.md` ‚Äî Claude Code project instructions, injected\n- Skills ‚Äî from `&lt;workspace&gt;/.agents/skills/`, `~/.agents/skills/`, injected per-session\n\nEnsures compat with Codex CLI / Claude Code users ‚Äî config carries over.\n\n## 10.0.1 Codex Feature Parity\n\nFull user-facing feature parity with Codex CLI. Reference implementation.\n\n**Slash commands (type `/` in composer):**\n\n| Command | Behavior |\n|---------|----------|\n| `/plan` | Plan mode ‚Äî agent plans before executing. Inline args + pasted images. |\n| `/review` | Code review ‚Äî summarize working tree issues, focus on behavior + missing tests. |\n| `/diff` | Inspect exact file changes from reviews. |\n| `/fork` | Clone conversation ‚Üí new chat session with fresh ID. Original intact. |\n| `/new` | Fresh conversation, same session. |\n| `/resume` | Resume saved session from picker. |\n| `/status` | Show active model, approval policy, writable roots, token usage. |\n| `/compact` | Summarize long conversations to free context. |\n| `/mention` | Add file by path (e.g., `/mention src/lib/api.ts`). |\n| `/init` | Create AGENTS.md for project config. |\n| `/model` | Switch models. |\n\n**@Mention (type `@` in composer):**\n- `@` ‚Üí autocomplete popup with workspace files\n- Select ‚Üí insert as context reference\n- Referenced files persist across follow-up turns\n- MVP: files + open tabs. Future: symbols, functions, agent names.\n\n**Steer mode (real-time agent interaction ‚Äî match Codex CLI):**\n- Agent running ‚Üí type in composer ‚Üí **Enter** ‚Üí send mid-turn steering message\n- **Tab** ‚Üí queue follow-up for next turn (after agent finishes)\n- Mid-turn corrections without stopping agent\n- Study Codex CLI source for exact behavior. In-process Zig API ‚Üí call steering function directly. If no steering API ‚Üí inject follow-up into conversation context.\n\n**Skills (invoke `$skill-name` or via Skills button):**\n- Reusable instruction bundles with SKILL.md\n- Explicit: `$skill-name` in composer\n- Implicit: Codex auto-selects based on context\n- Browse, install, activate/deactivate per session\n- `AGENTS.md` at project root = project-wide config\n\n**Thread management:**\n- Thread = durable container (many turns)\n- Turn = one user msg ‚Üí agent response\n- Fork, resume, compact ops on threads\n- All threads auto-saved (SQLite, not JSON)\n- History syncs across sessions\n\n**Execution mode ‚Äî YOLO only:**\n- No approvals, no sandbox, unrestricted. Agent reads/writes any file, runs any command, no confirmation.\n- Intentional for power users.\n- Future: sandboxing + per-action approval. MVP: user&#x27;s responsibility to sandbox environment.\n- `/permissions` NOT implemented in MVP ‚Äî remove from slash table.\n\n**Model selection:**\n- Switch via `/model` or settings\n- MVP: Codex (OpenAI) only. Future: Claude, others (issue 004).\n\n**Multi-provider support (MVP lower priority ‚Äî issue 004):**\n- Architecture must support multiple backends, not just Codex\n- MVP ships Codex (fork) as primary. Claude Code + OpenCode = MVP but lower priority ‚Äî implement end of MVP.\n- **Unified Agent Protocol Adapter** abstracts backend ‚Üí swap Codex for Claude Code (WebSocket MCP) or OpenCode (ACP) = backend change, not UI change.\n- Adapter interface: send msg, receive events (deltas, commands, file changes, turn complete), manage threads.\n\n## 10.0.2 Background + Scheduled Agents (MVP ‚Äî issue 007)\n\nBackground agents = core (already in 10.0). Scheduled agents extend:\n\n**Scheduled agents:**\n- Config agents on cron schedules (e.g., &quot;code review every morning&quot;)\n- Config in SQLite (not TOML ‚Äî v1 spec stale)\n- `SchedulerService` (Zig: `src/scheduler.zig`) manages triggers\n- Schedule fires ‚Üí spawn sub-agent via orchestrator with configured prompt/skill\n- Results in agent dashboard\n- **Scheduler runs in-app.** Background-capable macOS app (stays alive when &quot;closed&quot; ‚Äî menu bar icon). Scheduled agents fire while backgrounded.\n- **Future: cloud scheduling.** MVP = local only.\n\n**Review queue:**\n- Scheduled agent results enter review queue (agent dashboard)\n- User reviews + approves/rejects before applying to main workspace\n- NOT merge queue (post-MVP) ‚Äî simpler: list of completed scheduled runs awaiting review.\n\n## 10.1 CodexService\n\nCodex **linked into libsmithers** as static lib ‚Äî not child process. `src/codex_client.zig` calls Codex Zig API (from `submodules/codex/`) directly. Swift `CodexService` = thin wrapper around libsmithers C API.\n\n**Session multiplexing (study Codex source):** In-process ‚Üí multiplexing simpler. Orchestrator + all sub-agents communicate through same linked Codex lib. Each sub-agent = logical session within shared instance.\n\n**Orchestrator session (main chat):**\n- Init on app start via Codex Zig API\n- Connected to **libsmithers MCP server** (injected at runtime) ‚Üí controls IDE\n- Full visibility: workspace state, running agents, settings\n- Job: interpret intent, delegate to sub-agents\n\n**Sub-agent sessions:**\n- Created by orchestrator (Codex Zig API) as new sessions in shared instance\n- NO MCP ‚Äî only filesystem + terminal\n- Scoped to jj workspace branch\n- Run hidden until user opens tab\n\n**Startup sequence (Zig-managed):**\n1. Init Codex Zig API (in-process from `submodules/codex/`)\n2. Pass storage callbacks (`src/storage.zig` + `pkg/sqlite/`) ‚Äî replace Codex JSONL with shared SQLite\n3. Attach MCP server endpoint (runtime injection) for orchestrator\n4. Init orchestrator session via Codex Zig API\n5. If thread ID exists (SQLite lookup) ‚Üí resume, else new\n6. Register event callbacks ‚Äî Codex ‚Üí libsmithers (chat deltas, commands, file changes, turn completions)\n7. Sub-agent sessions created on-demand via Codex Zig API\n\n**Event distribution:** `CodexService` exposes `events: AsyncStream&lt;CodexEvent&gt;`. `AppModel` consumes, routes to sub-models:\n\n```swift\n// In AppModel, after starting CodexService:\nTask {\n    for await event in services.codex!.events {\n        switch event {\n        case .agentMessageDelta(let turnId, let text):\n            chat.appendDelta(text: text, turnId: turnId)\n        case .commandStarted(let turnId, let itemId, let command, let cwd):\n            chat.appendCommand(turnId: turnId, itemId: itemId, command: command, cwd: cwd)\n        case .fileChange(let turnId, let item):\n            chat.appendDiffPreview(turnId: turnId, item: item)\n            handleAIFileChange(item)\n        case .turnCompleted(let turnId, _):\n            chat.completeTurn(turnId: turnId)\n            workspace?.jj.autoSnapshot()\n        // ...\n        }\n    }\n}\n```\n\n## 10.2 Codex Zig API (In-Process, No JSON-RPC)\n\nCodex fork linked as static lib ‚Üí **NO JSON-RPC**. `src/codex_client.zig` calls Codex Zig API directly ‚Äî function calls, not serialized msgs.\n\n- **Calls:** Direct Zig function calls into Codex lib (send msg, create session, manage threads)\n- **Events:** Codex ‚Üí libsmithers via Zig callback function pointers (chat deltas, commands, file changes, turn completions)\n- **Error handling:** Zig error unions, not JSON-RPC codes\n- **Types:** Zig structs shared between `src/codex_client.zig` + Codex fork Zig API layer. Defined once in fork, imported by libsmithers.\n\n**Note:** `JSONRPCTransport` may exist for other backends (Claude Code, OpenCode) using JSON-RPC. Primary Codex integration = in-process Zig API.\n\n## 10.2.1 Shared SQLite (Codex Fork Zig API + Storage Callbacks)\n\nFork shares **same SQLite** as Smithers (`~/Library/Application Support/Smithers/smithers.db`). Wraps Codex in Zig API, accepts storage callbacks ‚Äî Codex doesn&#x27;t know SQLite.\n\n**Architecture:**\n1. Fork compiles Rust as **static lib** (not binary). Thin Zig wrapper (`submodules/codex/build.zig`) exposes **Zig-native API** libsmithers calls. ONLY thing fork does.\n2. libsmithers (`src/codex_client.zig`) calls Codex Zig API ‚Äî create sessions, send msgs, manage threads ‚Äî direct Zig function calls. No JSON-RPC, pipes, child process.\n3. Init Codex Zig API ‚Üí pass **storage callback functions** (Zig function pointers) for persistence: save_session, load_session, list_threads, delete_thread, etc. Implemented in `src/storage.zig` + `pkg/sqlite/`.\n4. Codex calls callbacks for persistence. Doesn&#x27;t know it&#x27;s SQLite ‚Äî just calls.\n5. Swift (GRDB.swift) accesses same db for UI queries. SQLite WAL mode ‚Üí concurrent access from Zig + Swift.\n\n**Why Zig API wrapper (not JSON-RPC, not C FFI vtable):**\n- **In-process** ‚Äî No child overhead, IPC latency, serialization. Codex = linked lib within libsmithers.\n- **Zig-native** ‚Äî Idiomatic Zig. libsmithers calls like any Zig module. Error handling, memory, lifetime = Zig-native.\n- **Minimal fork** ‚Äî Zig wrapper on Rust code. Rust internals mostly untouched. Easy rebase on upstream.\n- **Single artifact** ‚Äî Codex compiles into libsmithers. One binary, no external runtime deps.\n- **Storage callbacks** ‚Äî Clean dependency injection. Codex calls callbacks; we provide SQLite impl. Pattern = libghostty callbacks.\n\n**Fork maintenance:** Minimal, rebased (not merged) on upstream Codex releases. Zig API wrapper isolated from Rust internals ‚Üí upstream changes rarely conflict.\n\n**Schema ownership:** Codex (via callbacks) owns tables (sessions, threads, msgs, items). Smithers owns tables (workspace state, prefs, schedules, snapshots). Both coexist. Migrations versioned independently.\n\n## 10.3 SmithersCtlInterpreter\n\nParses CLI strings from AI, dispatches to IDE actions.\n\nCommands: `open`, `terminal`, `diff show`, `overlay`, `dismiss-overlay`, `webview open/close/eval/url`.\n\n**Arg parsing:** Manual tokenizer (splits whitespace, respects quotes). Switch on first token ‚Üí handler methods. Supports vim-style `+line:column`.\n\n**Integration:** v2 receives `AppModel` ref (not `WorkspaceState`). Calls `appModel.showInEditor()`, `appModel.workspace?.tabs.openTerminal()`, etc.\n\n## 10.4 CompletionService\n\nSeparate from CodexService. Editor ghost text completions.\n\n- 300ms debounce after keystroke\n- Send request: file path, cursor, surrounding context\n- Stream partial results ‚Üí update ghost text overlay\n- Cancellation: each keystroke increments generation counter. Stale responses discarded.\n\n## 10.5 Chat History Persistence\n\n`ChatHistoryStore` uses **SQLite (GRDB.swift)** at `~/Library/Application Support/Smithers/smithers.db`.\n\n- **Tables:** `sessions` (id, title, workspace_path, thread_id, created_at, updated_at), `messages` (id, session_id, role, kind, content, timestamp, metadata_json), `images` (id, message_id, filename, data_hash)\n- **Images** stored as files at `~/Library/Application Support/Smithers/images/&lt;hash&gt;`, referenced by hash\n- **Migrations** via GRDB&#x27;s `DatabaseMigrator`\n- **Save:** 1s debounce after msg changes. GRDB write transactions for atomicity.\n- **Load:** app launch (all sessions) + workspace open (workspace-specific). Graceful degradation on migration fail.\n- **Cleanup:** unused images pruned periodically.\n\n# Version Control (JJ)\n\n## 11. JJ\n\n**Bundled** ‚Äî `jj` binary ships in `.app` bundle, users never install. Agent orchestration, snapshots, VCS UI all depend on jj.\n\n### 11.1 JJService\n\nSpawns bundled `jj` as child process per op. Path: `Bundle.main.path(forAuxiliaryExecutable: &quot;jj&quot;)`. All `async`, `Task.detached` bg thread.\n\n**Ops:** `status()` ‚Üí `JJStatus` (mods, conflicts); `log(limit:)` ‚Üí `[JJChange]`; `diff(changeId:)` ‚Üí unified diff `String`; `commit(description:)` ‚Üí success/fail; `bookmarkList()` ‚Üí `[JJBookmark]`; `opLog(limit:)` ‚Üí `[JJOperation]`; `snapshot(description:)` ‚Üí change ID `String`; `undo()` ‚Üí success/fail; `detectVCS()` ‚Üí `VCSType` (.jjColocated, .jjNative, .gitOnly, .none); `initRepo()` ‚Üí init jj (colocated if .git exists).\n\n**Parsing:** jj `--template` flag ‚Üí JSON arrays from stdout.\n\n**Threading:** `@MainActor`. `Process` ops in `Task.detached` with captures, results ‚Üí main.\n\n### 11.2 JJSnapshotStore\n\nSQLite via GRDB `&lt;workspace&gt;/.jj/smithers/snapshots.db`.\n\n`DatabaseQueue` (thread-safe), `DatabaseMigrator` (migrations), async `withCheckedThrowingContinuation` + `DispatchQueue.global(.utility)`. Records: `Snapshot` (changeId, commitId, workspacePath, description, triggerType: aiChange/userSave/manualCommit, chatSessionId, timestamp).\n\n### 11.3 Chat integration\n\nAuto-snapshot post-AI turn (2s debounce). Snapshot on manual save (if pref enabled). Hover &quot;Revert&quot; ‚Üí `jjService.undo()`. Diff cards show unified diff.\n\n### 11.4 AgentOrchestrator\n\nParallel agents, separate jj workspaces. `createAgent(task:)` ‚Üí new jj branch, CodexService instance. Independent runs, own branch. On complete ‚Üí merge to main (MVP: simple merge, conflicts flagged). **Merge queue post-MVP** (prioritization, gates, ordering deferred).\n\n### 11.5 CommitStyleDetector\n\nReads last 30 `jjService.log(limit: 30)`. Detects: conventional (`type: description`), emoji, freeform. Returns style ‚Üí AI commits match conventions.\n\n# Skills System\n\n## 12. Skills System\n\n### 12.1 Discovery\n\n`SkillScanner` searches in priority order:\n1. `&lt;workspace&gt;/.agents/skills/` (project)\n2. `~/.agents/skills/` (user)\n3. `/etc/codex/skills/` (admin)\n4. `$CODEX_HOME/skills/.system/` (system)\n\nEach skill = directory with `SKILL.md` (YAML frontmatter: name, description, author, version, tags, allowedTools + markdown body = instructions passed to AI).\n\n### 12.2 Activation\n\nPer-chat session. Active skill instructions injected into AI context when sending messages. Status bar shows active skills, popover toggles.\n\n### 12.3 UI\n\nAll skill views = sheets from active window:\n- **SkillBrowserView** ‚Äî browse registry, search, install\n- **SkillListView** ‚Äî manage installed (enable/disable/uninstall)\n- **SkillUseView** ‚Äî activate/deactivate for current chat\n- **SkillDetailView** ‚Äî full metadata\n- **CreateSkillWizardView** ‚Äî multi-step authoring wizard\n\n# Web Application (SolidJS)\n\n## 12A. Web App (SolidJS)\n\nNative macOS = primary. **Developed in tandem**: SolidJS web app (`web/`) talks to same `libsmithers` via HTTP/WS server (`src/http_server.zig`). Every native feature also in web. Two purposes:\n\n1. **Cross-platform access** ‚Äî browser access while native stays macOS-only\n2. **E2E via Playwright** ‚Äî **primary motivation**: testable surface for backend without XCUITest\n\n### 12A.1 Stack\n\n- **SolidJS+Vite** ‚Äî reactive UI + bundler. **PWA** (installable, offline cached). SPA w/ client routing, feels native. Plain stores (`createStore`) ‚Äî mirrors Swift `@Observable`, SolidJS best practices.\n- **shadcn-solid** (hngngn/shadcn-solid) ‚Äî shadcn/ui port, unstyled accessible composable primitives\n- **Tailwind CSS** ‚Äî utility-first. Design tokens from `docs/design.md` ‚Üí Tailwind config\n- **Monaco Editor** ‚Äî VS Code component for IDE editing\n- **xterm.js** ‚Äî terminal emulator, connects PTY (libsmithers) via WS\n- **Playwright** ‚Äî e2e tests: web UI ‚Üí HTTP/WS ‚Üí libsmithers (Zig) ‚Üí Codex/JJ\n- **pnpm** ‚Äî package manager\n\n### 12A.2 Feature Parity (In Tandem)\n\n**Every native feature = web feature.** Simultaneous dev, NOT &quot;port later&quot;. Feature added to `macos/Sources/Features/Chat/` ‚Üí SolidJS in `web/src/features/Chat/` same cycle.\n\n`web/src/features/` mirrors `macos/Sources/Features/`:\n\n```\nweb/src/\n‚îú‚îÄ‚îÄ features/\n‚îÇ   ‚îú‚îÄ‚îÄ Chat/           ‚Äî sidebar, msgs, composer, slash cmds, @mention, steer\n‚îÇ   ‚îú‚îÄ‚îÄ IDE/            ‚Äî file tree, tabs, breadcrumbs, Monaco, status bar\n‚îÇ   ‚îú‚îÄ‚îÄ Agents/         ‚Äî dashboard, scheduled agents\n‚îÇ   ‚îú‚îÄ‚îÄ Terminal/       ‚Äî xterm.js (libsmithers PTY via WS)\n‚îÇ   ‚îú‚îÄ‚îÄ Settings/       ‚Äî prefs UI\n‚îÇ   ‚îî‚îÄ‚îÄ Skills/         ‚Äî browser, activation\n‚îú‚îÄ‚îÄ components/         ‚Äî shadcn-solid (Button, Dialog, Popover, etc)\n‚îú‚îÄ‚îÄ lib/\n‚îÇ   ‚îú‚îÄ‚îÄ api-client.ts   ‚Äî HTTP REST for libsmithers\n‚îÇ   ‚îú‚îÄ‚îÄ ws-client.ts    ‚Äî WS real-time (chat deltas, agent status, file changes)\n‚îÇ   ‚îú‚îÄ‚îÄ store.ts        ‚Äî SolidJS stores (createStore ‚Äî mirrors AppModel/WorkspaceModel)\n‚îÇ   ‚îî‚îÄ‚îÄ types.ts        ‚Äî Hand-maintained TS types (synced by AI + e2e tests)\n‚îú‚îÄ‚îÄ styles/\n‚îÇ   ‚îî‚îÄ‚îÄ tokens.css      ‚Äî CSS vars matching design.md ¬ß2.1 (same as prototype1)\n‚îî‚îÄ‚îÄ tests/\n    ‚îî‚îÄ‚îÄ e2e/            ‚Äî Playwright (mirrors features)\n```\n\n### 12A.3 Visual Parity\n\nWeb looks **as close to native as possible**. `prototype1/` = design ref for **both** ‚Äî same colors, spacing, layout, components. CSS vars (`--sm-base`, `--sm-surface1`, `--sm-accent`, etc) from prototype ‚Üí `tokens.css` directly.\n\n**Prototype lifecycle:** `prototype1/` = frozen ref. **Deleted** once SolidJS fully functional, replaces as visual ref.\n\n### 12A.4 Communication w/ libsmithers\n\nWeb does NOT bundle/run libsmithers. Connects to running HTTP/WS server (`src/http_server.zig`, interface #4 from ¬ß2.6). **No auth** ‚Äî localhost only.\n\n**HTTP REST:**\n`POST /api/chat/send`, `GET /api/chat/sessions`, `GET /api/workspace/files`, `POST /api/workspace/open`, `POST /api/agent/spawn`, `POST /api/terminal/create`, etc (same capability as C API, MCP, CLI)\n\n**WebSocket:**\n`ws://localhost:&lt;port&gt;/ws` ‚Äî events: chat deltas, agent status, file changes, turn completions\n`ws://localhost:&lt;port&gt;/ws/terminal/&lt;id&gt;` ‚Äî PTY I/O for xterm.js\nMirrors `CodexEvent` on Swift side\n\n### 12A.5 Playwright Testing\n\n**Primary reason web exists.** E2E coverage of libsmithers Zig core without XCUITest:\n\n```\nweb/tests/e2e/\n‚îú‚îÄ‚îÄ chat.spec.ts          ‚Äî send, receive, verify streaming\n‚îú‚îÄ‚îÄ chat-commands.spec.ts ‚Äî slash, @mentions, steer\n‚îú‚îÄ‚îÄ file-tree.spec.ts     ‚Äî open workspace, browse, Monaco\n‚îú‚îÄ‚îÄ editor.spec.ts        ‚Äî edit, save, persist\n‚îú‚îÄ‚îÄ terminal.spec.ts      ‚Äî xterm, run cmd, verify output\n‚îú‚îÄ‚îÄ agents.spec.ts        ‚Äî spawn, monitor, complete\n‚îú‚îÄ‚îÄ jj.spec.ts            ‚Äî VCS ops, snapshots, undo\n‚îî‚îÄ‚îÄ skills.spec.ts        ‚Äî activate, modified prompts\n```\n\n**Strategy:** Tests run against real libsmithers (not mocks). Validates: SolidJS ‚Üí HTTP/WS ‚Üí Zig ‚Üí Codex/JJ. Combined w/ Zig unit + Swift XCUITests = three layers.\n\n**CI (once wired):** `zig build playwright` starts HTTP server ‚Üí `pnpm exec playwright test` ‚Üí teardown\n\n### 12A.6 Build Integration\n\n- Planned build steps (add to `build.zig`):\n  - `zig build web` ‚Üí `cd web &amp;&amp; pnpm install &amp;&amp; pnpm build`\n  - `zig build dev` includes web step\n  - `zig build playwright` ‚Üí build web + start HTTP + run tests\n- Until wired, run the `pnpm` commands directly in `web/`.\n- HTTP server serves built static files directly (no separate web server)\n\n# Localhost Security Posture\n\nHTTP/WS server runs with no auth. This is intentional for a power-user tool but the security contract must be explicit.\n\n## Binding\n\n- **MUST bind to `127.0.0.1` only.** NEVER `0.0.0.0` or `::`.\n- Use a random high port (ephemeral range 49152-65535) by default.\n- If a fixed port is configured, warn at startup if another process is already bound.\n\n## Access Control\n\n- No authentication required for localhost connections (YOLO mode).\n- Optional per-session token: if enabled, passed via `Authorization: Bearer &lt;token&gt;` header or `?token=&lt;token&gt;` query param. Token generated at server start, printed to stdout.\n- Token mode is opt-in via config. Default: no token (localhost trust model).\n\n## Filesystem Scope\n\n- Server MUST NOT read/write outside the workspace root unless explicitly enabled via config.\n- Workspace root = directory containing `.jj/`, `.git/`, or `CLAUDE.md` (walked upward from cwd).\n- Terminal PTY sessions inherit workspace root as cwd.\n\n## Future: Sandbox Mode\n\n- Post-MVP: sandboxed execution (filesystem allowlist, network restrictions, process limits).\n- Current MVP: YOLO mode only. No sandbox.\n\n## Threat Model\n\n| Threat | Mitigation |\n|--------|-----------|\n| Remote access to API | Bind 127.0.0.1 only |\n| Other local users on shared machine | macOS user isolation (default); optional token |\n| Malicious web page accessing API | CORS: reject non-localhost origins |\n| Path traversal | Restrict to workspace root |\n\n# Design System Implementation\n\n## 13.1 Token Definitions\n\nAll tokens in `SmithersDesignSystem/Tokens/`. Static constants on namespaced enums:\n\n```swift\nenum DS {\n    enum Color {\n        static let base = NSColor(hex: &quot;#0F111A&quot;)!\n        static let surface1 = NSColor(hex: &quot;#141826&quot;)!\n        static let surface2 = NSColor(hex: &quot;#1A2030&quot;)!\n        static let border = NSColor.white.withAlphaComponent(0.08)\n        static let accent = NSColor(hex: &quot;#4C8DFF&quot;)!\n        // ... all tokens from design spec 2.1\n    }\n    enum Type {\n        static let xs: CGFloat = 10\n        static let s: CGFloat = 11\n        static let base: CGFloat = 13\n        static let l: CGFloat = 15\n        static let xl: CGFloat = 20\n        static let chatHeading: CGFloat = 28\n        // ... all from design spec 2.5\n    }\n    enum Space {\n        static let _4: CGFloat = 4\n        static let _6: CGFloat = 6\n        static let _8: CGFloat = 8\n        // ... through _32\n    }\n    enum Radius {\n        static let _4: CGFloat = 4\n        static let _6: CGFloat = 6\n        // ... through _16\n    }\n}\n```\n\n## 13.2 AppTheme\n\nStruct with all resolved colors for current appearance (dark/light). Injected via custom `EnvironmentKey`.\n\n```swift\nstruct AppTheme: Equatable {\n    let background: NSColor\n    let foreground: NSColor\n    let mutedForeground: NSColor\n    let secondaryBackground: NSColor\n    // ... 24+ color properties\n\n    static let dark = AppTheme(...)   // default dark\n    static let light = AppTheme(...)  // derived light\n}\n\nprivate struct ThemeKey: EnvironmentKey {\n    static let defaultValue = AppTheme.dark\n}\n\nextension EnvironmentValues {\n    var theme: AppTheme {\n        get { self[ThemeKey.self] }\n        set { self[ThemeKey.self] = newValue }\n    }\n}\n```\n\nViews access via `@Environment(\\.theme) private var theme`.\n\n## 13.3 Light Theme Derivation\n\nPer design spec 2.4:\n\n```swift\nextension AppTheme {\n    static var light: AppTheme {\n        AppTheme(\n            background: NSColor(hex: &quot;#F6F7FB&quot;)!,\n            foreground: NSColor.black.withAlphaComponent(0.88),\n            mutedForeground: NSColor.black.withAlphaComponent(0.60),\n            secondaryBackground: NSColor(hex: &quot;#FFFFFF&quot;)!,\n            panelBackground: NSColor(hex: &quot;#EEF1F7&quot;)!,\n            border: NSColor.black.withAlphaComponent(0.10),\n            accent: DS.Color.accent,  // same accent both themes\n            // Hover: black@3-4% instead of white\n            // Chat bubbles: assistant ‚Üí black@4%, user ‚Üí accent@12%\n            // ...\n        )\n    }\n}\n```\n\n## 13.4 Neovim Theme Derivation\n\n`ThemeDerived.fromNvimHighlights()` takes Neovim highlight group colors ‚Üí maps to `AppTheme`:\n\n- `Normal.bg` ‚Üí `background`, `Normal.fg` ‚Üí `foreground`\n- `Visual.bg` ‚Üí `selectionBackground`\n- `CursorLine.bg` ‚Üí `lineHighlight`\n- `TabLine*` ‚Üí tab bar colors\n- `Pmenu*` ‚Üí panel colors\n- `LineNr` / `CursorLineNr` ‚Üí line number colors\n- Missing groups: derive via alpha blending from background + foreground.\n\n## 13.5 Shared Components\n\nAll in `SmithersDesignSystem/Components/`, read theme from environment. Purely presentational ‚Äî no business logic, no dependencies on models/services.\n\n# Keyboard Shortcuts &amp; Input\n\n## 14. Keyboard\n\n### 14.1 Global (both windows)\n\n`.commands { }` in `SmithersApp`:\n\n| Shortcut | Action | Impl |\n|----------|--------|------|\n| Cmd+S | Save file | `appModel.workspace?.saveCurrentFile()` |\n| Cmd+Shift+S | Save all | `appModel.workspace?.saveAllFiles()` |\n| Cmd+Shift+O | Open folder | Open panel ‚Üí `appModel.openDirectory(url)` |\n| Cmd+P | Go to file | Open workspace if needed ‚Üí command palette |\n| Cmd+Shift+F | Search | Open workspace if needed ‚Üí search panel |\n\n### 14.2 Chat window\n\n| Shortcut | Action | Impl |\n|----------|--------|------|\n| Return | Send | Composer `.onSubmit` |\n| Shift+Return | Newline | Default multiline TextField |\n| Cmd+N | New chat | `appModel.workspace?.chat.createNewSession()` |\n| Cmd+V | Paste image | `.onPasteCommand(of: [UTType.image])` |\n| Esc | Interrupt/defocus | Streaming: `chat.interruptTurn()`. Else: `@FocusState = false` |\n\n### 14.3 Workspace panel\n\n| Shortcut | Action | Impl |\n|----------|--------|------|\n| Cmd+B | Toggle sidebar | NavigationSplitView visibility |\n| Cmd+` | New terminal | `workspace?.tabs.openTerminal()` |\n| Cmd+Shift+N | Toggle Neovim | `services.nvim?.toggle()` |\n| Cmd+/ | Shortcuts panel | `showShortcutsPanel.toggle()` |\n\n### 14.4 Tmux prefix\n\n`TmuxKeyHandler` monitors `NSEvent.addLocalMonitorForEvents`. Ctrl+A ‚Üí prefix mode, wait follow-up:\n\n`c` = new terminal; `n` = next tab; `p` = prev tab; `1-9` = tab by index; `&amp;` = close tab; `z` = zoom terminal; `|` = split vert; `-` = split horiz.\n\nTimeout 1s ‚Üí cancel. Show &quot;Prefix&quot; in status bar during mode.\n\n**Critical TUI-native.** tmux users expect identical bindings. Terminal one keystroke: Ctrl+A c.\n\n### 14.5 Responder chain\n\nMulti-window routing: global (Cmd+S, Cmd+Shift+O) in `.commands { }` work regardless focus. Window-specific (Cmd+B IDE, Return chat) via focused responder chain.\n\n`NSEvent.addLocalMonitorForEvents` tmux keys work all windows. Terminal tab Ctrl+A intercepted (not passed) ‚Äî tmux behavior.\n\n### 14.6 TUI philosophy\n\nEvery action no-mouse. Nav flow: **Ctrl+A c** = terminal (always); **Cmd+`** = terminal (macOS alt); **Cmd+P** = palette (files, commands, settings); **Cmd+K** = chat composer (any window); **Esc** = dismiss/prev context; **Tab/Shift+Tab** = cycle panes.\n\nGoal: mouse-free users at home.\n\n# Testing Strategy\n\n## 15. Testing Strategy\n\n### 15.1 Unit Tests (swift test)\n\nZig: `zig build test`. Swift: `swift test` (if SwiftPM targets exist) or `xcodebuild test` (Xcode project).\n\n**SmithersModelsTests:** FileItem lazy loading+tree mutation; ChatMessage serialization; DiffModels/JJModels parsing; Preference defaults+validation\n\n**SmithersServicesTests:** JJService output parsing (mock strings); CommitStyleDetector; SkillScanner (mock fs); ChatHistoryStore round-trip; JSONRPCTransport framing (for JSON-RPC providers); SmithersCtlInterpreter parsing\n\n**SmithersEditorTests:** SupportedLanguages ext mapping; BracketMatcher; fuzzy search scoring\n\n### 15.2 Integration Tests\n\nRequire running services/UI frameworks. Still `swift test`, may need `@MainActor`.\n\nCodexService (mock transport, verify events); JJSnapshotStore (in-mem SQLite); SearchService (mock ripgrep)\n\n### 15.3 UI Tests (XCUITest)\n\n`zig build ui-test` (once wired) or `xcodebuild test` with UI test scheme. Requires Xcode project+UI test target.\n\n**Chat:** Launch ‚Üí verify window; send msg ‚Üí verify in list; new chat ‚Üí verify in sidebar; switch modes\n**Workspace:** Open dir ‚Üí verify tree; select file ‚Üí verify editor; cmd palette ‚Üí search/open; verify tab bar\n**Cross-window:** Click &quot;Open Editor&quot; ‚Üí verify panel; AI file change ‚Üí opens panel (if pref enabled)\n**Screenshots:** `XCTAttachment` for visual review. Extract from `.xcresult` via `xcrun xcresulttool`.\n\n### 15.4 Playwright E2E (Web App)\n\n**Primary reason web app exists** ‚Äî exercises full libsmithers Zig core e2e via web UI. Comprehensive integration without XCUITest/macOS sim.\n\n**Run (once wired):** `zig build playwright` (start HTTP server ‚Üí run tests ‚Üí teardown)\n\n**Suites** (`web/tests/e2e/`):\nChat (send, stream, render); slash cmds, @mentions, steer; file tree (open workspace, browse, Monaco); editor (edit, save, persist); terminal (xterm.js, run cmd, PTY WS); agents (spawn, monitor, complete); JJ (ops, snapshots, undo); skills (activate, modified prompts)\n\n**Three layers:**\n1. Zig unit (`zig build test`) ‚Äî fast, no deps\n2. Playwright e2e (`zig build playwright` once wired) ‚Äî full stack via web\n3. XCUITest (`zig build ui-test` once wired) ‚Äî native macOS UI\n\nMock/replay (¬ß15.5) used by all three.\n\n### 15.5 Mock/Replay Infrastructure\n\nApp depends on `codex-app-server`, tests work without live AI:\n\n- **MockJSONRPCTransport** ‚Äî Same interface as `JSONRPCTransport`, reads recorded sessions for JSON-RPC providers. Records = JSON `{request, response, delay}` arrays.\n- **Recording** ‚Äî `SMITHERS_RECORD_PROVIDER=1` env ‚Üí `JSONRPCTransport` writes session file during normal op.\n- **Replay** ‚Äî `MockJSONRPCTransport` plays back w/ realistic timing (10x compressed). Used in unit+XCUITests.\n- **Stub** ‚Äî For in-process Codex, use `StubCodexService` or libsmithers event fixtures.\n\n### 15.6 Enterprise Quality Standards\n\nProduction software for enterprise:\n\n- **Error handling:** Every async op has handling w/ user feedback. No silent fails. Categorize (recoverable/fatal), present appropriately (toast transient, alert blocking).\n- **Logging:** `os_log`, subsystem `com.smithers`, categories per domain (`.codex`, `.jj`, `.editor`, `.terminal`). Levels: `.debug` internal, `.info` user actions, `.error` fails, `.fault` invariant violations. Viewable via Console.app, captured in crash reports.\n- **Crash reporting:** Integrate symbolication. Catch/report `fatalError`/`preconditionFailure`.\n- **Performance:** `os_signpost` for key ops (file open, tree parse, msg send, jj refresh). Track cold launch, time-to-first-chat, syntax highlight latency.\n- **Memory:** Profile w/ Instruments. No retain cycles in model graph. Weak refs for delegates/coordinators. Large content (file bodies, images) lazy loaded, released on tab close.\n- **Accessibility:** Every element has identifier, label, role. VoiceOver navigates full app. NOT optional ‚Äî enterprise requirement.\n\n### 15.7 CI/CD (GitHub Actions)\n\nmacOS runners, full pipeline:\n\n- **Zig:** `zig build test` ‚Äî every PR, fast\n- **Swift:** `zig build xcode-test` (once wired) or `xcodebuild test` ‚Äî macOS runner\n- **Playwright e2e:** `zig build playwright` (once wired) ‚Äî HTTP server + real libsmithers\n- **Native UI:** `zig build ui-test` (once wired) ‚Äî XCUITest, macOS runner\n- **Web build:** `zig build web` (once wired) ‚Äî compile check\n- **Rust submodules:** Built in `zig build test` (Codex+JJ linked)\n\nValidates polyglot monorepo: Zig, Rust (cargo), Swift (xcodebuild), TypeScript/SolidJS (pnpm+Playwright).\n\n# Migration &amp; Reference\n\n## 16. Migration &amp; Reference\n\n### 16.0 v1 location\n\n`../smithers/apps/desktop/` ‚Äî ~92 Swift files, ~31K LOC:\n\n- **Chat/AI** (`CodexService.swift`, `ChatView.swift`, `ChatHistoryStore.swift`) ‚Äî v1 JSON-RPC stdio; v2 in-process Zig. JSONRPCTransport remains only for non-Codex providers. Study event patterns, rendering.\n- **Agent orchestration** (`AgentOrchestrator.swift`) ‚Äî parallel jj workspaces, merge queue\n- **JJ** (`JJService.swift`, `JJPanelView.swift`, `JJSnapshotStore.swift`) ‚Äî VCS panel, snapshots\n- **Terminal/Ghostty** (`GhosttyApp.swift`, `GhosttyTerminalView.swift`) ‚Äî C FFI singleton, surface lifecycle, frame scheduling\n- **Neovim** (`NvimController.swift`, `NvimRPC.swift`) ‚Äî MessagePack RPC, buffer sync, ext UI\n- **Editor** (`MultiCursorTextView.swift`, `SyntaxHighlighting.swift`) ‚Äî STTextView, TreeSitter\n- **Skills** (`SkillScanner.swift`, views) ‚Äî discovery, activation, wizard\n- **IPC** (`SmithersCtlInterpreter.swift`, `SmithersIPCServer.swift`) ‚Äî Unix socket, parsing\n\nv1: 7.1K-line `WorkspaceState` god object, 2.5K-line `ContentView`. v2 decomposes. Services/integrations = excellent reference. **Study patterns, don&#x27;t copy-paste.**\n\n### 16.1 v1 study guide\n\nReference (not copy-paste) patterns:\n\n| v1 | Study | v2 |\n|---|---|---|\n| `GhosttyApp.swift` | C FFI singleton, callbacks, tick sched | `Terminal/GhosttyApp.swift` |\n| `GhosttyTerminalView.swift` | NSView lifecycle, userdata, frame sched | `Terminal/GhosttyTerminalView.swift` |\n| `GhosttyInput.swift` | Key map, Option-as-Meta | `Terminal/GhosttyInput.swift` |\n| `NvimRPC.swift` | MessagePack codec | `Neovim/NvimRPC.swift` |\n| `NvimController.swift` | Socket RPC, UI attach, autocmd | `Neovim/NvimController.swift` |\n| `JSONRPCTransport.swift` | Pipe JSON-RPC, correlation, async | `Services/JSONRPCTransport.swift` (external providers). Codex uses `src/codex_client.zig` (in-process Zig API). |\n| `CodexService.swift` | Events, threads, notifications | `Services/CodexService.swift` ‚Üí `src/orchestrator.zig` |\n| `SmithersCtlInterpreter.swift` | Parsing, vim +line:col | `Services/SmithersCtlInterpreter.swift` |\n| `SyntaxHighlighting.swift` | TreeSitter pipeline, cancellation, registry | `Editor/TreeSitterHighlighter.swift` |\n| `ContentView.swift` (editor) | STTextView NSViewRep, Coordinator, state | `Editor/CodeEditorView.swift` |\n| `MultiCursorTextView.swift` | STTextView subclass, multi-cursor undo | `Editor/MultiCursorTextView.swift` |\n| `GhostTextOverlayView.swift` | NSView overlay, NSLayoutManager | `Editor/GhostTextOverlayView.swift` |\n| `ScrollbarOverlayView.swift` | Custom NSView scrollbar, drawing, hit test | `Editor/ScrollbarOverlayView.swift` |\n| `JJService.swift` | CLI invoke, template JSON parse | `Services/JJService.swift` ‚Üí `src/jj.zig` |\n| `JJSnapshotStore.swift` | GRDB, migration, async | `Services/JJSnapshotStore.swift` |\n| `SmithersIPCServer.swift` | NWListener socket, wait-close | `Services/IPCServer.swift` |\n| `CloseGuard.swift` | NSWindowDelegate, async confirm, bypass | `App/CloseGuard.swift` |\n| `WindowFrameStore.swift` | Per-workspace frame, screen adjust | `Services/WindowFrameStore.swift` |\n| `AppTheme.swift` | Theme, hex parse, Neovim derive | `DesignSystem/Theme/AppTheme.swift` |\n| `ChatHistoryStore.swift` | SHA256 hash, image storage, version | `Services/ChatHistoryStore.swift` |\n\n### 16.2 NOT carry forward\n\n- **WorkspaceState.swift** ‚Äî 7.1K-line god object. Decompose ‚Üí AppModel + WorkspaceModel + sub-models. (God object pattern OK, 7K-line file not.)\n- **ContentView.swift** ‚Äî 2.5K monolith. Split ‚Üí IDEWorkspaceDetailView, CodeEditorView, IDETabBar, BreadcrumbBar, IDEStatusBar.\n- **`ObservableObject` + `@Published`** ‚Üí replaced `@Observable`.\n- **Single-window** ‚Üí multi-window scene-based (Chrome DevTools style).\n- **SmithersShared compiled both targets** ‚Üí v2 shared in `macos/Sources/`, single Xcode target. Zig core handles logic.\n- **Hardcoded welcome** ‚Üí AI-generated workspace-aware (`SuggestionService`).\n- **External binaries** ‚Äî v1 PATH lookup. v2 builds codex-app-server, jj from source (submodules), bundles in `.app`. Users install Smithers only.\n\n---\n\n## 18. v1 Features (297 commits, ~250 features)\n\nUnder-specified features from v1 audit (others covered earlier):\n\n### 18.1 Auto-update\nSparkle `SPUStandardUpdaterController` ‚Üí `UpdateController.swift`. Channels: Release/Snapshot enum `UpdateChannel` (UserDefaults) ‚Üí feed URL. Manual &quot;Check for Updates...&quot; menu. Feed URL per-channel Info.plist, Snapshot = pre-release.\n\n### 18.2 URL schemes\n`smithers://`, `smithers-open-file://`, `smithers-chat://` registered Info.plist. External opens (Finder, CLI, URL) ‚Üí `ExternalOpenRequest` batch. Pending queue if pre-workspace, process on load. Workspace root inferred from file hierarchy.\n\n### 18.3 File ops\nCreate file/folder (tree context). Rename inline. Delete ‚Üí Trash (not permanent). Non-UTF-8 detection ‚Üí read-only placeholder, no save/auto-save.\n\n### 18.4 Auto-save\nIntervals: 5s, 10s, 30s. Toggle prefs. Toast on save. Guard: never non-UTF-8.\n\n### 18.5 Session persist\nTabs + selected + sidebar widths per workspace. Terminal state across restarts. Last workspace on launch. Chat session ID ‚Üí thread resume. Editor state (scroll, selection) per file. Shortcuts panel visibility. Sidebar mode (Chats/Source/Agents). Debounced on changes, explicit on close.\n\n### 18.6 Perf monitor (debug)\n`PerformanceMonitor` singleton: FPS, frame, render, highlight, glyph cache. `PerformanceOverlayView` debug HUD. Log JSON. Toggle prefs (debug only). Instrumented: highlight, Ghostty render, glyph cache.\n\n### 18.7 Pinch-zoom\nEditor magnification gesture, live preview, temp font size adjust.\n\n### 18.8 Press-hold disable\n`PressAndHoldDisabler` ‚Äî disable macOS accent popup ‚Üí key repeat works (editor/terminal). Required vim nav.\n\n# Implementation Phases\n\n## 17. Phases\n\n### Phase 0: Scaffold (1 session)\n- New repo Ghostty structure\n- Dirs: `src/` (Zig), `pkg/` (vendored C), `include/`, `macos/` (Swift), `web/` (SolidJS)\n- `build.zig`: compile libsmithers stub ‚Üí `include/libsmithers.h` ‚Üí xcframework ‚Üí Swift app ‚Üí launch\n- `macos/Smithers.xcodeproj` real Xcode (no Package.swift, no xcodegen)\n- Init submodules `submodules/codex/`, `submodules/jj/` (EVMTS forks)\n- Copy `GhosttyKit.xcframework` ‚Üí `macos/`\n- Vendor SQLite `pkg/sqlite/` + Zig build wrapper\n- `include/libsmithers.h`: opaque types, action enum, callbacks\n- `src/lib.zig`: CAPI block `smithers_app_new`, `smithers_app_free`, `smithers_app_action`\n- `src/memory.zig`: arena helpers, lifetime patterns\n- `src/storage.zig`: storage trait + SQLite impl\n- `macos/Sources/Ghostty/SmithersCore.swift`: Unmanaged/callback pattern\n- `macos/Sources/Ghostty/MockSmithersCore.swift`: mock for parallel UI dev\n- Verify `zig build` passes (and `zig build dev` once wired) for empty app + libsmithers linked\n- Verify `zig build test` and Swift tests (`xcodebuild test`, or `swift test` if SwiftPM exists) run (placeholder tests)\n\n### Phase 1: Design system + window shell (2-3 sessions)\n- `DesignSystem/`: tokens, AppTheme, shared components (IconButton, PrimaryButton, PillButton, Badge, Panel, SidebarListRow)\n- `App/`: AppModel, WindowCoordinator, scenes (chat window + workspace panel)\n- Chat window always present, workspace opens/closes/hides\n- Frame persistence\n- Bundled binaries load (codex-app-server, jj)\n- Preferences model (UserDefaults, no UI)\n- Verify: launch ‚Üí themed chat, open/close workspace\n\n### Phase 2: Chat window (3-4 sessions)\n- `Models/`: ChatMessage, ChatSession, ChatModel\n- `Views/Chat/`: sidebar (mode bar, sessions), detail (messages, composer, welcome)\n- `Services/`: CodexService (in-process), JSONRPCTransport (non-Codex), SuggestionService\n- Wire: send ‚Üí CodexService ‚Üí stream ‚Üí ChatModel ‚Üí render\n- Chat history persistence\n- Bubbles: user, assistant, command, diff preview, status, starter\n- AI welcome suggestions (workspace-aware / generic)\n- Image paste/drop + fullscreen viewer\n- Hover action bar\n- Verify: full chat e2e (with/without workspace)\n\n### Phase 3: Workspace ‚Äî file tree + editor (3-4 sessions)\n- `Models/`: FileItem, TabItem, EditorViewState, FileTreeModel, TabModel, EditorStateModel\n- `Editor/`: CodeEditorView, MultiCursorTextView, TreeSitterHighlighter, overlays (cursors, ghost, scrollbar, indent, brackets)\n- `Views/IDE/`: FileTreeSidebar, IDETabBar, BreadcrumbBar, IDEContentArea, IDEStatusBar\n- `Services/SearchService`\n- Wire: open folder ‚Üí tree ‚Üí select ‚Üí editor + highlight ‚Üí save\n- Tabs: open, close, reorder, context\n- Command palette (Cmd+P), search (Cmd+Shift+F), shortcuts (Cmd+/)\n- Verify: IDE e2e ‚Äî open, browse, edit, save\n\n### Phase 4: Cross-window (1-2 sessions)\n- `showInEditor()`: chat &quot;Open&quot; ‚Üí workspace opens file@line\n- AI changes ‚Üí diff in chat + optional auto-open workspace\n- `SmithersCtlInterpreter` wired\n- IPC server (Unix socket)\n- SmithersCLI target\n- Verify: AI change ‚Üí diff ‚Üí click ‚Üí workspace scrolls\n\n### Phase 5: Terminal (1-2 sessions)\n- `Terminal/`: GhosttyApp, GhosttyTerminalView, GhosttyInput, GhosttyFrameScheduler\n- Terminal tabs in workspace\n- Terminal from chat (smithers-ctl)\n- Verify: open tab, run, shell works\n\n### Phase 6: Neovim (2-3 sessions)\n- `Neovim/`: NvimController, NvimRPC\n- NvimExtUIOverlay (cmdline, popup, messages, floats)\n- Bidirectional buffer sync, theme derivation, crash recovery\n- Verify: toggle, edit, save, switch, theme syncs\n\n### Phase 7: JJ + agents (2-3 sessions)\n- `Services/`: JJService, JJSnapshotStore, CommitStyleDetector, AgentOrchestrator\n- `Models/`: JJ, Agent, multi-workspace\n- JJ panel sidebar (working copy, log, bookmarks, ops, snapshots)\n- Agent dashboard sidebar\n- Auto-snapshot post-AI, revert from chat\n- Verify: VCS status, snapshots, spawn agents\n\n### Phase 8: Skills + settings + polish (2-3 sessions)\n- Skills: scanner, registry, installer, views\n- SettingsView all categories\n- Toast, progress bar, close guards (tab/window/app)\n- Tmux handler, update (Sparkle), diff viewer (tabs + sheets), light theme\n- Verify: v1 feature parity\n\n### Phase 9: Zig core (parallel 1-8)\nParallel with Swift. **TDD** ‚Äî `zig build test` coverage before Swift hooks up.\n\n**Priority** (portable ‚Üí UI-coupled):\n1. `src/memory.zig` ‚Äî arena helpers, lifetimes, owned-return\n2. `src/storage.zig` ‚Äî trait + SQLite (`pkg/sqlite/`). Critical ‚Äî Codex fork depends on it.\n3. `src/codex_client.zig` ‚Äî in-process Codex Zig API. Mock-tested.\n4. `src/orchestrator.zig` ‚Äî chat delegation, MCP dispatch\n5. `src/mcp_server.zig` ‚Äî Codex ‚Üî IDE bridge\n6. `src/agent.zig` ‚Äî sub-agent lifecycle, arena-per-agent\n7. `src/jj.zig` ‚Äî CLI wrapper, JSON parse. Mock output tests.\n8. `src/chat_state.zig` ‚Äî session state, routing\n9. `src/http_server.zig` ‚Äî HTTP/WS for web app\n10. `src/scheduler.zig` ‚Äî cron-like bg agent runner\n11. `src/search.zig` ‚Äî ripgrep wrapper\n12. `src/file_watcher.zig` ‚Äî FSEvents (macOS)\n13. `src/suggestion.zig` ‚Äî AI suggestion gen\n14. `src/snapshot.zig` ‚Äî JJ snapshot mgmt\n15. `src/ipc.zig` ‚Äî smithers-ctl protocol\n\n**TDD:** Zig ‚Üí tests ‚Üí C header ‚Üí Swift bridge ‚Üí verify vs mock. Swift uses `MockSmithersCore` until real ready.\n\n### Phase 10: Test + a11y + perf (2-3 sessions)\n- Mock/replay infra (MockJSONRPCTransport for external providers, Codex stubs/fixtures)\n- Unit tests all models/services\n- XCUITests both windows (replay)\n- A11y identifiers, labels, tooltips (enterprise req)\n- Logging (os_log), perf (os_signpost)\n- Instruments: view invalidations, leaks, slow highlighting\n- Optimize: chat streaming (append-only, no full re-parse), file tree (virtualize large)\n- Verify: tests pass, VoiceOver, no v1 regressions\n\n## Project Conventions (CLAUDE.md)\n\n# Smithers v2 ‚Äî The Ultimate UX for Agentic Coding\n\nA native macOS IDE (Swift/SwiftUI) that *feels* like a TUI but has the UX of a GUI. Not a terminal app ‚Äî a Swift app designed for terminal power-users. One keystroke from a real terminal (GhosttyKit), Neovim mode for file editing, tmux shortcuts everywhere. Iterating on Claude Code via GUI without losing what terminal users love.\n\n## Project Structure (mirrors Ghostty)\n\n- `src/` - Zig source (libsmithers ‚Äî the portable logic layer)\n- `pkg/` - Vendored C/C++ deps with Zig build wrappers (SQLite, Zap/facil.io, TreeSitter)\n- `include/` - C API header (libsmithers.h ‚Äî THE contract between Zig and Swift)\n- `macos/` - Swift app (Xcode project, feature-based organization)\n- `web/` - SolidJS Vite PWA (developed in tandem, visual parity with native app)\n- `submodules/codex/` - EVMTS fork: wraps Codex in a Zig API + storage callbacks. Rebased on upstream.\n- `submodules/jj/` - EVMTS fork of Jujutsu (no code changes, Zig build wrapper)\n- `build.zig` / `build.zig.zon` - Builds EVERYTHING. Zig is the monorepo build tool.\n- `prototype0` ‚Üí symlink to `../smithers/apps/desktop` (v1 Swift app reference)\n- `prototype1/` - Next.js UI prototype (frozen design reference for both native + web, delete when done)\n- `issues/` - Feature specs (take features literally, NOT implementation details ‚Äî stale from v1)\n- `scripts/smithers-workflow/` - Automated workflow (3 AI agents build the product e2e)\n\n## Architecture Overview\n\n**libsmithers** (Zig core) exposes five interfaces, all backed by the same capability surface:\n1. **C API** ‚Üí consumed by Swift UI layer via xcframework (libghostty pattern)\n2. **MCP server** ‚Üí injected into Codex at runtime\n3. **CLI** (`smithers-ctl`) ‚Üí consumed by shell/scripts/user\n4. **HTTP/WebSocket server** ‚Üí consumed by SolidJS web app + Playwright tests. Uses Zap (`pkg/zap/`). No auth.\n5. **Zig API** ‚Üí internal\n\n**Key principle:** Tools in the CLI = command palette = MCP server = HTTP API. One capability surface, multiple access methods.\n\n## Codex Fork ‚Äî Zig API Wrapper (In-Process, No JSON-RPC)\n\nEVMTS fork at `submodules/codex/`. The fork does ONE thing: **wraps the entire Codex in a Zig API**. Codex compiles as a static library and is linked directly into libsmithers. No child process, no JSON-RPC, no pipes. Storage callbacks (Zig function pointers) passed in at init ‚Äî our Zig implementation (`src/storage.zig` + `pkg/sqlite/`) writes to shared SQLite. Codex doesn&#x27;t know about SQLite. Fork rebased on upstream.\n\n## Web App (SolidJS Vite PWA) ‚Äî Developed in Tandem\n\n**Every feature in the native app is also in the web app.** SolidJS + Vite PWA + shadcn-solid + Tailwind + Monaco + xterm.js. Plain SolidJS stores. Hand-maintained TypeScript types (AI + e2e tests keep in sync). pnpm package manager.\n\n**Playwright tests are a primary reason for the web app** ‚Äî e2e tests exercise full Zig core through web UI.\n\n## Execution Mode\n\n**YOLO mode only.** No approvals, no sandbox. Future: sandboxing.\n\n## Project Config Files\n\nReads: `AGENTS.md` (preferred), `CLAUDE.md`, and skills from workspace.\n\n## Dependency Strategy\n\n- **Zig/C deps:** Vendor in `pkg/` with Zig build wrappers (SQLite, Zap, TreeSitter)\n- **Rust deps:** Git submodules in `submodules/` ‚Äî compiled as static libs, linked into libsmithers\n- **Swift deps:** Xcode&#x27;s built-in SPM (Sparkle, STTextView, GRDB.swift)\n- **Web deps:** pnpm in `web/` (SolidJS, Vite, shadcn-solid, Tailwind, Monaco, xterm.js, Playwright)\n- **Monorepo tool:** `build.zig` orchestrates everything. No Turborepo/Nx.\n\n## Build\n\n```bash\nzig build            # Build everything wired in build.zig\nzig build run        # Build + run CLI (current)\nzig build test       # Zig unit tests\nzig build all        # Build + tests + fmt/lint (canonical green check)\n\n# Planned (once build.zig defines these steps):\n# zig build dev        # Build everything + launch\n# zig build web        # Build web app only\n# zig build playwright # Build web + start HTTP server + run Playwright e2e tests\n# zig build codex      # Build codex static lib only\n# zig build jj         # Build jj only\n# zig build xcode-test # Swift tests\n# zig build ui-test    # XCUITest e2e\n```\n\n## CI/CD\n\nGitHub Actions with macOS runners. Full pipeline: Zig tests ‚Üí Rust submodule builds ‚Üí Swift tests ‚Üí Playwright e2e ‚Üí web build.\n\nIMPLEMENTATION PHASE ‚Äî Ticket: chat-streaming-bridge ‚Äî Wire Swift chat composer to libsmithers and render streaming\n\nImplement FULLY end-to-end. Do NOT stop until fully implemented + ALL tests pass.\n\nTICKET DESCRIPTION:\n\nImplement a Swift-side SmithersCore wrapper that owns smithers_app_t, installs runtime callbacks, and forwards events to a minimal @Observable ChatModel. Update ChatWindowRootView to bind MessagesZone + ChatComposerZone to ChatModel and call smithers_app_action(SMITHERS_ACTION_CHAT_SEND) on Return. Render assistant deltas live on SMITHERS_EVENT_CHAT_DELTA and finalize on SMITHERS_EVENT_TURN_COMPLETE. Use the existing Zig codex_client stub for streaming; no real provider yet.\nACCEPTANCE CRITERIA:\n\nPressing Return in composer sends SMITHERS_ACTION_CHAT_SEND\n- Assistant messages stream in-place (‚â•2 deltas) then finalize\n- No UI regressions: window chrome and design tokens intact\n- Thread-safe callback handling (main-actor UI updates)\n- zig build all remains green; xcode project builds cleanly\nPLAN:\nRead plan: docs/plans/chat-streaming-bridge.md\nRead research context: docs/context/chat-streaming-bridge.md\n\nBEFORE CODING:\n\n- Explore codebase first. Read existing files relevant to ticket.\n\n- Understand existing patterns, naming conventions, architecture.\n\n- For plan ambiguities, explore codebase to resolve.\n\n- If plan wrong or needs adjustment, document why + what you&#x27;re doing differently.\n\n- Read Ghostty source for code style + pattern reference.\n\nIMPLEMENTATION RULES:\n\n- Implement plan FULLY ‚Äî nothing unfinished\n\n- Order: plan doc (docs/plans/) FIRST ‚Üí tests SECOND (TDD) ‚Üí implementation THIRD ‚Üí user-facing docs LAST (after tests green)\n\n- **ALL commits go directly on `main`. NEVER create branches. Stay on `main`.**\n\n- Atomic git commits: ‚ú® feat, üß™ test, üêõ fix, üìã docs, ‚ôªÔ∏è refactor, ‚ö° perf, üîß chore\n\n- After implementing, run ALL relevant tests:\n\n- zig build all (canonical; runs all wired checks)\n\n- If `xcode-test` / `ui-test` steps are wired: run them, otherwise `xcodebuild test`\n\n- If `playwright` step is wired: run it, otherwise `cd web &amp;&amp; pnpm test &amp;&amp; pnpm exec playwright test`\n\n- If tests fail, fix before moving on. NEVER leave failing tests.\n\n- If pre-existing test failures found, fix those too. Codebase ALWAYS green.\n\nCODE QUALITY:\n\n- Follow existing repo patterns. When unsure, read Ghostty source.\n\n- DRY ‚Äî no duplicate code\n\n- Handle all error cases elegantly\n\n- Write clear, self-documenting code with minimal comments\n\n- Only comment where logic truly non-obvious. Remove verbose/redundant comments.\n\n- Elegant, minimal code. Less code = better.\n\nARCHITECTURE:\n\n- libsmithers (Zig) = source of truth for all business logic\n\n- Use dependency injection for platform-specific concerns\n\n- Keep Zig platform-agnostic (WASM-compilable in theory)\n\n- Use comptime dependency injection patterns (vtable pattern)\n\nZIG-SPECIFIC:\n\n- Unsure about Zig stdlib API? Read actual source at /opt/homebrew/lib/zig/std/\n\n- Common APIs LLMs get wrong: std.json, std.ArrayList, std.HashMap ‚Äî verify against source\n\n- Use std.testing.allocator in all tests (detects memory leaks)\n\n- Define explicit error sets, never anyerror\n\n- Use ArenaAllocator for request-scoped work\n\nSWIFT-SPECIFIC:\n\n- Use @Observable (NOT ObservableObject)\n\n- Use NavigationStack (NOT NavigationView)\n\n- Use Swift Testing (@Test, #expect) for new tests\n\n- XCUITest with .accessibilityIdentifier() for e2e tests\n\n- async/await only, no DispatchQueue\n\nSELF-REVIEW:\nBefore finishing, self-review. Reviewers check for:\n\n- Test coverage: all edge cases, error conditions, boundary cases\n\n- Code cleanliness + DRY principles\n\n- UX (keyboard navigation, error states, network-down scenarios)\n\n- Doc accuracy\n\n- Architectural consistency (Zig as source of truth, dependency injection)\n\n- Minimal, high-quality comments only\nFix issues before submitting.\n\n**REQUIRED OUTPUT** ‚Äî JSON matching this schema:\n\n{\n  &quot;filesCreated&quot;: [\n    &quot;string&quot;\n  ],\n  &quot;filesModified&quot;: [\n    &quot;string&quot;\n  ],\n  &quot;commitMessages&quot;: [\n    &quot;string&quot;\n  ],\n  &quot;whatWasDone&quot;: &quot;Detailed description of what was implemented&quot;,\n  &quot;testsWritten&quot;: [\n    &quot;string&quot;\n  ],\n  &quot;docsUpdated&quot;: [\n    &quot;string&quot;\n  ],\n  &quot;allTestsPassing&quot;: false,\n  &quot;testOutput&quot;: &quot;Output from running tests&quot;\n}\nDO NOT skip JSON output. Workflow fails without it.\nmcp: voltaire starting\nmcp: zig-docs starting\n2026-02-11T03:31:34.081047Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c49ba-8821-78f0-b445-d464edea3b12\n2026-02-11T03:31:34.104308Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4636-3d07-72a0-8120-4045237876a9\n2026-02-11T03:31:34.129336Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4637-181a-75f3-8088-e1ba8abe1989\n2026-02-11T03:31:34.155540Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4637-434a-7cd3-a9d7-285dcc28587c\n2026-02-11T03:31:34.183176Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4ab3-49a2-7312-ba0f-ffcd797d66b6\n2026-02-11T03:31:34.208408Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4634-6e9a-70d1-98cc-d1c11ad90370\n2026-02-11T03:31:34.235612Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c49cf-a734-7a91-b187-697181c54044\n2026-02-11T03:31:34.260543Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4635-c2c4-7471-9512-67be562dc314\n2026-02-11T03:31:34.288551Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4a84-9893-7672-9a01-decee2d76b1c\n2026-02-11T03:31:34.311600Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4796-ec01-72e3-bdc1-f4c6f95f8868\n2026-02-11T03:31:34.338001Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4634-d008-7692-ad14-2224faf3e18f\n2026-02-11T03:31:34.366004Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4a8f-2ab5-7cc3-bd8d-da6174e69008\n2026-02-11T03:31:34.391561Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4637-f0bc-7f73-bfc9-9e3a7658ca40\n2026-02-11T03:31:34.419828Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4634-9804-7b92-a1f7-c1c1f7bd2659\n2026-02-11T03:31:34.447156Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c46d6-bd0a-75b1-9681-01602cb180df\n2026-02-11T03:31:34.475587Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4635-391d-7132-91e7-922445d76530\n2026-02-11T03:31:34.503076Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4a83-cbdc-7902-b665-5b8ac28767d9\n2026-02-11T03:31:34.530466Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4635-b977-7930-a2d6-ee44ddb1be01\n2026-02-11T03:31:34.558130Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4634-843a-77f1-b6e7-538eca343503\n2026-02-11T03:31:34.585972Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c49d8-1fb8-75e0-ab05-324742b1c6fb\n2026-02-11T03:31:34.613020Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4793-f71d-7e00-9408-03314cff25d0\n2026-02-11T03:31:34.640467Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c49d8-7fa0-7230-875b-ee79c04bd5e9\n2026-02-11T03:31:34.667620Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4a94-f8f7-7792-8e77-25393073166a\n2026-02-11T03:31:34.694437Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4791-2cfd-7e52-b4e7-25a98445207f\n2026-02-11T03:31:34.719020Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c49ff-ab5a-7140-be3d-b78ca0a84155\n2026-02-11T03:31:34.745901Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4638-32c3-7e51-8d34-8ec1b82081ec\nmcp: voltaire ready\nmcp: zig-docs ready\nmcp startup: ready: voltaire, zig-docs\n2026-02-11T03:32:45.512372Z ERROR codex_api::endpoint::responses: error=network error: error sending request for url (https://api.openai.com/v1/responses)\nReconnecting... 1/5 (stream disconnected before completion: error sending request for url (https://api.openai.com/v1/responses))\n2026-02-11T03:32:48.727644Z ERROR codex_api::endpoint::responses: error=network error: error sending request for url (https://api.openai.com/v1/responses)\nReconnecting... 2/5 (stream disconnected before completion: error sending request for url (https://api.openai.com/v1/responses))\n2026-02-11T03:32:52.085146Z ERROR codex_api::endpoint::responses: error=network error: error sending request for url (https://api.openai.com/v1/responses)\nReconnecting... 3/5 (stream disconnected before completion: error sending request for url (https://api.openai.com/v1/responses))\n2026-02-11T03:32:56.067602Z ERROR codex_api::endpoint::responses: error=network error: error sending request for url (https://api.openai.com/v1/responses)\nReconnecting... 4/5 (stream disconnected before completion: error sending request for url (ht","stack":"Error: OpenAI Codex v0.99.0-alpha.13 (research preview)\n--------\nworkdir: /Users/williamcory/agent\nmodel: gpt-5.3-codex\nprovider: openai\napproval: never\nsandbox: danger-full-access\nreasoning effort: high\nreasoning summaries: auto\nsession id: 019c4ac1-0b30-7900-bae3-168baa07e7a7\n--------\nuser\nBuilding Smithers v2 ‚Äî ultimate UX for agentic coding.\n\nNative macOS IDE (Swift/SwiftUI) that feels like TUI but has GUI UX, with parallel SolidJS web app. Swift app for terminal power-users.\n\nV1 prototype: ../smithers/apps/desktop/ (symlinked as prototype0/). Use for reference in research steps.\n\nprototype1/ ‚Äî Next.js UI prototype (frozen design reference). Delete when done.\n\n# Spec Precedence &amp; Conflict Resolution\n\nWhen specs conflict, the higher-precedence rule wins. Agent or implementer MUST note the conflict and which rule took precedence.\n\n## Precedence (highest first)\n\n1. **Always Green** ‚Äî Build/tests passing. Nothing ships broken.\n2. **Architecture invariants** ‚Äî Zig source of truth, dependency injection, 5 interfaces, libghostty pattern.\n3. **Language rules** ‚Äî `zig-rules.md`, `swift-rules.md`, `ghostty-patterns.md`. Correct API usage, memory safety.\n4. **Current ticket** ‚Äî What the task actually requires. Ticket scope overrides general guidance.\n5. **Engineering spec** ‚Äî Implementation approach, data flow, module boundaries.\n6. **Design spec** ‚Äî UI/UX, tokens, layout, interactions.\n7. **Style guidance** ‚Äî &quot;Minimal comments&quot;, &quot;elegant code&quot;, &quot;DRY&quot;. Lowest priority ‚Äî never block shipping.\n\n## Rules\n\n- If two docs disagree on the same topic, the one listed as **canonical** in `spec-index.md` wins.\n- If a conflict is detected during implementation, explicitly note it in the ticket output (plan, implement, or review) and pick the higher-precedence rule.\n- Dependent docs MUST reference the canonical doc and not redefine its rules. If they add context, they must not contradict.\n- When in doubt: ask &quot;does this break the build?&quot; (precedence 1), &quot;does this violate architecture?&quot; (precedence 2), &quot;does this use wrong API?&quot; (precedence 3). If none apply, use judgment.\n\n# Spec Index &amp; Ownership\n\nEvery topic has ONE canonical doc. Dependent docs may reference but MUST NOT redefine.\n\n## Topic Ownership\n\n| Topic | Canonical Doc | Dependent Docs |\n|-------|--------------|----------------|\n| **Window architecture** | `design/principles.md` ¬ß1 | `eng/window-management.md` (impl details) |\n| **Chat UI** | `design/chat-window.md` | `eng/chat-implementation.md` (impl details) |\n| **IDE UI** | `design/ide-window.md` | `eng/ide-implementation.md` (impl details) |\n| **Keyboard shortcuts** | `design/keyboard-shortcuts.md` | `eng/keyboard-input.md` (impl details) |\n| **Design tokens** | `design/system-tokens.md` | `eng/design-system-impl.md` (impl details) |\n| **Skills system** | `eng/skills-system.md` | `design/overlays.md` (UI only) |\n| **AI integration** | `eng/ai-integration.md` | `design/chat-window.md` (UI only) |\n| **Terminal** | `eng/terminal-subsystem.md` | `design/ide-window.md` (UI only) |\n| **Editor** | `eng/editor-subsystem.md` | `design/ide-window.md` (UI only) |\n| **JJ/VCS** | `eng/jj-integration.md` | `design/chat-window.md` (sidebar UI only) |\n| **State architecture** | `eng/state-architecture.md` | ‚Äî |\n| **Build/repo** | `eng/repo-build.md` | `CLAUDE.md` (summary) |\n| **Testing** | `eng/testing.md` | `always-green.md` (policy) |\n| **Phases** | `eng/implementation-phases.md` | `mvp-scope.md` (gating) |\n| **Web app** | `eng/web-app.md` | ‚Äî |\n| **Code style (Zig)** | `zig-rules.md` + `ghostty-patterns.md` | ‚Äî |\n| **Code style (Swift)** | `swift-rules.md` | ‚Äî |\n| **Font/typography** | `design/system-tokens.md` ¬ß2.5 | `swift-rules.md` (must reference, not redefine) |\n| **Security posture** | `eng/security-posture.md` | `eng/web-app.md` (references) |\n| **MVP scope** | `mvp-scope.md` | `eng/implementation-phases.md` (references) |\n| **Conflict resolution** | `spec-precedence.md` | ‚Äî |\n\n## Rules\n\n- **Canonical doc** defines the truth. Other docs may add implementation detail but must link back.\n- If you find a contradiction between canonical and dependent docs, the canonical doc wins.\n- When updating a topic, update the canonical doc first; dependent docs only if they add impl detail.\n- New topics should be added to this index before writing specs.\n\n# MVP Scope Gating\n\nPrevents agents from implementing post-MVP features prematurely.\n\n## P0 ‚Äî Must Ship\n\n- Scaffold: repo structure, build.zig, libsmithers stub, C API, xcframework pipeline\n- Design system: tokens, shared components, theme\n- Chat window: sidebar (chats/source/agents modes), messages, composer, streaming\n- Codex integration: in-process Zig API, send/receive/stream\n- Chat persistence: SQLite, session CRUD\n- IDE window: file tree, editor (TreeSitter syntax), tabs, breadcrumbs, status bar\n- Cross-window: &quot;Open in Editor&quot; from chat, AI diff preview\n- Terminal: GhosttyKit embedded surfaces, terminal tabs\n- JJ: bundled binary, working copy status, commit, undo, snapshot\n- Agent orchestration: sub-agent spawn, status tracking, jj branch per agent\n- Command palette: Cmd+P file open, Cmd+Shift+P commands, Cmd+/ shortcuts\n- Web app: SolidJS parity for all P0 features, Playwright e2e tests\n- Keyboard: all core actions keyboard-accessible, tmux-compat prefix\n- Settings: core prefs (theme, font size, keybindings, agent config)\n\n## P1 ‚Äî Nice to Have\n\n- Background/scheduled agents (issue 007)\n- Multiple agent backends beyond Codex (issue 004 ‚Äî Claude Code, OpenCode)\n- Neovim modal editing mode\n- Image paste/drop + fullscreen viewer\n- Search: workspace-wide Cmd+Shift+F (ripgrep)\n- Light theme\n- Diff viewer (tabs + sheets)\n- Toast notifications, progress indicators\n- Auto-update (Sparkle)\n\n## P2 ‚Äî Stubs/Reserved UI OK, No Implementation\n\n- Skills system (scanner, registry, installer)\n- URL scheme deep linking\n- IPC server (Unix socket)\n- Menu bar background mode with agent status\n\n## Post-MVP ‚Äî Do Not Implement\n\n- Multi-workspace / Conductor parity (issue 038)\n- Workflow Studio (issue 039)\n- Workspace tools sidebar panels (issue 020)\n- MiniApps (issue 013)\n- Telegram agent bridge (issue 010)\n- Remote development (issue 033)\n- JJ merge queue UI\n- LSP integration\n- Cross-platform (Linux/iOS)\n\n## Gating Rule\n\nWhen Discover compares &quot;what SHOULD exist vs what does&quot;, it MUST check this scope:\n- P0 items that are incomplete = valid tickets\n- P1 items = valid tickets only after all P0 complete\n- P2 items = stubs only, no full implementation\n- Post-MVP items = NEVER create tickets for these\n\n# CRITICAL: ALWAYS GREEN\n\nCodebase MUST be green. ZERO tolerance for failures (even pre-existing).\n\n## Canonical Command\n\n**`zig build all`** ‚Äî Run after EVERY change. Runs ALL checks wired in `build.zig` in parallel.\nDo NOT commit until passes with zero errors.\n\n## Individual Checks\n\n`zig build all` is canonical, but individual checks:\n\n### 1. Build\n- `zig build` ‚Äî zero errors, zero warnings\n- When `build.zig` defines them: `zig build dev`, `zig build web`, `zig build codex`, `zig build jj`\n\n### 2. Tests\n- `zig build test` ‚Äî ALL Zig unit tests pass (use std.testing.allocator for leak detection)\n- When defined: `zig build playwright`, `zig build xcode-test`, `zig build ui-test`\n- If those steps are not yet wired, run the equivalent manual commands (e.g., `xcodebuild test`, `pnpm exec playwright test`)\n- ANY failure (even pre-existing) ‚Äî fix before moving on\n\n### 3. Formatting\n- `zig fmt --check .` ‚Äî all Zig formatted (run `zig fmt .` to fix)\n- `prettier --check .` ‚Äî JSON/YAML/Markdown/JS/TS formatted\n- Swift: Xcode default (4-space indent)\n\n### 4. Linting\n- Zero Zig warnings (treat as errors)\n- Zero Swift concurrency warnings (Swift 6 strict)\n- `shellcheck --severity=warning` on shell scripts\n- `typos` ‚Äî spell check (configure typos.toml for domain words)\n\n### 5. Memory Safety\n- std.testing.allocator ‚Äî zero leaks\n- errdefer on every failable allocation ‚Äî no resource leaks on error paths\n- `self.* = undefined` after deinit (poison use-after-free)\n\n### 6. Correctness\n- Exhaustive switches (no `else` for unknown variants)\n- Explicit error sets (never `anyerror`)\n- Public APIs must have tests\n\n## Rules\n- NEVER accept failing test (even pre-existing)\n- NEVER leave build broken\n- NEVER commit code that doesn&#x27;t compile\n- Pre-existing failure ‚Üí fix as part of current work WHEN TRIVIAL\n- Run full check suite after EVERY change; failures ‚Üí fix before moving on\n- When in doubt, run more checks, not fewer\n\n## Escape Hatch for Pre-Existing Failures\nIf `zig build all` fails due to unrelated pre-existing failures AND fixing them is non-trivial (would significantly expand ticket scope):\n1. Document the failure in `docs/triage/preexisting-failures.md` (append, don&#x27;t overwrite)\n2. Note it in the validation failingSummary so a dedicated ticket is created in the next Discover pass\n3. Continue with the current ticket ‚Äî do NOT go down unrelated rabbit holes\nThis keeps the workflow from stalling on issues orthogonal to the current work.\n\n# Architecture\n\n- **libsmithers** (Zig core) ‚Äî 5 interfaces: C API (Swift), MCP server (Codex), CLI (smithers-ctl), HTTP/WS (web app), Zig API (internal)\n- **Codex fork** (`submodules/codex/`) ‚Äî wraps entire Codex in Zig API, static lib linked into libsmithers. NO child process, NO JSON-RPC. Storage callbacks = Zig function pointers.\n- **JJ fork** (`submodules/jj/`) ‚Äî version control. No code changes, Zig build wrapper only.\n- **SolidJS Vite PWA** (`web/`) ‚Äî visual parity with native. shadcn-solid + Tailwind + Monaco + xterm.js.\n- **SQLite** (`pkg/sqlite/`) ‚Äî persistence. GRDB.swift on Swift side. WAL mode. Same database.\n- **Zap** (`pkg/zap/`) ‚Äî HTTP server wraps facil.io. No auth (localhost).\n- **TreeSitter** (`pkg/`) ‚Äî syntax parsing.\n- **build.zig** ‚Äî builds EVERYTHING: Zig, C deps, Rust submodules, Swift app, web app.\n- **libsmithers = PLATFORM AGNOSTIC** ‚Äî theoretically compiles to WASM. Use DEPENDENCY INJECTION for platform-specific (SQLite, HTTP, filesystem).\n- **Zig library = single source of truth** for all business logic.\n\n# Zig Rules (LLMs get these wrong)\n\nTarget: Zig 0.15. NOT 0.11, 0.12, 0.13, 0.14.\n\n## Common Mistakes\n- **ArrayList**: 0.14 prefers ArrayListUnmanaged (pass allocator to every method). std.ArrayList transitional.\n- **JSON**: `std.json.parseFromSlice(T, allocator, input, .{})` returns `Parsed(T)` with `.value` + `.deinit()`. NEVER forget `defer parsed.deinit()`.\n- **HashMap**: AutoHashMap for integer keys, StringHashMap for `[]const u8`. NEVER AutoHashMap with string keys.\n- **Type introspection**: 0.14+ uses `.int`, `.@&quot;struct&quot;`, `.@&quot;enum&quot;` (lowercase + @ prefix for keywords). NOT `.Int`, `.Struct`, `.Enum`.\n- `std.mem.page_size` ‚Üí `std.heap.pageSize()` or `page_size_min`/`page_size_max`\n- `std.rand` ‚Üí `std.Random`\n- `std.TailQueue` ‚Üí `std.DoublyLinkedList`\n- `std.ChildProcess` ‚Üí `std.process.Child`\n- `@setCold(true)` ‚Üí `@branchHint(.cold)`\n\n## Allocator Patterns\n- Pass explicitly. NO global state.\n- ArenaAllocator for batch allocations with shared lifetime (request-scoped, JSON parsing).\n- `std.testing.allocator` in ALL tests (leak detection).\n- `defer`/`errdefer` immediately after allocation.\n\n## Error Handling\n- Explicit error sets. NEVER `anyerror`.\n- Handle all cases. NEVER `catch {}` or `catch |_| {}`.\n- `errdefer` for cleanup on error paths.\n\n## Comptime\n- `comptime T: type` (NOT `anytype`) for generics.\n- Use for dependency injection (vtable like `src/host.zig`).\n\n## Style\n- `const` over `var`; slices over raw pointers\n- `std.log.scoped` for namespaced loggers\n- Exhaustive switches\n\n## Stdlib API Help\nZig stdlib changes frequently. Unsure ‚Üí read source.\nmacOS Homebrew: `/opt/homebrew/lib/zig/std/`\nCheck: `std/json.zig`, `std/array_list.zig`, `std/hash_map.zig`, `std/io.zig`, `std/heap.zig`\n\n# Swift/SwiftUI Rules (LLMs get these wrong)\n\n## Modern Patterns Only\n- `@Observable` (NOT ObservableObject) for models\n- `@State` (NOT @StateObject) as owning wrapper\n- `@Environment(Type.self)` (NOT @EnvironmentObject)\n- `NavigationStack` (NOT NavigationView)\n- `.foregroundStyle()` (NOT .foregroundColor())\n- `.clipShape(.rect(cornerRadius:))` (NOT .cornerRadius())\n- `navigationDestination(for:)` type-safe routing (NOT inline NavigationLink)\n- `async/await` structured concurrency (NO DispatchQueue, NO completion handlers)\n- `@Bindable` for bindings to @Observable\n\n## Concurrency\n- Swift 6 strict. NEVER ignore warnings.\n- `@MainActor` for UI.\n- `actor` for shared mutable state.\n- NEVER `@unchecked Sendable` as quick fix.\n- NEVER DispatchQueue.\n\n## UI\n- SF Symbols for icons\n- No arbitrary font literals ‚Äî use design tokens (`type.xs`, `type.base`, etc.) from `design/system-tokens.md`. Prefer SwiftUI text styles (`.caption`, `.body`) where appropriate. macOS does not have iOS Dynamic Type, but support user-configurable font scaling via preferences.\n- `Button` (NOT onTapGesture) for tappables\n- Extract views &gt;100 lines\n- `guard` for early exits\n\n## Testing\n- Swift Testing (`@Test`, `#expect`) for new unit tests\n- XCUITest + Page Object Model for e2e\n- `.accessibilityIdentifier()` on interactive elements\n- NEVER `Thread.sleep()` ‚Äî use `waitForExistence(timeout:)`\n\n# Ghostty Reference ‚Äî Follow These Patterns\n\nSmithers mirrors Ghostty repo/code style. When unsure, read Ghostty source at `../smithers/ghostty/`.\n\n## Zig File Naming\n- **PascalCase.zig** = struct-as-file (file IS struct): `App.zig`, `Surface.zig`, `Terminal.zig`\n- **snake_case.zig** = namespace/module: `config.zig`, `apprt.zig`, `renderer.zig`\n- Subsystem = directory + namespace: `terminal/` + `terminal.zig` (or `terminal/main.zig`)\n\n## Struct-as-File Pattern\n\n```zig\n//! Module-level doc ‚Äî explain purpose.\nconst MyType = @This();\n\nconst std = @import(&quot;std&quot;);\nconst Allocator = std.mem.Allocator;\nconst log = std.log.scoped(.my_module);\n\n/// Field doc\nalloc: Allocator,\nsurfaces: SurfaceList,\nfocused: bool = true,\n\npub const CreateError = Allocator.Error || OtherError;\n\npub fn create(alloc: Allocator) CreateError!*MyType {\n    var self = try alloc.create(MyType);\n    errdefer alloc.destroy(self);\n    try self.init(alloc);\n    return self;\n}\n\npub fn init(self: *MyType, alloc: Allocator) CreateError!void {\n    self.* = .{ .alloc = alloc, .surfaces = .{}, .focused = true };\n}\n\npub fn deinit(self: *MyType) void {\n    self.surfaces.deinit(self.alloc);\n    self.* = undefined; // Poison\n}\n\npub fn destroy(self: *MyType) void {\n    const alloc = self.alloc;\n    self.deinit();\n    alloc.destroy(self);\n}\n```\n\n## Namespace/Module Pattern\n\n```zig\n// Private imports (no pub)\nconst charsets = @import(&quot;charsets.zig&quot;);\n// Public re-exports\npub const apc = @import(&quot;apc.zig&quot;);\npub const Terminal = @import(&quot;Terminal.zig&quot;);\n// Test discovery\ntest { @import(&quot;std&quot;).testing.refAllDecls(@This()); }\n```\n\n## Import Order (strict)\n1. std library: `const std = @import(&quot;std&quot;);`\n2. std aliases: `const Allocator = std.mem.Allocator;`\n3. Internal: `const configpkg = @import(&quot;config.zig&quot;);`\n4. External: `const oni = @import(&quot;oniguruma&quot;);`\n5. Logger: `const log = std.log.scoped(.module_name);`\n6. Type aliases\n\n## Module Naming\nShadow avoidance ‚Äî suffix `pkg`:\n```zig\nconst configpkg = @import(&quot;config.zig&quot;);\nconst Config = configpkg.Config;\n```\n\n## Lifecycle Pattern\n- `create(alloc)` ‚Äî alloc on heap, call init, return pointer. Use errdefer.\n- `init(self, alloc)` ‚Äî initialize struct. `self.* = .{ ... }`.\n- `deinit(self)` ‚Äî free resources. NOT self. Poison: `self.* = undefined`.\n- `destroy(self)` ‚Äî save allocator, call deinit(), free self.\n\n## Error Pattern\n- Per-operation: `pub const OpenError = error{OpenFailed};`\n- Union: `pub const Error = OpenError || GetModeError || SetSizeError;`\n- errdefer immediately after failable allocation\n- Log: `catch |err| { log.warn(&quot;failed err={}&quot;, .{err}); ... }`\n\n## Generic Type Pattern\n```zig\npub fn BlockingQueue(comptime T: type, comptime capacity: usize) type {\n    return struct {\n        const Self = @This();\n        // ...\n    };\n}\n```\n\n## Platform Abstraction (comptime)\n```zig\npub const Pty = switch (builtin.os.tag) {\n    .windows =&gt; WindowsPty,\n    .ios =&gt; NullPty,\n    else =&gt; PosixPty,\n};\n```\n\n## Labeled Blocks\n```zig\nself.gpa = gpa: {\n    if (condition) break :gpa null;\n    break :gpa GPA{};\n};\n```\n\n## Naming\n- Types/Structs: PascalCase (`App`, `Surface`, `GlobalState`)\n- Functions: camelCase (`init`, `deinit`, `updateConfig`, `drainMailbox`)\n- Variables/fields/constants/enum fields/log scopes: snake_case (`font_grid_set`, `min_window_width_cells`, `.debug`, `.app`)\n\n## Comment Style\n- `//!` ‚Äî module-level doc at file top. WHY module exists, conceptual context.\n- `///` ‚Äî field/function doc. Behavioral contracts, not just types.\n- `//` ‚Äî inline notes. Consequences of alternatives.\n- Minimal. Code self-documents. Explain WHY, not WHAT. Delete if restates code.\n- First person, conversational. Honest about limits: &quot;hack because...&quot;, &quot;can&#x27;t do X because...&quot;\n\n### Field Documentation as Contracts\nBehavioral implications, not just type:\n```zig\n/// Font faces for rendering ‚Äî lookup for codepoints, fallback, etc.\n/// Replaced at runtime on config change.\nfont_grid_set: ?*font.SharedGridSet = null,\n\n/// Non-null = surface closed by host, ignore further interactions.\nclosed: ?*Surface = null,\n```\n\n### Self-Poisoning After Deinit\n`self.* = undefined` at end of `deinit()` ‚Äî use-after-free crashes instead of silent corruption:\n```zig\npub fn deinit(self: *MyType) void {\n    self.resource.deinit();\n    self.alloc.free(self.buffer);\n    self.* = undefined; // Poison\n}\n```\n\n## Test Pattern\n```zig\ntest &quot;CircBuf append&quot; {\n    const testing = std.testing;\n    const alloc = testing.allocator;\n    var buf = try CircBuf(u8, 0).init(alloc, 3);\n    defer buf.deinit(alloc);\n    try buf.append(1);\n    try testing.expectEqual(@as(u8, 1), buf.get(0));\n}\n```\n\n- `std.testing.allocator` (leak detection)\n- `defer` cleanup\n- Progressive complexity (simple ‚Üí edge cases)\n- Descriptive names: `&quot;CircBuf append wraps around&quot;`\n\n## C API Header (`include/libsmithers.h`)\n- Prefix: `smithers_`\n- Types: `_e` (enum), `_s` (struct), `_t` (opaque), `_cb` (callback)\n- Enum values: `SMITHERS_SCREAMING_SNAKE_CASE`\n- Functions: `smithers_snake_case`\n- Sections: `//-------------------------------------------------------------------`\n\n## Swift Organization\n- Feature-based: `macos/Sources/Features/{Chat,IDE,Terminal,Editor,...}`\n- Namespace: `Smithers.Action.swift`, `Smithers.App.swift` (enum as namespace)\n- Extensions: `TypeName+Extension.swift`\n- MARK: `// MARK: App Operations`\n- Guard-let: `guard let app = self.app else { return }`\n\n## build.zig\n- Root thin ‚Äî delegates to `src/build/main.zig`\n- Each artifact/step = `PascalCase.zig` in `src/build/`\n- `pkg/` deps have own `build.zig` wrapper\n\n# Git Commit Rules\n\n- **ALL commits go directly on `main`. NEVER create feature branches, fix branches, or any other branches. Stay on `main` at all times.**\n- Atomic commits (one logical change)\n- Emoji conventional: `EMOJI type(scope): description`\n  - ‚ú® feat ‚Äî new feature\n  - üß™ test ‚Äî add/update tests\n  - üêõ fix ‚Äî bug fix\n  - üìã docs ‚Äî documentation\n  - ‚ôªÔ∏è refactor ‚Äî restructure (no behavior change)\n  - ‚ö° perf ‚Äî performance\n  - üîß chore ‚Äî build/tooling/deps\n- Examples:\n  - `‚ú® feat(chat): add message streaming with WebSocket`\n  - `üß™ test(storage): add WAL mode concurrent access tests`\n  - `üêõ fix(terminal): correct cursor position after resize`\n  - `‚ôªÔ∏è refactor(host): extract platform abstraction to vtable`\n\n## Folder Structure\n\n# Smithers v2 Folder Structure\n\nMirrors Ghostty layout. Single `build.zig` builds all code.\n\n```\nsmithers-v2/\n‚îú‚îÄ‚îÄ build.zig              # Thin ‚Äî delegates to src/build/main.zig\n‚îú‚îÄ‚îÄ build.zig.zon          # Zig package manifest\n‚îú‚îÄ‚îÄ CLAUDE.md              # AI agent conventions\n‚îú‚îÄ‚îÄ docs/\n‚îÇ   ‚îú‚îÄ‚îÄ design.md          # UI/UX spec (~1400 lines)\n‚îÇ   ‚îú‚îÄ‚îÄ engineering.md     # Engineering spec (~2800 lines)\n‚îÇ   ‚îî‚îÄ‚îÄ folder-structure.md\n‚îú‚îÄ‚îÄ issues/*.md            # Feature specs (NOT implementation details)\n‚îú‚îÄ‚îÄ src/                   # Zig source (libsmithers ‚Äî portable logic)\n‚îÇ   ‚îú‚îÄ‚îÄ main.zig           # CLI entry (smithers-ctl)\n‚îÇ   ‚îú‚îÄ‚îÄ build/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.zig       # Build orchestration\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ *.zig          # Each artifact/step = PascalCase.zig\n‚îÇ   ‚îú‚îÄ‚îÄ storage.zig        # SQLite storage\n‚îÇ   ‚îú‚îÄ‚îÄ host.zig           # Platform abstraction (comptime vtable/DI)\n‚îÇ   ‚îî‚îÄ‚îÄ &lt;module&gt;/\n‚îÇ       ‚îú‚îÄ‚îÄ main.zig       # Namespace (re-exports, test discovery)\n‚îÇ       ‚îî‚îÄ‚îÄ *.zig          # PascalCase.zig=struct, snake_case.zig=module\n‚îú‚îÄ‚îÄ include/\n‚îÇ   ‚îî‚îÄ‚îÄ libsmithers.h      # C API ‚Äî contract between Zig/Swift\n‚îÇ                          # smithers_ prefix; _e(enum), _s(struct), _t(opaque), _cb(callback)\n‚îú‚îÄ‚îÄ pkg/                   # Vendored C/C++ deps + Zig wrappers\n‚îÇ   ‚îú‚îÄ‚îÄ sqlite/build.zig   # SQLite amalgamation\n‚îÇ   ‚îú‚îÄ‚îÄ zap/build.zig      # Zap HTTP (wraps facil.io)\n‚îÇ   ‚îî‚îÄ‚îÄ tree-sitter/build.zig\n‚îú‚îÄ‚îÄ submodules/            # Git submodules (Rust ‚Üí static libs)\n‚îÇ   ‚îú‚îÄ‚îÄ codex/build.zig    # EVMTS fork ‚Äî Codex as Zig API (cargo wrapper)\n‚îÇ   ‚îî‚îÄ‚îÄ jj/build.zig       # EVMTS fork ‚Äî Jujutsu (no code changes, cargo wrapper)\n‚îú‚îÄ‚îÄ macos/                 # Swift app (Xcode project, NOT Package.swift)\n‚îÇ   ‚îú‚îÄ‚îÄ Smithers.xcodeproj/\n‚îÇ   ‚îî‚îÄ‚îÄ Sources/Features/  # Feature-based: App/, Chat/, IDE/, Terminal/, Editor/\n‚îú‚îÄ‚îÄ web/                   # SolidJS Vite PWA (parity with native)\n‚îÇ   ‚îú‚îÄ‚îÄ package.json       # pnpm\n‚îÇ   ‚îú‚îÄ‚îÄ vite.config.ts\n‚îÇ   ‚îú‚îÄ‚îÄ src/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/    # SolidJS (shadcn-solid)\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stores/        # Plain SolidJS stores\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/         # SPA routes\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lib/           # Utils, API client\n‚îÇ   ‚îî‚îÄ‚îÄ tests/*.spec.ts    # Playwright e2e\n‚îú‚îÄ‚îÄ prototype0 -&gt; ../smithers/apps/desktop  # v1 reference\n‚îú‚îÄ‚îÄ prototype1/            # Next.js frozen reference (delete when done)\n‚îú‚îÄ‚îÄ scripts/smithers-workflow/  # 3 AI agents build product\n‚îî‚îÄ‚îÄ .github/workflows/     # CI: Zig tests‚ÜíRust‚ÜíSwift‚ÜíPlaywright‚Üíweb\n```\n\n## Naming Conventions\n\n### Zig\n- **PascalCase.zig** = struct-as-file (file IS struct, `const Self = @This();`). Ex: `App.zig`, `Surface.zig`, `Terminal.zig`, `Storage.zig`\n- **snake_case.zig** = namespace/module (re-exports, shared types). Ex: `config.zig`, `apprt.zig`, `renderer.zig`\n- Subsystem = **directory + namespace file**: `terminal/` + `terminal/main.zig`\n\n### Swift\n- **Feature-based**: `macos/Sources/Features/{FeatureName}/`\n- **Namespace**: `Smithers.Action.swift`, `Smithers.App.swift` (enum as namespace)\n- **Extensions**: `TypeName+Extension.swift`\n\n### Web\n- **Components**: `web/src/components/` (SolidJS, shadcn-solid)\n- **Stores**: `web/src/stores/` (SolidJS createStore)\n- **Tests**: `web/tests/*.spec.ts` (Playwright)\n\n## Build Commands\n\n```bash\nzig build              # Everything wired in build.zig\nzig build run          # Build + run CLI (current)\nzig build test         # Zig unit tests\nzig build all          # Build + tests + fmt/lint (canonical green check)\n\n# Planned (once build.zig defines these steps):\n# zig build dev          # Build + launch macOS\n# zig build web          # Web only\n# zig build playwright   # Web + server + Playwright e2e\n# zig build codex        # Codex static lib\n# zig build jj           # JJ only\n# zig build xcode-test   # Swift tests\n# zig build ui-test      # XCUITest e2e\n```\n\n## Key Principles\n\n1. **build.zig builds EVERYTHING** ‚Äî Zig, C deps, Rust (cargo), Swift, web\n2. **Vendor C/C++** in `pkg/` with Zig wrappers\n3. **Rust** as git submodules in `submodules/` ‚Üí static libs\n4. **Swift deps** via Xcode SPM (Sparkle, STTextView, GRDB.swift)\n5. **Web deps** via pnpm in `web/`\n6. **No Turborepo/Nx** ‚Äî `build.zig` = monorepo tool\n\n## JSON Output Requirement\n\nMUST end response with JSON object in code fence. Format specified in task prompt.\n\n```json\n{&quot;key&quot;: &quot;value&quot;, &quot;other&quot;: &quot;data&quot;}\n\n```\n\nREQUIRED. Workflow cannot continue without it.\n\n## Design Specification\n\n# Design Principles &amp; Window Architecture\n\n## Ultimate UX for Agentic Coding ‚Äî TUI to GUI\n\n**Goal: build ultimate UX for agentic coding evolving TUI to GUI.**\n\nTargets TUI power-users living in terminal ‚Äî Claude Code, vim, tmux users want better harness, NOT VS Code users seeking AI plugin. Must **feel like TUI, have GUI UX**:\n\n- **Keyboard first.** Every core action achievable without mouse. Tmux-style prefix, vim-compatible nav, command palette everything.\n- **Feels like terminal, built as GUI.** Native Swift app ‚Äî not terminal app. Designed to *feel* like terminal to power users. One keystroke from literal terminal (via **GhosttyKit** ‚Äî Ghostty&#x27;s emulator library embedded as terminal surfaces). Neovim mode makes file editing feel vim. Tmux shortcuts work everywhere. GUI adds value through things painful in raw terminal ‚Äî orchestrating multiple agents, visual diff review, quad-pane layouts ‚Äî without losing what terminal users love: speed, keyboard control, directness.\n- **Chat first.** Primary interaction conversational. Main chat window = &quot;pane 0&quot; ‚Äî always present. Everything else (editor, file tree, JJ panel, agents, terminals) attaches to and orchestrated from chat.\n\nNOT &quot;chat + IDE.&quot; A **chat-first agentic coding environment** where AI orchestrates work across multiple sub-agents, human monitors/steers/intervenes when needed.\n\n### Chat sidebar modes\n\nMain chat window sidebar not just chat history. Three modes (visible in `prototype1/`):\n\n1. **Chats** ‚Äî Top-level conversation history grouped by time, ability to **fork** any conversation at any point. User&#x27;s direct conversations with main agent.\n2. **Source** ‚Äî JJ (Jujutsu) version control panel: working copy changes, change log, bookmarks, operation log, snapshots.\n3. **Agents** ‚Äî Background sub-agent dashboard. **Separate from top-level chats.** Sub-agents = ephemeral background workers spawned by main agent. Run without human in loop, user monitors status here.\n\n**Top-level chats vs. sub-agents are different.** Top-level chat = user talking to orchestrator. Sub-agent = background worker delegated by orchestrator for specific task. Agent dashboard shows sub-agent status; chat history shows conversation threads.\n\n### Reference prototype\n\nTarget look/feel in `prototype1/` ‚Äî Next.js + TypeScript + Tailwind CSS mockup (&quot;Smithers v2 prototype&quot;). Also live v0: https://v0.app/chat/mac-os-ide-prototype-cEqmBbcomU7\n\n**Prototype = design reference for BOTH native macOS app and SolidJS web app.** Web app (`web/`) should look close to native ‚Äî same colors, spacing, layout, components. CSS custom properties (`--sm-*`) from prototype used directly in web app.\n\n---\n\n## Chat‚ÄëFirst Dual‚ÄëWindow macOS IDE (SwiftUI, macOS 14+)\n\nTranslates &quot;chat‚Äëas‚Äëprimary&quot; paradigm into implementable pixel‚Äëprecise UI system. Assumes all core capabilities remain functionally available (editor/terminal/JJ/agents/skills/search/diffs), reorganized into **two independent windows** sharing state.\n\n---\n\n## 0) Product principles\n\n1. **Chat default workspace.** User never opens IDE window, app still feels complete.\n2. **Secondary tools on-demand.** IDE window revealed only when human wants inspect/edit or AI produces work worth reviewing.\n3. **Least-noisy UI.** No persistent clutter. Observable constraints:\n   - Hover-only action bars appear within 100ms of hover\n   - No more than 3 persistent toolbar buttons in composer/footer\n   - Chrome controls hidden until hover or focus; no always-visible icons for actions used &lt;20% of the time\n4. **macOS-native behaviors.** Traffic lights, standard Cmd shortcuts, proper focus rings, contextual menus, draggable window background.\n5. **Performance-first rendering.** Observable constraints:\n   - Chat list uses `LazyVStack` (Swift) / virtualized list (web) ‚Äî no full DOM/view tree for off-screen messages\n   - No full markdown reparse on each streaming token delta ‚Äî append-only rendering\n   - File tree loads children on expand (lazy), no eager recursion of entire workspace\n   - Debounce search/filter inputs by 150ms\n   - No blur effects except small overlays (&lt;400x400px)\n6. **One design system shared.** Same tokens, same components. IDE chrome uses Nova-inspired syntax palette (see `system-tokens.md` ¬ß2.3). Chat density follows compact messaging app conventions (8-12px vertical padding between messages).\n7. **TUI-native feel.** Keyboard-first nav, tmux-compatible prefix keys, terminal always one keystroke away. GUI exists as harness making complex workflows possible ‚Äî orchestrating multiple agents, visual diff review, long-running parallel tasks ‚Äî things painful in raw terminal.\n\n---\n\n## 1) Window architecture &amp; lifecycle\n\n### 1.1 Windows\n\nTwo `NSWindow` instances, two SwiftUI roots, one shared app state.\n\n- **Chat Window (primary)**\n  - Created on launch\n  - Closing **hides window, does NOT quit app**. Smithers continues background with **menu bar icon** (like Slack, Discord). Required for scheduled agents fire on schedule. Menu bar shows agent status, allows quick access. Quitting explicit via Cmd+Q or menu &quot;Quit&quot;.\n  - Always shows chat detail\n\n- **IDE Window (secondary)**\n  - Created on demand\n  - Closing **hides** (doesn&#x27;t destroy state)\n  - Reopening restores last tab set, scroll positions, sidebar widths\n\n### 1.2 Default sizing &amp; placement\n\nPer workspace, persist both window frames independently (WindowFrameStore expanded to two keys).\n\nDefault Chat Window: width 45% screen visible frame, height 85%, origin center-left (x offset ‚àí6% screen width from center)\n\nDefault IDE Window: width 55%, height 85%, origin center-right (x offset +6%)\n\n### 1.3 Window chrome (both)\n\n`titlebarAppearsTransparent = true`, `.hiddenTitleBar` / &quot;full-size content view&quot;; Traffic lights standard position; Content extends behind titlebar; `isMovableByWindowBackground = true` ‚Äî ensure only non-interactive chrome regions participate drag\n\n### 1.4 Focus / activation rules\n\nOpening IDE from chat: brings IDE front; If invoked &quot;Open in Editor&quot; on diff/file path, IDE selects that file tab scrolls target line\n\nWhen AI finishes applying changes: chat window remains focused unless pref &quot;Auto-open IDE on file change&quot; enabled\n\n### 1.5 Menu bar icon &amp; background mode\n\nSmithers persists **menu bar app** even all windows closed. Menu bar icon (`NSStatusItem`) provides:\n\n- **Status indicator:** Idle (default icon), Working (animated dot/spinner), Completed (badge count finished agents)\n- **Click menu:** &quot;Show Smithers&quot; (reveal chat), &quot;New Chat&quot; (new session + reveal), &quot;Active Agents&quot; (submenu listing running agents + status), separator, &quot;Check for Updates‚Ä¶&quot;, &quot;Preferences‚Ä¶&quot;, &quot;Quit Smithers&quot; (‚åòQ)\n- **Notification badge:** background/scheduled agent completes, icon briefly pulses + macOS notification (if enabled)\n\nRequired **scheduled agents** feature (cron-like background tasks) + agents running while user switched to another app.\n\n### 1.6 URL scheme deep linking\n\nRegisters URL schemes Info.plist:\n\n- `smithers://` ‚Äî general deep linking\n- `smithers-open-file://&lt;path&gt;?line=N&amp;col=M` ‚Äî opens file at location. Used by external tools, terminal output, Finder.\n- `smithers-chat://&lt;session-id&gt;` ‚Äî opens specific chat session\n\nBehavior: all funnel through `ExternalOpenRequest` handler with batch support; Pending URL queue if files opened before workspace ready, process once workspace loads; Workspace root inference when opening file ‚Äî walk up directory hierarchy looking `.jj/`, `.git/`, or project files\n\n# Design System Tokens\n\n## 2) Design system\n\nNormalized token table + semantic/system tokens for all states.\n\n### 2.1 Color tokens (Dark default)\n\n#### Surfaces\n\n| Token | Purpose | Value |\n|-------|---------|-------|\n| `color.base` | Deepest background | `#0F111A` |\n| `color.surface1` | Primary panes | `#141826` |\n| `color.surface2` | Chrome (tab/status/sidebar headers) | `#1A2030` |\n| `color.border` | 1px separators | `white@8%` |\n\n#### Chat-specific surfaces\n\n| Token | Purpose | Value |\n|-------|---------|-------|\n| `chat.sidebar.bg` | Chat sidebar background | `#0C0E16` |\n| `chat.sidebar.hover` | Row hover | `white@4%` |\n| `chat.sidebar.selected` | Selected session | `accent@12%` |\n| `chat.pill.bg` | Category pill bg | `white@6%` |\n| `chat.pill.border` | Category pill border | `white@10%` |\n| `chat.pill.active` | Pill hover/active | `accent@15%` |\n| `titlebar.bg` | Titlebar background | `#141826` |\n| `titlebar.fg` | Titlebar text | `white@70%` |\n\n#### Chat bubbles\n\n| Token | Purpose | Value |\n|-------|---------|-------|\n| `chat.bubble.assistant` | Assistant bubble | `white@5%` |\n| `chat.bubble.user` | User bubble | `accent@12%` |\n| `chat.bubble.command` | Command bubble | `white@4%` |\n| `chat.bubble.status` | Status bubble | `white@4%` |\n| `chat.bubble.diff` | Diff preview bubble | `white@5%` |\n| `chat.input.bg` | Input field bg | `white@6%` |\n\n#### Accent &amp; semantic\n\n| Token | Purpose | Value |\n|-------|---------|-------|\n| `color.accent` | Primary accent | `#4C8DFF` |\n| `color.success` | Success (exit 0, applied) | `#34D399` (saturated not neon) |\n| `color.warning` | Warning (declined, conflicts) | `#FBBF24` |\n| `color.danger` | Error (exit !=0, failed) | `#F87171` |\n| `color.info` | Informational status | `#60A5FA` |\n\n&gt; Use semantic colors **sparingly**; most UI neutral. Semantic appears as small badges/indicators, not full-pane fills.\n\n### 2.2 Text opacity\n\n| Level | Token | Opacity | Usage |\n|-------|-------|---------|-------|\n| Primary | `text.primary` | 88% | main text |\n| Secondary | `text.secondary` | 60% | descriptions, inactive |\n| Tertiary | `text.tertiary` | 45% | timestamps, hints |\n\n### 2.3 Syntax palette (Nova-inspired)\n\n| Token type | Color |\n|------------|-------|\n| Keywords | `#FF5370` |\n| Strings | `#C3E88D` |\n| Functions | `#82AAFF` |\n| Comments | `#676E95` |\n| Types | `#FFCB6B` |\n| Variables/Props | `#F07178` |\n| Numbers/Constants | `#D4C26A` |\n| Operators | `#89DDFF` |\n| Punctuation | `gray@70%` |\n| Tags (JSX/HTML) | coral/red family |\n\n### 2.3.1 Token Math Contract\n\nTint shorthand (`white@X%`, `accent@X%`) is unambiguous across platforms:\n\n| Shorthand | Meaning | Swift | CSS |\n|-----------|---------|-------|-----|\n| `white@X%` | White with X% opacity | `NSColor.white.withAlphaComponent(X/100)` | `rgba(255, 255, 255, X/100)` |\n| `black@X%` | Black with X% opacity | `NSColor.black.withAlphaComponent(X/100)` | `rgba(0, 0, 0, X/100)` |\n| `accent@X%` | Accent (#4C8DFF) with X% opacity | `NSColor(accent).withAlphaComponent(X/100)` | `rgba(var(--sm-accent-rgb), X/100)` |\n| `gray@X%` | Mid-gray with X% opacity | `NSColor.gray.withAlphaComponent(X/100)` | `rgba(128, 128, 128, X/100)` |\n\n**Application method:** Direct background fill (NOT overlay compositing). These are background colors applied via `backgroundColor` / `background-color`, not blended on top of existing surfaces.\n\n**CSS variable convention:** `--sm-accent-rgb: 76, 141, 255;` (comma-separated for use in `rgba()`).\n\n**SwiftUI:** Use `.background(Color.white.opacity(0.06))` for `white@6%`.\n\n### 2.4 Light theme derivation\n\nDeterministic derivation so engineering not hand-tuning 30 colors.\n\n**Algorithm:**\n\n- Keep `accent` identical\n- Replace surface stack near-white neutrals: `base` ‚Üí `#F6F7FB`, `surface1` ‚Üí `#FFFFFF`, `surface2` ‚Üí `#EEF1F7`, `border` ‚Üí `black@10%`\n- Text opacities map black same opacities (primary 88%, etc.)\n- Chat bubbles: assistant ‚Üí `black@4%`, user ‚Üí `accent@12%` (unchanged tint logic)\n- Hover states `black@3‚Äì4%` instead white\n\n### 2.5 Typography\n\nSystem fonts; no custom files.\n\n#### UI font\n\nSystem UI `.system` (SF Pro); Weights: Regular body, Medium labels, Semibold headings\n\n#### Code font\n\nSystem monospace `.monospaced` / SF Mono; Default 13pt (code), 14pt if want closer current Smithers feel\n\n#### Scale\n\n| Token | Size | Usage |\n|-------|------|-------|\n| `type.xs` | 10 | timestamps, tiny labels, line numbers |\n| `type.s` | 11 | sidebar items, status bar |\n| `type.base` | 13 | default body, chat, code |\n| `type.l` | 15 | section headers |\n| `type.xl` | 20 | dialogs, empty state headings |\n| `type.chatHeading` | 28 | &quot;How can I help you?&quot; |\n| `type.chatSubheading` | 16 | project name under heading |\n| `type.chatSidebarTitle` | 12 | session title |\n| `type.chatTimestamp` | 10 | session timestamp |\n\nLine height multipliers: UI 1.35, chat messages 1.5, code 1.4\n\n### 2.6 Spacing &amp; sizing\n\n4pt grid. Primary component metrics:\n\n`space.4 = 4`, `space.6 = 6`, `space.8 = 8`, `space.10 = 10`, `space.12 = 12`, `space.16 = 16`, `space.24 = 24`, `space.32 = 32`\n\nCommon heights: sidebar mode bar 40pt, title bar zone 28pt, status bar 22pt, tab bar 32pt, input send button 32√ó32\n\n### 2.7 Corner radii\n\n| Token | Value | Usage |\n|-------|-------|-------|\n| `radius.4` | 4 | chat tail corner |\n| `radius.6` | 6 | buttons, small cards |\n| `radius.8` | 8 | pills, inputs, tabs |\n| `radius.10` | 10 | input bar container |\n| `radius.12` | 12 | chat bubbles |\n| `radius.16` | 16 | dialogs, large cards |\n\n### 2.8 Borders &amp; separators\n\n1px separators use `color.border` (`white@8%` / `black@10%` light); Avoid heavy strokes; use separators between structural panes only\n\n### 2.9 Shadows\n\nOnly overlays (command palette, image viewer, modals): shadow y=10 blur=30 color `black@35%` (dark) / `black@18%` (light)\n\n# Shared Components &amp; View Hierarchy\n\n## 3) Components library\n\nUsed in both windows. Keep in `DesignSystem` module with tokens + reusable views.\n\n### 3.1 `IconButton`\n\nSizes: Small 24√ó24 (toolbar), Medium 28√ó28, Large 32√ó32 (primary); Default: no bg, Hover `white@6%`, Active `white@10%`; Icon 14‚Äì16pt; Tooltip via `.help()`\n\n### 3.2 `PrimaryButton`\n\n32pt height, 12pt h padding, radius 8, `accent@90%` bg, white 92% text; Hover brighten +6% (or `white@6%` overlay); Disabled 45% opacity\n\n### 3.3 `PillButton`\n\nRadius 999, padding 14pt h / 8pt v, `chat.pill.bg`, border 1px `chat.pill.border`; Hover/active `chat.pill.active`\n\n### 3.4 `Panel`\n\nBg `surface2` (chrome) or `surface1` (content), border 1px `color.border`, radius 10‚Äì16\n\n### 3.5 `SidebarListRow`\n\n44pt (or 36pt dense); Hover `white@4%`, selected `accent@12%`; Title `type.chatSidebarTitle` 12pt primary, secondary 10pt tertiary\n\n### 3.6 `Badge`\n\n18‚Äì20pt, padding 6pt h / 2pt v, radius 6, semantic@18% bg, semantic@95% text (or white 88% contrast)\n\n---\n\n## 4) View hierarchy\n\n### 4.1 App root / scenes\n\n- `SmithersApp`\n  - `AppModel` (@State shared)\n  - `ChatWindowScene` ‚Üí `ChatWindowRootView`\n  - `IDEWindowScene` (hidden until opened) ‚Üí `IDEWindowRootView`\n  - `SettingsScene` ‚Üí `SettingsRootView` (standard macOS)\n\n# Chat Window Spec\n\n## 5.1 Layout\n\nRoot: `NavigationSplitView` ‚Äî sidebar 200‚Äì360pt (default 260pt), detail flexible\n\n`ChatWindowRootView` ‚Üí `ChatSidebarView` + `ChatDetailView`\n\n## 5.2 Sidebar hierarchy\n\n`ChatSidebarView` (VStack) ‚Üí `SidebarModeBar` (40pt) + Divider + `ChatSidebarContent`\n\nModes: Chats (NewChatButton + SearchField + SessionList), Source (JJPanelSidebar), Agents (AgentDashboardSidebar)\n\n### 5.2.1 Mode bar\n\n40pt height, 8pt padding, `chat.sidebar.bg`\n\n3 `ModeBarItemButton`: Chats (`bubble.left.and.bubble.right`), Source (`arrow.triangle.branch`), Agents (`person.3`)\n\nSelected: accent text, `accent@12%` pill (radius 8); Inactive: secondary text, no bg; Hover: `white@4%`\n\n### 5.2.2 Chats mode ‚Äî Session list\n\nGroups: Today / Yesterday / This Week / Older ‚Äî headers uppercase `type.xs` tertiary, padding 8pt top / 6pt bottom / 12pt h\n\n`ChatSessionRow`: 56pt, padding 10pt v / 12pt h; Title 12pt semibold primary, timestamp 10pt tertiary trailing, preview 10pt tertiary max 2 lines; Hover `chat.sidebar.hover`, selected `chat.sidebar.selected`; Context menu: Rename / Delete / Duplicate; Inline rename: Enter commits, Esc cancels\n\n### 5.2.3 Source mode ‚Äî JJ panel\n\nCompact JJ (Jujutsu) workflow: viewing changes, committing, branching, git remotes\n\n`JJPanelSidebar` sections: WorkingCopy, ChangeLog, Bookmarks, OpLog, Snapshots\n\nSection header (32pt): disclosure triangle, title 11pt medium, optional trailing action; Content rows 36‚Äì44pt\n\n**Working Copy:**\n\nAction buttons: Describe (pencil ‚Äî inline text field, `CommitStyleDetector` matches team style from last 30 commits), New (plus ‚Äî `jj new`), Snapshot (camera ‚Äî Describe + New)\n\nFile rows: status badge M/A/D/? (M=warning, A=success, D=danger, ?=tertiary), filename 11pt + path tertiary if not unique, `+N ‚àíM` monospace 10pt success/danger; Click opens diff (chat card or IDE tab per pref); Context: Reveal / Open / Copy Path / Revert\n\n**Change Log:**\n\nRows: change ID (short hash mono), description 11pt, author, relative time; Working copy highlighted accent; Context: Squash / Abandon (confirm) / Edit / Describe / Create bookmark / Copy ID\n\n**Bookmarks:**\n\nRows: name 11pt medium, tracking (local/remote), change ID; Context: Git Push (`jj git push -b &lt;name&gt;`) / Delete (confirm) / Rename / Copy Name\n\nFooter buttons: Push All Tracked (`jj git push --tracked`), Fetch (`jj git fetch`)\n\n**Operations Log:**\n\nRows: operation description, relative timestamp; Context: Restore (`jj op restore &lt;id&gt;`, confirm dialog), Undo (`jj undo`, recent only)\n\n**Snapshots:**\n\nRows: description, time, trigger (auto/manual/agent); Click: revert preview dialog + diff (confirm/cancel); AI turns auto-create (2s debounce), manual saves optional (pref)\n\n**Conflict indicator:** warning banner top of Source panel ‚Äî `warning@12%` bg, triangle icon, &quot;N conflicts in M files&quot;, click opens conflict list\n\n### 5.2.4 Agents mode ‚Äî Dashboard\n\n`AgentDashboardSidebar`: New Agent button (PrimaryButton full width) + ActiveAgentsList + PastAgentsList (collapsible) + MergeQueueList\n\n**Agent row:** status dot 8pt ‚Äî Idle (tertiary), Working (`color.info` pulse 0.8s), Completed (`color.success`), Failed (`color.danger`), Cancelled (tertiary strikethrough), Conflicted (`color.warning`), In Queue (tertiary + badge), Merged (`color.success` + checkmark); Title 11pt medium, subtitle 10pt tertiary 1 line truncated, files badge monospace `white@8%` radius 4; Hover actions 24√ó24: Open Chat (bubble ‚Äî unhides `.chat` tab in IDE), Open Diff (diff icon), Merge (merge icon, confirm + preview), Cancel (stop, confirm &quot;Changes preserved in JJ branch&quot;); Click row expands: task, start time, duration, file list\n\n**Config:** Concurrent limit (default 4, configurable, excess queued); Setup commands (optional shell per-workspace)\n\n**Lifecycle:** Each agent: JJ workspace branch (`jj workspace add`), Codex session (multiplexed), polls file changes, reports events; Complete: ready to merge or show conflicts\n\n**Merge queue (post-MVP, UI reserved):** entries show agent, priority (low/normal/high/urgent), status (waiting/testing/merging/merged/failed); drag reorder, test status spinner/badge, auto-merge toggle; MVP: simple Merge button\n\n---\n\n## 5.3 Detail view\n\n`ChatDetailView` (VStack spacing 0): TitleBarZone (28pt) + Divider + MessagesZone (fills) + Divider + ComposerZone\n\n### 5.3.1 Title bar\n\n28pt, `titlebar.bg`; HStack: leading spacer, center workspace name 11pt `titlebar.fg`, trailing OpenEditorButton (icon `rectangle.split.2x1`, tooltip &quot;Open Editor&quot;); Click: create &amp; show IDE or bring to front\n\n### 5.3.2 Messages zone\n\n`ScrollViewReader` + `ScrollView` + `LazyVStack` (spacing 10‚Äì12), padding 16pt h / 16pt top / 12pt bottom\n\nAuto-scroll: pin to bottom on new text if at bottom, else show &quot;Jump to latest&quot; button (bottom-right above composer, 36pt, radius 8)\n\n#### Message types\n\n1. **User bubble:** trailing, max 80% width, `UnevenRoundedRectangle` corners 12 tail 4 (bottom-right), `chat.bubble.user`, 13pt primary line-height 1.5, markdown (bold/italic/code)\n\n2. **Assistant bubble:** leading, tail bottom-left, `chat.bubble.assistant`; Headings 15pt semibold, code blocks mono `white@4%` radius 8 padding 10pt, inline code mono `white@6%`; File paths `path:line:col` clickable (underline hover, opens IDE)\n\n3. **Command bubble:** leading, max 90%, `chat.bubble.command`; Header `$ command` mono 13pt semibold + spinner/exit badge, CWD 10pt tertiary, output mono 12‚Äì13pt selectable h-scroll; Running: spinner &quot;Running‚Ä¶&quot; secondary, stream in place smooth height\n\n4. **Diff card:** leading, max 90%, `chat.bubble.diff`; Title &quot;N files changed&quot; or filename 13pt medium, file list (5 max then &quot;+N more&quot;), summary `+N ‚àíM` mono success/danger, preview 8 lines mono diff coloring; Footer: status badge (Applying/Applied/Failed/Declined) + &quot;Open in Editor&quot; button; Click: full diff viewer (sheet or IDE tab per pref); &quot;Open in Editor&quot; always opens IDE + selects diff/file\n\n5. **Status:** neutral pill centered/leading, `chat.bubble.status`, 11pt secondary\n\n6. **Starter prompt:** new/empty chats only, renders welcome (5.5)\n\n#### Message hover action bar\n\n150ms delay, floats above bubble edge; `black@30%` bg, `white@6%` border, radius 8\n\nButtons: Fork (branch ‚Äî new chat session inherits messages to this point, appears in sidebar + can open as `.chat` tab), Copy, Retry (assistant/last user), Edit &amp; Resend (user), Revert (if JJ snapshot), More (ellipsis ‚Üí &quot;Rollback to here&quot;); Dismiss on mouse leave\n\n### 5.3.3 Thinking\n\nLeading bubble, spinner + &quot;Thinking‚Ä¶&quot;, assistant bubble style, 8pt padding\n\n## 5.4 Composer\n\n`ChatComposerZone` (VStack spacing 8, padding 12‚Äì16): ComposerContainer (radius 10 ‚Äî TextField multiline 1‚Äì4 + optional AttachmentStrip) + FooterRow (hint text left tertiary, Send/Interrupt right)\n\nContainer: `chat.input.bg`, border 1px `white@6%`, padding 10pt; Drop: border accent, bg `accent@6%`\n\nAction buttons (left row): Attach (paperclip ‚Äî file picker/paste), @Mention (AtSign ‚Äî popup files/symbols, inserts `@filename`/`@symbol` context), Skills (sparkles ‚Äî popover toggles active skills); Always visible left of send\n\nSend: 32√ó32 radius 6 accent solid, up arrow, hover brighten +6%, disabled if empty + no attachments\n\nInterrupt: 32√ó32 `danger@25%` stop icon, visible only while AI processing\n\nSlash popup: `/` at start ‚Üí autocomplete `/plan` `/review` `/diff` `/fork` `/new` `/resume` `/status` `/compact` `/mention` `/init` `/model`; surface2 radius 8 shadow, max 8 rows, arrows + Enter/Esc; Accepts inline args\n\n@Mention popup: `@` ‚Üí file/symbol autocomplete filtered, inserts references; Same style as slash\n\nSteer mode (while agent running): composer active, Enter steers real-time, Tab queues follow-up, indicator shows Steer/Queue\n\nKeys: Return=Send (or Steer), Tab=Queue (if agent running), Shift+Return=newline, Cmd+Return=Send, Esc=interrupt or clear focus\n\n### 5.4.1 Images\n\nAccept paste/drag; `AttachmentStrip` 56‚Äì72pt: thumbnails 56√ó56 radius 8, h-scroll if &gt;4, hover x to remove\n\n### 5.4.2 Fullscreen viewer\n\nOverlay (not sheet), scrim `black@60%`, centered image max 90% window; Close: Esc or top-right X\n\n---\n\n## 5.5 Welcome screen\n\nShown: new chat or no messages; Centered VStack max width 640\n\n1. Heading 28pt semibold &quot;How can I help you?&quot;\n2. Subheading 16pt secondary project name (if workspace)\n3. Category pills (Create / Explore / Code / Learn)\n4. AI-generated prompts (4 rows): `white@6%` bg/border radius 8, padding 12pt, trailing arrow\n\nPrompts AI-generated workspace-aware (NOT hardcoded). `SuggestionService` analyzes: recent files/edits, JJ status (uncommitted/conflicts/commits), project type (language/framework), recent/repeated prompts; Cached per-workspace 5min refresh; Defaults if not ready: &quot;Explore codebase&quot; &quot;Review changes&quot; &quot;Fix bug&quot; &quot;Write docs&quot;\n\nInteraction: click pill filters, click suggestion inserts text + focuses composer\n\n# IDE Window Spec (Secondary)\n\n## 6.1 Layout\n\nRoot: `NavigationSplitView` ‚Äî sidebar 180‚Äì400pt (default 240pt), detail flexible\n\n`IDEWindowRootView` ‚Üí `FileTreeSidebar` + `IDEWorkspaceDetailView`\n\n## 6.2 File tree sidebar\n\n### Empty state\n\nCentered: folder icon, &quot;No Folder Open&quot;, &quot;Open Folder‚Ä¶&quot; button, &quot;‚åò‚áßO&quot; hint\n\n### Tree appearance\n\nBg `surface1`, root header `surface2`; Indent 16pt per level, guides 1px `border@35%`; Row height 28‚Äì32pt\n\n### Row spec\n\nHStack: disclosure chevron (folders, 12pt), file/folder icon 16pt colored (Swift orange, TS/JS blue/yellow, Python green, Rust red-brown, Zig orange-gold, JSON/YAML gray, Markdown light blue, folders accent when expanded, SF Symbols fallback `doc`), name 11pt, spacer, modified dot 6pt `color.warning` (unsaved)\n\nStates: Hover `white@4%`, selected accent capsule 3pt width radius 2 full height minus 6pt inset; Current file `accent@6%` bg + capsule\n\nContext: Folders (New File/Folder, Copy Path, Reveal, Rename, Delete), Files (Copy Path, Reveal, Open in Terminal, Rename, Delete); Inline rename Enter commits Esc cancels\n\n### Keyboard nav\n\nArrows Up/Down move; Right expands folder or first child; Left collapses or parent; Enter opens; Space quick-look; Delete confirms\n\n### Lazy loading &amp; auto-refresh\n\nExpand triggers children load, chevron rotates 90¬∞ 0.15s ease-in-out; Auto-refresh via `FSEvents` 250ms debounce; Respects `.gitignore`/`.jj/ignore`, toggle &quot;Show Hidden Files&quot; in context/palette\n\n---\n\n## 6.3 IDE detail\n\n`IDEWorkspaceDetailView` (VStack spacing 0): TabBar (32pt if tabs) + BreadcrumbBar (18‚Äì22pt if file) + Divider + ContentArea (fills) + Divider + StatusBar (22pt)\n\n### 6.3.1 Tab bar\n\nTypes: file, terminal, diff, webview, chat (sub-agents, forked chats ‚Äî any chat can open as tab)\n\nNova-like: bg `surface2`; Selected `white@6%` + accent underline 2pt; Unselected secondary text; Geometry 28‚Äì30pt in 32pt bar, radius 8, padding 10pt h, min 120pt max 220pt; Distribute evenly if fits else h-scroll\n\nContents: leading icon (colored), filename 11pt, modified dot OR close on hover; Tooltip shows path\n\nInteractions: Click selects, drag reorder (insertion highlight, animate swap), middle-click closes; Context: Close / Close Others / All / to Right, Copy Path, Reveal Finder/Sidebar\n\nRight: overflow menu (ellipsis ‚Äî &quot;Switch To&quot; list, close actions)\n\n### 6.3.2 Breadcrumb bar\n\nBg `surface1` (or `surface2`), 10pt font, clickable segments, last bold, opacity gradient (earlier tertiary, later secondary/primary)\n\n### 6.3.3 Content area\n\n#### A) Code editor\n\nBg `surface1`; Gutter 44‚Äì56pt line numbers, bg `surface1`, divider 1px `border`; Current line `white@6‚Äì10%`, matching bracket `white@16%`, indent guides 1px `border@35%`; Minimap optional 70pt + separator 1px; Scrollbar overlay (always/auto/never)\n\n**Multi-cursor:** Opt+Click add cursor, Opt+Shift+Up/Down adjacent line, Cmd+D next occurrence, Cmd+Shift+L all occurrences, Esc collapse; All cursors type/delete/select together, grouped undo, multi-clipboard; Each cursor identical blink/block per pref\n\n**Ghost text:** `GhostTextOverlayView` dim `white@35‚Äì45%` overlay at cursor, pass-through no hit; Fade in 0.12s ease-out, fade out 0.12s dismiss/accept; Tab accepts, Esc dismisses, typing advances or cancels; `CompletionService` 300ms debounce to codex-app-server, streaming updates, generation counter cancels previous; Not in Neovim mode\n\n**Pinch-to-zoom:** trackpad adjusts font 8‚Äì48pt real-time, persists on gesture end, smooth no flicker\n\n**Press-and-hold disable:** macOS accent popup disabled (`ApplePressAndHoldEnabled = false` scoped), ensures key repeat for vim (holding j/h/etc)\n\n**Smooth scrolling:** `SmoothScrollController` velocity-based easing (not jarring jumps); Terminal snaps to cell grid; Integrated with Neovim mouse scroll RPC; Respects natural/inverted system pref\n\n**Link detection:** File paths `path:line:col` clickable (accent underline hover, opens IDE via `showInEditor()`); URLs in chat/terminal clickable (browser or webview tab per pref); Terminal Cmd+Click paths/URLs, Ghostty handles URLs natively, add file path detection workspace-relative\n\n**Neovim mode parity:** When active, STTextView replaced by Ghostty terminal running embedded Neovim\n\n| Feature | Editor mode | Neovim mode |\n|---------|-------------|-------------|\n| Syntax highlight | TreeSitter Swift-side | Neovim built-in |\n| Multi-cursor | Custom | Plugins (vim-visual-multi) |\n| Ghost text | GhostTextOverlayView | N/A (Neovim completion) |\n| Auto-save | Editor interval | BufWritePost detected |\n| JJ auto-snapshot | On save | BufWritePost triggers |\n| Pinch-to-zoom | Trackpad gesture | N/A (terminal font) |\n| Line numbers | Editor gutter | `set number` |\n| Current line | Editor feature | `cursorline` |\n| Bracket matching | Editor feature | `matchparen` |\n| Find/replace | Command palette | `/` and `:%s` |\n| Undo/redo | Editor stack | Undo tree |\n\n**Loading:** skeleton lines shimmer pulse 0.8s autoreverse\n\n#### B) Terminal (Ghostty)\n\nFull terminal, tab title updates live; Same scrollbar overlay; Smooth scrolling velocity + grid snap; Link detection Cmd+Click URLs + workspace-relative file paths open editor\n\n#### C) Diff viewer\n\nStandalone for IDE tabs, chat sheets, inline cards\n\n**Header 32pt:** left filename 13pt medium + `+N ‚àíM` mono success/danger, right hunk arrows up/down + counter &quot;3/12&quot;, &quot;Open in Tab&quot; if inline/sheet\n\n**Content:** Syntax highlighting within diffs ‚Äî added/removed retain TreeSitter syntax under tint; Line bg: additions `success@12%`, deletions `danger@12%`, hunks `@@` `accent@8%` bg `info` text, context no tint; Line numbers dual gutter (old | new) mono 10pt tertiary; Long lines h-scroll (no wrap default)\n\n**Controls (toolbar trailing):** Wrap toggle (icon `text.word.spacing`), Compact toggle (hides context, icon `arrow.up.and.down.text.horizontal`), Full-screen (fills area, hides sidebar/tabs, Esc or button)\n\n**Keyboard:** `]c` / `[c` vim-style next/prev hunk; Arrows Up/Down scroll; Cmd+Up/Down next/prev file (multi-file)\n\n**Sources:** AI changes (Codex), JJ working copy diffs, JJ change-to-change, session diffs, manual `smithers-ctl diff show`\n\n**Multi-file:** left sidebar 200pt file list `+N ‚àíM` per-file; Click scrolls diff pane to file section; Order: modified &gt; added &gt; deleted\n\n#### D) Webview\n\n`WKWebView` title observation, tab uses page title; Back/forward hidden default (reduce noise, accessible via palette/context)\n\n---\n\n## 6.4 Status bar\n\n22pt, `surface2`, top divider 1px\n\nLeft: `Ln X, Col Y | UTF-8 | LF` mono 10pt secondary; Center: Skills &quot;Skills: a, b +N&quot; (click popover); Right: `Language | Spaces: 4` 10pt secondary\n\n**Additional indicators:**\n\n- **Neovim mode** (left after line/col): badge shows vim mode ‚Äî NORMAL `accent@15%` bg accent text, INSERT `success@15%` success text, VISUAL `warning@15%` warning text, COMMAND `info@15%` info text\n- **Tmux prefix** (left): &quot;PREFIX&quot; badge `accent@20%` bg when Ctrl+A pressed awaiting follow-up, auto-dismiss 1s\n\n---\n\n## 6.5 Neovim mode\n\nMajor feature ‚Äî many users spend most time here. When enabled, STTextView replaced by Ghostty terminal running embedded Neovim with full UI extensions.\n\n### 6.5.1 Activation\n\nToggle Cmd+Shift+N (global both windows); Switches `CodeEditorView` ‚Üî `NvimTerminalView`; File state (cursor, unsaved) preserved across transitions; Persisted per-workspace\n\n### 6.5.2 Architecture\n\n1. `NvimController` creates Unix socket `/tmp/smithers-nvim-&lt;uuid&gt;.sock`\n2. Launches Neovim hidden Ghostty terminal `--listen &lt;socket&gt;`\n3. Connects retry (10 attempts, 100ms backoff)\n4. Attaches UI extensions: `ext_multigrid`, `ext_cmdline`, `ext_popupmenu`, `ext_messages`, `ext_hlstate`\n5. Installs autocmds `BufEnter`/`BufLeave`/`BufWritePost` track file changes\n6. Starts notification loop handle events\n\n### 6.5.3 Bidirectional sync\n\n- User selects file sidebar ‚Üí NvimController `:edit &lt;path&gt;` RPC, Neovim opens\n- User opens file Neovim ‚Üí `BufEnter` autocmd ‚Üí update `TabModel` (ensure tab exists/selected) + `EditorStateModel`\n- User saves Neovim ‚Üí `BufWritePost` ‚Üí mark clean tab model, triggers JJ auto-snapshot (2s debounce same as editor)\n- Tab model changes ‚Üí switch tabs bar click/keyboard ‚Üí NvimController `:edit &lt;path&gt;` sync\n- File tree, terminal, tab model coordinate with NvimController as source of truth active file Neovim mode\n\n### 6.5.4 External UI overlays\n\nNeovim ext_ui render native SwiftUI overlays on terminal (not in char grid)\n\n**Cmdline (`NvimCmdlineOverlay`):** bottom editor area above status, `surface2` radius 8 1px `border`, shows current cmdline (`:` `/` `?` `!`), mono same font editor, cursor visible blinking, dismisses on exec/cancel\n\n**Popup menu (`NvimPopupMenuOverlay`):** anchored cursor position, `surface2` radius 8 shadow, completion candidates Neovim native; Rows icon (type) + text + detail (secondary trailing); Selected `accent@12%`; Max 10 rows scrollable; Arrows + Enter/Esc\n\n**Message (`NvimMessageOverlay`):** floating notifications top-right editor; Max 6 visible, oldest auto-expire 4s; `surface2` radius 8 shadow; Levels ‚Üí colors: error danger, warning warning, info/echo primary; Slide-in right, fade-out dismiss\n\n**Floating windows (`NvimFloatingWindowView`):** plugin floats (hover docs, signature help); Native views on terminal; Configurable: blur 0‚Äì30pt (pref default 10), shadow 0‚Äì30pt (pref default 8), corner radius 0‚Äì20pt (pref default 8); Bg `surface2` blur vibrancy, border 1px `border`\n\n### 6.5.5 Theme sync\n\nNeovim mode reads highlight groups derives `AppTheme`: `Normal.bg` ‚Üí `background`, `Normal.fg` ‚Üí `foreground`, `Visual.bg` ‚Üí `selectionBackground`, `CursorLine.bg` ‚Üí `lineHighlight`, `TabLine*` ‚Üí tab bars, `Pmenu*` ‚Üí popup/panels, `LineNr`/`CursorLineNr` ‚Üí line numbers; Missing derived via alpha blend bg+fg\n\nOverrides app theme while active, reverts on deactivate\n\n### 6.5.6 Mode indicator\n\nStatus bar (6.4) + cursor shape changes mode: bar (insert), block (normal), underline (replace) ‚Äî Ghostty handles via escape sequences; Real-time updates\n\n### 6.5.7 Input method (CJK)\n\n**Critical CJK.** `InputMethodSwitcher` auto: switches ASCII-capable input source entering normal mode (so j/k/dd work without IME), restores previous input source entering insert mode (type native language); Automatic no config\n\n### 6.5.8 Crash recovery\n\nIf Neovim dies, `NvimRecoveryView` instead silent fail: centered editor area, `surface1` bg; Warning icon large `color.warning`, title &quot;Neovim crashed unexpectedly&quot;, subtitle crash type (startup/runtime/unexpected exit); Actions: Restart Neovim (PrimaryButton ‚Äî attempts restart full state restoration same files/positions), Disable Neovim Mode (secondary ‚Äî switches standard editor preserves files), Reveal Crash Report (tertiary link ‚Äî opens Finder `~/Library/Application Support/Smithers/Nvim/Reports/`)\n\nCrash report: captures logs, workspace state, open files, last RPC messages ‚Üí `~/Library/Application Support/Smithers/Nvim/Reports/`; Neovim logs ‚Üí `~/Library/Application Support/Smithers/Nvim/Logs/`\n\n### 6.5.9 Settings\n\nNeovim category in Preferences:\n\n- Nvim binary path: text field + file picker, validates working `nvim`, default system PATH\n- Option-as-Meta: dropdown Left/Right/Both/None, controls Option‚ÜíMeta terminal (same as Terminal prefs)\n- Floating window blur: toggle + slider 0‚Äì30pt\n- Floating window shadow: toggle + slider 0‚Äì30pt\n- Floating window corner radius: slider 0‚Äì20pt\n\n# Overlays &amp; Panels\n\n## 7) Overlays &amp; panels\n\n### 7.1 Command palette (Cmd+P)\n\nIDE-only overlay (callable globally, see shortcuts)\n\nScrim `black@35%`; Panel: width 420‚Äì680px (65% window max 680), height 320‚Äì460px (55% window max 460), radius 10, `surface2`, shadow overlay spec\n\nLayout two-pane: left results list, right preview (first 20 lines, 8KB)\n\nModes: default file search, command mode prefix `&gt;` search commands\n\nKeys: Up/Down navigate, Enter open, Esc dismiss\n\nAnimation: appear scale 0.97 + opacity spring (0.25s bounce 0.15), dismiss 0.15s ease-in\n\n### 7.2 Search panel (Cmd+Shift+F)\n\nTop-anchored slide-down (IDE); Width 55% max 560px, height 65% max 520px, `surface2`, slide + opacity animation\n\n**Input row (HStack):** text field fills placeholder &quot;Search in files...&quot;, regex toggle (icon `.*` ‚Äî active accent bg), case-sensitive toggle (icon `Aa` ‚Äî active accent bg), close button trailing\n\n**Results area (two-pane):**\n\nLeft results list (grouped by file): file header icon + filename + match count badge (&quot;12 matches&quot;), match rows indented line number tertiary + highlighted match text + context; Click match opens file at line highlights match; Keys arrows navigate Enter opens\n\nRight preview pane: ~10 lines context around selected match, match highlighted `accent@20%`, syntax TreeSitter, file path + line number top\n\n**Summary bar (bottom):** &quot;N results in M files&quot; 11pt secondary, search time &quot;0.12s&quot;\n\nBackend ripgrep fast workspace search, respects `.gitignore`/`.jj/ignore`\n\n### 7.3 Toast notifications\n\nBottom-center above status bar (IDE) or composer (Chat); Auto dismiss 2‚Äì3s, slide up + fade, `surface2` radius 10\n\n### 7.4 Progress bar\n\nTop edge window; Height default 3pt (1‚Äì8 configurable), track `white@6%`, fill accent, auto-hide 0.45s after complete\n\n### 7.5 Keyboard shortcuts panel (Cmd+/)\n\nRight-side slide-in; Width 260‚Äì320pt, `surface2`, search field top, sections grouped by category\n\n### 7.6 Skills system\n\nSkills = reusable AI instruction packages (plugins) extend agent capabilities. Each skill = `SKILL.md` YAML frontmatter + markdown body.\n\n#### Skill discovery\n\nScanned priority order:\n\n1. `&lt;workspace&gt;/.agents/skills/` ‚Äî project-scoped (checked into repo)\n2. `~/.agents/skills/` ‚Äî user-scoped (personal cross-project)\n3. `/etc/codex/skills/` ‚Äî admin-scoped (organization-wide)\n4. `$CODEX_HOME/skills/.system/` ‚Äî system-scoped (bundled defaults)\n\nEach `SKILL.md` YAML frontmatter:\n\n```yaml\n---\nname: react-component\ndescription: Generate React components following project conventions\nauthor: team\nversion: 1.0.0\ntags: [react, frontend, components]\nallowedTools: [read_file, write_file, run_terminal]\nargumentHints: [component name, props interface]\n---\n```\n\nMarkdown body = AI instruction set, injected agent context when skill activated\n\n#### Skill activation\n\nPer-chat-session (not global); Active skills injected AI context system instructions; Invocation explicit (`$skill-name` composer) or implicit (AI recognizes relevant); Status bar shows active skills (6.4)\n\n#### Skill modals\n\nAvailable either window, presented sheets active window (radius 16 padding 16 `surface2`)\n\n**Skill Browser (`SkillBrowserView`):** search field top (filters name/description/tags), grid/list available skills remote registry; Each card: name, description, author, tags, install button; Installed show &quot;Installed&quot; badge\n\n**Skill List (`SkillListView`):** all installed grouped scope (Project/User/Admin/System); Each row: name, scope badge, description preview; Trailing toggle switch active/inactive current session; Context: Reveal Finder, Edit, Uninstall\n\n**Skill Detail (`SkillDetailView`):** full metadata (name, description, author, version, tags, allowed tools), instructions preview markdown scrollable; Actions: Activate, Edit, Uninstall\n\n**Create Skill Wizard (`CreateSkillWizardView`):** multi-step: 1) Name &amp; description text fields, 2) Scope (Project/User), 3) Allowed tools checkbox list, 4) Instructions markdown editor, 5) Review &amp; create preview + save; Optional `CodebaseAnalyzer` suggests templates based detected language/framework\n\n**Skill Use popover (composer):** triggered Sparkles button composer footer; Shows installed skills toggles activate/deactivate current session; Quick filter name; &quot;Browse Skills&quot; link opens full Browser\n\n# Cross-Window Workflow Rules\n\n## 8) Cross-window workflow\n\n### 8.1 &quot;Open in Editor&quot; contract\n\n`showInEditor(fileURL, line?, column?, highlightRange?)`\n\n1. Ensure IDE visible\n2. Ensure file tab open (or reuse)\n3. Select tab\n4. Scroll to line/col (0.2s ease-in-out)\n5. Pulse highlight `white@10%` on line 0.6s fade\n\n### 8.2 AI file changes\n\n1. Chat receives Diff Preview Card\n2. If `autoOpenIDEOnFileChange == true`: IDE opens + focuses first changed file (or diff tab); Chat remains front unless &quot;Focus editor on change&quot; enabled (default false)\n3. JJ snapshot created\n4. Message hover allows revert/rollback\n\n# Settings / Preferences Window\n\n## 9) Settings\n\nStandard macOS Settings window with sidebar list of categories.\n\n### Categories\n\n**Appearance:** Theme Dark/Light/System; Window transparency toggle + opacity slider 70‚Äì100%\n\n**Editor:** Font name, size 8‚Äì48; Ligatures; Line spacing, char spacing; Cursor shape bar/block/underline\n\n**Display:** Line numbers, current line highlight, indent guides, minimap, scrollbar mode\n\n**Terminal:** Option-as-Meta left/right/both/none\n\n**Neovim:** Binary path; Floating window blur/radius/shadow\n\n**Behavior:** Close warnings; Auto-save toggle + interval; Auto-open IDE on AI file change (new, default on)\n\n**Updates:** Stable/Snapshot channel picker (if channels); &quot;Check for Updates...&quot; button; Auto-check on launch toggle\n\n### Sparkle auto-update\n\nUses **Sparkle** (`SPUStandardUpdaterController`) for auto-updates.\n\n- **Update channels:** Release (stable) vs. Snapshot (pre-release/nightly). Persisted UserDefaults. Changing channels switches appcast feed URL.\n- **Manual check:** &quot;Check for Updates...&quot; in menu bar icon menu + Preferences.\n- **Auto-check:** on app launch (configurable, default on). Non-intrusive notification when update available.\n- **Feed URL:** configured per-channel Info.plist. Snapshot may include pre-release builds experimental features.\n- **Update flow:** standard Sparkle dialog ‚Äî shows release notes, &quot;Install Update&quot; / &quot;Remind Me Later&quot; / &quot;Skip This Version&quot;.\n\n# Keyboard Shortcuts\n\n## 10) Shortcuts\n\n### Global (both windows)\n\n| Shortcut | Action |\n|----------|--------|\n| ‚åòS | Save current file |\n| ‚åò‚áßS | Save all |\n| ‚åò‚áßO | Open folder |\n| ‚åòP | Go to file (opens IDE + palette if needed) |\n| ‚åò‚áßF | Search in files (opens IDE + search panel if needed) |\n| ‚åòK | Focus chat composer (any window) |\n| ‚åòQ | Quit Smithers (explicit, not window close) |\n\n### Chat window\n\n| Shortcut | Action |\n|----------|--------|\n| Return | Send (or Steer if agent running) |\n| Tab | Queue follow-up (if agent running) |\n| ‚áßReturn | New line |\n| ‚åòN | New chat |\n| ‚åòV | Paste image |\n| Esc | Interrupt (running) / defocus |\n| ‚åò‚Üë/‚åò‚Üì | Jump between messages |\n\n### IDE window\n\n| Shortcut | Action |\n|----------|--------|\n| ‚åòB | Toggle sidebar |\n| ‚åò` | New terminal |\n| ‚åò‚áßN | Toggle Neovim mode |\n| ‚åò/ | Toggle shortcuts panel |\n\n### Tmux-style prefix (Ctrl+A)\n\n`TmuxKeyHandler` monitors `NSEvent.addLocalMonitorForEvents`. Ctrl+A enters prefix mode awaits follow-up. **Critical TUI-native experience** ‚Äî tmux users expect identical keybindings.\n\n| Follow-up | Action |\n|-----------|--------|\n| c | New terminal |\n| n | Next tab |\n| p | Previous tab |\n| 1‚Äì9 | Select tab by index |\n| &amp; | Close current tab |\n| z | Toggle terminal zoom (full-pane) |\n| \\| | Split vertical |\n| - | Split horizontal |\n\nPrefix timeout 1s no follow-up cancels; &quot;PREFIX&quot; indicator status bar while active (6.4)\n\n**Terminal always one keystroke away:** Ctrl+A c opens terminal immediately any context, must feel instantaneous\n\n### TUI-native keyboard philosophy\n\nEvery core action achievable without mouse. Flow:\n\n- Ctrl+A c ‚Üí new terminal (always, any window)\n- Cmd+` ‚Üí new terminal (macOS-native alternative)\n- Cmd+P ‚Üí command palette (fuzzy find: files, commands, settings)\n- Cmd+K ‚Üí focus chat composer (any window)\n- Esc ‚Üí dismiss overlay / return previous context\n- Tab / Shift+Tab ‚Üí cycle panes within window\n\nGoal: user never touches mouse feels at home in Smithers\n\n# State Management, Animations, Responsive, Accessibility &amp; Implementation\n\n## 11) State management (shared across windows)\n\n### 11.1 Core model layers\n\nShared `AppModel` injected both window roots.\n\nRecommended structure:\n\n- `AppModel` (@Observable)\n  - `workspace: WorkspaceModel?`\n  - `preferences: PreferencesModel`\n  - `windowCoordinator: WindowCoordinator` (show/hide/focus IDE, routing)\n\n- `WorkspaceModel`\n  - `fileTreeModel`, `tabModel` (open tabs, selected), `editorModel` (per-file view state: scroll, selection), `chatModel` (sessions, selected, messages), `jjModel` (status/log/bookmarks/ops/snapshots), `agentModel` (orchestrator state), `skillsModel`\n  - `services`: `CodexService`, `JJService`, `SearchService`, etc.\n\n### 11.2 Window-local UI state\n\nEphemeral UI state per window:\n\n- `ChatWindowUIState`: sidebar mode, sidebar search query, message hover state, active action bar, composer draft + attachments\n- `IDEWindowUIState`: sidebar width/collapsed, active overlays (palette/search/shortcuts), command palette query + selection\n\nPersist only what improves &quot;return-to-work&quot;: window frames, open tabs + selected tab, editor per-file positions, selected chat session\n\n---\n\n## 12) Animations &amp; timing\n\nConsistent motion vocabulary (short, subtle).\n\n| Interaction | Duration | Curve |\n|-------------|----------|-------|\n| Chat message insert | 0.20s | ease-in-out |\n| Auto-scroll to bottom | 0.20s | ease-out |\n| Hover action bar appear | 0.15s delay + 0.12s fade | ease-out |\n| Folder disclosure rotate | 0.15s | ease-in-out |\n| Command palette appear | 0.25s | spring (bounce 0.15) |\n| Search panel slide | 0.20s | ease-in-out |\n| Toast appear | 0.25s | ease-out |\n| Toast dismiss | 0.15s | ease-in |\n| Progress bar value | 0.20s | ease-in-out |\n| Editor jump-to-line | 0.20s | ease-in-out |\n| Cursor blink | 0.53s interval | linear fade 0.22s |\n\n---\n\n## 13) Responsive behavior\n\n### Chat window\n\nSidebar min 200pt; collapses entirely below window width 680pt; Detail content: message bubble max 80‚Äì90% (lines not too long), composer sticks bottom always\n\n### IDE window\n\nSidebar collapsible: toggle ‚åòB, auto-collapse if window &lt;720pt wide (optional); Tab bar: if narrow hide subtitles, icons + filename only\n\n---\n\n## 14) Accessibility\n\nEvery interactive element: accessibility label, identifier (UI tests), tooltip via `.help()`\n\nFull keyboard nav: sidebar lists arrows + Enter select, command palette arrows + Enter, chat Cmd+Up/Down jump messages (optional recommended)\n\nVoiceOver: message bubbles grouped; action bar buttons explicit labels (&quot;Copy message&quot;, &quot;Fork from here&quot;, etc.)\n\n---\n\n## Implementation notes (non-visual, critical)\n\n**Chat rendering** highly optimized: `LazyVStack`, avoid reflow on streaming by appending attributed runs rather rerendering entire markdown tree each delta\n\n**File tree** virtualized lazy-loaded as already done\n\nCentralize tokens in `AppTheme`/`ThemeTokens`, never hardcode colors in views\n\n### Image storage &amp; management\n\nChat images (pasted/dropped/attached) stored disk, not inline database:\n\n- **Storage:** `~/Library/Application Support/Smithers/images/&lt;hash&gt;` ‚Äî content-addressed by hash\n- **Database ref:** `images` table stores `(id, message_id, filename, data_hash)`, hash references file on disk\n- **Thumbnails:** generated 56√ó56 for attachment strip + chat display, cached memory\n- **Full-size viewer:** clicking thumbnail opens fullscreen overlay (5.4.2)\n- **Cleanup:** unused images (not referenced any message) **pruned periodically** app launch or workspace close, prevents disk bloat deleted messages\n- **Size limits:** individual 20MB cap, total 1GB per workspace (configurable), oldest pruned when limit reached\n\n### Commit style detection\n\n`CommitStyleDetector` analyzes last 30 commits `jjService.log(limit: 30)` detects team conventions:\n\n- **Conventional commits:** `type(scope): description` (e.g., `feat(auth): add OAuth login`)\n- **Emoji prefixes:** messages starting emoji (e.g., `‚ú® Add new feature`)\n- **Freeform:** no consistent pattern detected\n\nDetected style used by AI generating commit descriptions (JJ panel &quot;Describe&quot; action or automatic snapshot descriptions). Ensures AI messages match team conventions without manual config.\n\n### IPC server &amp; smithers-ctl CLI\n\nSmithers runs **Unix socket IPC server** `~/Library/Application Support/Smithers/smithers.sock` (or `/tmp/smithers.sock`) for external tools.\n\n**`smithers-ctl` CLI commands:**\n\n| Command | Description |\n|---------|-------------|\n| `smithers-ctl open-file &lt;path&gt; [+line:col]` | Open file at location (vim-style `+line:col`) |\n| `smithers-ctl terminal [run] &lt;command&gt;` | Open terminal, optionally run command |\n| `smithers-ctl search &lt;query&gt;` | Trigger workspace search |\n| `smithers-ctl diff show` | Open diff viewer with piped diff content |\n| `smithers-ctl webview open &lt;url&gt;` | Open URL in webview tab |\n| `smithers-ctl webview eval &lt;js&gt;` | Execute JavaScript in active webview |\n| `smithers-ctl agent spawn &lt;task&gt;` | Spawn new sub-agent |\n| `smithers-ctl agent cancel &lt;id&gt;` | Cancel running agent |\n| `smithers-ctl agent status [id]` | Get agent status |\n| `smithers-ctl jj status` | Get JJ status |\n| `smithers-ctl status` | Get app/workspace status |\n| `smithers-ctl read &lt;path&gt;` | Read file contents |\n| `smithers-ctl write &lt;path&gt;` | Write file contents from stdin |\n| `smithers-ctl set &lt;key&gt; &lt;value&gt;` | Change setting |\n\n**Wait-for-close:** `smithers-ctl open-file --wait` blocks until file closed editor. Useful `$EDITOR` integration (e.g., `export EDITOR=&quot;smithers-ctl open-file --wait&quot;`)\n\n**Unified capability surface:** CLI provides same capabilities as command palette + MCP server. Adding capability to one surface must add to all three (see engineering spec capability matrix)\n\n## Engineering Specification\n\n# Goals &amp; Constraints\n\n## 1.1 What v2 Solves\n\nv1 has single 7,100-line `WorkspaceState` god object owning all state (files, editor, chat, terminals, VCS, themes, search, UI chrome). 2,500-line `ContentView` contains editor `NSViewRepresentable`, tab bar, breadcrumbs, status bar, overlays. One target, no module boundaries ‚Üí theme change recompiles entire app.\n\nv2 fixes:\n\n1. **Files split for findability, not isolation** ‚Äî NOT eliminating god object. Single centralized state tree (Flux-style) = fine, desirable. Fix: v1&#x27;s 7,100-line files. v2 splits code into smaller domain-organized files. Xcode project with a flat dependency graph ‚Äî no complex DAG. File needs import ‚Üí import it. Don&#x27;t overcomplicate.\n\n2. **Composed state model** ‚Äî Instead of massive class holding everything, top-level `AppModel` contains smaller sub-models: `ChatModel` (msgs/sessions), `FileTreeModel` (browser), `TabModel` (editor tabs), etc. Each ~100-250 lines, owns one domain. Navigable ‚Äî understand chat ‚Üí read `ChatModel`, not 7,000-line file. Compose into single god object (`AppModel`) ‚Äî by design.\n\n3. **Chrome DevTools window arch** ‚Äî Main chat = &quot;pane 0&quot; (always present; closing hides to menu bar, does NOT quit). MVP uses two windows (chat + single workspace panel). Architecture should expand to multiple workspace panels later. Everything = tabs. Secondary window shows editor/terminal/diff/chat tabs. Windows positioned/resized/managed independently, share data via model layer.\n\n4. **Workspace-optional** ‚Äî Works without workspace. Launch ‚Üí just chat, no folder needed. Create/open workspace via main agent or Cmd+Shift+O. Usually users open in workspace dir.\n\n5. **Zig as logic layer (libghostty model)** ‚Äî Ideal arch = libghostty pattern: Zig lib (`libsmithers`) handles business logic, Swift = thin UI syncing with it. Zig = source of truth (state, subprocess mgmt, agent orchestration, protocols). Swift observes Zig state, renders UI. Evaluated case-by-case ‚Äî some stays Swift (UI-adjacent: scroll positions, animation), but default direction = push to Zig. Key reason: **cross-platform portability**. Smithers on Linux eventually ‚Üí Zig core unchanged, only UI replatformed. See 2.6 for Zig ‚Üî Swift arch.\n\n6. **Testability** ‚Äî Models/services in own files with clear boundaries ‚Üí unit tests run instantly with `swift test` (no simulator, no Xcode). Zig logic tested with `zig build test`. v1: testing service = import entire app.\n\n## 1.2 Hard Constraints\n\n### macOS 14+ (Sonoma) + `@Observable` Macro\n\nTarget macOS 14 (Sonoma) min. Important: macOS 14 introduced **Observation framework** with `@Observable` macro ‚Äî fundamentally better than old approach.\n\n**Background ‚Äî SwiftUI updates:**\n\nSwiftUI = declarative. Describe UI given data, SwiftUI figures out changes, re-renders affected parts. Critical: how does SwiftUI know data changed?\n\n**Old way (v1): `ObservableObject` + `@Published` (Combine)**\n\n```swift\nclass WorkspaceState: ObservableObject {\n    @Published var editorText: String = &quot;&quot;\n    @Published var chatMessages: [ChatMessage] = []\n    @Published var selectedFileURL: URL?\n    // ... 100+ @Published properties\n}\n```\n\nProblem: when ANY `@Published` changes, SwiftUI re-evaluates EVERY view observing object. `chatMessages` changes ‚Üí editor (only reads `editorText`) still re-evaluated. 100+ published props on one object = constant unnecessary work.\n\n**New way (v2): `@Observable` macro (Observation framework)**\n\n```swift\n@Observable\nclass WorkspaceModel {\n    var editorText: String = &quot;&quot;\n    var chatMessages: [ChatMessage] = []\n    var selectedFileURL: URL?\n}\n```\n\n`@Observable` ‚Üí SwiftUI tracks which specific props each view reads during last render. View only reads `editorText` ‚Üí ONLY re-renders when `editorText` changes, not `chatMessages`. *Fine-grained observation* ‚Äî dramatically more efficient.\n\nSimpler syntax: no `@Published` wrapper, just plain `var`. `@Observable` macro generates tracking at compile time.\n\n### Other Constraints\n\n- **Same features as v1:** editor with TreeSitter syntax, Ghostty terminal, Neovim modal editing, JJ version control, Codex AI chat, skills plugins, agent orchestration (parallel AI workers), command palette, workspace search, diff viewer.\n- **JJ bundled.** `jj` binary built + included in `.app` bundle. Users don&#x27;t install separately ‚Äî Smithers ships it. Hard dependency: agent orchestration, snapshot system, VCS UI all depend on jj.\n- **TUI-native interaction.** Native GUI must feel familiar to TUI users: terminal one keystroke away (Ctrl+A c or Cmd+`), Neovim mode for editing, all actions have keyboard shortcuts, Tmux-compat prefix keys, no mouse required for core workflows. GUI adds value via visual diff review, multi-agent dashboards, quad-pane layouts, parallel workspace mgmt ‚Äî not replacing terminal.\n- **Native macOS:** Standard window chrome (traffic lights), standard keyboard shortcuts (Cmd+S, Cmd+C, etc.), proper window mgmt (resize, minimize, fullscreen), focus rings, right-click context menus, drag-drop.\n- **Bundled binaries (shipped inside `.app`):**\n  - **GhosttyKit** ‚Äî Terminal = C lib (Zig, compiled to C-compat framework). Pre-built `.xcframework` (Apple format for pre-compiled libs). Swift calls Ghostty C functions via C interop (FFI).\n  - **codex-app-server** ‚Äî Small fork of OpenAI Codex (Rust binary, git submodule in EVMTS org). Fork wraps Codex in **Zig API** ‚Äî ONLY thing it does. libsmithers calls Zig API directly (no JSON-RPC, no child process). Storage handlers (SQLite) passed as callbacks. Built from source by `build.zig`, linked as static lib into libsmithers.\n  - **jj** ‚Äî Jujutsu VCS binary. Pre-built, copied into `Contents/MacOS/` during build. Located at runtime via `Bundle.main.path(forAuxiliaryExecutable: &quot;jj&quot;)`. JJService always uses bundled binary, never user&#x27;s PATH version.\n\n## 1.3 Non-Goals\n\nExplicitly NOT doing in v2 (scope mgmt):\n\n- **Cross-platform (iOS, Linux) ‚Äî deferred, not abandoned.** v2 ships macOS-only. SwiftUI technically supports iOS, but heavy AppKit interop (native macOS UI framework) for editor/terminal has no iOS equivalent. **However**, cross-platform (esp Linux) = explicit future goal. Why libsmithers in Zig ‚Äî Zig core fully portable. Smithers on Linux ‚Üí only UI replatformed; entire Zig business logic unchanged. Architect libsmithers with portability in mind.\n- **Rewriting Ghostty or Neovim.** Wrap as black boxes. Manage lifecycle (start, stop, communicate), don&#x27;t modify internals. (Note: codex-app-server IS forked ‚Äî only for Zig API wrapper + storage callbacks. Codex internals not rewritten.)\n- **LSP integration (Language Server Protocol).** Powers &quot;go to definition&quot;, &quot;find references&quot;, rich autocompletion in VS Code. Deferred to v2.1+ ‚Äî large subsystem, can be added non-disruptively later.\n- **Native git support.** Use jj exclusively. jj &quot;colocated&quot; mode maintains `.git` alongside `.jj` ‚Üí users can `git push`/`pull` through jj. No separate git integration needed.\n- **Custom font bundling.** Use system monospace (SF Mono on macOS) + system UI font (SF Pro). No font files shipped.\n\n## 1.3.1 Features from Issues Directory\n\n`issues/` contains feature specs from v1 arch. **Take feature descriptions literally, NOT implementation details** ‚Äî stale, based on old arch. v2 impl follows this spec.\n\n**MVP features (from issues):**\n- **007** ‚Äî Background + scheduled agents (tab-based agents, cron schedules)\n- **004** ‚Äî Claude Code / OpenCode integration (multiple agent backends, not just Codex)\n\n**Post-MVP:**\n- **038** ‚Äî Multi-workspace + Conductor parity (workspace switcher, cross-workspace search)\n- **039** ‚Äî Workflow Studio (Bun workflow engine, AI-powered workflow creation)\n- **020** ‚Äî Workspace tools sidebar panels (buffer list, markdown preview, search results)\n- **013** ‚Äî MiniApps (local-first web apps with JS bridge to Smithers SDK)\n- **010** ‚Äî Telegram agent bridge (mobile access to coding agents)\n- **033** ‚Äî Remote development (SSH/TCP Neovim sessions)\n\n**Explicitly NOT MVP:**\n- JJ merge queue UI (agent work merges via simple jj ops, no dedicated queue view)\n- MiniApps\n- Multi-workspace\n- Remote development\n\n## 1.4 Key Terminology\n\n| Term | Meaning |\n|------|---------|\n| **SwiftUI** | Apple&#x27;s declarative UI framework (React for macOS/iOS). Describe views as function of state, framework handles render/updates. |\n| **AppKit** | Older imperative macOS UI framework. Needed for things SwiftUI can&#x27;t do well (custom text editors, terminal rendering). SwiftUI embeds AppKit via `NSViewRepresentable`. |\n| **NSViewRepresentable** | SwiftUI protocol wrapping AppKit `NSView` for use in SwiftUI layouts. `Coordinator` object = bridge between SwiftUI declarative world + AppKit delegate-based world. |\n| **NSWindow** | Native macOS window object. Each on-screen window = one `NSWindow`. Two: main chat (pane 0), workspace panel. Tabs can detach into additional windows. |\n| **@MainActor** | Swift annotation ensuring code runs on main thread (UI thread). All UI updates on main thread. Background work (file I/O, network, process spawn) on other threads, dispatch results to `@MainActor`. |\n| **async/await** | Swift structured concurrency. `async` functions can pause (e.g., wait for network) without blocking thread. `await` marks pause point. `Task { }` creates concurrent work unit. `Task.detached { }` creates one not inheriting current actor context (for blocking work off main thread). |\n| **SPM (Swift Package Manager)** | Swift&#x27;s built-in dependency mgr + build system (like npm/cargo). Config via `Package.swift`. Defines targets (libs/executables), source dirs, dependencies on other targets/external packages. |\n| **xcodegen** | Generates Xcode project files (`.xcodeproj`) from YAML config (`project.yml`). Needed because SPM alone can&#x27;t define XCUITest targets (Apple&#x27;s UI testing requires Xcode project). |\n| **xcframework** | Apple format for distributing pre-compiled libs across architectures (Intel + Apple Silicon). GhosttyKit distributed this way. |\n| **TreeSitter** | Parser generator producing fast, incremental parsers. Syntax highlighting ‚Äî parses code into syntax tree, map nodes to colors. Each language (Swift, Python, JS, etc.) has own TreeSitter grammar. |\n| **FFI (Foreign Function Interface)** | Calling functions written in one language from another. Call Ghostty C functions from Swift, Neovim MessagePack RPC from Swift. |\n| **JSON-RPC** | Protocol for remote procedure calls using JSON. For communication with secondary agent backends (Claude Code, OpenCode). Primary Codex integration = in-process via Zig API (no JSON-RPC). |\n| **MessagePack RPC** | Like JSON-RPC but uses MessagePack (binary serialization, like compressed JSON) instead of text JSON. Neovim&#x27;s native protocol. |\n| **Sendable** | Swift protocol marking type as safe to pass between concurrent threads. Value types (structs, enums) usually auto-Sendable. Ref types (classes) need explicit thread-safety. |\n| **UserDefaults** | macOS built-in key-value storage for app preferences. Simple, persistent across launches, only for small data (settings, window positions). Not for large data (chat history). |\n| **libsmithers** | Zig core lib. Contains business logic, agent orchestration, protocol handling. Swift calls via C FFI. Follows libghostty pattern. |\n| **Zig** | Systems programming language with no runtime, no GC, C-compatible ABI. Portable logic layer (like libghostty). Compiles to any target ‚Üí future cross-platform support. |\n| **C FFI** | Interface between Swift + Zig. Zig exposes C-compat functions Swift calls directly. State change notifications via callback function pointers with opaque `userdata` pointers (GhosttyKit pattern). |\n| **Orchestrator** | Main chat&#x27;s role. Answers simple questions directly (via MCP tools to read state), primarily delegates work tasks to sub-agents. Has full app state context, coordinates everything. All async ‚Äî delegate fast, respond immediately, process results as they come. |\n| **Sub-agent** | Ephemeral CodexService instance spawned by orchestrator for specific task. Appears as `.chat` tab in workspace panel. Has own jj workspace branch. |\n\n## 2. Repository &amp; Build\n\n### 2.1 Structure\n\n```\nsmithers/\n‚îú‚îÄ‚îÄ build.zig                  # THE makefile: Zig core, vendored C, Rust subs (Codex, JJ), xcframework, Swift, web\n‚îú‚îÄ‚îÄ build.zig.zon              # Zig package manifest\n‚îú‚îÄ‚îÄ AGENTS.md / CLAUDE.md      # Agent / Claude Code instructions\n‚îú‚îÄ‚îÄ docs/{design,engineering}.md\n‚îú‚îÄ‚îÄ issues/                    # Post-MVP feature specs\n‚îú‚îÄ‚îÄ prototype1/                # Next.js UI reference (frozen)\n‚îú‚îÄ‚îÄ include/libsmithers.h      # C API header ‚Äî THE Zig‚ÜîSwift contract\n‚îú‚îÄ‚îÄ src/                       # Zig (libsmithers logic)\n‚îÇ   ‚îú‚îÄ‚îÄ lib.zig               # Root: C API exports\n‚îÇ   ‚îú‚îÄ‚îÄ orchestrator.zig, agent.zig, codex_client.zig, jj.zig, search.zig\n‚îÇ   ‚îú‚îÄ‚îÄ file_watcher.zig, chat_state.zig, snapshot.zig, suggestion.zig\n‚îÇ   ‚îú‚îÄ‚îÄ ipc.zig, mcp_server.zig, http_server.zig, scheduler.zig\n‚îÇ   ‚îú‚îÄ‚îÄ storage.zig, memory.zig\n‚îÇ   ‚îî‚îÄ‚îÄ models/               # Zig structs ‚Üí C structs ‚Üí Swift\n‚îú‚îÄ‚îÄ pkg/                       # Vendored C/C++ + Zig wrappers\n‚îÇ   ‚îú‚îÄ‚îÄ sqlite/, zap/, tree-sitter/grammars/, macos/\n‚îú‚îÄ‚îÄ submodules/                # Git subs (Rust forks + Zig wrappers)\n‚îÇ   ‚îú‚îÄ‚îÄ codex/                # EVMTS fork: cargo ‚Üí static lib ‚Üí Zig API\n‚îÇ   ‚îî‚îÄ‚îÄ jj/                   # EVMTS fork: no code changes, Zig build wrapper\n‚îú‚îÄ‚îÄ macos/                     # Swift app (Ghostty pattern)\n‚îÇ   ‚îú‚îÄ‚îÄ Smithers.xcodeproj/   # Real Xcode (no Package.swift, no xcodegen)\n‚îÇ   ‚îú‚îÄ‚îÄ Smithers-Info.plist, Smithers.entitlements\n‚îÇ   ‚îú‚îÄ‚îÄ SmithersKit.xcframework/, GhosttyKit.xcframework/\n‚îÇ   ‚îú‚îÄ‚îÄ Assets.xcassets/\n‚îÇ   ‚îú‚îÄ‚îÄ Sources/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App/              # Entry, scenes, window coord\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Ghostty/SmithersCore.swift  # C FFI bridge\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Features/         # Chat, IDE, Terminal, Editor, Neovim, Agents, Skills, Settings, Command Palette, Search, Update\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Helpers/{Extensions, DesignSystem}\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Services/         # Thin over libsmithers C API\n‚îÇ   ‚îú‚îÄ‚îÄ Tests/, SmithersUITests/\n‚îú‚îÄ‚îÄ web/                       # SolidJS parallel app\n‚îÇ   ‚îú‚îÄ‚îÄ package.json          # SolidJS + shadcn-solid + Tailwind + Monaco\n‚îÇ   ‚îú‚îÄ‚îÄ src/{index.tsx, components/, features/, lib/, styles/}\n‚îî‚îÄ‚îÄ dist/                      # Packaging, signing\n```\n\n**Mirrors Ghostty:** `src/` Zig, `pkg/` vendored C + Zig wrappers, `include/` C API, `macos/` Swift + real Xcode, `build.zig` THE makefile, `submodules/` Rust forks, `web/` SolidJS (talks HTTP), feature-based `macos/Sources/Features/`.\n\n**No Package.Swift.** Real Xcode. SPM via Xcode (Sparkle, STTextView, GRDB.swift) ‚Äî Ghostty approach.\n\n**Vendor + Zig wrap:** C/C++ ‚Üí `pkg/` + Zig wrappers (SQLite, Zap/facil.io, TreeSitter). Rust ‚Üí `submodules/` forks + Zig wrappers calling `cargo build` (EVMTS org). Swift ‚Üí Xcode SPM. Web ‚Üí npm/pnpm.\n\n**Pattern:** Every dep has `build.zig` wrapper ‚Üí target is `zig build dev` builds all from source once wired. Until then, use `zig build` / `zig build all`.\n\n**Zig‚ÜíSwift migration:** MVP starts more Swift (v1 is Swift, proven). `src/` Zig grows, `Services/` shrinks. `Ghostty/` Swift wrapper thins as logic migrates.\n\n**Feature-based:** `macos/Sources/Features/` ‚Äî views+models+VMs per feature, not by arch layer. Findable.\n\n### 2.2 Xcode (no Package.swift)\n\nGhostty approach: real `Smithers.xcodeproj`, no SPM app target. SPM via Xcode: Sparkle (binary xcframework), STTextView, GRDB.swift.\n\nTreeSitter vendored `pkg/tree-sitter/` ‚Äî core + all grammars (Swift, JS, TS, Python, JSON, Bash, Markdown, Zig, Rust, Go) with C + `highlights.scm`. Zig builds ‚Üí static lib ‚Üí Swift links via SmithersKit.xcframework.\n\nGhosttyKit, SmithersKit = xcframeworks pre-built by build systems ‚Üí `macos/`, Xcode refs as binary.\n\ncodex-app-server, jj = submodules built by `build.zig` (`cargo build`) ‚Üí copied to `.app` bundle.\n\n### 2.3 Xcode project\n\n`Smithers.xcodeproj`: Smithers app, SmithersTests, SmithersUITests. No xcodegen ‚Äî maintained direct (Ghostty).\n\n### 2.4 Build pipeline\n\n`build.zig` THE makefile ‚Äî dependency graph (Ghostty pattern):\n\n1. Build vendored C (`pkg/sqlite/`, `pkg/tree-sitter/`, etc.)\n2. Build Rust subs (`submodules/codex/build.zig` ‚Üí `cargo build --release` codex; same for jj)\n3. Build libsmithers (`src/` ‚Üí `.a`, link vendored, gen `include/libsmithers.h`)\n4. Package SmithersKit.xcframework (`.a` + header ‚Üí xcframework)\n5. Build macOS (`xcodebuild build -project macos/Smithers.xcodeproj -scheme Smithers`)\n6. Copy binaries (codex-app-server, jj ‚Üí `.app/Contents/MacOS/`)\n7. Build web (optional: `cd web &amp;&amp; pnpm install &amp;&amp; pnpm build`)\n8. Launch (`open .build/xcode/Build/Products/Debug/Smithers.app`)\n\n**Commands (current build.zig):** `zig build`, `zig build run`, `zig build test`, `zig build all`, `zig build fmt-check`, `zig build prettier-check`, `zig build typos-check`, `zig build shellcheck`.\n\n**Planned (add to build.zig):** `zig build dev` (1-8 full+launch), `zig build web`, `zig build playwright` (web+HTTP+e2e), `zig build codex`, `zig build jj`, `zig build xcode-test` (Swift tests), `zig build ui-test` (XCUITest).\n\n### 2.5 Binary integration\n\n**GhosttyKit.xcframework** ‚Äî pre-built C, `macos/GhosttyKit.xcframework`, Xcode binary ref, `import GhosttyKit`.\n\n**SmithersKit.xcframework** ‚Äî `build.zig` from `src/` Zig ‚Üí `libsmithers.a` + `include/libsmithers.h`.\n\n**codex-app-server (EVMTS fork)** ‚Äî small OpenAI Codex fork, EVMTS org submodule `submodules/codex/`. **Wraps Codex in Zig API.** Compiles static lib (not binary), Zig API libsmithers calls direct. Storage handlers as Zig callbacks ‚Üí `src/storage.zig` writes SQLite (Codex doesn&#x27;t know SQLite). Fork `build.zig` wraps `cargo build --release --lib` ‚Üí static ‚Üí Zig API. Build pipeline (via `zig build dev` once wired) builds+links. Minimal fork rebased upstream. **No child process, no JSON-RPC, no pipes** ‚Äî in-process linked lib.\n\n**jj (EVMTS fork)** ‚Äî Jujutsu fork EVMTS org `submodules/jj/`. **No code changes** ‚Äî just Zig `build.zig` wrapper. Build pipeline (via `zig build dev` once wired) builds jj binary, copies `.app/Contents/MacOS/`. No user PATH dep.\n\n**SQLite (vendored)** ‚Äî `pkg/sqlite/` + Zig wrapper. Used `src/storage.zig`. Separate from GRDB.swift (Swift layer). Both access same db WAL mode concurrent.\n\n### 2.6 Zig‚ÜîSwift (libsmithers model)\n\n**libghostty pattern:** Zig business logic, Swift thin UI syncs.\n\n**Why Zig:** Cross-platform (Zig unchanged, UI replatformed Linux/Windows). Performance (no runtime, no GC). Testability (`zig build test` no Apple deps).\n\n**Split:**\n| Layer | Lang | Responsibilities |\n|-------|------|------------------|\n| libsmithers (Zig) | Zig | Agent orchestration, codex protocol, jj ops, file watch, IPC, chat state, suggestion, search, snapshot. Source of truth. |\n| SmithersUI (Swift) | Swift/SwiftUI | Render, animations, AppKit (STTextView, Ghostty surface, NSWindow), input, a11y. Observes libsmithers ‚Üí renders. |\n\n**Communication (libghostty exact patterns):**\n\n**1. C header contract:**\n\n```c\n// include/libsmithers.h ‚Äî THE Zig‚ÜîSwift contract\n\n// Opaque (Swift never sees Zig internals)\ntypedef struct smithers_app_s* smithers_app_t;\ntypedef struct smithers_surface_s* smithers_surface_t;  // per-workspace\n\n// Lifecycle\nsmithers_app_t smithers_app_new(const smithers_config_t* config);\nvoid smithers_app_free(smithers_app_t app);\n\n// Actions (Swift‚ÜíZig intent dispatch) ‚Äî tagged union, one fn many types\ntypedef enum {\n    SMITHERS_ACTION_CHAT_SEND, SMITHERS_ACTION_WORKSPACE_OPEN,\n    SMITHERS_ACTION_WORKSPACE_CLOSE, SMITHERS_ACTION_AGENT_SPAWN,\n    SMITHERS_ACTION_AGENT_CANCEL, SMITHERS_ACTION_FILE_SAVE,\n    SMITHERS_ACTION_FILE_OPEN, SMITHERS_ACTION_SEARCH,\n    SMITHERS_ACTION_JJ_COMMIT, SMITHERS_ACTION_JJ_UNDO,\n    SMITHERS_ACTION_SETTINGS_CHANGE, SMITHERS_ACTION_SUGGESTION_REFRESH,\n    // ... grows\n} smithers_action_tag_e;\n\ntypedef union { /* per-action payloads */ } smithers_action_payload_u;\n\nvoid smithers_app_action(smithers_app_t app, smithers_action_tag_e tag,\n                         smithers_action_payload_u payload);\n\n// Callbacks (Zig‚ÜíSwift) ‚Äî ghostty: fn ptr + opaque userdata\ntypedef void (*smithers_wakeup_cb)(void* userdata);\ntypedef void (*smithers_action_cb)(void* userdata, smithers_action_tag_e tag,\n                                   const void* data, size_t len);\n\ntypedef struct {\n    smithers_wakeup_cb wakeup;       // &quot;changed, re-read&quot;\n    smithers_action_cb action;       // &quot;specific event&quot;\n    void* userdata;                  // Unmanaged&lt;App&gt;.toOpaque()\n} smithers_runtime_config_s;\n```\n\n**2. Zig exports (ghostty CAPI):**\n\n```zig\n// src/lib.zig\nconst App = @import(&quot;app.zig&quot;).App;\n\npub const CAPI = struct {\n    pub export fn smithers_app_new(config: *const c.smithers_config_t) callconv(.c) ?*App {\n        return App.init(config) catch null;\n    }\n    pub export fn smithers_app_free(app: *App) callconv(.c) void {\n        app.deinit();\n    }\n    pub export fn smithers_app_action(\n        app: *App, tag: c.smithers_action_tag_e, payload: c.smithers_action_payload_u,\n    ) callconv(.c) void {\n        app.performAction(tag, payload);\n    }\n};\n\n// Force export all CAPI symbols\ncomptime {\n    for (@typeInfo(CAPI).@&quot;struct&quot;.decls) |decl| {\n        _ = &amp;@field(CAPI, decl.name);\n    }\n}\n```\n\n**3. Swift bridge (Unmanaged pattern):**\n\n```swift\n// Bridge/LibSmithers.swift\nfinal class SmithersCore {\n    private let app: smithers_app_t\n\n    init(config: SmithersConfig) throws {\n        var cConfig = config.toCConfig()\n        // Callbacks ‚Äî Unmanaged pattern\n        cConfig.runtime.userdata = Unmanaged.passUnretained(self).toOpaque()\n        cConfig.runtime.wakeup = { userdata in\n            let core = Unmanaged&lt;SmithersCore&gt;.fromOpaque(userdata!).takeUnretainedValue()\n            DispatchQueue.main.async { core.handleWakeup() }\n        }\n        cConfig.runtime.action = { userdata, tag, data, len in\n            let core = Unmanaged&lt;SmithersCore&gt;.fromOpaque(userdata!).takeUnretainedValue()\n            core.handleAction(tag, data: data, len: len)\n        }\n        guard let app = smithers_app_new(&amp;cConfig) else { throw SmithersError.initFailed }\n        self.app = app\n    }\n\n    deinit { smithers_app_free(app) }\n\n    // Actions ‚Üí Zig (Swift never mutates state)\n    func sendChatMessage(_ text: String) {\n        text.withCString { cStr in\n            var payload = smithers_action_payload_u()\n            payload.chat_send.message = cStr\n            smithers_app_action(app, SMITHERS_ACTION_CHAT_SEND, payload)\n        }\n    }\n\n    // Zig callbacks ‚Üí Swift NotificationCenter\n    private func handleAction(_ tag: smithers_action_tag_e, data: UnsafeRawPointer?, len: Int) {\n        switch tag {\n        case SMITHERS_ACTION_CHAT_DELTA:\n            NotificationCenter.default.post(name: .smithersChatDelta, object: /* decoded */)\n        case SMITHERS_ACTION_AGENT_STATUS:\n            NotificationCenter.default.post(name: .smithersAgentStatus, object: /* decoded */)\n        default: break\n        }\n    }\n\n    private func handleWakeup() {\n        NotificationCenter.default.post(name: .smithersWakeup, object: nil)\n    }\n}\n```\n\n**4. libsmithers interfaces (critical):**\n\n**Multiple consumers, same Zig API. Principle: CLI tools = command palette = MCP server. One capability, multiple access.**\n\n**Interfaces:**\n1. **C API** ‚Üí Swift UI (above). libghostty pattern.\n2. **MCP server** ‚Üí Codex orchestrator. **Inject libsmithers MCP into Codex runtime** ‚Äî how Codex controls Smithers. Exposes IDE tools (open files, terminals, search, spawn agents, etc.). Transport (stdio/socket/in-process) = engineering decision from Codex source study.\n3. **CLI** (`smithers-ctl`) ‚Üí external tools, scripts, shell. Same capability as palette+MCP.\n4. **HTTP/WS server** ‚Üí **SolidJS web app** (`web/`). Same capability C API, MCP, CLI over HTTP REST + WS real-time. Zig (`src/http_server.zig`) using **Zap** (vendored `pkg/zap/`, wraps facil.io ~3.2k stars, WebSocket). No auth (localhost). Serves web static, WS PTY for xterm.js. **Playwright primary consumer** ‚Äî e2e tests full Zig via web.\n5. **Zig API** ‚Üí internal.\n\nMCP exposes palette capabilities. Main Codex connects MCP. **Sub-agents NO MCP** ‚Äî only filesystem+terminal scoped to jj branch.\n\n**MCP‚ÜîCodex:** Figure best injection (stdio/socket/in-process). Study `codex-app-server` source.\n\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ                  libsmithers (Zig)                        ‚îÇ\n‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ\n‚îÇ ‚îÇZig API ‚îÇ ‚îÇ C API  ‚îÇ ‚îÇ MCP ‚îÇ ‚îÇ CLI ‚îÇ ‚îÇHTTP  ‚îÇ          ‚îÇ\n‚îÇ ‚îÇ(intern)‚îÇ ‚îÇ(Swift) ‚îÇ ‚îÇServ ‚îÇ ‚îÇstdio‚îÇ ‚îÇ /WS  ‚îÇ          ‚îÇ\n‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ\n‚îÇ     ‚Üë          ‚Üë         ‚Üë       ‚Üë        ‚Üë              ‚îÇ\n‚îÇ  [Zig mods] [Swift]  [Codex] [smithers-ctl] [SolidJS]   ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n**5. Zig memory (arenas):**\n\n**Rule: same lifetime ‚Üí same arena.** Eliminates individual frees, trivial cleanup.\n\n- **Lifetime allocation:** Shared lifetime = shared arena. Agent session = one arena (complete ‚Üí free all). Chat message = message arena. Workspace = workspace arena.\n- **Arena everywhere:** `std.heap.ArenaAllocator` default. App arena = process life. Workspace = until close. Agent = until complete. Request = MCP/CLI duration.\n- **Owned return:** Return owned data ‚Üí internal arena scratch, copy caller allocator before return. Predictable lifetimes, no dangling.\n- **No hidden allocs:** Every allocating fn takes explicit `Allocator` param. Idiomatic Zig, obvious ownership.\n\n```zig\n// Arena-per-agent\npub const Agent = struct {\n    arena: std.heap.ArenaAllocator,\n    messages: std.ArrayList(Message),\n    workspace_path: []const u8,\n    // All from arena\n\n    pub fn deinit(self: *Agent) void {\n        self.arena.deinit();  // One free kills all\n    }\n};\n\n// Owned return with caller alloc\npub fn getAgentListJson(app: *App, caller_alloc: Allocator) ![]const u8 {\n    var scratch = std.heap.ArenaAllocator.init(std.heap.page_allocator);\n    defer scratch.deinit();\n    const tmp = try buildJsonArray(scratch.allocator(), app.agents);\n    return try caller_alloc.dupe(u8, tmp);  // Caller owns\n}\n```\n\n**Build approach ‚Äî Zig TDD, UI parallel:**\n\nTDD ‚Äî `zig build test` instant, no Apple deps. Swift parallel using mocks.\n\n1. **Phase A (Zig):** `src/` modules + comprehensive `zig build test`. Mock Codex, recorded sessions.\n2. **Phase B (Swift parallel):** Views + `@Observable` using `MockSmithersCore` canned data. No Zig block.\n3. **Phase C (integration):** Replace Mock ‚Üí real `SmithersCore` wrapping `libsmithers.a`. Integration tests.\n\n**Build integration (`build.zig`):**\n1. Vendored C `pkg/` (SQLite, TreeSitter, etc.)\n2. Rust subs `cargo build --release` (codex, jj)\n3. Compile libsmithers `.a` + gen `include/libsmithers.h`\n4. Package SmithersKit.xcframework\n5. `zig build test`\n6. `xcodebuild` Swift (links SmithersKit+GhosttyKit)\n7. Copy Rust bins ‚Üí `.app/Contents/MacOS/`\n8. Web (optional): `cd web &amp;&amp; pnpm install &amp;&amp; pnpm build`\n9. Launch\n\n**Zig-wrapped deps:** Logic layer owns from day one:\n\n- **jj** ‚Äî Zig spawns bundled binary, parses JSON. `src/jj.zig` owns VCS.\n- **codex-app-server** ‚Äî Zig calls in-process Zig API. `src/codex_client.zig` wraps, `src/orchestrator.zig` dispatches.\n- **ripgrep** ‚Äî Zig wraps `rg`. `src/search.zig`.\n- **File watch** ‚Äî FSEvents macOS C API (`CoreServices`), inotify Linux later. `src/file_watcher.zig`.\n- **MCP** ‚Äî Zig implements protocol. `src/mcp_server.zig`.\n\n**Stay Swift:** UI render, STTextView/editor coord, Ghostty surface (Zig via GhosttyKit), Neovim RPC (deep AppKit), prefs UI, window mgmt, a11y.\n\n# Code Organization\n\n## Philosophy\n\n**Feature-based org** (Ghostty pattern). Code by feature, not layer. Chat ‚Üí `Features/Chat/`, editor ‚Üí `Features/Editor/`, etc. Makes features findable.\n\nNo complex module graph. Single Xcode app target, organized by dirs. Any file refs any other ‚Äî intentional. Dir structure provides findability, not isolation.\n\n**Principle:** &quot;Not avoiding god object. Breaking into smaller, findable files.&quot; Single god object with modular file split = correct architecture.\n\n## Directory Responsibilities\n\nAll within `macos/Sources/`. Files ref each other directly ‚Äî no imports between dirs.\n\n### App/\n\nEntry point, window coordination, app-wide state.\n\n```\nApp/\n‚îú‚îÄ‚îÄ SmithersApp.swift            ‚Äî @main, scenes, menu commands\n‚îú‚îÄ‚îÄ AppModel.swift               ‚Äî Composition root: single @Observable god object\n‚îú‚îÄ‚îÄ WorkspaceModel.swift         ‚Äî Per-workspace state\n‚îú‚îÄ‚îÄ WindowCoordinator.swift      ‚Äî Create, show, hide, focus workspace windows\n‚îú‚îÄ‚îÄ CloseGuard.swift             ‚Äî Unsaved changes prompts (tab/window/app close)\n‚îú‚îÄ‚îÄ TmuxKeyHandler.swift         ‚Äî Ctrl+A prefix system\n‚îî‚îÄ‚îÄ UpdateController.swift       ‚Äî Sparkle integration\n```\n\n### Ghostty/\n\nCore libsmithers Swift wrapper (like Ghostty&#x27;s dir). C FFI bridge.\n\n```\nGhostty/\n‚îú‚îÄ‚îÄ SmithersCore.swift          ‚Äî Thin wrapper around libsmithers C API (Unmanaged/callbacks)\n‚îú‚îÄ‚îÄ MockSmithersCore.swift      ‚Äî Mock for parallel UI dev\n‚îî‚îÄ‚îÄ Surface View/               ‚Äî If needed for terminal surface mgmt\n```\n\n### Features/\n\nFeature-based. Each dir contains views, models, feature logic.\n\n#### Features/Chat/\n\n```\nFeatures/Chat/\n‚îú‚îÄ‚îÄ Models/\n‚îÇ   ‚îú‚îÄ‚îÄ ChatMessage.swift        ‚Äî Message (role, kind, images, timestamps, turns)\n‚îÇ   ‚îú‚îÄ‚îÄ ChatSession.swift        ‚Äî Session metadata (id, title, creation, last preview)\n‚îÇ   ‚îî‚îÄ‚îÄ ChatModel.swift          ‚Äî Sessions, msgs, streaming (~250 lines)\n‚îú‚îÄ‚îÄ Views/\n‚îÇ   ‚îú‚îÄ‚îÄ ChatWindowRootView.swift ‚Äî NavigationSplitView (sidebar + detail)\n‚îÇ   ‚îú‚îÄ‚îÄ Sidebar/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatSidebarView.swift, SidebarModeBar.swift, ChatSessionList.swift,\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatSessionRow.swift, ChatSidebarSearchField.swift\n‚îÇ   ‚îú‚îÄ‚îÄ Detail/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatDetailView.swift, ChatTitleBarZone.swift, ChatMessagesZone.swift,\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MessageBubbles/ (User, Assistant, Command, Diff, Status)\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MessageHoverActionBar.swift, ChatComposerZone.swift,\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SlashCommandPopup.swift, MentionPopup.swift, ChatWelcomeScreen.swift\n‚îÇ   ‚îî‚îÄ‚îÄ DiffSheet/InlineDiffViewer.swift\n‚îî‚îÄ‚îÄ Services/\n    ‚îú‚îÄ‚îÄ CodexService.swift               ‚Äî Thin wrapper over libsmithers Codex C API (in-process)\n    ‚îú‚îÄ‚îÄ JSONRPCTransport.swift           ‚Äî JSON-RPC framing for non-Codex backends (Claude Code/OpenCode)\n    ‚îú‚îÄ‚îÄ SuggestionService.swift          ‚Äî AI-generated workspace suggestions\n    ‚îî‚îÄ‚îÄ ChatHistoryStore.swift           ‚Äî SQLite chat persistence\n```\n\n#### Features/IDE/\n\n```\nFeatures/IDE/\n‚îú‚îÄ‚îÄ IDEWindowRootView.swift      ‚Äî NavigationSplitView (sidebar + detail)\n‚îú‚îÄ‚îÄ Sidebar/ (FileTreeSidebar, FileTreeRow, FileTreeEmptyState)\n‚îú‚îÄ‚îÄ Detail/\n‚îÇ   ‚îú‚îÄ‚îÄ IDEWorkspaceDetailView.swift, IDETabBar.swift, IDETabItem.swift,\n‚îÇ   ‚îú‚îÄ‚îÄ BreadcrumbBar.swift, IDEContentArea.swift, IDEStatusBar.swift, IDEEmptyState.swift\n‚îú‚îÄ‚îÄ DiffViewer/DiffViewer.swift\n‚îî‚îÄ‚îÄ Models/\n    ‚îú‚îÄ‚îÄ FileItem.swift, TabItem.swift, TabModel.swift,\n    ‚îú‚îÄ‚îÄ FileTreeModel.swift, EditorStateModel.swift\n```\n\n### Helpers/\n\n```\nHelpers/\n‚îú‚îÄ‚îÄ Extensions/ (NSColor+Hex, View+Theme, etc.)\n‚îú‚îÄ‚îÄ DesignSystem/ (Tokens, AppTheme, shared components: IconButton, Badge, etc.)\n‚îî‚îÄ‚îÄ Protocols.swift\n```\n\n### Services/\n\nExternal integrations. All async. Classes (ref types) ‚Äî manage subprocess lifecycle, connections, caches.\n\n```\nServices/\n‚îú‚îÄ‚îÄ CodexService.swift (in-process), JSONRPCTransport.swift (external providers), CompletionService.swift,\n‚îú‚îÄ‚îÄ JJService.swift, JJSnapshotStore.swift, CommitStyleDetector.swift,\n‚îú‚îÄ‚îÄ AgentOrchestrator.swift, SearchService.swift, SuggestionService.swift,\n‚îú‚îÄ‚îÄ SkillScanner.swift, SkillRegistryClient.swift, SkillInstaller.swift,\n‚îú‚îÄ‚îÄ ChatHistoryStore.swift, SessionStore.swift, WindowFrameStore.swift,\n‚îú‚îÄ‚îÄ IPCServer.swift, SmithersCtlInterpreter.swift, FileWatcher.swift,\n‚îî‚îÄ‚îÄ ServiceContainer.swift (holds all service instances, created by AppModel)\n```\n\n### DesignSystem/\n\nTokens + shared SwiftUI components. No business logic.\n\n```\nDesignSystem/\n‚îú‚îÄ‚îÄ Tokens/ (ColorTokens, Typography, Spacing, Radii, Shadows)\n‚îú‚îÄ‚îÄ Theme/ (AppTheme, ThemeEnvironment, ThemeDerived)\n‚îú‚îÄ‚îÄ Components/ (IconButton, PrimaryButton, PillButton, Badge, Panel, SidebarListRow, DividerLine, ToastView)\n‚îî‚îÄ‚îÄ Extensions/ (NSColor+Hex, View+Theme)\n```\n\n### Editor/\n\nCode editor subsystem. STTextView, TreeSitter, design tokens. Access services (e.g., `CompletionService` for ghost text) + models.\n\n```\nEditor/\n‚îú‚îÄ‚îÄ CodeEditorView.swift, CodeEditorCoordinator.swift, MultiCursorTextView.swift,\n‚îú‚îÄ‚îÄ TreeSitterHighlighter.swift, SupportedLanguages.swift,\n‚îú‚îÄ‚îÄ EditorCursorView.swift, EditorCursorGroupView.swift, GhostTextOverlayView.swift,\n‚îú‚îÄ‚îÄ ScrollbarOverlayView.swift, ScrollbarHostingView.swift, IndentGuidesView.swift,\n‚îú‚îÄ‚îÄ MinimapView.swift, BracketMatcher.swift\n```\n\n### Terminal/\n\nGhostty integration. Thin wrapper around C lib.\n\n```\nTerminal/\n‚îú‚îÄ‚îÄ GhosttyApp.swift (singleton managing ghostty_app_t lifecycle)\n‚îú‚îÄ‚îÄ GhosttyTerminalView.swift (NSView wrapping ghostty_surface_t)\n‚îú‚îÄ‚îÄ GhosttyInput.swift (keyboard ‚Üí ghostty key mapping)\n‚îú‚îÄ‚îÄ GhosttyFrameScheduler.swift (display link for frame rendering)\n‚îî‚îÄ‚îÄ TerminalConfiguration.swift (config string builder)\n```\n\n### Neovim/\n\nNeovim mode. Subprocess + bidirectional sync (editor, file tree, tab model, terminal).\n\n```\nNeovim/\n‚îú‚îÄ‚îÄ NvimController.swift (subprocess lifecycle + RPC bridge)\n‚îú‚îÄ‚îÄ NvimRPC.swift (MessagePack encoder/decoder)\n‚îú‚îÄ‚îÄ NvimExtUIOverlay.swift (SwiftUI overlays: cmdline, popup, messages)\n‚îú‚îÄ‚îÄ NvimFloatingWindowEffects.swift, NvimUIState.swift, InputMethodSwitcher.swift\n```\n\n### Views/Chat/\n\nChat window view hierarchy.\n\n```\nViews/Chat/\n‚îú‚îÄ‚îÄ ChatWindowRootView.swift\n‚îú‚îÄ‚îÄ Sidebar/ (ChatSidebarView, SidebarModeBar, ChatSessionList, ChatSessionRow, ChatSidebarSearchField, JJPanelSidebar, AgentDashboardSidebar)\n‚îú‚îÄ‚îÄ Detail/\n‚îÇ   ‚îú‚îÄ‚îÄ ChatDetailView.swift, ChatTitleBarZone.swift, ChatMessagesZone.swift,\n‚îÇ   ‚îú‚îÄ‚îÄ MessageBubbles/ (User, Assistant, Command, DiffPreview, Status, StarterPrompt)\n‚îÇ   ‚îú‚îÄ‚îÄ MessageHoverActionBar.swift, ChatComposerZone.swift, AttachmentStrip.swift,\n‚îÇ   ‚îú‚îÄ‚îÄ FullscreenImageViewer.swift, ChatWelcomeScreen.swift\n‚îî‚îÄ‚îÄ DiffSheet/InlineDiffViewer.swift\n```\n\n### Views/IDE/\n\nIDE/workspace window hierarchy.\n\n```\nViews/IDE/\n‚îú‚îÄ‚îÄ IDEWindowRootView.swift\n‚îú‚îÄ‚îÄ Sidebar/ (FileTreeSidebar, FileTreeRow, FileTreeEmptyState)\n‚îú‚îÄ‚îÄ Detail/ (IDEWorkspaceDetailView, IDETabBar, IDETabItem, BreadcrumbBar, IDEContentArea, IDEStatusBar, IDEEmptyState)\n‚îî‚îÄ‚îÄ DiffViewer/DiffViewer.swift\n```\n\n### Views/Overlays/\n\nShared or IDE-specific overlays.\n\n```\nViews/Overlays/\n‚îú‚îÄ‚îÄ CommandPaletteView.swift (Cmd+P fuzzy finder)\n‚îú‚îÄ‚îÄ SearchPanelView.swift (Cmd+Shift+F workspace search)\n‚îú‚îÄ‚îÄ KeyboardShortcutsPanel.swift (Cmd+/ slide-in)\n‚îî‚îÄ‚îÄ ProgressBarView.swift (top-edge progress)\n```\n\n### App/\n\nEntry point, window coordination, app-wide concerns.\n\n```\nApp/\n‚îú‚îÄ‚îÄ SmithersApp.swift (@main, scenes, menus)\n‚îú‚îÄ‚îÄ WindowCoordinator.swift (create, show, hide, focus workspace windows)\n‚îú‚îÄ‚îÄ CloseGuard.swift (unsaved prompts: tab/window/app)\n‚îú‚îÄ‚îÄ TmuxKeyHandler.swift (Ctrl+A prefix)\n‚îú‚îÄ‚îÄ SettingsView.swift (preferences window)\n‚îî‚îÄ‚îÄ UpdateController.swift (Sparkle)\n```\n\n# State Architecture\n\n## Overview\n\nv2 uses `@Observable` (not Combine `ObservableObject`+`@Published`). SwiftUI tracks per-view property reads, invalidates only when those change.\n\n## Model Graph\n\n```\nAppModel (@Observable, @MainActor)\n‚îú‚îÄ‚îÄ workspace: WorkspaceModel?           ‚Äî nil until folder opened (single for MVP)\n‚îú‚îÄ‚îÄ chat: ChatModel                      ‚Äî works WITHOUT workspace\n‚îÇ   ‚îú‚îÄ‚îÄ sessions, messages, streaming state\n‚îÇ   ‚îî‚îÄ‚îÄ suggestions: [SuggestedPrompt]   ‚Äî AI-generated, workspace-aware\n‚îú‚îÄ‚îÄ preferences: PreferencesModel        ‚Äî all settings ‚Üí UserDefaults\n‚îú‚îÄ‚îÄ theme: AppTheme                      ‚Äî resolved tokens (from prefs + optional nvim override)\n‚îú‚îÄ‚îÄ windowCoordinator: WindowCoordinator ‚Äî manages workspace panel window\n‚îî‚îÄ‚îÄ services: ServiceContainer\n    ‚îú‚îÄ‚îÄ codex: CodexService?, completion: CompletionService?\n    ‚îú‚îÄ‚îÄ suggestion: SuggestionService    ‚Äî generates workspace-aware prompts\n    ‚îú‚îÄ‚îÄ jj: JJService?                   ‚Äî bundled binary from app bundle\n    ‚îú‚îÄ‚îÄ snapshotStore: JJSnapshotStore?, agentOrchestrator: AgentOrchestrator?\n    ‚îú‚îÄ‚îÄ searchService: SearchService, chatHistory: ChatHistoryStore\n    ‚îú‚îÄ‚îÄ sessionStore: SessionStore, windowFrames: WindowFrameStore\n    ‚îú‚îÄ‚îÄ ipcServer: IPCServer, skillScanner: SkillScanner\n    ‚îî‚îÄ‚îÄ nvim: NvimController?            ‚Äî nil unless nvim mode active\n\nWorkspaceModel (@Observable, @MainActor)\n‚îú‚îÄ‚îÄ rootDirectory: URL\n‚îú‚îÄ‚îÄ fileTree: FileTreeModel              ‚Äî root items, expansion, lazy loading\n‚îú‚îÄ‚îÄ tabs: TabModel                       ‚Äî open tabs, selected, ordering (EVERYTHING = tab)\n‚îú‚îÄ‚îÄ editorState: EditorStateModel        ‚Äî per-file (scroll, selection, cursors)\n‚îú‚îÄ‚îÄ jj: JJModel                          ‚Äî working copy, log, bookmarks, ops, snapshots\n‚îú‚îÄ‚îÄ agents: AgentModel                   ‚Äî active agents, merge queue\n‚îú‚îÄ‚îÄ skills: SkillsModel                  ‚Äî installed, active, registry cache\n‚îî‚îÄ‚îÄ search: SearchModel                  ‚Äî query, results, preview\n```\n\n## Key Decisions\n\n1. **Chat = global, not per-workspace.** Works without workspace. Sessions reference workspace but not tied. Workspace-aware but standalone.\n2. **Single workspace MVP.** `workspace: WorkspaceModel?` (0 or 1). Expands to `workspaces: [WorkspaceModel]` later.\n3. **Everything = tab.** Files, terminals, chats, diffs, webviews ‚Äî all `TabModel`. Detach/attach to windows.\n4. **AI-generated suggestions.** Welcome prompts NOT hardcoded. `SuggestionService` generates from workspace context.\n5. **Bundled deps.** `codex-app-server` + `jj` built from source, shipped in `.app` bundle.\n\n## AppModel ‚Äî Composition Root\n\n```swift\n@Observable @MainActor\nfinal class AppModel {\n    var workspace: WorkspaceModel?       // nil until folder opened\n    var chat: ChatModel, preferences: PreferencesModel, theme: AppTheme\n    let windowCoordinator: WindowCoordinator, services: ServiceContainer\n\n    var hasWorkspace: Bool { workspace != nil }\n    var workspaceName: String { workspace?.rootDirectory.lastPathComponent ?? &quot;Smithers&quot; }\n\n    func openDirectory(_ url: URL) async { ... }\n    func closeWorkspace() { ... }\n    func showInEditor(fileURL: URL, line: Int?, column: Int?) { ... }\n}\n```\n\nCreated once in `SmithersApp.init()`, injected via SwiftUI environment to all windows.\n\n## WorkspaceModel ‚Äî Per-Workspace State\n\nCreated on directory open. Destroyed on close. Does NOT contain chat.\n\n```swift\n@Observable @MainActor\nfinal class WorkspaceModel: Identifiable {\n    let id = UUID(), rootDirectory: URL\n    let fileTree: FileTreeModel, tabs: TabModel, editorState: EditorStateModel\n    let jj: JJModel, agents: AgentModel, skills: SkillsModel, search: SearchModel\n}\n```\n\n### Sub-Models\n\n**FileTreeModel** (~200 LOC):\n`items: [FileItem]`, `expandFolder(item:)`, `collapseFolder(item:)`, `reloadTree()`, `modifiedFiles: Set&lt;URL&gt;`\n\n**TabModel** (~200 LOC) ‚Äî everything = tab (files, terminals, diffs, webviews, sub-chats):\n`openTabs: [TabItem]`, `selectedTab: TabItem?`\n`openFile(_:)`, `closeTab(_:)`, `closeOtherTabs(keeping:)`, `reorderTab(from:to:)`\n`openTerminal(id:title:)`, `openDiff(id:title:)`, `openChat(id:title:)`, `openWebview(id:url:title:)`\n`detachTab(_:)`, `attachTab(_:)`\n\n**EditorStateModel** (~100 LOC):\n`viewStates: [URL: EditorViewState]`, `activeFileContent: String`, `activeLanguage: SupportedLanguage?`, `isLoading: Bool`\n\n**ChatModel** (~300 LOC) ‚Äî lives on AppModel, not WorkspaceModel. Main chat = orchestrator:\n`sessions: [ChatSession]`, `selectedSession: ChatSession?`, `messages: [ChatMessage]`\n`isTurnInProgress: Bool`, `streamingMessageId: UUID?`\n`composerText: String`, `composerAttachments: [ChatImage]`, `suggestions: [SuggestedPrompt]`\n`activeAgentChats: [AgentChatHandle]`\n`sendMessage()`, `appendDelta(text:toMessage:)`, `interruptTurn()`, `spawnAgent(task:)`\n\n**Main chat (orchestrator) vs sub-agents:**\n- Main (pane 0) = user assistant, full context\n- Sub-agents = ephemeral background workers, no human-in-loop, run to completion\n- Human-in-loop: sub-agent &quot;needs input&quot; ‚Üí orchestrator surfaces question ‚Üí user responds ‚Üí new sub-agent spawned\n- Sub-agents unhideable as `.chat` tabs in workspace panel\n\n**JJModel** (~100 LOC):\n`isAvailable`, `modifiedFiles`, `changeLog`, `bookmarks`, `operations`, `snapshots`, `conflicts`, `refresh()`\n\n**AgentModel** (~80 LOC):\n`activeAgents: [AgentWorkspace]`, `mergeQueue: [MergeQueueEntry]`, `createAgent(task:)`, `cancelAgent(id:)`, `processQueue()`\n\n**SkillsModel** (~100 LOC):\n`installedSkills`, `activeSkills`, `registrySkills`, `toggleSkill(_:)`, `installSkill(_:)`, `scanWorkspace()`\n\n**SearchModel** (~80 LOC):\n`query`, `results`, `isSearching`, `selectedResult`, `preview`, `search()` (debounced)\n\n## Window-Local UI State\n\nPer-window ephemeral `@State` (not persisted):\n**Chat:** `sidebarMode`, `sidebarSearchQuery`, `hoveredMessageId`, `showImageViewer`, `viewedImage`\n**Workspace:** `showCommandPalette`, `showSearchPanel`, `showShortcutsPanel`, `commandPaletteQuery`, `isSidebarCollapsed`\n\n## Persistence\n\nSQLite (GRDB.swift) = primary layer.\n\n| Data | Storage | When |\n|------|---------|------|\n| Preferences | UserDefaults | Immediate on change |\n| Window frames | UserDefaults | 250ms debounce post resize/move |\n| Chat sessions+messages | SQLite `~/Library/Application Support/Smithers/smithers.db` | 1s debounce |\n| Thread IDs | SQLite (sessions) | On creation |\n| Open tabs+sidebar widths | SQLite (keyed by workspace path) | Workspace close / app quit |\n| JJ snapshots | SQLite (snapshots) | On creation |\n| Scheduled agents | SQLite (schedules) | On create/edit |\n| Per-file editor state | In-memory dict | NOT persisted |\n| Chat images | File `~/Library/Application Support/Smithers/images/&lt;hash&gt;` | On attach |\n\n## Cross-Window Reactivity\n\nAll windows observe same `AppModel`. AI appends message ‚Üí only chat re-renders (workspace doesn&#x27;t read `messages`).\n\nAI changes file:\n1. `ChatModel` appends `DiffPreviewCard` ‚Üí chat re-renders\n2. If `preferences.autoOpenIDEOnFileChange` ‚Üí `AppModel.showInEditor()` called\n3. `WindowCoordinator` ensures workspace panel visible\n4. `TabModel` opens/selects file tab ‚Üí workspace re-renders\n5. `EditorStateModel.scrollToLine` set ‚Üí editor animates\n\nNo explicit cross-window messaging. Shared model = communication channel.\n\n## Agent Workspaces\n\nSingle user workspace, but `AgentOrchestrator` creates parallel agent workspaces via `jj workspace add` ‚Äî lightweight working copies, shared repo history, independent file trees.\n\nAgent workspaces NOT full `WorkspaceModel` ‚Äî managed internally by `AgentOrchestrator`, visualized via agent dashboard. Work enters merge queue, merged into user workspace when complete.\n\n# Window Management\n\n## Scene Definitions\n\nChat = fixed `Window`. Workspace panel = second `Window` (single workspace MVP).\n\n```swift\n@main\nstruct SmithersApp: App {\n    @State private var appModel = AppModel()\n\n    var body: some Scene {\n        // Chat (primary, pane 0 ‚Äî always present)\n        Window(&quot;Smithers&quot;, id: &quot;chat&quot;) {\n            ChatWindowRootView().environment(appModel)\n        }\n        .windowStyle(.hiddenTitleBar).windowResizability(.contentSize)\n        .defaultSize(width: 800, height: 900).commands { appMenuCommands }\n\n        // Workspace panel (on-demand, shows when workspace open)\n        Window(&quot;Smithers IDE&quot;, id: &quot;workspace&quot;) {\n            IDEWindowRootView().environment(appModel)\n        }\n        .windowStyle(.hiddenTitleBar).windowResizability(.contentSize)\n        .defaultSize(width: 1100, height: 900)\n\n        Settings { SettingsView().environment(appModel) }\n    }\n}\n```\n\nFuture multi-workspace: panel ‚Üí `WindowGroup(&quot;Workspace&quot;, id: &quot;workspace&quot;, for: UUID.self)`\n\n## WindowCoordinator\n\nManages workspace panel. Chat always present (SwiftUI scene lifecycle).\n\n```swift\n@Observable @MainActor\nfinal class WindowCoordinator {\n    private(set) var isWorkspacePanelVisible: Bool = false\n\n    func showWorkspacePanel() {\n        // NSApp.windows find by identifier ‚Üí if not found OpenWindowAction create\n        // If found but hidden ‚Üí orderFront+makeKey\n        isWorkspacePanelVisible = true\n    }\n\n    func hideWorkspacePanel() {\n        // Find+orderOut panel. Do NOT close (triggers scene teardown)\n        isWorkspacePanelVisible = false\n    }\n\n    func showInEditor(fileURL: URL, line: Int? = nil, column: Int? = nil) {\n        showWorkspacePanel()\n        // Route to workspace TabModel+EditorStateModel\n    }\n}\n```\n\n**Chrome DevTools analogy:** Chat = main Chrome, workspace panel = DevTools. Everything = tabs (chat, diff, editor, terminal, anything).\n\n**Window access:** `NSApp.windows.first { $0.identifier?.rawValue == &quot;workspace-\\(id)&quot; }` in `onAppear`. Retry-with-delay (SwiftUI creates async).\n\n## Window Chrome\n\nBoth windows:\n\n```swift\n.onAppear {\n    DispatchQueue.main.asyncAfter(deadline: .now() + 0.05) {\n        guard let window = NSApp.windows.first(where: { $0.identifier?.rawValue == windowId }) else { return }\n        window.titlebarAppearsTransparent = true\n        window.isMovableByWindowBackground = true\n        window.titleVisibility = .hidden\n        // Install NSWindowDelegate for close guards + frame persistence\n    }\n}\n```\n\n## Close Behavior\n\n**Chat close ‚Üí background (not quit):**\n`NSWindowDelegate.windowShouldClose` hides, does NOT quit. Smithers continues w/ menu bar icon (scheduled agents). Quit = explicit Cmd+Q or menu &quot;Quit&quot;.\n\n**Workspace close ‚Üí hide:**\n`windowShouldClose` returns `false`, calls `windowCoordinator.hideWorkspacePanel()`. Hidden not destroyed. Tab state, scroll, sidebar width preserved in memory.\n\n**App termination:**\n`NSApplicationDelegate.applicationShouldTerminate` returns `.terminateLater`, runs close guard, persists session state ‚Üí `NSApp.reply(toApplicationShouldTerminate: true)`\n\n## Frame Persistence\n\n`WindowFrameStore` saves frames keyed by type+workspace path:\n\n```swift\nenum WindowFrameStore {\n    private static let frameMapKey = &quot;smithers.windowFrames&quot;\n\n    static func saveFrame(_ frame: NSRect, window: WindowKind, workspace: URL?) { ... }\n    static func loadFrame(window: WindowKind, workspace: URL?) -&gt; NSRect? { ... }\n\n    enum WindowKind: String { case chat, workspacePanel }\n}\n```\n\n250ms debounce on `windowDidResize`/`windowDidMove`. Validates vs screen geometry on load.\n\n## Default Sizing\n\n```swift\nstatic func defaultFrame(for kind: WindowKind, screen: NSScreen) -&gt; NSRect {\n    let vis = screen.visibleFrame\n    switch kind {\n    case .chat:\n        let w = vis.width * 0.45, h = vis.height * 0.85\n        let x = vis.midX - (vis.width * 0.06) - (w / 2), y = vis.midY - (h / 2)\n        return NSRect(x: x, y: y, width: w, height: h)\n    case .workspacePanel:\n        let w = vis.width * 0.55, h = vis.height * 0.85\n        let x = vis.midX + (vis.width * 0.06) - (w / 2), y = vis.midY - (h / 2)\n        return NSRect(x: x, y: y, width: w, height: h)\n    }\n}\n```\n\n# Chat Implementation\n\n## Root Structure\n\n```swift\nstruct ChatWindowRootView: View {\n    @Environment(AppModel.self) private var appModel\n    @State private var sidebarMode: SidebarMode = .chats\n\n    var body: some View {\n        NavigationSplitView {\n            ChatSidebarView(mode: $sidebarMode)\n        } detail: {\n            ChatDetailView()\n        }\n        .navigationSplitViewColumnWidth(min: 200, ideal: 260, max: 360)\n    }\n}\n```\n\n## Sidebar\n\n**Mode bar:** 3 buttons in HStack. `ModeBarItemButton` ‚Äî icon + label, selected = accent pill. Animation: `.spring(duration: 0.2)`.\n\n**Session list:** `List(selection:)` bound to `chat.selectedSession`. Sections from timestamps. `ChatSessionRow`: title (12pt semibold), trailing timestamp (10pt tertiary), 2-line preview (10pt tertiary). Context menu: Rename (inline), Delete (confirmation).\n\n**JJ panel:** `DisclosureGroup` sections. Working copy rows with M/A/D badges. Change log rows + context menus (View Diff, Describe, Squash, Abandon). Bookmarks, Op log, Snapshots.\n\n**Agent dashboard:**\n\nKey monitoring surface. Active visible; past toggleable.\n\n- **&quot;ACTIVE AGENTS&quot; header** ‚Äî 10px uppercase tracking, tertiary\n- **Agent rows:**\n  - Status dot (8px) ‚Äî blue working (glow), green completed, red failed, gray idle\n  - Agent name ‚Äî 11px semibold primary (e.g., &quot;CodeReview&quot;, &quot;TestWriter&quot;)\n  - Task desc ‚Äî 10px tertiary, truncated\n  - Change count badge ‚Äî pill if changes &gt; 0\n- **Sort** ‚Äî Active/working top\n- **Past toggle** ‚Äî Show/hide completed/failed\n- **Click to unhide** ‚Äî Opens `.chat` tab in workspace panel\n- **Hover** ‚Äî `sidebar-hover` bg\n- **&quot;New Agent&quot; button** ‚Äî Accent, spawns sub-agent via orchestrator\n\n## Detail Area\n\n**Title bar (28pt):** Centered workspace name, trailing &quot;Open Editor&quot; `IconButton` ‚Üí `appModel.windowCoordinator.showWorkspacePanel()`.\n\n**Messages zone:** `ScrollViewReader` + `ScrollView` + `LazyVStack(spacing: 10)`. Each msg `.id(message.id)`. Auto-scroll when near bottom (`.easeOut(duration: 0.2)`). &quot;Jump to latest&quot; when scrolled up.\n\n**Message bubbles:**\n\n- `UserMessageBubble` ‚Äî trailing align, `UnevenRoundedRectangle(topLeading: 12, bottomLeading: 12, bottomTrailing: 4, topTrailing: 12)`, `chat.bubble.user` bg, max width 80%\n- `AssistantMessageBubble` ‚Äî leading, `chat.bubble.assistant` bg. Markdown. File paths matching `path:line:col` ‚Üí links calling `appModel.showInEditor()`\n- `CommandBubble` ‚Äî leading, 90% width, monospaced cmd + streaming output + exit badge\n- `DiffPreviewCard` ‚Äî leading, 90%, file list + summary + 8-line preview + status badge + &quot;Open in Editor&quot;\n- `StatusMessageBubble` ‚Äî centered, small muted pill\n\n**Hover action bar:** After 150ms hover. Above bubble. Dark bg (`black@30%`), icon buttons: Fork, Copy, Retry, Edit, Revert, More.\n\n**Streaming:** When `chat.isTurnInProgress`, last assistant msg live-updates via `chat.appendDelta()`. Mutate text in-place. Avoid re-parsing full markdown ‚Äî append new run, re-parse affected tail only.\n\n## Composer\n\n`ChatComposerZone`:\n\n- `ComposerContainer` ‚Äî rounded rect (10pt), `chat.input.bg` bg, `white@6%` border\n- Multiline `TextField(axis: .vertical)`, `.lineLimit(1...4)`, 10pt padding\n- `AttachmentStrip` ‚Äî 56pt thumbnails, horizontal scroll, X to remove\n- Footer: Send (32x32, accent, up-arrow) when idle, Interrupt (32x32, danger, stop) when streaming\n- Keyboard: Return sends, Shift+Return newline, Esc interrupts\n- Drop target: `.dropDestination(for: Data.self)` with accent border highlight\n- Paste images: `.onPasteCommand(of: [UTType.image])`\n\n## Welcome Screen\n\nShown when `chat.messages.isEmpty`:\n\n- Centered `VStack(spacing: 24)`, max width 640\n- &quot;How can I help you?&quot; ‚Äî 28pt semibold\n- Project name ‚Äî 16pt secondary (if workspace open)\n- Category pills: HStack of `PillButton`s (Create, Explore, Code, Learn) with SF symbols\n- **AI-generated suggested prompts:** 4 cards from `SuggestionService`, NOT hardcoded\n  - First launch (no workspace): polished defaults\n  - Subsequent: `SuggestionService` analyzes workspace, updates in-place\n  - Impl: calls `codex-app-server` with suggestion prompt, cached per-workspace, refreshed on workspace change or 5min idle\n  - Cards: white@6% bg, 8pt radius, 12pt padding, text + trailing arrow\n- Clicking pill fills composer with prefix. Clicking suggestion fills + sends.\n\n# IDE Window Implementation\n\n## 7. IDE Window\n\n### 7.1 Root\n\n```swift\nstruct IDEWindowRootView: View {\n    @Environment(AppModel.self) private var appModel\n    @State private var showCommandPalette = false\n    @State private var showSearchPanel = false\n    @State private var showShortcutsPanel = false\n\n    var body: some View {\n        NavigationSplitView {\n            FileTreeSidebar()\n        } detail: {\n            IDEWorkspaceDetailView(\n                showCommandPalette: $showCommandPalette,\n                showSearchPanel: $showSearchPanel,\n                showShortcutsPanel: $showShortcutsPanel\n            )\n        }\n        .navigationSplitViewColumnWidth(min: 180, ideal: 240, max: 400)\n        .overlay { if showCommandPalette { CommandPaletteView(...) } }\n        .overlay { if showSearchPanel { SearchPanelView(...) } }\n    }\n}\n```\n\n### 7.2 File tree\n\n**Rendering:** `List(selection:)` + manual recursive `FileTreeRow` (NOT `OutlineGroup` ‚Äî manual = lazy loading + indent control).\n\n**Lazy loading:** Children start `nil` (unexpanded) or `[.lazyPlaceholder]` (loading). On expand ‚Üí `FileTreeModel.expandFolder(item:)` loads on bg thread. Chevron rotates 90¬∞ `.rotationEffect` 0.15s ease-in-out.\n\n**Row:** `HStack`: optional chevron (12pt, folders) ‚Üí icon (16pt, colored) ‚Üí name (11pt) ‚Üí spacer ‚Üí optional modified dot (5pt circle, accent).\n\n**Selection:** Accent `Capsule` overlay 3pt wide, row height - 6pt, leading edge.\n\n**Context menus:** `.contextMenu { }`. Folders: New File, New Folder, Copy Path, Reveal in Finder, Rename, Delete. Files: Copy Path, Reveal in Finder, Open in Terminal, Rename, Delete.\n\n**Empty:** Centered `VStack`: folder icon, &quot;No Folder Open&quot;, `PrimaryButton` &quot;Open Folder...&quot;, &quot;‚åò‚áßO&quot; hint.\n\n### 7.3 Tab bar\n\n`IDETabBar` ‚Äî horizontal `ScrollView(.horizontal)` of `IDETabItem`.\n\nBackground `surface2`. Geometry: 120-220pt width, 30pt height. If fits ‚Üí distribute evenly. Selected: white@6% bg + 2pt accent underline capsule. Unselected: secondary text. Content: icon (colored) + filename (11pt) + modified dot (non-hover) OR close btn (hover). Drag reorder: `.draggable` + `.dropDestination` with insertion highlight. Middle-click = close. Context: Close, Close Others, Close All, Close to Right, Copy Path, Reveal in Finder, Reveal in Sidebar. Overflow: trailing ellipsis.circle menu.\n\n**Tab types:** `.file(URL)`, `.terminal(id, title)`, `.diff(id, title)`, `.webview(id, title)`, `.chat(id, title)`. **Chat tabs first-class** ‚Äî sub-agents, forks, any session opens as `.chat` tab. Main chat (pane 0) NOT a tab ‚Äî window primary content. Others = tabs.\n\n### 7.4 Breadcrumb\n\nFile tabs only. `HStack` path segments separated by `Image(systemName: &quot;chevron.right&quot;)` 10pt tertiary. Last segment primary opacity, earlier tertiary.\n\n### 7.5 Content area\n\n`IDEContentArea` switches tab kind: `.file` ‚Üí `CodeEditorView`, `.terminal` ‚Üí `GhosttyTerminalView`, `.diff` ‚Üí `DiffViewer`, `.webview` ‚Üí `WebView`, `nil` ‚Üí `IDEEmptyState`. Transition: `.opacity` 0.1s crossfade.\n\n### 7.6 Status bar\n\n22pt, `surface2` bg, 1px top divider. Left: `Ln X, Col Y | UTF-8 | LF` (mono 10pt, secondary). Center: skills indicator (click ‚Üí popover). Right: language + &quot;Spaces: 4&quot; (10pt secondary).\n\n### 7.7 Command palette (Cmd+P)\n\nOverlay dark scrim `black@35%`. Panel centered 65% width (420-680px), 55% height (320-460px), radius 10, surface2.\n\nTwo-pane: results (left) + preview (right, first 20 lines).\n\n**Modes:** Default = fuzzy file (recent edits, views, index). Command = prefix `&gt;` triggers command list with icons + shortcuts.\n\n**Fuzzy:** substring &gt; subsequence. Highlight matches accent. Keys: arrows navigate, Enter opens, Esc dismisses. Animation: scale 0.97 + opacity, spring (0.25s, bounce 0.15) appear, 0.15s ease-in dismiss.\n\n### 7.8 Search panel (Cmd+Shift+F)\n\nTop slide-down 55% width (max 560px), 65% height (max 520px), surface2. Search field top. Results grouped by file, highlighted matches. Preview pane bottom (120-240px) with context. Click ‚Üí open + scroll. Backed by `SearchService` spawning `rg`.\n\n### 7.9 Shortcuts panel (Cmd+/)\n\nRight slide-in 260-320pt. Surface2. Search top. Grouped: General, Tabs, Command Palette, Search, Neovim.\n\n# Editor Subsystem\n\n## 8.1 CodeEditorView (NSViewRepresentable)\n\n`NSViewRepresentable` wrapping `MultiCursorTextView` (subclass of `STTextView`). Most complex view in app.\n\n**Inputs (bindings/params):**\n- `text: Binding&lt;String&gt;`, `language: SupportedLanguage?`, `theme: AppTheme`, `font: NSFont`, `lineSpacing: CGFloat`, `characterSpacing: CGFloat`, `ligaturesEnabled: Bool`, `cursorStyle: CursorStyle`, `showLineNumbers: Bool`, `highlightCurrentLine: Bool`, `showIndentGuides: Bool`, `showMinimap: Bool`, `scrollbarMode: ScrollbarVisibilityMode`, `scrollToRequest: ScrollToRequest?` (line/col, set by showInEditor), `ghostText: String?` (AI completion), `onTextChange: (String) -&gt; Void`, `onCursorChange: (Int, Int) -&gt; Void`\n\n**makeNSView:** Creates STTextView via `MultiCursorTextView.scrollableTextView()`, extracts text view + scroll view, creates line number ruler (`STLineNumberRulerView`), custom `ScrollbarOverlayView`, `GhostTextOverlayView`, wraps in `ScrollbarHostingView`.\n\n**Coordinator:** Weak refs to subviews. Caches highlighters per language. `STTextViewDelegate` for text change notifications. Manages highlight ‚Üí apply cycle. Tracks file URL changes ‚Üí save/restore view state (scroll, selection).\n\n**updateNSView:** Handles theme changes (reapply colors), font changes (reload with new attrs), text changes from outside (AI wrote file), scroll requests (animate to line/col).\n\n## 8.2 TreeSitter Highlighting Pipeline\n\n```\nUser types ‚Üí onTextChange callback\n‚Üí EditorStateModel updates activeFileContent\n‚Üí CodeEditorView.updateNSView detects change\n‚Üí Coordinator.scheduleHighlight()\n‚Üí 250ms debounce (cancels previous)\n‚Üí Increment requestID\n‚Üí Dispatch to parseQueue (background, .userInitiated QoS)\n‚Üí Parse with TreeSitter\n‚Üí Run highlight query, collect captures\n‚Üí Map captures to colors via syntax palette\n‚Üí Check requestID still matches (not stale)\n‚Üí Dispatch to main thread\n‚Üí Apply attrs to NSTextStorage via setAttributes(_:range:)\n```\n\n**Cancellation:** Increment `requestID`. Before apply, check `currentID == self.requestID`. Stale discarded.\n\n**Size limit:** Skip highlighting if &gt; 200,000 chars. Plain foreground only.\n\n**Language registry:** `SupportedLanguages.swift` maps extensions to TreeSitter `Language`:\n\n| Ext | Language |\n|-----|----------|\n| `.swift` | TreeSitterSwift |\n| `.js` | TreeSitterJavaScript |\n| `.ts` | TreeSitterTypeScript |\n| `.tsx` | TreeSitterTypeScript (TSX) |\n| `.py` | TreeSitterPython |\n| `.json` | TreeSitterJSON |\n| `.sh`, `.bash`, `.zsh` | TreeSitterBash |\n| `.md`, `.markdown` | TreeSitterMarkdown (block + inline) |\n| `.zig` | TreeSitterZig |\n| `.rs` | TreeSitterRust |\n| `.go` | TreeSitterGo |\n\n## 8.3 Multi-Cursor Support\n\n`MultiCursorTextView` subclasses `STTextView`. Overrides `mouseDown`, `keyDown`, `insertText`, delete, `doCommand`.\n\n- **Option+Click:** Add insertion at click\n- **Option+Shift+Up/Down:** Add cursor on adjacent line\n- **Cmd+D:** Select next occurrence\n- **Cmd+Shift+L:** Select all occurrences\n- **Escape:** Collapse to single cursor\n\nAll edits grouped into single undo via `groupedUndoIfNeeded`.\n\nCopy/paste with multi-cursor: one pasteboard item per selection. Paste distributes across cursors.\n\n## 8.4 Ghost Text (AI Completions)\n\n`GhostTextOverlayView` = `NSView` subclass over editor. Renders dimmed preview at cursor using `NSTextStorage` + `NSLayoutManager` + `NSTextContainer`.\n\n- Visibility: fade in/out with `NSAnimationContext` (0.12s)\n- Hit testing: always nil (pass-through)\n- Tab accepts (inserts into editor)\n- Escape dismisses\n- Typing advances through suggestion or cancels if diverges\n\nPipeline: `CompletionService` sends requests to codex-app-server after 300ms debounce. Streaming partial results update ghost text real-time. Each keystroke cancels previous, starts new.\n\n## 8.5 Scrollbar Overlay\n\n`ScrollbarOverlayView` ‚Äî custom `NSView`, manual drawing. Replaces native macOS scrollbar.\n\n- Modes: always (visible), automatic (shows on scroll, fades after 1.5s), never (hidden)\n- Knob sizing: proportional to viewport/content ratio, min 24pt\n- Interaction: click track for page scroll, drag knob for continuous\n- Drawing: filled rounded rect (4pt radius), alpha varies (0.38 idle, 0.55 hover/drag)\n- Hit testing: nil when invisible (alpha &lt; 0.01)\n\n## 8.6 Bracket Matching\n\n`BracketMatcher` scans outward from cursor for matching pairs: `()`, `[]`, `{}`, `&lt;&gt;`. Scans up to 10,000 chars each direction. Matching bracket highlighted with `white@16%` bg.\n\n## 8.7 Neovim Mode\n\nToggled via Cmd+Shift+N. When enabled, `CodeEditorView` replaced by `GhosttyTerminalView` running embedded Neovim.\n\n**NvimController** (in SmithersApp, not SmithersEditor):\n\n1. Creates Unix socket `/tmp/smithers-nvim-&lt;uuid&gt;.sock`\n2. Launches Neovim in hidden Ghostty terminal with `--listen &lt;socket&gt;`\n3. Connects with retry (10 attempts, 100ms backoff)\n4. Attaches UI with ext_multigrid, ext_cmdline, ext_popupmenu, ext_messages, ext_hlstate\n5. Installs autocmds for BufEnter/BufLeave ‚Üí track file changes\n6. Starts notification loop for Neovim events\n\n**Bidirectional sync:**\n- User selects file in sidebar ‚Üí NvimController sends `:edit &lt;path&gt;` via RPC\n- User opens in Neovim ‚Üí BufEnter autocmd ‚Üí NvimController updates `TabModel` + `EditorStateModel`\n- User saves in Neovim ‚Üí BufWritePost ‚Üí NvimController marks clean\n\n**External UI overlays** (`NvimExtUIOverlay`):\n- Cmdline: SwiftUI overlay at bottom\n- Popup menu: SwiftUI list at cursor\n- Messages: floating notifications (max 6, auto-expire 4s)\n- Floating windows: plugin popups with blur, rounded corners, shadow\n\n**Theme derivation:** On UI attach, NvimController reads highlight groups (Normal, Visual, CursorLine, TabLine, etc.), derives `AppTheme` via `ThemeDerived.fromNvimHighlights()`. Overrides default theme while Neovim active.\n\n**Crash recovery:** If Neovim dies ‚Üí recovery view: Restart Neovim, Disable Neovim Mode, Reveal Crash Report.\n\n# Terminal Subsystem\n\n## 9. Terminal Subsystem\n\n### 9.1 GhosttyApp Singleton\n\n```swift\nfinal class GhosttyApp {\n    static let shared = GhosttyApp()\n    private(set) var app: ghostty_app_t?\n    private var config: ghostty_config_t?, tickScheduled = false\n\n    private init() {\n        ghostty_init(...)\n        // Create config, load defaults, finalize\n        // Create runtime w/ callbacks (wakeup, action, clipboard, close_surface)\n        // Create app handle\n    }\n\n    func scheduleTick() {\n        // Coalesced: one tick per main queue cycle\n        guard !tickScheduled else { return }\n        tickScheduled = true\n        DispatchQueue.main.async { [weak self] in\n            self?.tickScheduled = false\n            ghostty_app_tick(self?.app)\n        }\n    }\n}\n```\n\n**Callback pattern:** C callbacks = static funcs. Extract Swift obj via `Unmanaged&lt;GhosttyApp&gt;.fromOpaque(userdata).takeUnretainedValue()`. Dispatch main queue for UI.\n\n**Focus tracking:** Observes `NSApplication.didBecomeActiveNotification`/`didResignActive` ‚Üí calls `ghostty_app_set_focus()`.\n\n### 9.2 GhosttyTerminalView\n\n`NSView` subclass, conforms `NSTextInputClient`.\n\n**Lifecycle:**\n1. `init(app:workingDirectory:command:optionAsMeta:)` ‚Äî creates surface via `ghostty_surface_new()`, stores `self` as userdata\n2. `shutdown()` ‚Äî frees surface (main thread) via `ghostty_surface_free()`, stops frame scheduler\n\n**Surface access:** Static `from(surface:) -&gt; GhosttyTerminalView?` extracts Swift obj from C surface userdata.\n\n**Frame scheduling:** `GhosttyFrameScheduler` uses display link ‚Üí `setNeedsDisplay()` at refresh rate. Visibility-aware, pauses when not visible.\n\n**Input:** `GhosttyInput.swift` maps `NSEvent` keycodes ‚Üí Ghostty constants. Handles modifiers, Option-as-Meta, IME via `NSTextInputClient`.\n\n### 9.3 Terminal Tabs\n\nTerminal tabs = `TabItem` kind `.terminal(id:title:)`. Each has `GhosttyTerminalView` stored in dict on `AppModel` (or `TerminalManager`). Title updates (shell escape sequences) ‚Üí tab title via Ghostty action callback.\n\nWorking directory defaults to workspace root.\n\n# AI Integration\n\n## 10.0 Orchestrator Architecture\n\nMain chat = orchestrator (&quot;top agent&quot;). Has full app state context (workspace, running agents, settings, file tree). Answers directly OR delegates to sub-agents.\n\n**Core flow:**\n1. User msg ‚Üí main chat (pane 0)\n2. Orchestrator Codex interprets intent. Has **libsmithers MCP server** (injected at runtime) ‚Äî same capabilities as command palette + CLI: open files, run terminals, search, read tree, spawn agents, change settings, etc.\n3. Simple queries (&quot;what&#x27;s in this file?&quot;, &quot;change theme to dark&quot;) ‚Üí responds directly via MCP tools\n4. Work tasks (&quot;fix login bug&quot;, &quot;add API tests&quot;) ‚Üí spawns **sub-agent** (ephemeral Codex process, workspace-scoped tools only: filesystem + terminal, **NO MCP**)\n5. **Sub-agents run YOLO (no approvals) to completion.** Execute task, apply to jj branch, complete.\n6. **HITL = sub-agent completes ‚Üí orchestrator asks ‚Üí new sub-agent.** No pause/resume ‚Äî complete ‚Üí ask ‚Üí new agent with updated context.\n7. Sub-agent runs **hidden by default.** Status in agent dashboard. Work in background.\n8. User can **unhide** ‚Üí opens `.chat` tab in workspace panel (attach to background process).\n9. Main chat sidebar dashboard shows all agent statuses. Active sorted top, past below (toggleable).\n10. Sub-agent completes ‚Üí changes enter merge queue (jj).\n\n**Sub-agents hidden by default.** User&#x27;s primary interaction = main chat. Sub-agents = background workers. Monitor via dashboard, open any to see full conversation.\n\n**Codex session multiplexing.** Share **one Codex session** with multiplexed sub-sessions. Single `codex-app-server` process, orchestrator + all sub-agents communicate through it. Reduces overhead, enables context caching, simplifies lifecycle. Each sub-agent = logical session ID within shared connection.\n\n**Orchestrator toolset = command palette = CLI = MCP server.** Unified capability surface.\n\n| Tool | MCP method | CLI command | Command palette |\n|------|-----------|-------------|-----------------|\n| Open file | `open_file(path, line, col)` | `smithers-ctl open-file &lt;path&gt; --line N` | Cmd+P ‚Üí select |\n| Search workspace | `search_workspace(query)` | `smithers-ctl search &lt;query&gt;` | Cmd+Shift+F |\n| Run terminal | `run_terminal(command, cwd)` | `smithers-ctl terminal --cwd PATH` | Cmd+` ‚Üí type |\n| Read file | `read_file(path)` | `smithers-ctl read &lt;path&gt;` | Open in editor |\n| Write file | `write_file(path, content)` | `smithers-ctl write &lt;path&gt;` | Edit + Cmd+S |\n| Get workspace state | `get_workspace_state()` | `smithers-ctl status` | Look at tree |\n| Get JJ status | `get_jj_status()` | `smithers-ctl jj status` | Source tab |\n| Spawn agent | `spawn_agent(task)` | `smithers-ctl agent spawn &lt;task&gt;` | &quot;New Agent&quot; |\n| Cancel agent | `cancel_agent(id)` | `smithers-ctl agent cancel &lt;id&gt;` | Cancel row |\n| Change setting | `change_setting(key, value)` | `smithers-ctl set &lt;key&gt; &lt;value&gt;` | Preferences |\n| Get agent status | `get_agent_status(id)` | `smithers-ctl agent status &lt;id&gt;` | Dashboard |\n| Show diff | `show_diff(content)` | `smithers-ctl diff show` | Open diff tab |\n\nSub-agents NO MCP ‚Äî only standard Codex tools (file r/w, terminal) scoped to jj branch.\n\n**Multiple sub-agents run in parallel.** Each gets own jj branch, multiplexed Codex session, hidden conversation. Orchestrator has global visibility via MCP.\n\n**Project config files.** On workspace open, reads/respects:\n- `AGENTS.md` ‚Äî project agent instructions (Codex compat), injected into orchestrator\n- `CLAUDE.md` ‚Äî Claude Code project instructions, injected\n- Skills ‚Äî from `&lt;workspace&gt;/.agents/skills/`, `~/.agents/skills/`, injected per-session\n\nEnsures compat with Codex CLI / Claude Code users ‚Äî config carries over.\n\n## 10.0.1 Codex Feature Parity\n\nFull user-facing feature parity with Codex CLI. Reference implementation.\n\n**Slash commands (type `/` in composer):**\n\n| Command | Behavior |\n|---------|----------|\n| `/plan` | Plan mode ‚Äî agent plans before executing. Inline args + pasted images. |\n| `/review` | Code review ‚Äî summarize working tree issues, focus on behavior + missing tests. |\n| `/diff` | Inspect exact file changes from reviews. |\n| `/fork` | Clone conversation ‚Üí new chat session with fresh ID. Original intact. |\n| `/new` | Fresh conversation, same session. |\n| `/resume` | Resume saved session from picker. |\n| `/status` | Show active model, approval policy, writable roots, token usage. |\n| `/compact` | Summarize long conversations to free context. |\n| `/mention` | Add file by path (e.g., `/mention src/lib/api.ts`). |\n| `/init` | Create AGENTS.md for project config. |\n| `/model` | Switch models. |\n\n**@Mention (type `@` in composer):**\n- `@` ‚Üí autocomplete popup with workspace files\n- Select ‚Üí insert as context reference\n- Referenced files persist across follow-up turns\n- MVP: files + open tabs. Future: symbols, functions, agent names.\n\n**Steer mode (real-time agent interaction ‚Äî match Codex CLI):**\n- Agent running ‚Üí type in composer ‚Üí **Enter** ‚Üí send mid-turn steering message\n- **Tab** ‚Üí queue follow-up for next turn (after agent finishes)\n- Mid-turn corrections without stopping agent\n- Study Codex CLI source for exact behavior. In-process Zig API ‚Üí call steering function directly. If no steering API ‚Üí inject follow-up into conversation context.\n\n**Skills (invoke `$skill-name` or via Skills button):**\n- Reusable instruction bundles with SKILL.md\n- Explicit: `$skill-name` in composer\n- Implicit: Codex auto-selects based on context\n- Browse, install, activate/deactivate per session\n- `AGENTS.md` at project root = project-wide config\n\n**Thread management:**\n- Thread = durable container (many turns)\n- Turn = one user msg ‚Üí agent response\n- Fork, resume, compact ops on threads\n- All threads auto-saved (SQLite, not JSON)\n- History syncs across sessions\n\n**Execution mode ‚Äî YOLO only:**\n- No approvals, no sandbox, unrestricted. Agent reads/writes any file, runs any command, no confirmation.\n- Intentional for power users.\n- Future: sandboxing + per-action approval. MVP: user&#x27;s responsibility to sandbox environment.\n- `/permissions` NOT implemented in MVP ‚Äî remove from slash table.\n\n**Model selection:**\n- Switch via `/model` or settings\n- MVP: Codex (OpenAI) only. Future: Claude, others (issue 004).\n\n**Multi-provider support (MVP lower priority ‚Äî issue 004):**\n- Architecture must support multiple backends, not just Codex\n- MVP ships Codex (fork) as primary. Claude Code + OpenCode = MVP but lower priority ‚Äî implement end of MVP.\n- **Unified Agent Protocol Adapter** abstracts backend ‚Üí swap Codex for Claude Code (WebSocket MCP) or OpenCode (ACP) = backend change, not UI change.\n- Adapter interface: send msg, receive events (deltas, commands, file changes, turn complete), manage threads.\n\n## 10.0.2 Background + Scheduled Agents (MVP ‚Äî issue 007)\n\nBackground agents = core (already in 10.0). Scheduled agents extend:\n\n**Scheduled agents:**\n- Config agents on cron schedules (e.g., &quot;code review every morning&quot;)\n- Config in SQLite (not TOML ‚Äî v1 spec stale)\n- `SchedulerService` (Zig: `src/scheduler.zig`) manages triggers\n- Schedule fires ‚Üí spawn sub-agent via orchestrator with configured prompt/skill\n- Results in agent dashboard\n- **Scheduler runs in-app.** Background-capable macOS app (stays alive when &quot;closed&quot; ‚Äî menu bar icon). Scheduled agents fire while backgrounded.\n- **Future: cloud scheduling.** MVP = local only.\n\n**Review queue:**\n- Scheduled agent results enter review queue (agent dashboard)\n- User reviews + approves/rejects before applying to main workspace\n- NOT merge queue (post-MVP) ‚Äî simpler: list of completed scheduled runs awaiting review.\n\n## 10.1 CodexService\n\nCodex **linked into libsmithers** as static lib ‚Äî not child process. `src/codex_client.zig` calls Codex Zig API (from `submodules/codex/`) directly. Swift `CodexService` = thin wrapper around libsmithers C API.\n\n**Session multiplexing (study Codex source):** In-process ‚Üí multiplexing simpler. Orchestrator + all sub-agents communicate through same linked Codex lib. Each sub-agent = logical session within shared instance.\n\n**Orchestrator session (main chat):**\n- Init on app start via Codex Zig API\n- Connected to **libsmithers MCP server** (injected at runtime) ‚Üí controls IDE\n- Full visibility: workspace state, running agents, settings\n- Job: interpret intent, delegate to sub-agents\n\n**Sub-agent sessions:**\n- Created by orchestrator (Codex Zig API) as new sessions in shared instance\n- NO MCP ‚Äî only filesystem + terminal\n- Scoped to jj workspace branch\n- Run hidden until user opens tab\n\n**Startup sequence (Zig-managed):**\n1. Init Codex Zig API (in-process from `submodules/codex/`)\n2. Pass storage callbacks (`src/storage.zig` + `pkg/sqlite/`) ‚Äî replace Codex JSONL with shared SQLite\n3. Attach MCP server endpoint (runtime injection) for orchestrator\n4. Init orchestrator session via Codex Zig API\n5. If thread ID exists (SQLite lookup) ‚Üí resume, else new\n6. Register event callbacks ‚Äî Codex ‚Üí libsmithers (chat deltas, commands, file changes, turn completions)\n7. Sub-agent sessions created on-demand via Codex Zig API\n\n**Event distribution:** `CodexService` exposes `events: AsyncStream&lt;CodexEvent&gt;`. `AppModel` consumes, routes to sub-models:\n\n```swift\n// In AppModel, after starting CodexService:\nTask {\n    for await event in services.codex!.events {\n        switch event {\n        case .agentMessageDelta(let turnId, let text):\n            chat.appendDelta(text: text, turnId: turnId)\n        case .commandStarted(let turnId, let itemId, let command, let cwd):\n            chat.appendCommand(turnId: turnId, itemId: itemId, command: command, cwd: cwd)\n        case .fileChange(let turnId, let item):\n            chat.appendDiffPreview(turnId: turnId, item: item)\n            handleAIFileChange(item)\n        case .turnCompleted(let turnId, _):\n            chat.completeTurn(turnId: turnId)\n            workspace?.jj.autoSnapshot()\n        // ...\n        }\n    }\n}\n```\n\n## 10.2 Codex Zig API (In-Process, No JSON-RPC)\n\nCodex fork linked as static lib ‚Üí **NO JSON-RPC**. `src/codex_client.zig` calls Codex Zig API directly ‚Äî function calls, not serialized msgs.\n\n- **Calls:** Direct Zig function calls into Codex lib (send msg, create session, manage threads)\n- **Events:** Codex ‚Üí libsmithers via Zig callback function pointers (chat deltas, commands, file changes, turn completions)\n- **Error handling:** Zig error unions, not JSON-RPC codes\n- **Types:** Zig structs shared between `src/codex_client.zig` + Codex fork Zig API layer. Defined once in fork, imported by libsmithers.\n\n**Note:** `JSONRPCTransport` may exist for other backends (Claude Code, OpenCode) using JSON-RPC. Primary Codex integration = in-process Zig API.\n\n## 10.2.1 Shared SQLite (Codex Fork Zig API + Storage Callbacks)\n\nFork shares **same SQLite** as Smithers (`~/Library/Application Support/Smithers/smithers.db`). Wraps Codex in Zig API, accepts storage callbacks ‚Äî Codex doesn&#x27;t know SQLite.\n\n**Architecture:**\n1. Fork compiles Rust as **static lib** (not binary). Thin Zig wrapper (`submodules/codex/build.zig`) exposes **Zig-native API** libsmithers calls. ONLY thing fork does.\n2. libsmithers (`src/codex_client.zig`) calls Codex Zig API ‚Äî create sessions, send msgs, manage threads ‚Äî direct Zig function calls. No JSON-RPC, pipes, child process.\n3. Init Codex Zig API ‚Üí pass **storage callback functions** (Zig function pointers) for persistence: save_session, load_session, list_threads, delete_thread, etc. Implemented in `src/storage.zig` + `pkg/sqlite/`.\n4. Codex calls callbacks for persistence. Doesn&#x27;t know it&#x27;s SQLite ‚Äî just calls.\n5. Swift (GRDB.swift) accesses same db for UI queries. SQLite WAL mode ‚Üí concurrent access from Zig + Swift.\n\n**Why Zig API wrapper (not JSON-RPC, not C FFI vtable):**\n- **In-process** ‚Äî No child overhead, IPC latency, serialization. Codex = linked lib within libsmithers.\n- **Zig-native** ‚Äî Idiomatic Zig. libsmithers calls like any Zig module. Error handling, memory, lifetime = Zig-native.\n- **Minimal fork** ‚Äî Zig wrapper on Rust code. Rust internals mostly untouched. Easy rebase on upstream.\n- **Single artifact** ‚Äî Codex compiles into libsmithers. One binary, no external runtime deps.\n- **Storage callbacks** ‚Äî Clean dependency injection. Codex calls callbacks; we provide SQLite impl. Pattern = libghostty callbacks.\n\n**Fork maintenance:** Minimal, rebased (not merged) on upstream Codex releases. Zig API wrapper isolated from Rust internals ‚Üí upstream changes rarely conflict.\n\n**Schema ownership:** Codex (via callbacks) owns tables (sessions, threads, msgs, items). Smithers owns tables (workspace state, prefs, schedules, snapshots). Both coexist. Migrations versioned independently.\n\n## 10.3 SmithersCtlInterpreter\n\nParses CLI strings from AI, dispatches to IDE actions.\n\nCommands: `open`, `terminal`, `diff show`, `overlay`, `dismiss-overlay`, `webview open/close/eval/url`.\n\n**Arg parsing:** Manual tokenizer (splits whitespace, respects quotes). Switch on first token ‚Üí handler methods. Supports vim-style `+line:column`.\n\n**Integration:** v2 receives `AppModel` ref (not `WorkspaceState`). Calls `appModel.showInEditor()`, `appModel.workspace?.tabs.openTerminal()`, etc.\n\n## 10.4 CompletionService\n\nSeparate from CodexService. Editor ghost text completions.\n\n- 300ms debounce after keystroke\n- Send request: file path, cursor, surrounding context\n- Stream partial results ‚Üí update ghost text overlay\n- Cancellation: each keystroke increments generation counter. Stale responses discarded.\n\n## 10.5 Chat History Persistence\n\n`ChatHistoryStore` uses **SQLite (GRDB.swift)** at `~/Library/Application Support/Smithers/smithers.db`.\n\n- **Tables:** `sessions` (id, title, workspace_path, thread_id, created_at, updated_at), `messages` (id, session_id, role, kind, content, timestamp, metadata_json), `images` (id, message_id, filename, data_hash)\n- **Images** stored as files at `~/Library/Application Support/Smithers/images/&lt;hash&gt;`, referenced by hash\n- **Migrations** via GRDB&#x27;s `DatabaseMigrator`\n- **Save:** 1s debounce after msg changes. GRDB write transactions for atomicity.\n- **Load:** app launch (all sessions) + workspace open (workspace-specific). Graceful degradation on migration fail.\n- **Cleanup:** unused images pruned periodically.\n\n# Version Control (JJ)\n\n## 11. JJ\n\n**Bundled** ‚Äî `jj` binary ships in `.app` bundle, users never install. Agent orchestration, snapshots, VCS UI all depend on jj.\n\n### 11.1 JJService\n\nSpawns bundled `jj` as child process per op. Path: `Bundle.main.path(forAuxiliaryExecutable: &quot;jj&quot;)`. All `async`, `Task.detached` bg thread.\n\n**Ops:** `status()` ‚Üí `JJStatus` (mods, conflicts); `log(limit:)` ‚Üí `[JJChange]`; `diff(changeId:)` ‚Üí unified diff `String`; `commit(description:)` ‚Üí success/fail; `bookmarkList()` ‚Üí `[JJBookmark]`; `opLog(limit:)` ‚Üí `[JJOperation]`; `snapshot(description:)` ‚Üí change ID `String`; `undo()` ‚Üí success/fail; `detectVCS()` ‚Üí `VCSType` (.jjColocated, .jjNative, .gitOnly, .none); `initRepo()` ‚Üí init jj (colocated if .git exists).\n\n**Parsing:** jj `--template` flag ‚Üí JSON arrays from stdout.\n\n**Threading:** `@MainActor`. `Process` ops in `Task.detached` with captures, results ‚Üí main.\n\n### 11.2 JJSnapshotStore\n\nSQLite via GRDB `&lt;workspace&gt;/.jj/smithers/snapshots.db`.\n\n`DatabaseQueue` (thread-safe), `DatabaseMigrator` (migrations), async `withCheckedThrowingContinuation` + `DispatchQueue.global(.utility)`. Records: `Snapshot` (changeId, commitId, workspacePath, description, triggerType: aiChange/userSave/manualCommit, chatSessionId, timestamp).\n\n### 11.3 Chat integration\n\nAuto-snapshot post-AI turn (2s debounce). Snapshot on manual save (if pref enabled). Hover &quot;Revert&quot; ‚Üí `jjService.undo()`. Diff cards show unified diff.\n\n### 11.4 AgentOrchestrator\n\nParallel agents, separate jj workspaces. `createAgent(task:)` ‚Üí new jj branch, CodexService instance. Independent runs, own branch. On complete ‚Üí merge to main (MVP: simple merge, conflicts flagged). **Merge queue post-MVP** (prioritization, gates, ordering deferred).\n\n### 11.5 CommitStyleDetector\n\nReads last 30 `jjService.log(limit: 30)`. Detects: conventional (`type: description`), emoji, freeform. Returns style ‚Üí AI commits match conventions.\n\n# Skills System\n\n## 12. Skills System\n\n### 12.1 Discovery\n\n`SkillScanner` searches in priority order:\n1. `&lt;workspace&gt;/.agents/skills/` (project)\n2. `~/.agents/skills/` (user)\n3. `/etc/codex/skills/` (admin)\n4. `$CODEX_HOME/skills/.system/` (system)\n\nEach skill = directory with `SKILL.md` (YAML frontmatter: name, description, author, version, tags, allowedTools + markdown body = instructions passed to AI).\n\n### 12.2 Activation\n\nPer-chat session. Active skill instructions injected into AI context when sending messages. Status bar shows active skills, popover toggles.\n\n### 12.3 UI\n\nAll skill views = sheets from active window:\n- **SkillBrowserView** ‚Äî browse registry, search, install\n- **SkillListView** ‚Äî manage installed (enable/disable/uninstall)\n- **SkillUseView** ‚Äî activate/deactivate for current chat\n- **SkillDetailView** ‚Äî full metadata\n- **CreateSkillWizardView** ‚Äî multi-step authoring wizard\n\n# Web Application (SolidJS)\n\n## 12A. Web App (SolidJS)\n\nNative macOS = primary. **Developed in tandem**: SolidJS web app (`web/`) talks to same `libsmithers` via HTTP/WS server (`src/http_server.zig`). Every native feature also in web. Two purposes:\n\n1. **Cross-platform access** ‚Äî browser access while native stays macOS-only\n2. **E2E via Playwright** ‚Äî **primary motivation**: testable surface for backend without XCUITest\n\n### 12A.1 Stack\n\n- **SolidJS+Vite** ‚Äî reactive UI + bundler. **PWA** (installable, offline cached). SPA w/ client routing, feels native. Plain stores (`createStore`) ‚Äî mirrors Swift `@Observable`, SolidJS best practices.\n- **shadcn-solid** (hngngn/shadcn-solid) ‚Äî shadcn/ui port, unstyled accessible composable primitives\n- **Tailwind CSS** ‚Äî utility-first. Design tokens from `docs/design.md` ‚Üí Tailwind config\n- **Monaco Editor** ‚Äî VS Code component for IDE editing\n- **xterm.js** ‚Äî terminal emulator, connects PTY (libsmithers) via WS\n- **Playwright** ‚Äî e2e tests: web UI ‚Üí HTTP/WS ‚Üí libsmithers (Zig) ‚Üí Codex/JJ\n- **pnpm** ‚Äî package manager\n\n### 12A.2 Feature Parity (In Tandem)\n\n**Every native feature = web feature.** Simultaneous dev, NOT &quot;port later&quot;. Feature added to `macos/Sources/Features/Chat/` ‚Üí SolidJS in `web/src/features/Chat/` same cycle.\n\n`web/src/features/` mirrors `macos/Sources/Features/`:\n\n```\nweb/src/\n‚îú‚îÄ‚îÄ features/\n‚îÇ   ‚îú‚îÄ‚îÄ Chat/           ‚Äî sidebar, msgs, composer, slash cmds, @mention, steer\n‚îÇ   ‚îú‚îÄ‚îÄ IDE/            ‚Äî file tree, tabs, breadcrumbs, Monaco, status bar\n‚îÇ   ‚îú‚îÄ‚îÄ Agents/         ‚Äî dashboard, scheduled agents\n‚îÇ   ‚îú‚îÄ‚îÄ Terminal/       ‚Äî xterm.js (libsmithers PTY via WS)\n‚îÇ   ‚îú‚îÄ‚îÄ Settings/       ‚Äî prefs UI\n‚îÇ   ‚îî‚îÄ‚îÄ Skills/         ‚Äî browser, activation\n‚îú‚îÄ‚îÄ components/         ‚Äî shadcn-solid (Button, Dialog, Popover, etc)\n‚îú‚îÄ‚îÄ lib/\n‚îÇ   ‚îú‚îÄ‚îÄ api-client.ts   ‚Äî HTTP REST for libsmithers\n‚îÇ   ‚îú‚îÄ‚îÄ ws-client.ts    ‚Äî WS real-time (chat deltas, agent status, file changes)\n‚îÇ   ‚îú‚îÄ‚îÄ store.ts        ‚Äî SolidJS stores (createStore ‚Äî mirrors AppModel/WorkspaceModel)\n‚îÇ   ‚îî‚îÄ‚îÄ types.ts        ‚Äî Hand-maintained TS types (synced by AI + e2e tests)\n‚îú‚îÄ‚îÄ styles/\n‚îÇ   ‚îî‚îÄ‚îÄ tokens.css      ‚Äî CSS vars matching design.md ¬ß2.1 (same as prototype1)\n‚îî‚îÄ‚îÄ tests/\n    ‚îî‚îÄ‚îÄ e2e/            ‚Äî Playwright (mirrors features)\n```\n\n### 12A.3 Visual Parity\n\nWeb looks **as close to native as possible**. `prototype1/` = design ref for **both** ‚Äî same colors, spacing, layout, components. CSS vars (`--sm-base`, `--sm-surface1`, `--sm-accent`, etc) from prototype ‚Üí `tokens.css` directly.\n\n**Prototype lifecycle:** `prototype1/` = frozen ref. **Deleted** once SolidJS fully functional, replaces as visual ref.\n\n### 12A.4 Communication w/ libsmithers\n\nWeb does NOT bundle/run libsmithers. Connects to running HTTP/WS server (`src/http_server.zig`, interface #4 from ¬ß2.6). **No auth** ‚Äî localhost only.\n\n**HTTP REST:**\n`POST /api/chat/send`, `GET /api/chat/sessions`, `GET /api/workspace/files`, `POST /api/workspace/open`, `POST /api/agent/spawn`, `POST /api/terminal/create`, etc (same capability as C API, MCP, CLI)\n\n**WebSocket:**\n`ws://localhost:&lt;port&gt;/ws` ‚Äî events: chat deltas, agent status, file changes, turn completions\n`ws://localhost:&lt;port&gt;/ws/terminal/&lt;id&gt;` ‚Äî PTY I/O for xterm.js\nMirrors `CodexEvent` on Swift side\n\n### 12A.5 Playwright Testing\n\n**Primary reason web exists.** E2E coverage of libsmithers Zig core without XCUITest:\n\n```\nweb/tests/e2e/\n‚îú‚îÄ‚îÄ chat.spec.ts          ‚Äî send, receive, verify streaming\n‚îú‚îÄ‚îÄ chat-commands.spec.ts ‚Äî slash, @mentions, steer\n‚îú‚îÄ‚îÄ file-tree.spec.ts     ‚Äî open workspace, browse, Monaco\n‚îú‚îÄ‚îÄ editor.spec.ts        ‚Äî edit, save, persist\n‚îú‚îÄ‚îÄ terminal.spec.ts      ‚Äî xterm, run cmd, verify output\n‚îú‚îÄ‚îÄ agents.spec.ts        ‚Äî spawn, monitor, complete\n‚îú‚îÄ‚îÄ jj.spec.ts            ‚Äî VCS ops, snapshots, undo\n‚îî‚îÄ‚îÄ skills.spec.ts        ‚Äî activate, modified prompts\n```\n\n**Strategy:** Tests run against real libsmithers (not mocks). Validates: SolidJS ‚Üí HTTP/WS ‚Üí Zig ‚Üí Codex/JJ. Combined w/ Zig unit + Swift XCUITests = three layers.\n\n**CI (once wired):** `zig build playwright` starts HTTP server ‚Üí `pnpm exec playwright test` ‚Üí teardown\n\n### 12A.6 Build Integration\n\n- Planned build steps (add to `build.zig`):\n  - `zig build web` ‚Üí `cd web &amp;&amp; pnpm install &amp;&amp; pnpm build`\n  - `zig build dev` includes web step\n  - `zig build playwright` ‚Üí build web + start HTTP + run tests\n- Until wired, run the `pnpm` commands directly in `web/`.\n- HTTP server serves built static files directly (no separate web server)\n\n# Localhost Security Posture\n\nHTTP/WS server runs with no auth. This is intentional for a power-user tool but the security contract must be explicit.\n\n## Binding\n\n- **MUST bind to `127.0.0.1` only.** NEVER `0.0.0.0` or `::`.\n- Use a random high port (ephemeral range 49152-65535) by default.\n- If a fixed port is configured, warn at startup if another process is already bound.\n\n## Access Control\n\n- No authentication required for localhost connections (YOLO mode).\n- Optional per-session token: if enabled, passed via `Authorization: Bearer &lt;token&gt;` header or `?token=&lt;token&gt;` query param. Token generated at server start, printed to stdout.\n- Token mode is opt-in via config. Default: no token (localhost trust model).\n\n## Filesystem Scope\n\n- Server MUST NOT read/write outside the workspace root unless explicitly enabled via config.\n- Workspace root = directory containing `.jj/`, `.git/`, or `CLAUDE.md` (walked upward from cwd).\n- Terminal PTY sessions inherit workspace root as cwd.\n\n## Future: Sandbox Mode\n\n- Post-MVP: sandboxed execution (filesystem allowlist, network restrictions, process limits).\n- Current MVP: YOLO mode only. No sandbox.\n\n## Threat Model\n\n| Threat | Mitigation |\n|--------|-----------|\n| Remote access to API | Bind 127.0.0.1 only |\n| Other local users on shared machine | macOS user isolation (default); optional token |\n| Malicious web page accessing API | CORS: reject non-localhost origins |\n| Path traversal | Restrict to workspace root |\n\n# Design System Implementation\n\n## 13.1 Token Definitions\n\nAll tokens in `SmithersDesignSystem/Tokens/`. Static constants on namespaced enums:\n\n```swift\nenum DS {\n    enum Color {\n        static let base = NSColor(hex: &quot;#0F111A&quot;)!\n        static let surface1 = NSColor(hex: &quot;#141826&quot;)!\n        static let surface2 = NSColor(hex: &quot;#1A2030&quot;)!\n        static let border = NSColor.white.withAlphaComponent(0.08)\n        static let accent = NSColor(hex: &quot;#4C8DFF&quot;)!\n        // ... all tokens from design spec 2.1\n    }\n    enum Type {\n        static let xs: CGFloat = 10\n        static let s: CGFloat = 11\n        static let base: CGFloat = 13\n        static let l: CGFloat = 15\n        static let xl: CGFloat = 20\n        static let chatHeading: CGFloat = 28\n        // ... all from design spec 2.5\n    }\n    enum Space {\n        static let _4: CGFloat = 4\n        static let _6: CGFloat = 6\n        static let _8: CGFloat = 8\n        // ... through _32\n    }\n    enum Radius {\n        static let _4: CGFloat = 4\n        static let _6: CGFloat = 6\n        // ... through _16\n    }\n}\n```\n\n## 13.2 AppTheme\n\nStruct with all resolved colors for current appearance (dark/light). Injected via custom `EnvironmentKey`.\n\n```swift\nstruct AppTheme: Equatable {\n    let background: NSColor\n    let foreground: NSColor\n    let mutedForeground: NSColor\n    let secondaryBackground: NSColor\n    // ... 24+ color properties\n\n    static let dark = AppTheme(...)   // default dark\n    static let light = AppTheme(...)  // derived light\n}\n\nprivate struct ThemeKey: EnvironmentKey {\n    static let defaultValue = AppTheme.dark\n}\n\nextension EnvironmentValues {\n    var theme: AppTheme {\n        get { self[ThemeKey.self] }\n        set { self[ThemeKey.self] = newValue }\n    }\n}\n```\n\nViews access via `@Environment(\\.theme) private var theme`.\n\n## 13.3 Light Theme Derivation\n\nPer design spec 2.4:\n\n```swift\nextension AppTheme {\n    static var light: AppTheme {\n        AppTheme(\n            background: NSColor(hex: &quot;#F6F7FB&quot;)!,\n            foreground: NSColor.black.withAlphaComponent(0.88),\n            mutedForeground: NSColor.black.withAlphaComponent(0.60),\n            secondaryBackground: NSColor(hex: &quot;#FFFFFF&quot;)!,\n            panelBackground: NSColor(hex: &quot;#EEF1F7&quot;)!,\n            border: NSColor.black.withAlphaComponent(0.10),\n            accent: DS.Color.accent,  // same accent both themes\n            // Hover: black@3-4% instead of white\n            // Chat bubbles: assistant ‚Üí black@4%, user ‚Üí accent@12%\n            // ...\n        )\n    }\n}\n```\n\n## 13.4 Neovim Theme Derivation\n\n`ThemeDerived.fromNvimHighlights()` takes Neovim highlight group colors ‚Üí maps to `AppTheme`:\n\n- `Normal.bg` ‚Üí `background`, `Normal.fg` ‚Üí `foreground`\n- `Visual.bg` ‚Üí `selectionBackground`\n- `CursorLine.bg` ‚Üí `lineHighlight`\n- `TabLine*` ‚Üí tab bar colors\n- `Pmenu*` ‚Üí panel colors\n- `LineNr` / `CursorLineNr` ‚Üí line number colors\n- Missing groups: derive via alpha blending from background + foreground.\n\n## 13.5 Shared Components\n\nAll in `SmithersDesignSystem/Components/`, read theme from environment. Purely presentational ‚Äî no business logic, no dependencies on models/services.\n\n# Keyboard Shortcuts &amp; Input\n\n## 14. Keyboard\n\n### 14.1 Global (both windows)\n\n`.commands { }` in `SmithersApp`:\n\n| Shortcut | Action | Impl |\n|----------|--------|------|\n| Cmd+S | Save file | `appModel.workspace?.saveCurrentFile()` |\n| Cmd+Shift+S | Save all | `appModel.workspace?.saveAllFiles()` |\n| Cmd+Shift+O | Open folder | Open panel ‚Üí `appModel.openDirectory(url)` |\n| Cmd+P | Go to file | Open workspace if needed ‚Üí command palette |\n| Cmd+Shift+F | Search | Open workspace if needed ‚Üí search panel |\n\n### 14.2 Chat window\n\n| Shortcut | Action | Impl |\n|----------|--------|------|\n| Return | Send | Composer `.onSubmit` |\n| Shift+Return | Newline | Default multiline TextField |\n| Cmd+N | New chat | `appModel.workspace?.chat.createNewSession()` |\n| Cmd+V | Paste image | `.onPasteCommand(of: [UTType.image])` |\n| Esc | Interrupt/defocus | Streaming: `chat.interruptTurn()`. Else: `@FocusState = false` |\n\n### 14.3 Workspace panel\n\n| Shortcut | Action | Impl |\n|----------|--------|------|\n| Cmd+B | Toggle sidebar | NavigationSplitView visibility |\n| Cmd+` | New terminal | `workspace?.tabs.openTerminal()` |\n| Cmd+Shift+N | Toggle Neovim | `services.nvim?.toggle()` |\n| Cmd+/ | Shortcuts panel | `showShortcutsPanel.toggle()` |\n\n### 14.4 Tmux prefix\n\n`TmuxKeyHandler` monitors `NSEvent.addLocalMonitorForEvents`. Ctrl+A ‚Üí prefix mode, wait follow-up:\n\n`c` = new terminal; `n` = next tab; `p` = prev tab; `1-9` = tab by index; `&amp;` = close tab; `z` = zoom terminal; `|` = split vert; `-` = split horiz.\n\nTimeout 1s ‚Üí cancel. Show &quot;Prefix&quot; in status bar during mode.\n\n**Critical TUI-native.** tmux users expect identical bindings. Terminal one keystroke: Ctrl+A c.\n\n### 14.5 Responder chain\n\nMulti-window routing: global (Cmd+S, Cmd+Shift+O) in `.commands { }` work regardless focus. Window-specific (Cmd+B IDE, Return chat) via focused responder chain.\n\n`NSEvent.addLocalMonitorForEvents` tmux keys work all windows. Terminal tab Ctrl+A intercepted (not passed) ‚Äî tmux behavior.\n\n### 14.6 TUI philosophy\n\nEvery action no-mouse. Nav flow: **Ctrl+A c** = terminal (always); **Cmd+`** = terminal (macOS alt); **Cmd+P** = palette (files, commands, settings); **Cmd+K** = chat composer (any window); **Esc** = dismiss/prev context; **Tab/Shift+Tab** = cycle panes.\n\nGoal: mouse-free users at home.\n\n# Testing Strategy\n\n## 15. Testing Strategy\n\n### 15.1 Unit Tests (swift test)\n\nZig: `zig build test`. Swift: `swift test` (if SwiftPM targets exist) or `xcodebuild test` (Xcode project).\n\n**SmithersModelsTests:** FileItem lazy loading+tree mutation; ChatMessage serialization; DiffModels/JJModels parsing; Preference defaults+validation\n\n**SmithersServicesTests:** JJService output parsing (mock strings); CommitStyleDetector; SkillScanner (mock fs); ChatHistoryStore round-trip; JSONRPCTransport framing (for JSON-RPC providers); SmithersCtlInterpreter parsing\n\n**SmithersEditorTests:** SupportedLanguages ext mapping; BracketMatcher; fuzzy search scoring\n\n### 15.2 Integration Tests\n\nRequire running services/UI frameworks. Still `swift test`, may need `@MainActor`.\n\nCodexService (mock transport, verify events); JJSnapshotStore (in-mem SQLite); SearchService (mock ripgrep)\n\n### 15.3 UI Tests (XCUITest)\n\n`zig build ui-test` (once wired) or `xcodebuild test` with UI test scheme. Requires Xcode project+UI test target.\n\n**Chat:** Launch ‚Üí verify window; send msg ‚Üí verify in list; new chat ‚Üí verify in sidebar; switch modes\n**Workspace:** Open dir ‚Üí verify tree; select file ‚Üí verify editor; cmd palette ‚Üí search/open; verify tab bar\n**Cross-window:** Click &quot;Open Editor&quot; ‚Üí verify panel; AI file change ‚Üí opens panel (if pref enabled)\n**Screenshots:** `XCTAttachment` for visual review. Extract from `.xcresult` via `xcrun xcresulttool`.\n\n### 15.4 Playwright E2E (Web App)\n\n**Primary reason web app exists** ‚Äî exercises full libsmithers Zig core e2e via web UI. Comprehensive integration without XCUITest/macOS sim.\n\n**Run (once wired):** `zig build playwright` (start HTTP server ‚Üí run tests ‚Üí teardown)\n\n**Suites** (`web/tests/e2e/`):\nChat (send, stream, render); slash cmds, @mentions, steer; file tree (open workspace, browse, Monaco); editor (edit, save, persist); terminal (xterm.js, run cmd, PTY WS); agents (spawn, monitor, complete); JJ (ops, snapshots, undo); skills (activate, modified prompts)\n\n**Three layers:**\n1. Zig unit (`zig build test`) ‚Äî fast, no deps\n2. Playwright e2e (`zig build playwright` once wired) ‚Äî full stack via web\n3. XCUITest (`zig build ui-test` once wired) ‚Äî native macOS UI\n\nMock/replay (¬ß15.5) used by all three.\n\n### 15.5 Mock/Replay Infrastructure\n\nApp depends on `codex-app-server`, tests work without live AI:\n\n- **MockJSONRPCTransport** ‚Äî Same interface as `JSONRPCTransport`, reads recorded sessions for JSON-RPC providers. Records = JSON `{request, response, delay}` arrays.\n- **Recording** ‚Äî `SMITHERS_RECORD_PROVIDER=1` env ‚Üí `JSONRPCTransport` writes session file during normal op.\n- **Replay** ‚Äî `MockJSONRPCTransport` plays back w/ realistic timing (10x compressed). Used in unit+XCUITests.\n- **Stub** ‚Äî For in-process Codex, use `StubCodexService` or libsmithers event fixtures.\n\n### 15.6 Enterprise Quality Standards\n\nProduction software for enterprise:\n\n- **Error handling:** Every async op has handling w/ user feedback. No silent fails. Categorize (recoverable/fatal), present appropriately (toast transient, alert blocking).\n- **Logging:** `os_log`, subsystem `com.smithers`, categories per domain (`.codex`, `.jj`, `.editor`, `.terminal`). Levels: `.debug` internal, `.info` user actions, `.error` fails, `.fault` invariant violations. Viewable via Console.app, captured in crash reports.\n- **Crash reporting:** Integrate symbolication. Catch/report `fatalError`/`preconditionFailure`.\n- **Performance:** `os_signpost` for key ops (file open, tree parse, msg send, jj refresh). Track cold launch, time-to-first-chat, syntax highlight latency.\n- **Memory:** Profile w/ Instruments. No retain cycles in model graph. Weak refs for delegates/coordinators. Large content (file bodies, images) lazy loaded, released on tab close.\n- **Accessibility:** Every element has identifier, label, role. VoiceOver navigates full app. NOT optional ‚Äî enterprise requirement.\n\n### 15.7 CI/CD (GitHub Actions)\n\nmacOS runners, full pipeline:\n\n- **Zig:** `zig build test` ‚Äî every PR, fast\n- **Swift:** `zig build xcode-test` (once wired) or `xcodebuild test` ‚Äî macOS runner\n- **Playwright e2e:** `zig build playwright` (once wired) ‚Äî HTTP server + real libsmithers\n- **Native UI:** `zig build ui-test` (once wired) ‚Äî XCUITest, macOS runner\n- **Web build:** `zig build web` (once wired) ‚Äî compile check\n- **Rust submodules:** Built in `zig build test` (Codex+JJ linked)\n\nValidates polyglot monorepo: Zig, Rust (cargo), Swift (xcodebuild), TypeScript/SolidJS (pnpm+Playwright).\n\n# Migration &amp; Reference\n\n## 16. Migration &amp; Reference\n\n### 16.0 v1 location\n\n`../smithers/apps/desktop/` ‚Äî ~92 Swift files, ~31K LOC:\n\n- **Chat/AI** (`CodexService.swift`, `ChatView.swift`, `ChatHistoryStore.swift`) ‚Äî v1 JSON-RPC stdio; v2 in-process Zig. JSONRPCTransport remains only for non-Codex providers. Study event patterns, rendering.\n- **Agent orchestration** (`AgentOrchestrator.swift`) ‚Äî parallel jj workspaces, merge queue\n- **JJ** (`JJService.swift`, `JJPanelView.swift`, `JJSnapshotStore.swift`) ‚Äî VCS panel, snapshots\n- **Terminal/Ghostty** (`GhosttyApp.swift`, `GhosttyTerminalView.swift`) ‚Äî C FFI singleton, surface lifecycle, frame scheduling\n- **Neovim** (`NvimController.swift`, `NvimRPC.swift`) ‚Äî MessagePack RPC, buffer sync, ext UI\n- **Editor** (`MultiCursorTextView.swift`, `SyntaxHighlighting.swift`) ‚Äî STTextView, TreeSitter\n- **Skills** (`SkillScanner.swift`, views) ‚Äî discovery, activation, wizard\n- **IPC** (`SmithersCtlInterpreter.swift`, `SmithersIPCServer.swift`) ‚Äî Unix socket, parsing\n\nv1: 7.1K-line `WorkspaceState` god object, 2.5K-line `ContentView`. v2 decomposes. Services/integrations = excellent reference. **Study patterns, don&#x27;t copy-paste.**\n\n### 16.1 v1 study guide\n\nReference (not copy-paste) patterns:\n\n| v1 | Study | v2 |\n|---|---|---|\n| `GhosttyApp.swift` | C FFI singleton, callbacks, tick sched | `Terminal/GhosttyApp.swift` |\n| `GhosttyTerminalView.swift` | NSView lifecycle, userdata, frame sched | `Terminal/GhosttyTerminalView.swift` |\n| `GhosttyInput.swift` | Key map, Option-as-Meta | `Terminal/GhosttyInput.swift` |\n| `NvimRPC.swift` | MessagePack codec | `Neovim/NvimRPC.swift` |\n| `NvimController.swift` | Socket RPC, UI attach, autocmd | `Neovim/NvimController.swift` |\n| `JSONRPCTransport.swift` | Pipe JSON-RPC, correlation, async | `Services/JSONRPCTransport.swift` (external providers). Codex uses `src/codex_client.zig` (in-process Zig API). |\n| `CodexService.swift` | Events, threads, notifications | `Services/CodexService.swift` ‚Üí `src/orchestrator.zig` |\n| `SmithersCtlInterpreter.swift` | Parsing, vim +line:col | `Services/SmithersCtlInterpreter.swift` |\n| `SyntaxHighlighting.swift` | TreeSitter pipeline, cancellation, registry | `Editor/TreeSitterHighlighter.swift` |\n| `ContentView.swift` (editor) | STTextView NSViewRep, Coordinator, state | `Editor/CodeEditorView.swift` |\n| `MultiCursorTextView.swift` | STTextView subclass, multi-cursor undo | `Editor/MultiCursorTextView.swift` |\n| `GhostTextOverlayView.swift` | NSView overlay, NSLayoutManager | `Editor/GhostTextOverlayView.swift` |\n| `ScrollbarOverlayView.swift` | Custom NSView scrollbar, drawing, hit test | `Editor/ScrollbarOverlayView.swift` |\n| `JJService.swift` | CLI invoke, template JSON parse | `Services/JJService.swift` ‚Üí `src/jj.zig` |\n| `JJSnapshotStore.swift` | GRDB, migration, async | `Services/JJSnapshotStore.swift` |\n| `SmithersIPCServer.swift` | NWListener socket, wait-close | `Services/IPCServer.swift` |\n| `CloseGuard.swift` | NSWindowDelegate, async confirm, bypass | `App/CloseGuard.swift` |\n| `WindowFrameStore.swift` | Per-workspace frame, screen adjust | `Services/WindowFrameStore.swift` |\n| `AppTheme.swift` | Theme, hex parse, Neovim derive | `DesignSystem/Theme/AppTheme.swift` |\n| `ChatHistoryStore.swift` | SHA256 hash, image storage, version | `Services/ChatHistoryStore.swift` |\n\n### 16.2 NOT carry forward\n\n- **WorkspaceState.swift** ‚Äî 7.1K-line god object. Decompose ‚Üí AppModel + WorkspaceModel + sub-models. (God object pattern OK, 7K-line file not.)\n- **ContentView.swift** ‚Äî 2.5K monolith. Split ‚Üí IDEWorkspaceDetailView, CodeEditorView, IDETabBar, BreadcrumbBar, IDEStatusBar.\n- **`ObservableObject` + `@Published`** ‚Üí replaced `@Observable`.\n- **Single-window** ‚Üí multi-window scene-based (Chrome DevTools style).\n- **SmithersShared compiled both targets** ‚Üí v2 shared in `macos/Sources/`, single Xcode target. Zig core handles logic.\n- **Hardcoded welcome** ‚Üí AI-generated workspace-aware (`SuggestionService`).\n- **External binaries** ‚Äî v1 PATH lookup. v2 builds codex-app-server, jj from source (submodules), bundles in `.app`. Users install Smithers only.\n\n---\n\n## 18. v1 Features (297 commits, ~250 features)\n\nUnder-specified features from v1 audit (others covered earlier):\n\n### 18.1 Auto-update\nSparkle `SPUStandardUpdaterController` ‚Üí `UpdateController.swift`. Channels: Release/Snapshot enum `UpdateChannel` (UserDefaults) ‚Üí feed URL. Manual &quot;Check for Updates...&quot; menu. Feed URL per-channel Info.plist, Snapshot = pre-release.\n\n### 18.2 URL schemes\n`smithers://`, `smithers-open-file://`, `smithers-chat://` registered Info.plist. External opens (Finder, CLI, URL) ‚Üí `ExternalOpenRequest` batch. Pending queue if pre-workspace, process on load. Workspace root inferred from file hierarchy.\n\n### 18.3 File ops\nCreate file/folder (tree context). Rename inline. Delete ‚Üí Trash (not permanent). Non-UTF-8 detection ‚Üí read-only placeholder, no save/auto-save.\n\n### 18.4 Auto-save\nIntervals: 5s, 10s, 30s. Toggle prefs. Toast on save. Guard: never non-UTF-8.\n\n### 18.5 Session persist\nTabs + selected + sidebar widths per workspace. Terminal state across restarts. Last workspace on launch. Chat session ID ‚Üí thread resume. Editor state (scroll, selection) per file. Shortcuts panel visibility. Sidebar mode (Chats/Source/Agents). Debounced on changes, explicit on close.\n\n### 18.6 Perf monitor (debug)\n`PerformanceMonitor` singleton: FPS, frame, render, highlight, glyph cache. `PerformanceOverlayView` debug HUD. Log JSON. Toggle prefs (debug only). Instrumented: highlight, Ghostty render, glyph cache.\n\n### 18.7 Pinch-zoom\nEditor magnification gesture, live preview, temp font size adjust.\n\n### 18.8 Press-hold disable\n`PressAndHoldDisabler` ‚Äî disable macOS accent popup ‚Üí key repeat works (editor/terminal). Required vim nav.\n\n# Implementation Phases\n\n## 17. Phases\n\n### Phase 0: Scaffold (1 session)\n- New repo Ghostty structure\n- Dirs: `src/` (Zig), `pkg/` (vendored C), `include/`, `macos/` (Swift), `web/` (SolidJS)\n- `build.zig`: compile libsmithers stub ‚Üí `include/libsmithers.h` ‚Üí xcframework ‚Üí Swift app ‚Üí launch\n- `macos/Smithers.xcodeproj` real Xcode (no Package.swift, no xcodegen)\n- Init submodules `submodules/codex/`, `submodules/jj/` (EVMTS forks)\n- Copy `GhosttyKit.xcframework` ‚Üí `macos/`\n- Vendor SQLite `pkg/sqlite/` + Zig build wrapper\n- `include/libsmithers.h`: opaque types, action enum, callbacks\n- `src/lib.zig`: CAPI block `smithers_app_new`, `smithers_app_free`, `smithers_app_action`\n- `src/memory.zig`: arena helpers, lifetime patterns\n- `src/storage.zig`: storage trait + SQLite impl\n- `macos/Sources/Ghostty/SmithersCore.swift`: Unmanaged/callback pattern\n- `macos/Sources/Ghostty/MockSmithersCore.swift`: mock for parallel UI dev\n- Verify `zig build` passes (and `zig build dev` once wired) for empty app + libsmithers linked\n- Verify `zig build test` and Swift tests (`xcodebuild test`, or `swift test` if SwiftPM exists) run (placeholder tests)\n\n### Phase 1: Design system + window shell (2-3 sessions)\n- `DesignSystem/`: tokens, AppTheme, shared components (IconButton, PrimaryButton, PillButton, Badge, Panel, SidebarListRow)\n- `App/`: AppModel, WindowCoordinator, scenes (chat window + workspace panel)\n- Chat window always present, workspace opens/closes/hides\n- Frame persistence\n- Bundled binaries load (codex-app-server, jj)\n- Preferences model (UserDefaults, no UI)\n- Verify: launch ‚Üí themed chat, open/close workspace\n\n### Phase 2: Chat window (3-4 sessions)\n- `Models/`: ChatMessage, ChatSession, ChatModel\n- `Views/Chat/`: sidebar (mode bar, sessions), detail (messages, composer, welcome)\n- `Services/`: CodexService (in-process), JSONRPCTransport (non-Codex), SuggestionService\n- Wire: send ‚Üí CodexService ‚Üí stream ‚Üí ChatModel ‚Üí render\n- Chat history persistence\n- Bubbles: user, assistant, command, diff preview, status, starter\n- AI welcome suggestions (workspace-aware / generic)\n- Image paste/drop + fullscreen viewer\n- Hover action bar\n- Verify: full chat e2e (with/without workspace)\n\n### Phase 3: Workspace ‚Äî file tree + editor (3-4 sessions)\n- `Models/`: FileItem, TabItem, EditorViewState, FileTreeModel, TabModel, EditorStateModel\n- `Editor/`: CodeEditorView, MultiCursorTextView, TreeSitterHighlighter, overlays (cursors, ghost, scrollbar, indent, brackets)\n- `Views/IDE/`: FileTreeSidebar, IDETabBar, BreadcrumbBar, IDEContentArea, IDEStatusBar\n- `Services/SearchService`\n- Wire: open folder ‚Üí tree ‚Üí select ‚Üí editor + highlight ‚Üí save\n- Tabs: open, close, reorder, context\n- Command palette (Cmd+P), search (Cmd+Shift+F), shortcuts (Cmd+/)\n- Verify: IDE e2e ‚Äî open, browse, edit, save\n\n### Phase 4: Cross-window (1-2 sessions)\n- `showInEditor()`: chat &quot;Open&quot; ‚Üí workspace opens file@line\n- AI changes ‚Üí diff in chat + optional auto-open workspace\n- `SmithersCtlInterpreter` wired\n- IPC server (Unix socket)\n- SmithersCLI target\n- Verify: AI change ‚Üí diff ‚Üí click ‚Üí workspace scrolls\n\n### Phase 5: Terminal (1-2 sessions)\n- `Terminal/`: GhosttyApp, GhosttyTerminalView, GhosttyInput, GhosttyFrameScheduler\n- Terminal tabs in workspace\n- Terminal from chat (smithers-ctl)\n- Verify: open tab, run, shell works\n\n### Phase 6: Neovim (2-3 sessions)\n- `Neovim/`: NvimController, NvimRPC\n- NvimExtUIOverlay (cmdline, popup, messages, floats)\n- Bidirectional buffer sync, theme derivation, crash recovery\n- Verify: toggle, edit, save, switch, theme syncs\n\n### Phase 7: JJ + agents (2-3 sessions)\n- `Services/`: JJService, JJSnapshotStore, CommitStyleDetector, AgentOrchestrator\n- `Models/`: JJ, Agent, multi-workspace\n- JJ panel sidebar (working copy, log, bookmarks, ops, snapshots)\n- Agent dashboard sidebar\n- Auto-snapshot post-AI, revert from chat\n- Verify: VCS status, snapshots, spawn agents\n\n### Phase 8: Skills + settings + polish (2-3 sessions)\n- Skills: scanner, registry, installer, views\n- SettingsView all categories\n- Toast, progress bar, close guards (tab/window/app)\n- Tmux handler, update (Sparkle), diff viewer (tabs + sheets), light theme\n- Verify: v1 feature parity\n\n### Phase 9: Zig core (parallel 1-8)\nParallel with Swift. **TDD** ‚Äî `zig build test` coverage before Swift hooks up.\n\n**Priority** (portable ‚Üí UI-coupled):\n1. `src/memory.zig` ‚Äî arena helpers, lifetimes, owned-return\n2. `src/storage.zig` ‚Äî trait + SQLite (`pkg/sqlite/`). Critical ‚Äî Codex fork depends on it.\n3. `src/codex_client.zig` ‚Äî in-process Codex Zig API. Mock-tested.\n4. `src/orchestrator.zig` ‚Äî chat delegation, MCP dispatch\n5. `src/mcp_server.zig` ‚Äî Codex ‚Üî IDE bridge\n6. `src/agent.zig` ‚Äî sub-agent lifecycle, arena-per-agent\n7. `src/jj.zig` ‚Äî CLI wrapper, JSON parse. Mock output tests.\n8. `src/chat_state.zig` ‚Äî session state, routing\n9. `src/http_server.zig` ‚Äî HTTP/WS for web app\n10. `src/scheduler.zig` ‚Äî cron-like bg agent runner\n11. `src/search.zig` ‚Äî ripgrep wrapper\n12. `src/file_watcher.zig` ‚Äî FSEvents (macOS)\n13. `src/suggestion.zig` ‚Äî AI suggestion gen\n14. `src/snapshot.zig` ‚Äî JJ snapshot mgmt\n15. `src/ipc.zig` ‚Äî smithers-ctl protocol\n\n**TDD:** Zig ‚Üí tests ‚Üí C header ‚Üí Swift bridge ‚Üí verify vs mock. Swift uses `MockSmithersCore` until real ready.\n\n### Phase 10: Test + a11y + perf (2-3 sessions)\n- Mock/replay infra (MockJSONRPCTransport for external providers, Codex stubs/fixtures)\n- Unit tests all models/services\n- XCUITests both windows (replay)\n- A11y identifiers, labels, tooltips (enterprise req)\n- Logging (os_log), perf (os_signpost)\n- Instruments: view invalidations, leaks, slow highlighting\n- Optimize: chat streaming (append-only, no full re-parse), file tree (virtualize large)\n- Verify: tests pass, VoiceOver, no v1 regressions\n\n## Project Conventions (CLAUDE.md)\n\n# Smithers v2 ‚Äî The Ultimate UX for Agentic Coding\n\nA native macOS IDE (Swift/SwiftUI) that *feels* like a TUI but has the UX of a GUI. Not a terminal app ‚Äî a Swift app designed for terminal power-users. One keystroke from a real terminal (GhosttyKit), Neovim mode for file editing, tmux shortcuts everywhere. Iterating on Claude Code via GUI without losing what terminal users love.\n\n## Project Structure (mirrors Ghostty)\n\n- `src/` - Zig source (libsmithers ‚Äî the portable logic layer)\n- `pkg/` - Vendored C/C++ deps with Zig build wrappers (SQLite, Zap/facil.io, TreeSitter)\n- `include/` - C API header (libsmithers.h ‚Äî THE contract between Zig and Swift)\n- `macos/` - Swift app (Xcode project, feature-based organization)\n- `web/` - SolidJS Vite PWA (developed in tandem, visual parity with native app)\n- `submodules/codex/` - EVMTS fork: wraps Codex in a Zig API + storage callbacks. Rebased on upstream.\n- `submodules/jj/` - EVMTS fork of Jujutsu (no code changes, Zig build wrapper)\n- `build.zig` / `build.zig.zon` - Builds EVERYTHING. Zig is the monorepo build tool.\n- `prototype0` ‚Üí symlink to `../smithers/apps/desktop` (v1 Swift app reference)\n- `prototype1/` - Next.js UI prototype (frozen design reference for both native + web, delete when done)\n- `issues/` - Feature specs (take features literally, NOT implementation details ‚Äî stale from v1)\n- `scripts/smithers-workflow/` - Automated workflow (3 AI agents build the product e2e)\n\n## Architecture Overview\n\n**libsmithers** (Zig core) exposes five interfaces, all backed by the same capability surface:\n1. **C API** ‚Üí consumed by Swift UI layer via xcframework (libghostty pattern)\n2. **MCP server** ‚Üí injected into Codex at runtime\n3. **CLI** (`smithers-ctl`) ‚Üí consumed by shell/scripts/user\n4. **HTTP/WebSocket server** ‚Üí consumed by SolidJS web app + Playwright tests. Uses Zap (`pkg/zap/`). No auth.\n5. **Zig API** ‚Üí internal\n\n**Key principle:** Tools in the CLI = command palette = MCP server = HTTP API. One capability surface, multiple access methods.\n\n## Codex Fork ‚Äî Zig API Wrapper (In-Process, No JSON-RPC)\n\nEVMTS fork at `submodules/codex/`. The fork does ONE thing: **wraps the entire Codex in a Zig API**. Codex compiles as a static library and is linked directly into libsmithers. No child process, no JSON-RPC, no pipes. Storage callbacks (Zig function pointers) passed in at init ‚Äî our Zig implementation (`src/storage.zig` + `pkg/sqlite/`) writes to shared SQLite. Codex doesn&#x27;t know about SQLite. Fork rebased on upstream.\n\n## Web App (SolidJS Vite PWA) ‚Äî Developed in Tandem\n\n**Every feature in the native app is also in the web app.** SolidJS + Vite PWA + shadcn-solid + Tailwind + Monaco + xterm.js. Plain SolidJS stores. Hand-maintained TypeScript types (AI + e2e tests keep in sync). pnpm package manager.\n\n**Playwright tests are a primary reason for the web app** ‚Äî e2e tests exercise full Zig core through web UI.\n\n## Execution Mode\n\n**YOLO mode only.** No approvals, no sandbox. Future: sandboxing.\n\n## Project Config Files\n\nReads: `AGENTS.md` (preferred), `CLAUDE.md`, and skills from workspace.\n\n## Dependency Strategy\n\n- **Zig/C deps:** Vendor in `pkg/` with Zig build wrappers (SQLite, Zap, TreeSitter)\n- **Rust deps:** Git submodules in `submodules/` ‚Äî compiled as static libs, linked into libsmithers\n- **Swift deps:** Xcode&#x27;s built-in SPM (Sparkle, STTextView, GRDB.swift)\n- **Web deps:** pnpm in `web/` (SolidJS, Vite, shadcn-solid, Tailwind, Monaco, xterm.js, Playwright)\n- **Monorepo tool:** `build.zig` orchestrates everything. No Turborepo/Nx.\n\n## Build\n\n```bash\nzig build            # Build everything wired in build.zig\nzig build run        # Build + run CLI (current)\nzig build test       # Zig unit tests\nzig build all        # Build + tests + fmt/lint (canonical green check)\n\n# Planned (once build.zig defines these steps):\n# zig build dev        # Build everything + launch\n# zig build web        # Build web app only\n# zig build playwright # Build web + start HTTP server + run Playwright e2e tests\n# zig build codex      # Build codex static lib only\n# zig build jj         # Build jj only\n# zig build xcode-test # Swift tests\n# zig build ui-test    # XCUITest e2e\n```\n\n## CI/CD\n\nGitHub Actions with macOS runners. Full pipeline: Zig tests ‚Üí Rust submodule builds ‚Üí Swift tests ‚Üí Playwright e2e ‚Üí web build.\n\nIMPLEMENTATION PHASE ‚Äî Ticket: chat-streaming-bridge ‚Äî Wire Swift chat composer to libsmithers and render streaming\n\nImplement FULLY end-to-end. Do NOT stop until fully implemented + ALL tests pass.\n\nTICKET DESCRIPTION:\n\nImplement a Swift-side SmithersCore wrapper that owns smithers_app_t, installs runtime callbacks, and forwards events to a minimal @Observable ChatModel. Update ChatWindowRootView to bind MessagesZone + ChatComposerZone to ChatModel and call smithers_app_action(SMITHERS_ACTION_CHAT_SEND) on Return. Render assistant deltas live on SMITHERS_EVENT_CHAT_DELTA and finalize on SMITHERS_EVENT_TURN_COMPLETE. Use the existing Zig codex_client stub for streaming; no real provider yet.\nACCEPTANCE CRITERIA:\n\nPressing Return in composer sends SMITHERS_ACTION_CHAT_SEND\n- Assistant messages stream in-place (‚â•2 deltas) then finalize\n- No UI regressions: window chrome and design tokens intact\n- Thread-safe callback handling (main-actor UI updates)\n- zig build all remains green; xcode project builds cleanly\nPLAN:\nRead plan: docs/plans/chat-streaming-bridge.md\nRead research context: docs/context/chat-streaming-bridge.md\n\nBEFORE CODING:\n\n- Explore codebase first. Read existing files relevant to ticket.\n\n- Understand existing patterns, naming conventions, architecture.\n\n- For plan ambiguities, explore codebase to resolve.\n\n- If plan wrong or needs adjustment, document why + what you&#x27;re doing differently.\n\n- Read Ghostty source for code style + pattern reference.\n\nIMPLEMENTATION RULES:\n\n- Implement plan FULLY ‚Äî nothing unfinished\n\n- Order: plan doc (docs/plans/) FIRST ‚Üí tests SECOND (TDD) ‚Üí implementation THIRD ‚Üí user-facing docs LAST (after tests green)\n\n- **ALL commits go directly on `main`. NEVER create branches. Stay on `main`.**\n\n- Atomic git commits: ‚ú® feat, üß™ test, üêõ fix, üìã docs, ‚ôªÔ∏è refactor, ‚ö° perf, üîß chore\n\n- After implementing, run ALL relevant tests:\n\n- zig build all (canonical; runs all wired checks)\n\n- If `xcode-test` / `ui-test` steps are wired: run them, otherwise `xcodebuild test`\n\n- If `playwright` step is wired: run it, otherwise `cd web &amp;&amp; pnpm test &amp;&amp; pnpm exec playwright test`\n\n- If tests fail, fix before moving on. NEVER leave failing tests.\n\n- If pre-existing test failures found, fix those too. Codebase ALWAYS green.\n\nCODE QUALITY:\n\n- Follow existing repo patterns. When unsure, read Ghostty source.\n\n- DRY ‚Äî no duplicate code\n\n- Handle all error cases elegantly\n\n- Write clear, self-documenting code with minimal comments\n\n- Only comment where logic truly non-obvious. Remove verbose/redundant comments.\n\n- Elegant, minimal code. Less code = better.\n\nARCHITECTURE:\n\n- libsmithers (Zig) = source of truth for all business logic\n\n- Use dependency injection for platform-specific concerns\n\n- Keep Zig platform-agnostic (WASM-compilable in theory)\n\n- Use comptime dependency injection patterns (vtable pattern)\n\nZIG-SPECIFIC:\n\n- Unsure about Zig stdlib API? Read actual source at /opt/homebrew/lib/zig/std/\n\n- Common APIs LLMs get wrong: std.json, std.ArrayList, std.HashMap ‚Äî verify against source\n\n- Use std.testing.allocator in all tests (detects memory leaks)\n\n- Define explicit error sets, never anyerror\n\n- Use ArenaAllocator for request-scoped work\n\nSWIFT-SPECIFIC:\n\n- Use @Observable (NOT ObservableObject)\n\n- Use NavigationStack (NOT NavigationView)\n\n- Use Swift Testing (@Test, #expect) for new tests\n\n- XCUITest with .accessibilityIdentifier() for e2e tests\n\n- async/await only, no DispatchQueue\n\nSELF-REVIEW:\nBefore finishing, self-review. Reviewers check for:\n\n- Test coverage: all edge cases, error conditions, boundary cases\n\n- Code cleanliness + DRY principles\n\n- UX (keyboard navigation, error states, network-down scenarios)\n\n- Doc accuracy\n\n- Architectural consistency (Zig as source of truth, dependency injection)\n\n- Minimal, high-quality comments only\nFix issues before submitting.\n\n**REQUIRED OUTPUT** ‚Äî JSON matching this schema:\n\n{\n  &quot;filesCreated&quot;: [\n    &quot;string&quot;\n  ],\n  &quot;filesModified&quot;: [\n    &quot;string&quot;\n  ],\n  &quot;commitMessages&quot;: [\n    &quot;string&quot;\n  ],\n  &quot;whatWasDone&quot;: &quot;Detailed description of what was implemented&quot;,\n  &quot;testsWritten&quot;: [\n    &quot;string&quot;\n  ],\n  &quot;docsUpdated&quot;: [\n    &quot;string&quot;\n  ],\n  &quot;allTestsPassing&quot;: false,\n  &quot;testOutput&quot;: &quot;Output from running tests&quot;\n}\nDO NOT skip JSON output. Workflow fails without it.\nmcp: voltaire starting\nmcp: zig-docs starting\n2026-02-11T03:31:34.081047Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c49ba-8821-78f0-b445-d464edea3b12\n2026-02-11T03:31:34.104308Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4636-3d07-72a0-8120-4045237876a9\n2026-02-11T03:31:34.129336Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4637-181a-75f3-8088-e1ba8abe1989\n2026-02-11T03:31:34.155540Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4637-434a-7cd3-a9d7-285dcc28587c\n2026-02-11T03:31:34.183176Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4ab3-49a2-7312-ba0f-ffcd797d66b6\n2026-02-11T03:31:34.208408Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4634-6e9a-70d1-98cc-d1c11ad90370\n2026-02-11T03:31:34.235612Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c49cf-a734-7a91-b187-697181c54044\n2026-02-11T03:31:34.260543Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4635-c2c4-7471-9512-67be562dc314\n2026-02-11T03:31:34.288551Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4a84-9893-7672-9a01-decee2d76b1c\n2026-02-11T03:31:34.311600Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4796-ec01-72e3-bdc1-f4c6f95f8868\n2026-02-11T03:31:34.338001Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4634-d008-7692-ad14-2224faf3e18f\n2026-02-11T03:31:34.366004Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4a8f-2ab5-7cc3-bd8d-da6174e69008\n2026-02-11T03:31:34.391561Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4637-f0bc-7f73-bfc9-9e3a7658ca40\n2026-02-11T03:31:34.419828Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4634-9804-7b92-a1f7-c1c1f7bd2659\n2026-02-11T03:31:34.447156Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c46d6-bd0a-75b1-9681-01602cb180df\n2026-02-11T03:31:34.475587Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4635-391d-7132-91e7-922445d76530\n2026-02-11T03:31:34.503076Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4a83-cbdc-7902-b665-5b8ac28767d9\n2026-02-11T03:31:34.530466Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4635-b977-7930-a2d6-ee44ddb1be01\n2026-02-11T03:31:34.558130Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4634-843a-77f1-b6e7-538eca343503\n2026-02-11T03:31:34.585972Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c49d8-1fb8-75e0-ab05-324742b1c6fb\n2026-02-11T03:31:34.613020Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4793-f71d-7e00-9408-03314cff25d0\n2026-02-11T03:31:34.640467Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c49d8-7fa0-7230-875b-ee79c04bd5e9\n2026-02-11T03:31:34.667620Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4a94-f8f7-7792-8e77-25393073166a\n2026-02-11T03:31:34.694437Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4791-2cfd-7e52-b4e7-25a98445207f\n2026-02-11T03:31:34.719020Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c49ff-ab5a-7140-be3d-b78ca0a84155\n2026-02-11T03:31:34.745901Z ERROR codex_core::rollout::list: state db missing rollout path for thread 019c4638-32c3-7e51-8d34-8ec1b82081ec\nmcp: voltaire ready\nmcp: zig-docs ready\nmcp startup: ready: voltaire, zig-docs\n2026-02-11T03:32:45.512372Z ERROR codex_api::endpoint::responses: error=network error: error sending request for url (https://api.openai.com/v1/responses)\nReconnecting... 1/5 (stream disconnected before completion: error sending request for url (https://api.openai.com/v1/responses))\n2026-02-11T03:32:48.727644Z ERROR codex_api::endpoint::responses: error=network error: error sending request for url (https://api.openai.com/v1/responses)\nReconnecting... 2/5 (stream disconnected before completion: error sending request for url (https://api.openai.com/v1/responses))\n2026-02-11T03:32:52.085146Z ERROR codex_api::endpoint::responses: error=network error: error sending request for url (https://api.openai.com/v1/responses)\nReconnecting... 3/5 (stream disconnected before completion: error sending request for url (https://api.openai.com/v1/responses))\n2026-02-11T03:32:56.067602Z ERROR codex_api::endpoint::responses: error=network error: error sending request for url (https://api.openai.com/v1/responses)\nReconnecting... 4/5 (stream disconnected before completion: error sending request for url (ht\n    at generate (/Users/williamcory/guillotine-mini/smithers/src/agents/cli.ts:528:17)\n    at processTicksAndRejections (native:7:39)"},"timestampMs":1770780787185}
{"type":"FrameCommitted","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","frameNo":5,"xmlHash":"fe1c901fb0724acf4a9408fe622c447684138a0f3b69c5a127406c36f861f114","timestampMs":1770780787214}
{"type":"RunFailed","runId":"0dde077d-635f-4fd6-bb86-90be7fc87d6a","error":"Task failed","timestampMs":1770780787239}
