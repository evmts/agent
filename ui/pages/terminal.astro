---
/**
 * Terminal Page
 *
 * Interactive PTY terminal session.
 */
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Terminal from "../components/Terminal.astro";

// Check authentication
let currentUser = null;
const sessionCookie = Astro.cookies.get('plue_session');

if (!sessionCookie) {
  return Astro.redirect('/login');
}

try {
  const response = await fetch(`${Astro.url.origin}/api/auth/me`, {
    headers: {
      Cookie: `plue_session=${sessionCookie.value}`,
    },
  });

  if (response.ok) {
    const data = await response.json();
    currentUser = data.user;
  } else {
    return Astro.redirect('/login');
  }
} catch (error) {
  console.error('Failed to fetch current user:', error);
  return Astro.redirect('/login');
}

// Get existing PTY session from query or create new
const existingPtyId = Astro.url.searchParams.get('pty');
---

<Layout title="Terminal - plue">
  <Header currentPath="/terminal" />

  <div class="terminal-page">
    <div class="terminal-header">
      <div class="terminal-title">
        <h1>Terminal</h1>
        <span class="pty-id" id="pty-id-display">
          {existingPtyId ? `Session: ${existingPtyId}` : 'No session'}
        </span>
      </div>
      <div class="terminal-actions">
        <button class="btn btn-sm" id="new-terminal-btn">
          New Terminal
        </button>
        <button class="btn btn-sm btn-danger" id="close-terminal-btn" style="display: none;">
          Close
        </button>
      </div>
    </div>

    <div class="terminal-container-wrapper">
      <div id="terminal-placeholder" class="terminal-placeholder">
        <div class="placeholder-content">
          <div class="placeholder-icon">&gt;_</div>
          <div class="placeholder-text">Click "New Terminal" to start a session</div>
        </div>
      </div>
      <div id="terminal-wrapper" style="display: none;">
        <Terminal ptyId={existingPtyId || ''} class="full-terminal" />
      </div>
    </div>

    <div class="terminal-sessions">
      <h3>Active Sessions</h3>
      <div id="sessions-list" class="sessions-list">
        <p class="loading">Loading sessions...</p>
      </div>
    </div>
  </div>
</Layout>

<style>
  .terminal-page {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 60px);
    padding: var(--space-4);
  }

  .terminal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
  }

  .terminal-title {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .terminal-title h1 {
    margin: 0;
    font-size: 18px;
  }

  .pty-id {
    font-size: 12px;
    color: var(--gray-400);
    font-family: inherit;
    background: var(--gray-800);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
  }

  .terminal-actions {
    display: flex;
    gap: var(--space-2);
  }

  .terminal-container-wrapper {
    flex: 1;
    min-height: 0;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    background: #1a1a1a;
  }

  .terminal-placeholder {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #1a1a1a;
  }

  .placeholder-content {
    text-align: center;
    color: var(--gray-500);
  }

  .placeholder-icon {
    font-size: 48px;
    font-family: inherit;
    margin-bottom: var(--space-4);
  }

  .placeholder-text {
    font-size: 14px;
  }

  #terminal-wrapper {
    height: 100%;
  }

  #terminal-wrapper :global(.full-terminal) {
    height: 100% !important;
    min-height: 100% !important;
  }

  .terminal-sessions {
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--border);
  }

  .terminal-sessions h3 {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: var(--space-3);
  }

  .sessions-list {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .sessions-list .loading {
    font-size: 12px;
    color: var(--gray-500);
  }

  .session-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: var(--gray-900);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 12px;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .session-item:hover {
    background: var(--gray-800);
    border-color: var(--border-hover);
  }

  .session-item.active {
    border-color: var(--success);
    background: rgba(16, 185, 129, 0.1);
  }

  .session-id {
    font-family: inherit;
    color: var(--gray-300);
  }

  .session-cmd {
    color: var(--gray-500);
  }

  .session-close {
    background: none;
    border: none;
    color: var(--gray-500);
    cursor: pointer;
    padding: 2px;
    font-size: 14px;
    line-height: 1;
  }

  .session-close:hover {
    color: var(--error);
  }

  .no-sessions {
    font-size: 12px;
    color: var(--gray-500);
  }
</style>

<script>
  import { Ghostty, Terminal, FitAddon } from "ghostty-web";

  let currentPtyId: string | null = null;
  let currentWs: WebSocket | null = null;
  let terminal: Terminal | null = null;
  let fitAddon: FitAddon | null = null;

  const terminalPlaceholder = document.getElementById('terminal-placeholder');
  const terminalWrapper = document.getElementById('terminal-wrapper');
  const ptyIdDisplay = document.getElementById('pty-id-display');
  const newTerminalBtn = document.getElementById('new-terminal-btn');
  const closeTerminalBtn = document.getElementById('close-terminal-btn');
  const sessionsList = document.getElementById('sessions-list');

  // Load existing sessions
  async function loadSessions() {
    if (!sessionsList) return;

    try {
      const res = await fetch('/api/pty');
      if (res.ok) {
        const data = await res.json();
        if (data.sessions && data.sessions.length > 0) {
          sessionsList.innerHTML = data.sessions.map((session: any) => `
            <div class="session-item ${session.id === currentPtyId ? 'active' : ''}"
                 data-session-id="${session.id}">
              <span class="session-id">${session.id.substring(0, 8)}</span>
              <span class="session-cmd">${session.command || 'shell'}</span>
              <button class="session-close" data-close-session="${session.id}">&times;</button>
            </div>
          `).join('');

          // Add click handlers
          sessionsList.querySelectorAll('.session-item').forEach(item => {
            item.addEventListener('click', (e) => {
              if ((e.target as HTMLElement).classList.contains('session-close')) return;
              const sessionId = item.getAttribute('data-session-id');
              if (sessionId) switchToSession(sessionId);
            });
          });

          sessionsList.querySelectorAll('.session-close').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const sessionId = btn.getAttribute('data-close-session');
              if (sessionId) await closeSession(sessionId);
            });
          });
        } else {
          sessionsList.innerHTML = '<p class="no-sessions">No active sessions</p>';
        }
      }
    } catch (e) {
      sessionsList.innerHTML = '<p class="no-sessions">Failed to load sessions</p>';
    }
  }

  // Create new terminal
  async function createTerminal() {
    try {
      const res = await fetch('/api/pty', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({}),
      });

      if (res.ok) {
        const data = await res.json();
        await switchToSession(data.id);
        loadSessions();
      } else if (res.status === 401) {
        window.location.href = '/login';
      } else {
        const error = await res.json();
        window.toast?.error(error.error || 'Failed to create terminal');
      }
    } catch (e) {
      window.toast?.error('Failed to create terminal');
    }
  }

  // Switch to an existing session
  async function switchToSession(ptyId: string) {
    // Close existing connection
    if (currentWs) {
      currentWs.close();
      currentWs = null;
    }

    currentPtyId = ptyId;

    // Update UI
    if (terminalPlaceholder) terminalPlaceholder.style.display = 'none';
    if (terminalWrapper) terminalWrapper.style.display = 'block';
    if (closeTerminalBtn) closeTerminalBtn.style.display = 'block';
    if (ptyIdDisplay) ptyIdDisplay.textContent = `Session: ${ptyId.substring(0, 8)}`;

    // Initialize terminal if not already done
    const container = terminalWrapper?.querySelector('[data-terminal]') as HTMLElement;
    if (container && !terminal) {
      const ghostty = await Ghostty.load();

      terminal = new Terminal({
        cursorBlink: true,
        fontSize: 14,
        fontFamily: "ui-monospace, 'SF Mono', Menlo, Monaco, 'Cascadia Code', monospace",
        allowTransparency: true,
        scrollback: 10_000,
        ghostty,
        theme: {
          background: "#1a1a1a",
          foreground: "#e0e0e0",
          cursor: "#e0e0e0",
          cursorAccent: "#1a1a1a",
          selectionBackground: "#404040",
        },
      } as any);

      fitAddon = new FitAddon();
      terminal.loadAddon(fitAddon);
      terminal.open(container);
      fitAddon.fit();

      // Handle resize
      window.addEventListener('resize', () => fitAddon?.fit());
      const resizeObserver = new ResizeObserver(() => fitAddon?.fit());
      resizeObserver.observe(container);
    } else if (terminal) {
      terminal.clear();
    }

    // Connect WebSocket
    const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
    const apiHost = import.meta.env.PUBLIC_API_URL || `${window.location.hostname}:4000`;
    currentWs = new WebSocket(`${protocol}//${apiHost}/pty/${ptyId}/ws`);

    currentWs.addEventListener('open', () => {
      if (terminal && currentWs) {
        currentWs.send(JSON.stringify({
          type: 'resize',
          cols: terminal.cols,
          rows: terminal.rows,
        }));
      }
    });

    currentWs.addEventListener('message', (event) => {
      if (typeof event.data === 'string' && terminal) {
        terminal.write(event.data);
      }
    });

    currentWs.addEventListener('close', () => {
      console.log('WebSocket closed');
    });

    currentWs.addEventListener('error', (error) => {
      console.error('WebSocket error:', error);
    });

    // Send input
    if (terminal) {
      terminal.onData((data) => {
        if (currentWs && currentWs.readyState === WebSocket.OPEN) {
          currentWs.send(data);
        }
      });

      terminal.onResize((size) => {
        if (currentWs && currentWs.readyState === WebSocket.OPEN) {
          currentWs.send(JSON.stringify({
            type: 'resize',
            cols: size.cols,
            rows: size.rows,
          }));
        }
      });

      terminal.focus();
    }

    // Update session list to show active
    loadSessions();
  }

  // Close a session
  async function closeSession(ptyId: string) {
    try {
      await fetch(`/api/pty/${ptyId}`, { method: 'DELETE' });

      if (currentPtyId === ptyId) {
        if (currentWs) {
          currentWs.close();
          currentWs = null;
        }
        currentPtyId = null;

        if (terminalPlaceholder) terminalPlaceholder.style.display = 'flex';
        if (terminalWrapper) terminalWrapper.style.display = 'none';
        if (closeTerminalBtn) closeTerminalBtn.style.display = 'none';
        if (ptyIdDisplay) ptyIdDisplay.textContent = 'No session';

        if (terminal) {
          terminal.clear();
        }
      }

      loadSessions();
    } catch (e) {
      window.toast?.error('Failed to close session');
    }
  }

  // Event handlers
  newTerminalBtn?.addEventListener('click', createTerminal);

  closeTerminalBtn?.addEventListener('click', () => {
    if (currentPtyId) closeSession(currentPtyId);
  });

  // Initial load
  loadSessions();

  // Check for existing PTY from URL
  const urlParams = new URLSearchParams(window.location.search);
  const existingPty = urlParams.get('pty');
  if (existingPty) {
    switchToSession(existingPty);
  }
</script>
