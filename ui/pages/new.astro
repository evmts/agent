---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import { listUsers, createRepository, ApiError } from "../lib/api";
import { initRepo } from "../lib/jj";

const usersData = await listUsers({ limit: 1000 });
const allUsers = usersData.users;

let error = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const userId = formData.get("user_id") as string;
  const name = (formData.get("name") as string)?.trim().toLowerCase().replace(/[^a-z0-9-]/g, "-");
  const description = formData.get("description") as string;

  if (!userId || !name) {
    error = "Owner and name are required";
  } else {
    try {
      // Find user from the list we already fetched
      const user = allUsers.find(u => u.id === parseInt(userId));

      if (!user) {
        error = "User not found";
      } else {
        // Get session cookie for authentication
        const sessionCookie = Astro.cookies.get('plue_session');
        const headers: HeadersInit = {};
        if (sessionCookie) {
          headers['Cookie'] = `plue_session=${sessionCookie.value}`;
        }

        // Create repository via API
        await createRepository(
          { name, description: description || undefined },
          headers
        );

        await initRepo(user.username, name);
        return Astro.redirect(`/${user.username}/${name}`);
      }
    } catch (e) {
      if (e instanceof ApiError) {
        error = e.message;
      } else {
        error = (e as Error).message;
      }
    }
  }
}
---

<Layout title="New Repository Â· plue">
  <Header currentPath="/new" />
  <div class="container">
    <h1 class="page-title mb-3">Create a new repository</h1>

    {error && (
      <div class="error-banner mb-3">
        {error}
      </div>
    )}

    <form method="POST">
      <div class="form-group">
        <label for="user_id">Owner</label>
        <select name="user_id" id="user_id" required>
          {allUsers.map((user) => (
            <option value={user.id}>{user.username}</option>
          ))}
        </select>
      </div>

      <div class="form-group">
        <label for="name">Repository name</label>
        <input
          type="text"
          name="name"
          id="name"
          required
          pattern="[a-z0-9-]+"
          placeholder="my-project"
          autocomplete="off"
          spellcheck="false"
          title="Lowercase letters, numbers, and hyphens only"
        />
      </div>

      <div class="form-group">
        <label for="description">Description <span class="text-muted">(optional)</span></label>
        <input
          type="text"
          name="description"
          id="description"
          placeholder="A short description of your repository"
        />
      </div>

      <button type="submit" class="btn btn-primary">Create repository</button>
    </form>
  </div>
</Layout>

<style>
  .error-banner {
    padding: 12px 16px;
    background: rgba(255, 68, 68, 0.1);
    border: 1px solid rgba(255, 68, 68, 0.3);
    border-radius: var(--radius);
    color: var(--error);
    font-size: 13px;
  }
</style>
