---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import RepoCard from "../components/RepoCard.astro";
import Pagination from "../components/Pagination.astro";
import { listRepos } from "../lib/api";
import type { Repository } from "../lib/types";

// Pagination settings
const PAGE_SIZE = 20;

// Validate page number: handle negative, zero, NaN, and non-integer values
const rawPageParam = Astro.url.searchParams.get('page');
const pageParam = parseInt(rawPageParam || '1', 10);
const validPage = Math.max(1, isNaN(pageParam) ? 1 : pageParam);

// Redirect to normalized URL if page param is invalid
if (rawPageParam !== null && (isNaN(pageParam) || pageParam < 1 || pageParam !== validPage)) {
  const url = new URL(Astro.url);
  url.searchParams.set('page', String(validPage));
  return Astro.redirect(url.pathname + url.search);
}

const page = validPage;
const offset = (page - 1) * PAGE_SIZE;

// Get paginated results from API
const response = await listRepos({
  limit: PAGE_SIZE,
  offset: offset,
  sort: 'updated_at'
});

const totalPages = Math.ceil(response.total / PAGE_SIZE);

// Map API response to UI format
const repos: Repository[] = response.repositories.map(repo => ({
  id: repo.id,
  user_id: 0, // Not provided by list API
  name: repo.name,
  username: repo.owner,
  description: repo.description || null,
  is_public: !repo.isPrivate,
  default_branch: repo.defaultBranch || 'main',
  updated_at: new Date(repo.updatedAt),
  created_at: new Date(repo.createdAt),
  topics: [],
}));
---

<Layout title="plue">
  <Header currentPath="/" />
  <div class="container">
    <div class="flex-between mb-3">
      <h1 class="page-title">Repositories</h1>
      <a href="/new" class="btn btn-primary">Create new</a>
    </div>

    {repos.length === 0 && page === 1 ? (
      <div class="empty-state">
        <div class="empty-state-icon">â–¡</div>
        <div class="empty-state-title">No repositories yet</div>
        <div class="empty-state-description">
          Get started by creating your first repository to host your code.
        </div>
        <a href="/new" class="btn btn-primary">Create your first repository</a>
      </div>
    ) : (
      <>
        <ul class="repo-list">
          {repos.map((repo) => (
            <RepoCard repo={repo} />
          ))}
        </ul>
        {totalPages > 1 && (
          <Pagination
            currentPage={page}
            totalPages={totalPages}
            baseUrl="/"
          />
        )}
      </>
    )}
  </div>
</Layout>
