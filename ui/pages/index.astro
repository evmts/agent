---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import RepoCard from "../components/RepoCard.astro";
import Pagination from "../components/Pagination.astro";
import { sql } from "../../db";
import type { Repository } from "../lib/types";

// Pagination settings
const PAGE_SIZE = 20;

// Validate page number: handle negative, zero, NaN, and non-integer values
const rawPageParam = Astro.url.searchParams.get('page');
const pageParam = parseInt(rawPageParam || '1', 10);
const validPage = Math.max(1, isNaN(pageParam) ? 1 : pageParam);

// Redirect to normalized URL if page param is invalid
if (rawPageParam !== null && (isNaN(pageParam) || pageParam < 1 || pageParam !== validPage)) {
  const url = new URL(Astro.url);
  url.searchParams.set('page', String(validPage));
  return Astro.redirect(url.pathname + url.search);
}

const page = validPage;
const offset = (page - 1) * PAGE_SIZE;

// Get total count for pagination
const [{ count }] = await sql<[{ count: number }]>`
  SELECT COUNT(*)::int as count
  FROM repositories r
  WHERE r.is_public = true
`;

const totalPages = Math.ceil(count / PAGE_SIZE);

// Get paginated results
const repos = await sql<Repository[]>`
  SELECT r.*, u.username
  FROM repositories r
  JOIN users u ON r.user_id = u.id
  WHERE r.is_public = true
  ORDER BY r.updated_at DESC
  LIMIT ${PAGE_SIZE}
  OFFSET ${offset}
`;
---

<Layout title="plue">
  <Header currentPath="/" />
  <div class="container">
    <div class="flex-between mb-3">
      <h1 class="page-title">Repositories</h1>
      <a href="/new" class="btn btn-primary">Create new</a>
    </div>

    {repos.length === 0 && page === 1 ? (
      <div class="empty-state">
        <div class="empty-state-icon">â–¡</div>
        <div class="empty-state-title">No repositories yet</div>
        <div class="empty-state-description">
          Get started by creating your first repository to host your code.
        </div>
        <a href="/new" class="btn btn-primary">Create your first repository</a>
      </div>
    ) : (
      <>
        <ul class="repo-list">
          {repos.map((repo) => (
            <RepoCard repo={repo} />
          ))}
        </ul>
        {totalPages > 1 && (
          <Pagination
            currentPage={page}
            totalPages={totalPages}
            baseUrl="/"
          />
        )}
      </>
    )}
  </div>
</Layout>
