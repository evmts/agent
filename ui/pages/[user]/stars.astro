---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import RepoCard from "../../components/RepoCard.astro";
import { users, stars } from '@plue/db';

const { user: username } = Astro.params;

if (!username) {
  return Astro.redirect('/404');
}

const user = await users.getByUsername(username);

if (!user) {
  return Astro.redirect("/404");
}

// Get starred repositories
const starredRepos = await stars.getStarredRepos(user.id);

// Get star counts for all repositories in one query
const starCountMap = starredRepos.length > 0
  ? await stars.getStarCountsForRepos(starredRepos.map(r => r.id))
  : new Map<number, number>();

// Map starred repos to the format expected by RepoCard
const starredReposWithData = starredRepos.map(repo => ({
  id: repo.id,
  user_id: 0, // Not needed for display
  name: repo.name,
  description: repo.description,
  is_public: true, // Starred repos are visible
  default_branch: 'main', // Not needed for display
  topics: [], // Not returned by DAO
  created_at: new Date(), // Not needed for display
  updated_at: new Date(), // Not needed for display
  username: repo.owner_username,
  star_count: starCountMap.get(repo.id) || 0,
}));
---

<Layout title={`Stars - ${user.username} · plue`}>
  <Header />
  <div class="container">
    <div class="user-profile mb-3">
      <h1 class="page-title">{user.display_name || user.username}</h1>
      {user.bio && <p class="bio">{user.bio}</p>}
    </div>

    <nav class="profile-nav mb-3">
      <a href={`/${username}`}>Repositories</a>
      <a href={`/${username}/stars`} class="active">Stars</a>
    </nav>

    <h2 class="mb-2">Starred Repositories ({starredReposWithData.length})</h2>

    {starredReposWithData.length === 0 ? (
      <div class="empty-state compact">
        <div class="empty-state-icon">★</div>
        <div class="empty-state-title">No starred repositories</div>
        <div class="empty-state-description">
          {user.username} hasn't starred any repositories yet.
        </div>
      </div>
    ) : (
      <ul class="repo-list">
        {starredReposWithData.map((repo) => (
          <RepoCard repo={repo} showUser={true} starCount={Number(repo.star_count)} />
        ))}
      </ul>
    )}
  </div>
</Layout>

<style>
  .user-profile {
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .bio {
    margin-top: 8px;
  }

  .profile-nav {
    display: flex;
    gap: 1.5rem;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0;
  }

  .profile-nav a {
    padding: 0.5rem 0;
    border-bottom: 2px solid transparent;
    text-decoration: none;
    color: var(--text);
  }

  .profile-nav a.active {
    border-bottom-color: var(--text);
    font-weight: 500;
  }

  .profile-nav a:hover {
    border-bottom-color: var(--border-hover);
  }
</style>
