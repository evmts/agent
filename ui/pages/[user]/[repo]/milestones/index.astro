---
import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import MilestoneCard from "../../../../components/MilestoneCard.astro";
import { getMilestones, getIssues, getRepoStats, createMilestone } from "../../../../lib/api";

const { user: username, repo: reponame } = Astro.params;
const state = Astro.url.searchParams.get("state") || "open";

if (!username || !reponame) {
  return Astro.redirect('/404');
}

// Fetch data from API
const [
  allMilestones,
  { counts: issueCounts },
  stats,
] = await Promise.all([
  getMilestones(username, reponame),
  getIssues(username, reponame, 'open'),
  getRepoStats(username, reponame),
]);

// Filter milestones by state
const milestonesList = allMilestones.milestones.filter(m => {
  if (state === 'all') return true;
  return m.state === state;
});

// Count milestones by state
const counts = {
  open: allMilestones.milestones.filter(m => m.state === 'open').length,
  closed: allMilestones.milestones.filter(m => m.state === 'closed').length,
};

const landingCount = stats.landingCount;
const issueCount = issueCounts.open;

let error = "";
let showCreateForm = false;

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action") as string;

  if (action === "create") {
    const title = (formData.get("title") as string)?.trim();
    const description = (formData.get("description") as string)?.trim();
    const due_date = (formData.get("due_date") as string)?.trim();

    if (!title) {
      error = "Title is required";
    } else {
      try {
        await createMilestone(username, reponame, {
          title,
          description,
          dueDate: due_date || undefined,
        });
        return Astro.redirect(Astro.url.pathname);
      } catch (e) {
        error = (e as Error).message;
      }
    }
  } else if (action === "show_form") {
    showCreateForm = true;
  }
}
---

<Layout title={`Milestones · ${username}/${reponame} · plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <span class="current">milestones</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`}>
      Issues
      {issueCount > 0 && <span class="badge">{issueCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/landing`}>
      Landing
      {landingCount > 0 && <span class="badge">{landingCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/bookmarks`}>Bookmarks</a>
    <a href={`/${username}/${reponame}/changes/main`}>Changes</a>
    <a href={`/${username}/${reponame}/milestones`} class="active">Milestones</a>
  </nav>

  <div class="container">
    <div class="flex-between mb-3">
      <h1 class="page-title">Milestones</h1>
      <form method="POST">
        <input type="hidden" name="action" value="show_form" />
        <button type="submit" class="btn btn-primary">New milestone</button>
      </form>
    </div>

    {showCreateForm && (
      <div class="card mb-3">
        <h2 class="mb-2">Create milestone</h2>

        {error && (
          <div class="error-banner mb-2">
            {error}
          </div>
        )}

        <form method="POST">
          <input type="hidden" name="action" value="create" />

          <div class="form-group">
            <label for="title">Title</label>
            <input
              type="text"
              name="title"
              id="title"
              required
              placeholder="Milestone title"
            />
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea
              name="description"
              id="description"
              rows="3"
              placeholder="Milestone description (optional)"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="due_date">Due date</label>
            <input
              type="date"
              name="due_date"
              id="due_date"
            />
          </div>

          <div class="flex gap-1">
            <button type="submit" class="btn btn-primary">Create milestone</button>
            <a href={`/${username}/${reponame}/milestones`} class="btn">Cancel</a>
          </div>
        </form>
      </div>
    )}

    <div class="tabs">
      <a
        href={`/${username}/${reponame}/milestones?state=open`}
        class:list={["tab", { active: state === "open" }]}
      >
        {counts.open} Open
      </a>
      <a
        href={`/${username}/${reponame}/milestones?state=closed`}
        class:list={["tab", { active: state === "closed" }]}
      >
        {counts.closed} Closed
      </a>
      <a
        href={`/${username}/${reponame}/milestones?state=all`}
        class:list={["tab", { active: state === "all" }]}
      >
        {counts.open + counts.closed} All
      </a>
    </div>

    {milestonesList.length === 0 ? (
      <div class="empty-state">
        <div class="empty-state-icon">◎</div>
        <div class="empty-state-title">No {state} milestones</div>
        <div class="empty-state-description">
          {state === 'open'
            ? "Create milestones to organize issues and track progress toward goals."
            : state === 'closed'
            ? "No milestones have been closed yet. Closed milestones will appear here."
            : "No milestones have been created yet. Use milestones to track your project's progress."}
        </div>
        <form method="POST">
          <input type="hidden" name="action" value="show_form" />
          <button type="submit" class="btn btn-primary">Create a milestone</button>
        </form>
      </div>
    ) : (
      <div class="milestone-list">
        {milestonesList.map((milestone) => (
          <MilestoneCard
            milestone={{
              id: milestone.id,
              repository_id: 0,
              title: milestone.title,
              description: milestone.description,
              due_date: milestone.dueDate ? new Date(milestone.dueDate) : null,
              state: milestone.state as 'open' | 'closed',
              created_at: new Date(milestone.createdAt),
              updated_at: new Date(milestone.updatedAt),
              closed_at: null, // API doesn't provide closedAt yet
              open_issues: milestone.openIssueCount,
              closed_issues: milestone.closedIssueCount,
            }}
            username={username!}
            reponame={reponame!}
          />
        ))}
      </div>
    )}
  </div>
</Layout>

<style>
  .milestone-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .error-banner {
    padding: 12px 16px;
    background: rgba(255, 68, 68, 0.1);
    border: 1px solid rgba(255, 68, 68, 0.3);
    color: var(--error);
    font-size: 13px;
  }

  .card {
    padding: 24px;
    border: 1px solid var(--border);
    background: var(--bg);
  }
</style>
