---
import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import { repositories, milestones, issues } from '@plue/db';
import type { User, Repository, Milestone, Issue } from "../../../../lib/types";

const { user: username, repo: reponame, id: milestoneId } = Astro.params;
const issueState = Astro.url.searchParams.get("issue_state") || "open";

if (!username || !reponame || !milestoneId) {
  return Astro.redirect('/404');
}

const repo = await repositories.getByOwnerAndName(username, reponame);
if (!repo) return Astro.redirect("/404");

// Get milestone with issue counts
const milestone = await milestones.getById(parseInt(milestoneId));

if (!milestone || milestone.repository_id !== repo.id) return Astro.redirect("/404");

// Get issues for this milestone
const issuesList = await issues.getByMilestone(
  parseInt(milestoneId),
  issueState as 'open' | 'closed' | 'all'
);

let error = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action") as string;

  if (action === "update") {
    const title = (formData.get("title") as string)?.trim();
    const description = (formData.get("description") as string)?.trim();
    const due_date = (formData.get("due_date") as string)?.trim();

    if (!title) {
      error = "Title is required";
    } else {
      try {
        await milestones.update(parseInt(milestoneId), {
          title,
          description: description || null,
          due_date: due_date || null,
        });
        return Astro.redirect(Astro.url.pathname);
      } catch (e) {
        error = (e as Error).message;
      }
    }
  } else if (action === "close") {
    try {
      await milestones.close(parseInt(milestoneId));
      return Astro.redirect(Astro.url.pathname);
    } catch (e) {
      error = (e as Error).message;
    }
  } else if (action === "reopen") {
    try {
      await milestones.reopen(parseInt(milestoneId));
      return Astro.redirect(Astro.url.pathname);
    } catch (e) {
      error = (e as Error).message;
    }
  } else if (action === "delete") {
    try {
      await milestones.remove(parseInt(milestoneId));
      return Astro.redirect(`/${username}/${reponame}/milestones`);
    } catch (e) {
      error = (e as Error).message;
    }
  }
}

function formatDate(date: string | Date | null): string {
  if (!date) return "";
  return new Date(date).toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
}

function calculateProgress(open: number, closed: number): number {
  const total = open + closed;
  if (total === 0) return 0;
  return Math.round((closed / total) * 100);
}

function getRelativeDueDate(dueDate: Date | null): { text: string; isOverdue: boolean; daysUntil: number } | null {
  if (!dueDate) return null;

  const now = new Date();
  const due = new Date(dueDate);
  const diffMs = due.getTime() - now.getTime();
  const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

  const isOverdue = diffDays < 0;
  const absDays = Math.abs(diffDays);

  let text: string;
  if (diffDays === 0) {
    text = "Due today";
  } else if (diffDays === 1) {
    text = "Due tomorrow";
  } else if (diffDays === -1) {
    text = "1 day overdue";
  } else if (isOverdue) {
    text = `${absDays} days overdue`;
  } else {
    text = `Due in ${diffDays} days`;
  }

  return { text, isOverdue, daysUntil: diffDays };
}

const total = (milestone.open_issues || 0) + (milestone.closed_issues || 0);
const progress = calculateProgress(milestone.open_issues || 0, milestone.closed_issues || 0);
const relativeDue = getRelativeDueDate(milestone.due_date);
const isOverdue = relativeDue?.isOverdue && milestone.state === 'open';

// Determine progress bar color based on overdue status
let progressColor = "var(--success)"; // Green for on track
if (isOverdue) {
  progressColor = "var(--error)"; // Red for overdue
} else if (relativeDue && relativeDue.daysUntil <= 7 && relativeDue.daysUntil > 0 && milestone.state === 'open' && progress < 100) {
  progressColor = "var(--warning)"; // Orange/yellow for due soon
}
---

<Layout title={`${milestone.title} · Milestone · plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}/milestones`}>milestones</a>
    <span class="sep">/</span>
    <span class="current">{milestone.title}</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`}>Issues</a>
    <a href={`/${username}/${reponame}/bookmarks`}>Bookmarks</a>
    <a href={`/${username}/${reponame}/changes/${repo.default_branch || 'main'}`}>Changes</a>
    <a href={`/${username}/${reponame}/milestones`} class="active">Milestones</a>
  </nav>

  <div class="container">
    <div class="milestone-header mb-3">
      <div class="flex-between mb-2">
        <div>
          <h1 class="page-title">{milestone.title}</h1>
          <div class="milestone-meta">
            <span class:list={["milestone-state", milestone.state]}>{milestone.state}</span>
            {milestone.due_date && (
              <div class="milestone-due-info">
                <span class:list={["milestone-due", { overdue: isOverdue }]}>
                  {relativeDue?.text}
                </span>
                <span class="milestone-due-date">
                  ({formatDate(milestone.due_date)})
                </span>
              </div>
            )}
          </div>
        </div>
      </div>

      {error && (
        <div class="error-banner mb-2">
          {error}
        </div>
      )}

      {milestone.description && (
        <p class="milestone-description">{milestone.description}</p>
      )}

      <div class="milestone-progress mb-3">
        <div class="progress-header">
          <span class="progress-percentage">{progress}% complete</span>
          <span class="progress-counts">
            {milestone.closed_issues || 0} of {total} {total === 1 ? 'issue' : 'issues'}
          </span>
        </div>
        <div class="progress-bar">
          <div
            class="progress-fill"
            style={`width: ${progress}%; background: ${progressColor};`}
          ></div>
        </div>
        <div class="progress-details">
          <span class="text-muted">{milestone.closed_issues || 0} closed</span>
          <span class="text-muted">{milestone.open_issues || 0} open</span>
        </div>
      </div>

      <div class="milestone-actions">
        <details class="dropdown">
          <summary class="btn">Edit</summary>
          <div class="dropdown-menu">
            <form method="POST" class="edit-form">
              <input type="hidden" name="action" value="update" />

              <div class="form-group">
                <label for="title">Title</label>
                <input
                  type="text"
                  name="title"
                  id="title"
                  required
                  value={milestone.title}
                />
              </div>

              <div class="form-group">
                <label for="description">Description</label>
                <textarea
                  name="description"
                  id="description"
                  rows="3"
                >{milestone.description || ""}</textarea>
              </div>

              <div class="form-group">
                <label for="due_date">Due date</label>
                <input
                  type="date"
                  name="due_date"
                  id="due_date"
                  value={milestone.due_date ? new Date(milestone.due_date).toISOString().split('T')[0] : ""}
                />
              </div>

              <button type="submit" class="btn btn-primary">Save changes</button>
            </form>
          </div>
        </details>

        <form method="POST" style="display: inline;">
          {milestone.state === "open" ? (
            <>
              <input type="hidden" name="action" value="close" />
              <button type="submit" class="btn">Close milestone</button>
            </>
          ) : (
            <>
              <input type="hidden" name="action" value="reopen" />
              <button type="submit" class="btn">Reopen milestone</button>
            </>
          )}
        </form>

        <form method="POST" style="display: inline;" onsubmit="return confirm('Are you sure? This will remove the milestone from all issues.')">
          <input type="hidden" name="action" value="delete" />
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>

    <div class="tabs">
      <a
        href={`/${username}/${reponame}/milestones/${milestoneId}?issue_state=open`}
        class:list={["tab", { active: issueState === "open" }]}
      >
        {milestone.open_issues || 0} Open
      </a>
      <a
        href={`/${username}/${reponame}/milestones/${milestoneId}?issue_state=closed`}
        class:list={["tab", { active: issueState === "closed" }]}
      >
        {milestone.closed_issues || 0} Closed
      </a>
      <a
        href={`/${username}/${reponame}/milestones/${milestoneId}?issue_state=all`}
        class:list={["tab", { active: issueState === "all" }]}
      >
        {(milestone.open_issues || 0) + (milestone.closed_issues || 0)} All
      </a>
    </div>

    {issuesList.length === 0 ? (
      <div class="empty-state">
        <p>No {issueState} issues in this milestone</p>
      </div>
    ) : (
      <div class="issue-list">
        {issuesList.map((issue) => (
          <div class="issue-item">
            <div class="issue-info">
              <a href={`/${username}/${reponame}/issues/${issue.issue_number}`} class="issue-title">
                {issue.title}
              </a>
              <p class="text-muted text-sm">
                #{issue.issue_number} opened by <strong>{issue.author_username}</strong> on {formatDate(issue.created_at)}
              </p>
            </div>
            <span class:list={["issue-state", issue.state]}>{issue.state}</span>
          </div>
        ))}
      </div>
    )}
  </div>
</Layout>

<style>
  .milestone-header {
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }

  .milestone-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
  }

  .milestone-state {
    padding: 4px 8px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    border: 1px solid var(--border);
    letter-spacing: 0.03em;
  }

  .milestone-state.open {
    color: var(--success);
    border-color: var(--success);
    background: rgba(0, 210, 106, 0.08);
  }

  .milestone-state.closed {
    color: var(--gray-400);
    background: rgba(255, 255, 255, 0.03);
  }

  .milestone-due-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .milestone-due {
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-300);
  }

  .milestone-due.overdue {
    color: var(--error);
    font-weight: 600;
  }

  .milestone-due-date {
    font-size: 12px;
    color: var(--gray-500);
  }

  .milestone-description {
    margin: 16px 0;
    color: var(--gray-400);
    font-size: 14px;
    line-height: 1.5;
  }

  .milestone-progress {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
  }

  .progress-percentage {
    font-weight: 600;
    color: var(--fg);
  }

  .progress-counts {
    color: var(--gray-400);
  }

  .progress-bar {
    width: 100%;
    height: 10px;
    background: var(--gray-900);
    border: 1px solid var(--border);
    overflow: hidden;
    position: relative;
  }

  .progress-fill {
    height: 100%;
    transition: width 0.3s ease, background 0.2s ease;
    position: relative;
  }

  .progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg,
      rgba(255, 255, 255, 0) 0%,
      rgba(255, 255, 255, 0.1) 50%,
      rgba(255, 255, 255, 0) 100%
    );
    animation: shimmer 2s infinite;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  .progress-details {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    gap: 16px;
  }

  .text-muted {
    color: var(--gray-500);
  }

  .milestone-actions {
    display: flex;
    gap: 8px;
  }

  .dropdown {
    position: relative;
  }

  .dropdown summary {
    cursor: pointer;
    list-style: none;
  }

  .dropdown summary::-webkit-details-marker {
    display: none;
  }

  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 4px;
    padding: 16px;
    background: var(--bg);
    border: 1px solid var(--border);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    min-width: 300px;
  }

  .edit-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .issue-list {
    display: flex;
    flex-direction: column;
  }

  .issue-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border-bottom: 1px solid var(--border);
  }

  .issue-item:last-child {
    border-bottom: none;
  }

  .issue-info {
    flex: 1;
  }

  .issue-title {
    font-size: 16px;
    font-weight: 500;
    color: var(--fg);
    text-decoration: none;
    display: block;
    margin-bottom: 4px;
  }

  .issue-title:hover {
    text-decoration: underline;
  }

  .issue-state {
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    border: 1px solid var(--border);
  }

  .issue-state.open {
    color: var(--success);
    border-color: var(--success);
  }

  .issue-state.closed {
    color: var(--muted);
  }

  .error-banner {
    padding: 12px 16px;
    background: rgba(255, 68, 68, 0.1);
    border: 1px solid rgba(255, 68, 68, 0.3);
    color: var(--error);
    font-size: 13px;
  }
</style>
