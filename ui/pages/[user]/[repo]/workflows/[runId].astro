---
/**
 * Workflow run detail page.
 * Displays a single workflow run with its jobs and steps.
 */

import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import WorkflowStatusBadge from "../../../../components/WorkflowStatusBadge.astro";
import RelativeTime from "../../../../components/RelativeTime.astro";
import { getWorkflowRun } from "../../../../lib/api";

const { user: username, repo: reponame, runId } = Astro.params;

if (!username || !reponame || !runId) {
  return Astro.redirect('/404');
}

const runIdInt = parseInt(runId);

// Get workflow run from API
const { run } = await getWorkflowRun(username, reponame, runIdInt).catch(() => {
  return Astro.redirect("/404");
});

// TODO: Get jobs, steps, and artifacts from API
// For now, use empty arrays
let jobs: any[] = [];
let steps: Record<number, any[]> = {};
let artifacts: any[] = [];

// Format file size
function formatFileSize(bytes: number): string {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}

// Format duration
function formatDuration(start: string | Date | null, end: string | Date | null): string {
  if (!start) return '-';
  const startDate = new Date(start);
  const endDate = end ? new Date(end) : new Date();
  const diffMs = endDate.getTime() - startDate.getTime();
  const diffSec = Math.floor(diffMs / 1000);
  const diffMin = Math.floor(diffSec / 60);

  if (diffMin > 0) {
    const sec = diffSec % 60;
    return `${diffMin}m ${sec}s`;
  }
  return `${diffSec}s`;
}

const shortSha = run.commit_sha?.slice(0, 7);
---

<Layout title={`Run #${run.run_number} Â· ${username}/${reponame}`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}/workflows`}>workflows</a>
    <span class="sep">/</span>
    <span class="current">#{run.run_number}</span>
  </div>

  <div class="run-detail">
    <div class="run-header">
      <div class="run-title-row">
        <h1>{run.title}</h1>
        <WorkflowStatusBadge status={run.status} size="large" />
      </div>

      <div class="run-meta">
        <span class="run-number">Run #{run.run_number}</span>
        <span class="trigger">{run.trigger_event}</span>
        {run.ref && <span class="ref">{run.ref}</span>}
        {shortSha && <code class="sha">{shortSha}</code>}
        <span class="timing">Started <RelativeTime date={run.created_at} /></span>
        <span class="duration">Duration: {formatDuration(run.started_at, run.stopped_at)}</span>
      </div>
    </div>

    <div class="run-actions">
      {run.status === 6 || run.status === 5 ? (
        <button class="btn btn-danger" id="cancel-btn" data-run-id={run.id}>
          Cancel
        </button>
      ) : (
        <button class="btn btn-secondary" id="rerun-btn" data-run-id={run.id}>
          Re-run
        </button>
      )}
    </div>

    <div class="jobs-section">
      <h2>Jobs</h2>

      {jobs.length === 0 ? (
        <div class="empty-jobs">No jobs in this run.</div>
      ) : (
        <div class="jobs-list">
          {jobs.map((job) => (
            <details class="job-card" open>
              <summary class="job-header">
                <div class="job-header-content">
                  <span class="expand-icon">â–¶</span>
                  <span class="job-name">{job.name}</span>
                  <WorkflowStatusBadge status={job.status} />
                  <span class="job-duration">
                    {formatDuration(job.started_at, job.stopped_at)}
                  </span>
                </div>
              </summary>

              {steps[job.id] && steps[job.id].length > 0 && (
                <div class="steps-list">
                  {steps[job.id].map((step: any) => (
                    <div class="step-item" data-step-status={step.status}>
                      <span class="step-icon">
                        {step.status === 1 ? 'âœ“' : step.status === 2 ? 'âœ•' : step.status === 6 ? 'âŸ³' : 'â—‹'}
                      </span>
                      <span class="step-index">{step.step_index + 1}</span>
                      <span class="step-name">{step.name}</span>
                      <WorkflowStatusBadge status={step.status} size="small" />
                      <span class="step-duration">
                        {formatDuration(step.started_at, step.stopped_at)}
                      </span>
                    </div>
                  ))}
                </div>
              )}
            </details>
          ))}
        </div>
      )}
    </div>

    <div class="artifacts-section">
      <h2>Artifacts</h2>

      {artifacts.length === 0 ? (
        <div class="empty-artifacts">No artifacts for this run.</div>
      ) : (
        <div class="artifacts-list">
          {artifacts.map((artifact: any) => (
            <div class="artifact-item">
              <div class="artifact-info">
                <span class="artifact-icon">ðŸ“¦</span>
                <div class="artifact-details">
                  <span class="artifact-name">{artifact.name}</span>
                  <span class="artifact-size">{formatFileSize(artifact.file_size)}</span>
                </div>
              </div>
              <a
                href={`/${username}/${reponame}/workflows/runs/${runId}/artifacts/${artifact.id}/download`}
                class="btn btn-sm"
                download
              >
                Download
              </a>
            </div>
          ))}
        </div>
      )}
    </div>

    <div class="logs-section">
      <div class="logs-header">
        <h2>Logs</h2>
        <button class="btn btn-sm" id="download-logs-btn">
          Download Logs
        </button>
      </div>
      <pre class="logs-container" id="logs-container">Loading logs...</pre>
    </div>
  </div>
</Layout>

<style>
  .run-detail {
    margin-top: 1rem;
  }

  .run-header {
    margin-bottom: 1rem;
  }

  .run-title-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .run-title-row h1 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
  }

  .run-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.875rem;
    color: var(--muted);
  }

  .run-number {
    font-family: var(--font-mono);
  }

  .trigger {
    padding: 0.125rem 0.375rem;
    background: var(--accent-bg, #dbeafe);
    border-radius: 2px;
  }

  .ref {
    padding: 0.125rem 0.375rem;
    background: var(--muted-bg, #f3f4f6);
    border-radius: 2px;
  }

  .sha {
    font-family: var(--font-mono);
    font-size: 0.75rem;
  }

  .run-actions {
    margin-bottom: 1.5rem;
  }

  .btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border);
    background: var(--bg);
    cursor: pointer;
    font-family: inherit;
  }

  .btn-secondary {
    background: var(--muted-bg, #f3f4f6);
  }

  .btn-danger {
    background: var(--error, #ef4444);
    color: white;
    border-color: var(--error, #ef4444);
  }

  .jobs-section, .artifacts-section, .logs-section {
    margin-top: 2rem;
  }

  .jobs-section h2, .artifacts-section h2 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .logs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .logs-header h2 {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
  }

  .empty-jobs, .empty-artifacts {
    color: var(--gray-400);
    padding: 1rem;
    border: 1px dashed var(--border);
    text-align: center;
  }

  .artifacts-list {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .artifact-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    transition: background var(--transition-fast);
  }

  .artifact-item:last-child {
    border-bottom: none;
  }

  .artifact-item:hover {
    background: var(--hover);
  }

  .artifact-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
  }

  .artifact-icon {
    font-size: 1.5rem;
  }

  .artifact-details {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .artifact-name {
    font-weight: 500;
    font-size: 0.875rem;
  }

  .artifact-size {
    font-size: 0.75rem;
    color: var(--gray-500);
    font-family: var(--font-mono);
  }

  .job-card {
    border: 1px solid var(--border);
    margin-bottom: 0.5rem;
  }

  .job-header {
    display: block;
    padding: 0.75rem 1rem;
    background: var(--gray-950);
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
    list-style: none;
  }

  .job-header::-webkit-details-marker {
    display: none;
  }

  .job-header-content {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .expand-icon {
    font-size: 0.625rem;
    color: var(--gray-400);
    transition: transform 0.2s;
    display: inline-block;
  }

  details[open] .expand-icon {
    transform: rotate(90deg);
  }

  .job-name {
    font-weight: 500;
    flex: 1;
  }

  .job-duration {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--gray-400);
  }

  .steps-list {
    padding: 0.5rem 0;
  }

  .step-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1rem 0.5rem 2.5rem;
    transition: background var(--transition-fast);
  }

  .step-item:hover {
    background: var(--hover);
  }

  .step-icon {
    font-size: 0.75rem;
    width: 1rem;
    text-align: center;
  }

  .step-item[data-step-status="1"] .step-icon {
    color: var(--success);
  }

  .step-item[data-step-status="2"] .step-icon {
    color: var(--error);
  }

  .step-item[data-step-status="6"] .step-icon {
    color: var(--info, #3b82f6);
    animation: spin 2s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .step-index {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--gray-500);
    width: 1.5rem;
    text-align: right;
  }

  .step-name {
    flex: 1;
    font-size: 0.875rem;
  }

  .step-duration {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--gray-500);
  }

  .logs-container {
    background: var(--code-bg, #1f2937);
    color: var(--code-fg, #f9fafb);
    padding: 1rem;
    overflow-x: auto;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    line-height: 1.5;
    max-height: 400px;
    overflow-y: auto;
  }
</style>

<script define:vars={{ runId, username, reponame, runStatus: run.status, workflowDefId: run.workflow_definition_id }}>
  // Get CSRF token from cookie
  function getCsrfToken() {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'csrf_token') {
        return value;
      }
    }
    return null;
  }

  // Helper to add CSRF token to fetch options
  function withCsrfToken(options = {}) {
    const token = getCsrfToken();
    if (token) {
      return {
        ...options,
        headers: {
          ...options.headers,
          'X-CSRF-Token': token,
        },
      };
    }
    return options;
  }

  // SSE streaming for live updates
  let eventSource = null;
  let isStreaming = false;

  function startStreaming() {
    if (isStreaming || eventSource) return;

    // Only stream if run is pending (5), running (6), or waiting (5)
    if (runStatus !== 5 && runStatus !== 6) return;

    isStreaming = true;
    eventSource = new EventSource(`/api/workflows/runs/${runId}/stream`);

    eventSource.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        handleStreamEvent(data);
      } catch (e) {
        console.error('Failed to parse SSE event:', e);
      }
    };

    eventSource.onerror = (e) => {
      console.error('SSE error:', e);
      stopStreaming();
      // Retry after 5 seconds
      setTimeout(startStreaming, 5000);
    };

    eventSource.addEventListener('step_status', (event) => {
      const data = JSON.parse(event.data);
      updateStepStatus(data.step_id, data.status);
    });

    eventSource.addEventListener('step_output', (event) => {
      const data = JSON.parse(event.data);
      appendLog(data.output);
    });

    eventSource.addEventListener('run_completed', (event) => {
      const data = JSON.parse(event.data);
      stopStreaming();
      // Reload page to show final state
      window.location.reload();
    });
  }

  function stopStreaming() {
    isStreaming = false;
    if (eventSource) {
      eventSource.close();
      eventSource = null;
    }
  }

  function handleStreamEvent(data) {
    switch (data.type) {
      case 'step_status':
        updateStepStatus(data.step_id, data.status);
        break;
      case 'step_output':
        appendLog(data.output);
        break;
      case 'run_completed':
        stopStreaming();
        window.location.reload();
        break;
    }
  }

  function updateStepStatus(stepId, status) {
    const stepItem = document.querySelector(`[data-step-id="${stepId}"]`);
    if (stepItem) {
      stepItem.setAttribute('data-step-status', status);
      // Update icon based on status
      const icon = stepItem.querySelector('.step-icon');
      if (icon) {
        icon.textContent = status === 1 ? 'âœ“' : status === 2 ? 'âœ•' : status === 6 ? 'âŸ³' : 'â—‹';
      }
    }
  }

  function appendLog(text) {
    const container = document.getElementById('logs-container');
    if (container) {
      container.textContent += text + '\n';
      // Auto-scroll to bottom
      container.scrollTop = container.scrollHeight;
    }
  }

  // Start streaming on page load
  startStreaming();

  // Cleanup on page unload
  window.addEventListener('beforeunload', stopStreaming);

  // Load logs
  async function loadLogs() {
    const container = document.getElementById('logs-container');
    if (!container) return;

    try {
      const response = await fetch(`/api/${username}/${reponame}/workflows/runs/${runId}/logs`);
      if (response.ok) {
        const logs = await response.text();
        container.textContent = logs || '(no logs yet)';
      } else {
        container.textContent = '(failed to load logs)';
      }
    } catch (e) {
      container.textContent = '(error loading logs)';
    }
  }

  loadLogs();

  // Download logs button
  const downloadLogsBtn = document.getElementById('download-logs-btn');
  if (downloadLogsBtn) {
    downloadLogsBtn.addEventListener('click', async () => {
      try {
        const response = await fetch(`/api/${username}/${reponame}/workflows/runs/${runId}/logs`);
        if (response.ok) {
          const logs = await response.text();
          const blob = new Blob([logs], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `workflow-run-${runId}-logs.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } else {
          window.toast.error('Failed to download logs');
        }
      } catch (e) {
        window.toast.error('Error downloading logs');
      }
    });
  }

  // Cancel button
  const cancelBtn = document.getElementById('cancel-btn');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', async () => {
      if (!confirm('Cancel this workflow run?')) return;

      try {
        const response = await fetch(`/api/${username}/${reponame}/workflows/runs/${runId}/cancel`, withCsrfToken({
          method: 'POST',
        }));
        if (response.ok) {
          window.location.reload();
        } else {
          window.toast.error('Failed to cancel workflow');
        }
      } catch (e) {
        window.toast.error('Error cancelling workflow');
      }
    });
  }

  // Rerun button
  const rerunBtn = document.getElementById('rerun-btn');
  if (rerunBtn) {
    rerunBtn.addEventListener('click', async () => {
      try {
        // Rerun uses the v2 API to create a new run with same config
        const response = await fetch(`/api/${username}/${reponame}/workflows/runs`, withCsrfToken({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            workflow_definition_id: workflowDefId,
            trigger_type: 'manual',
            trigger_payload: { rerun_of: runId },
          }),
        }));
        if (response.ok) {
          const data = await response.json();
          window.location.href = `/${username}/${reponame}/workflows/${data.run.id}`;
        } else {
          window.toast.error('Failed to re-run workflow');
        }
      } catch (e) {
        window.toast.error('Error re-running workflow');
      }
    });
  }
</script>
