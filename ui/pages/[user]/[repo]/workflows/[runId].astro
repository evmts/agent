---
/**
 * Workflow run detail page.
 * Displays a single workflow run with its jobs and steps.
 */

import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import WorkflowStatusBadge from "../../../../components/WorkflowStatusBadge.astro";
import { sql } from "../../../../lib/db";
import type { User, Repository } from "../../../../lib/types";

const { user: username, repo: reponame, runId } = Astro.params;

if (!username || !reponame || !runId) {
  return Astro.redirect('/404');
}

// Get user and repo
const [user] = await sql<User[]>`SELECT * FROM users WHERE username = ${username}`;
if (!user) return Astro.redirect("/404");

const [repo] = await sql<Repository[]>`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
`;
if (!repo) return Astro.redirect("/404");

// Get workflow run
let run: any = null;
let jobs: any[] = [];
let steps: Record<number, any[]> = {};

try {
  const [runRow] = await sql`
    SELECT * FROM workflow_runs WHERE id = ${parseInt(runId)}
  `;
  if (!runRow) return Astro.redirect("/404");
  run = runRow;

  // Get jobs for this run
  jobs = await sql`
    SELECT * FROM workflow_jobs
    WHERE run_id = ${run.id}
    ORDER BY id
  `;

  // Get steps for each job
  for (const job of jobs) {
    const taskRows = await sql`
      SELECT id FROM workflow_tasks
      WHERE job_id = ${job.id}
      ORDER BY attempt DESC
      LIMIT 1
    `;
    if (taskRows.length > 0) {
      const stepRows = await sql`
        SELECT * FROM workflow_steps
        WHERE task_id = ${taskRows[0].id}
        ORDER BY step_index
      `;
      steps[job.id] = stepRows;
    } else {
      steps[job.id] = [];
    }
  }
} catch (e) {
  console.error('Error fetching workflow run:', e);
  return Astro.redirect("/404");
}

// Format relative time
function formatRelativeTime(date: string | Date | null): string {
  if (!date) return '-';
  const d = new Date(date);
  const now = new Date();
  const diffMs = now.getTime() - d.getTime();
  const diffSec = Math.floor(diffMs / 1000);
  const diffMin = Math.floor(diffSec / 60);
  const diffHour = Math.floor(diffMin / 60);
  const diffDay = Math.floor(diffHour / 24);

  if (diffDay > 0) return `${diffDay}d ago`;
  if (diffHour > 0) return `${diffHour}h ago`;
  if (diffMin > 0) return `${diffMin}m ago`;
  return 'just now';
}

// Format duration
function formatDuration(start: string | Date | null, end: string | Date | null): string {
  if (!start) return '-';
  const startDate = new Date(start);
  const endDate = end ? new Date(end) : new Date();
  const diffMs = endDate.getTime() - startDate.getTime();
  const diffSec = Math.floor(diffMs / 1000);
  const diffMin = Math.floor(diffSec / 60);

  if (diffMin > 0) {
    const sec = diffSec % 60;
    return `${diffMin}m ${sec}s`;
  }
  return `${diffSec}s`;
}

const shortSha = run.commit_sha?.slice(0, 7);
---

<Layout title={`Run #${run.run_number} Â· ${username}/${reponame}`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}/workflows`}>workflows</a>
    <span class="sep">/</span>
    <span class="current">#{run.run_number}</span>
  </div>

  <div class="run-detail">
    <div class="run-header">
      <div class="run-title-row">
        <h1>{run.title}</h1>
        <WorkflowStatusBadge status={run.status} size="large" />
      </div>

      <div class="run-meta">
        <span class="run-number">Run #{run.run_number}</span>
        <span class="trigger">{run.trigger_event}</span>
        {run.ref && <span class="ref">{run.ref}</span>}
        {shortSha && <code class="sha">{shortSha}</code>}
        <span class="timing">Started {formatRelativeTime(run.created_at)}</span>
        <span class="duration">Duration: {formatDuration(run.started_at, run.stopped_at)}</span>
      </div>
    </div>

    <div class="run-actions">
      {run.status === 6 || run.status === 5 ? (
        <button class="btn btn-danger" id="cancel-btn" data-run-id={run.id}>
          Cancel
        </button>
      ) : (
        <button class="btn btn-secondary" id="rerun-btn" data-run-id={run.id}>
          Re-run
        </button>
      )}
    </div>

    <div class="jobs-section">
      <h2>Jobs</h2>

      {jobs.length === 0 ? (
        <div class="empty-jobs">No jobs in this run.</div>
      ) : (
        <div class="jobs-list">
          {jobs.map((job) => (
            <div class="job-card">
              <div class="job-header">
                <span class="job-name">{job.name}</span>
                <WorkflowStatusBadge status={job.status} />
                <span class="job-duration">
                  {formatDuration(job.started_at, job.stopped_at)}
                </span>
              </div>

              {steps[job.id] && steps[job.id].length > 0 && (
                <div class="steps-list">
                  {steps[job.id].map((step: any) => (
                    <div class="step-item">
                      <span class="step-index">{step.step_index + 1}</span>
                      <span class="step-name">{step.name}</span>
                      <WorkflowStatusBadge status={step.status} size="small" />
                    </div>
                  ))}
                </div>
              )}
            </div>
          ))}
        </div>
      )}
    </div>

    <div class="logs-section">
      <h2>Logs</h2>
      <pre class="logs-container" id="logs-container">Loading logs...</pre>
    </div>
  </div>
</Layout>

<style>
  .run-detail {
    margin-top: 1rem;
  }

  .run-header {
    margin-bottom: 1rem;
  }

  .run-title-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .run-title-row h1 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
  }

  .run-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.875rem;
    color: var(--muted);
  }

  .run-number {
    font-family: var(--font-mono);
  }

  .trigger {
    padding: 0.125rem 0.375rem;
    background: var(--accent-bg, #dbeafe);
    border-radius: 2px;
  }

  .ref {
    padding: 0.125rem 0.375rem;
    background: var(--muted-bg, #f3f4f6);
    border-radius: 2px;
  }

  .sha {
    font-family: var(--font-mono);
    font-size: 0.75rem;
  }

  .run-actions {
    margin-bottom: 1.5rem;
  }

  .btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border);
    background: var(--bg);
    cursor: pointer;
    font-family: inherit;
  }

  .btn-secondary {
    background: var(--muted-bg, #f3f4f6);
  }

  .btn-danger {
    background: var(--error, #ef4444);
    color: white;
    border-color: var(--error, #ef4444);
  }

  .jobs-section, .logs-section {
    margin-top: 2rem;
  }

  .jobs-section h2, .logs-section h2 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .empty-jobs {
    color: var(--muted);
    padding: 1rem;
    border: 1px dashed var(--border);
    text-align: center;
  }

  .job-card {
    border: 1px solid var(--border);
    margin-bottom: 0.5rem;
  }

  .job-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1rem;
    background: var(--muted-bg, #f9fafb);
    border-bottom: 1px solid var(--border);
  }

  .job-name {
    font-weight: 500;
    flex: 1;
  }

  .job-duration {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--muted);
  }

  .steps-list {
    padding: 0.5rem 0;
  }

  .step-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.375rem 1rem;
  }

  .step-item:hover {
    background: var(--hover-bg, #f9fafb);
  }

  .step-index {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--muted);
    width: 1.5rem;
    text-align: center;
  }

  .step-name {
    flex: 1;
    font-size: 0.875rem;
  }

  .logs-container {
    background: var(--code-bg, #1f2937);
    color: var(--code-fg, #f9fafb);
    padding: 1rem;
    overflow-x: auto;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    line-height: 1.5;
    max-height: 400px;
    overflow-y: auto;
  }
</style>

<script define:vars={{ runId, username, reponame }}>
  // Load logs
  async function loadLogs() {
    const container = document.getElementById('logs-container');
    if (!container) return;

    try {
      const response = await fetch(`/${username}/${reponame}/workflows/runs/${runId}/logs`);
      if (response.ok) {
        const logs = await response.text();
        container.textContent = logs || '(no logs yet)';
      } else {
        container.textContent = '(failed to load logs)';
      }
    } catch (e) {
      container.textContent = '(error loading logs)';
    }
  }

  loadLogs();

  // Cancel button
  const cancelBtn = document.getElementById('cancel-btn');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', async () => {
      if (!confirm('Cancel this workflow run?')) return;

      try {
        const response = await fetch(`/${username}/${reponame}/workflows/runs/${runId}/cancel`, {
          method: 'POST',
        });
        if (response.ok) {
          window.location.reload();
        } else {
          alert('Failed to cancel workflow');
        }
      } catch (e) {
        alert('Error cancelling workflow');
      }
    });
  }

  // Rerun button
  const rerunBtn = document.getElementById('rerun-btn');
  if (rerunBtn) {
    rerunBtn.addEventListener('click', async () => {
      try {
        const response = await fetch(`/${username}/${reponame}/workflows/runs/${runId}/rerun`, {
          method: 'POST',
        });
        if (response.ok) {
          const data = await response.json();
          window.location.href = `/${username}/${reponame}/workflows/${data.run.id}`;
        } else {
          alert('Failed to re-run workflow');
        }
      } catch (e) {
        alert('Error re-running workflow');
      }
    });
  }
</script>
