---
/**
 * Workflow runs list page.
 * Displays all workflow runs for a repository.
 */

import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import WorkflowRunCard from "../../../../components/WorkflowRunCard.astro";
import { sql } from '@plue/db';
import type { User, Repository } from "../../../../lib/types";

const { user: username, repo: reponame } = Astro.params;

if (!username || !reponame) {
  return Astro.redirect('/404');
}

// Get user and repo
const [user] = await sql<User[]>`SELECT * FROM users WHERE username = ${username}`;
if (!user) return Astro.redirect("/404");

const [repo] = await sql<Repository[]>`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
`;
if (!repo) return Astro.redirect("/404");

// Get query params
const statusParam = Astro.url.searchParams.get('status');
const workflowParam = Astro.url.searchParams.get('workflow');
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const perPage = 20;
const offset = (page - 1) * perPage;

// Get workflow definitions
let workflowDefinitions: any[] = [];
try {
  workflowDefinitions = await sql`
    SELECT * FROM workflow_definitions
    WHERE repository_id = ${repo.id}
    ORDER BY name
  `;
} catch (e) {
  console.error('Error fetching workflow definitions:', e);
}

// Get workflow runs with error counts
let runs: any[] = [];
let totalCount = 0;
let workflowErrorCounts: Record<number, number> = {};

try {
  // Calculate error counts for each workflow
  for (const def of workflowDefinitions) {
    const [result] = await sql`
      SELECT COUNT(*) as count FROM workflow_runs
      WHERE workflow_definition_id = ${def.id} AND status = 2
    `;
    workflowErrorCounts[def.id] = result?.count || 0;
  }

  // Status filter mapping
  const statusMap: Record<string, number> = {
    'success': 1,
    'failure': 2,
    'cancelled': 3,
    'waiting': 5,
    'running': 6,
  };

  // Build query based on filters
  let queryConditions = `repository_id = ${repo.id}`;
  if (statusParam && statusMap[statusParam] !== undefined) {
    queryConditions += ` AND status = ${statusMap[statusParam]}`;
  }
  if (workflowParam) {
    const workflowDefId = parseInt(workflowParam);
    if (!isNaN(workflowDefId)) {
      queryConditions += ` AND workflow_definition_id = ${workflowDefId}`;
    }
  }

  runs = await sql`
    SELECT * FROM workflow_runs
    WHERE repository_id = ${repo.id}
    ${statusParam && statusMap[statusParam] !== undefined ? sql`AND status = ${statusMap[statusParam]}` : sql``}
    ${workflowParam && !isNaN(parseInt(workflowParam)) ? sql`AND workflow_definition_id = ${parseInt(workflowParam)}` : sql``}
    ORDER BY created_at DESC
    LIMIT ${perPage} OFFSET ${offset}
  `;

  const [countResult] = await sql`
    SELECT COUNT(*) as count FROM workflow_runs
    WHERE repository_id = ${repo.id}
    ${statusParam && statusMap[statusParam] !== undefined ? sql`AND status = ${statusMap[statusParam]}` : sql``}
    ${workflowParam && !isNaN(parseInt(workflowParam)) ? sql`AND workflow_definition_id = ${parseInt(workflowParam)}` : sql``}
  `;
  totalCount = countResult?.count || 0;
} catch (e) {
  // Table may not exist yet
  console.error('Error fetching workflow runs:', e);
}

// Transform DB rows to expected format
const formattedRuns = runs.map((r: any) => ({
  id: r.id,
  runNumber: r.run_number,
  title: r.title,
  triggerEvent: r.trigger_event,
  status: r.status,
  ref: r.ref,
  commitSha: r.commit_sha,
  createdAt: r.created_at,
  startedAt: r.started_at,
  stoppedAt: r.stopped_at,
}));

const totalPages = Math.ceil(totalCount / perPage);
---

<Layout title={`Workflows · ${username}/${reponame}`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <span class="current">workflows</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`}>Issues</a>
    <a href={`/${username}/${reponame}/landing`}>Landing</a>
    <a href={`/${username}/${reponame}/workflows`} class="active">Workflows</a>
    <a href={`/${username}/${reponame}/bookmarks`}>Bookmarks</a>
  </nav>

  <div class="workflows-header">
    <h1>Workflow Runs</h1>
    <button class="btn btn-primary" id="trigger-btn">
      Run Workflow
    </button>
  </div>

  <div class="workflow-dispatch-modal" id="dispatch-modal" style="display: none;">
    <div class="modal-backdrop" id="modal-backdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>Run Workflow</h2>
        <button class="modal-close" id="modal-close">×</button>
      </div>
      <form id="dispatch-form">
        <div class="form-group">
          <label for="workflow-select">Workflow</label>
          <select id="workflow-select" name="workflow" required>
            <option value="">Select a workflow</option>
            {workflowDefinitions.map((def: any) => (
              <option value={def.id}>{def.name}</option>
            ))}
          </select>
        </div>

        <div class="form-group">
          <label for="ref-input">Branch/Tag</label>
          <input
            type="text"
            id="ref-input"
            name="ref"
            placeholder="main"
            value={repo.default_branch}
          />
        </div>

        <div class="form-group">
          <label for="title-input">Title</label>
          <input
            type="text"
            id="title-input"
            name="title"
            placeholder="Manual workflow run"
            required
          />
        </div>

        <div id="workflow-inputs"></div>

        <div class="modal-actions">
          <button type="button" class="btn" id="cancel-btn">Cancel</button>
          <button type="submit" class="btn btn-primary">Run Workflow</button>
        </div>
      </form>
    </div>
  </div>

  <div class="workflows-layout">
    <aside class="workflow-sidebar">
      <h2>Workflows</h2>
      <div class="workflow-list">
        <a
          href={`/${username}/${reponame}/workflows${statusParam ? `?status=${statusParam}` : ''}`}
          class:list={[{ active: !workflowParam }]}
        >
          All workflows
        </a>
        {workflowDefinitions.map((def: any) => (
          <a
            href={`/${username}/${reponame}/workflows?workflow=${def.id}${statusParam ? `&status=${statusParam}` : ''}`}
            class:list={[{ active: workflowParam === String(def.id) }]}
          >
            {def.name}
            {workflowErrorCounts[def.id] > 0 && (
              <span class="error-badge">{workflowErrorCounts[def.id]}</span>
            )}
          </a>
        ))}
      </div>
    </aside>

    <div class="workflow-content">
      <div class="status-tabs">
        <a href={`/${username}/${reponame}/workflows${workflowParam ? `?workflow=${workflowParam}` : ''}`} class:list={[{ active: !statusParam }]}>
          All
        </a>
        <a href={`/${username}/${reponame}/workflows?status=running${workflowParam ? `&workflow=${workflowParam}` : ''}`} class:list={[{ active: statusParam === 'running' }]}>
          Running
        </a>
        <a href={`/${username}/${reponame}/workflows?status=success${workflowParam ? `&workflow=${workflowParam}` : ''}`} class:list={[{ active: statusParam === 'success' }]}>
          Success
        </a>
        <a href={`/${username}/${reponame}/workflows?status=failure${workflowParam ? `&workflow=${workflowParam}` : ''}`} class:list={[{ active: statusParam === 'failure' }]}>
          Failure
        </a>
        <a href={`/${username}/${reponame}/workflows?status=waiting${workflowParam ? `&workflow=${workflowParam}` : ''}`} class:list={[{ active: statusParam === 'waiting' }]}>
          Waiting
        </a>
      </div>

      <div class="runs-list">
        {formattedRuns.length === 0 ? (
          <div class="empty-state">
            <p>No workflow runs yet.</p>
            <p class="hint">
              Create a workflow file in <code>.plue/workflows/</code> to get started.
            </p>
          </div>
        ) : (
          formattedRuns.map((run) => (
            <WorkflowRunCard run={run} user={username} repo={reponame} />
          ))
        )}
      </div>
    </div>
  </div>

  {totalPages > 1 && (
    <div class="pagination">
      {page > 1 && (
        <a href={`/${username}/${reponame}/workflows?page=${page - 1}${statusParam ? `&status=${statusParam}` : ''}`}>
          Previous
        </a>
      )}
      <span class="page-info">Page {page} of {totalPages}</span>
      {page < totalPages && (
        <a href={`/${username}/${reponame}/workflows?page=${page + 1}${statusParam ? `&status=${statusParam}` : ''}`}>
          Next
        </a>
      )}
    </div>
  )}
</Layout>

<style>
  .workflows-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 24px;
  }

  .workflows-header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
  }

  .workflows-layout {
    display: grid;
    grid-template-columns: 240px 1fr;
    gap: 0;
    min-height: calc(100vh - 300px);
  }

  .workflow-sidebar {
    border-right: 1px solid var(--border);
    padding: 1rem 0;
    background: var(--gray-950);
  }

  .workflow-sidebar h2 {
    padding: 0 1rem 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--gray-400);
  }

  .workflow-list {
    display: flex;
    flex-direction: column;
  }

  .workflow-list a {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    color: var(--gray-400);
    text-decoration: none;
    font-size: 0.875rem;
    transition: all var(--transition-fast);
  }

  .workflow-list a:hover {
    background: var(--hover);
    color: var(--fg);
  }

  .workflow-list a.active {
    background: var(--gray-800);
    color: var(--fg);
    border-left: 2px solid var(--fg);
  }

  .error-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    font-size: 0.75rem;
    font-weight: 600;
    background: var(--error);
    color: white;
    border-radius: 10px;
  }

  .workflow-content {
    padding: 0 24px;
  }

  .status-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }

  .status-tabs a {
    padding: 0.5rem 1rem;
    text-decoration: none;
    color: var(--gray-400);
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all var(--transition-fast);
  }

  .status-tabs a:hover {
    color: var(--fg);
  }

  .status-tabs a.active {
    color: var(--fg);
    border-bottom-color: var(--fg);
  }

  .runs-list {
    margin-top: 1rem;
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
    border: 1px dashed var(--border);
  }

  .empty-state p {
    margin: 0.5rem 0;
  }

  .empty-state .hint {
    color: var(--gray-400);
    font-size: 0.875rem;
  }

  .empty-state code {
    background: var(--gray-800);
    padding: 0.125rem 0.25rem;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin: 2rem 0;
    padding: 0 24px;
  }

  .pagination a {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border);
    text-decoration: none;
  }

  .page-info {
    color: var(--gray-400);
    font-size: 0.875rem;
  }

  .workflow-dispatch-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
  }

  .modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
  }

  .modal-header h2 {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
    text-transform: none;
    letter-spacing: normal;
    color: var(--fg);
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--gray-400);
    cursor: pointer;
    padding: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius);
    transition: all var(--transition-fast);
  }

  .modal-close:hover {
    background: var(--hover);
    color: var(--fg);
  }

  #dispatch-form {
    padding: 1.5rem;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }

  @media (max-width: 768px) {
    .workflows-layout {
      grid-template-columns: 1fr;
    }

    .workflow-sidebar {
      border-right: none;
      border-bottom: 1px solid var(--border);
    }

    .modal-content {
      width: 95%;
      max-height: 90vh;
    }
  }
</style>

<script>
  // Get CSRF token from cookie
  function getCsrfToken(): string | null {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'csrf_token') {
        return value;
      }
    }
    return null;
  }

  // Helper to add CSRF token to fetch options
  function withCsrfToken(options: RequestInit = {}): RequestInit {
    const token = getCsrfToken();
    if (token) {
      return {
        ...options,
        headers: {
          ...options.headers,
          'X-CSRF-Token': token,
        },
      };
    }
    return options;
  }

  const triggerBtn = document.getElementById('trigger-btn');
  const modal = document.getElementById('dispatch-modal');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const modalClose = document.getElementById('modal-close');
  const cancelBtn = document.getElementById('cancel-btn');
  const dispatchForm = document.getElementById('dispatch-form');
  const workflowSelect = document.getElementById('workflow-select') as HTMLSelectElement;

  // Open modal
  if (triggerBtn && modal) {
    triggerBtn.addEventListener('click', () => {
      modal.style.display = 'block';
    });
  }

  // Close modal
  function closeModal() {
    if (modal) {
      modal.style.display = 'none';
    }
  }

  if (modalBackdrop) {
    modalBackdrop.addEventListener('click', closeModal);
  }

  if (modalClose) {
    modalClose.addEventListener('click', closeModal);
  }

  if (cancelBtn) {
    cancelBtn.addEventListener('click', closeModal);
  }

  // Handle workflow selection change (for dynamic inputs in the future)
  if (workflowSelect) {
    workflowSelect.addEventListener('change', () => {
      const workflowInputsDiv = document.getElementById('workflow-inputs');
      if (workflowInputsDiv) {
        // Clear existing inputs
        workflowInputsDiv.innerHTML = '';

        // In the future, fetch workflow definition and render input fields
        // based on the workflow's input schema
      }
    });
  }

  // Handle form submission
  if (dispatchForm) {
    dispatchForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const pathParts = window.location.pathname.split('/').filter(Boolean);
      const user = pathParts[0];
      const repo = pathParts[1];

      const formData = new FormData(dispatchForm as HTMLFormElement);
      const data = {
        workflowId: formData.get('workflow'),
        title: formData.get('title'),
        ref: formData.get('ref'),
        inputs: {} as Record<string, any>,
      };

      // Collect custom inputs
      const inputs = dispatchForm.querySelectorAll('[data-workflow-input]');
      inputs.forEach((input: any) => {
        const name = input.getAttribute('data-workflow-input');
        data.inputs[name] = input.value;
      });

      try {
        // Call the v2 API for workflow execution
        const response = await fetch(`/api/workflows/run`, withCsrfToken({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            workflow_definition_id: parseInt(data.workflowId as string),
            trigger_type: 'manual',
            trigger_payload: {
              ref: data.ref,
              title: data.title,
              inputs: data.inputs,
            },
          }),
        }));

        if (response.ok) {
          closeModal();
          window.location.reload();
        } else {
          const error = await response.json();
          window.toast.error(`Error: ${error.error || 'Failed to trigger workflow'}`);
        }
      } catch (e) {
        window.toast.error('Error triggering workflow');
      }
    });
  }
</script>
