---
import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import FileTree from "../../../../components/FileTree.astro";
import { getRepoStats, getBookmarks } from "../../../../lib/api";
import { getTree } from "../../../../lib/jj";

const { user: username, repo: reponame, path: pathParam } = Astro.params;

if (!username || !reponame) {
  return Astro.redirect('/404');
}

// Validate repository exists
const stats = await getRepoStats(username, reponame).catch(() => null);
if (!stats) return Astro.redirect("/404");

// Get default branch/bookmark
const bookmarksResult = await getBookmarks(username, reponame).catch(() => ({ bookmarks: [] }));
const defaultBranch = bookmarksResult.bookmarks.find(b => b.isDefault)?.name || "main";

const pathParts = pathParam?.split("/") || [];
const branch = pathParts[0] || defaultBranch;
const filePath = pathParts.slice(1).join("/");

const tree = await getTree(username, reponame, branch, filePath);
const breadcrumbParts = filePath ? filePath.split("/") : [];
---

<Layout title={`${filePath || branch} · ${username}/${reponame} · plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}/tree/${branch}`}>{branch}</a>
    {breadcrumbParts.map((part, i) => {
      const partPath = breadcrumbParts.slice(0, i + 1).join("/");
      const isLast = i === breadcrumbParts.length - 1;
      return (
        <>
          <span class="sep">/</span>
          {isLast ? (
            <span class="current">{part}</span>
          ) : (
            <a href={`/${username}/${reponame}/tree/${branch}/${partPath}`}>{part}</a>
          )}
        </>
      );
    })}
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`} class="active">Code</a>
    <a href={`/${username}/${reponame}/issues`}>Issues</a>
    <a href={`/${username}/${reponame}/changes/${branch}`}>Changes</a>
    <a href={`/${username}/${reponame}/bookmarks`}>Bookmarks</a>
  </nav>

  <div class="container">
    <FileTree tree={tree} user={username} repo={reponame} branch={branch} path={filePath} />
  </div>
</Layout>
