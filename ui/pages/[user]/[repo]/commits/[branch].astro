---
import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import { sql } from "../../../../lib/db";
import { getCommits } from "../../../../lib/git";
import type { User, Repository } from "../../../../lib/types";

const { user: username, repo: reponame, branch } = Astro.params;

const [user] = await sql`SELECT * FROM users WHERE username = ${username}` as User[];
if (!user) return Astro.redirect("/404");

const [repo] = await sql`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
` as Repository[];

if (!repo) return Astro.redirect("/404");

const commits = await getCommits(username!, reponame!, branch!, 50);

const [{ count: issueCount }] = await sql`
  SELECT COUNT(*) as count FROM issues WHERE repository_id = ${repo.id} AND state = 'open'
`;

const [{ count: prCount }] = await sql`
  SELECT COUNT(*) as count 
  FROM pull_requests pr
  JOIN issues i ON pr.issue_id = i.id 
  WHERE pr.base_repo_id = ${repo.id} AND i.state = 'open' AND pr.has_merged = false
`;

function formatDate(timestamp: number): string {
  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return "today";
  if (diffDays === 1) return "yesterday";
  if (diffDays < 7) return `${diffDays} days ago`;
  if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;

  return date.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: date.getFullYear() !== now.getFullYear() ? "numeric" : undefined,
  });
}
---

<Layout title={`Commits · ${username}/${reponame} · plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <span class="current">commits</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`}>
      Issues
      {Number(issueCount) > 0 && <span class="badge">{issueCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/pulls`}>
      Pull Requests
      {Number(prCount) > 0 && <span class="badge">{prCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/commits/${branch}`} class="active">Commits</a>
  </nav>

  <div class="container">
    <h1 class="page-title mb-3">
      Commits on <code>{branch}</code>
    </h1>

    {commits.length === 0 ? (
      <div class="empty-state">
        <p>No commits yet</p>
      </div>
    ) : (
      <div class="commit-list">
        {commits.map((commit) => (
          <div class="commit-item">
            <div class="commit-message">
              <div class="msg">{commit.message}</div>
              <div class="commit-meta">
                {commit.authorName} · {formatDate(commit.timestamp)}
              </div>
            </div>
            <code class="commit-hash">{commit.shortHash}</code>
          </div>
        ))}
      </div>
    )}
  </div>
</Layout>