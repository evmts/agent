---
import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import { getRepoStats, getBookmarks } from "../../../../lib/api";

const { user: username, repo: reponame } = Astro.params;

if (!username || !reponame) {
  return Astro.redirect('/404');
}

// Validate repository exists via stats endpoint
const stats = await getRepoStats(username, reponame).catch(() => null);
if (!stats) return Astro.redirect("/404");

// Get bookmarks (replaces branches in jj)
const bookmarksResult = await getBookmarks(username, reponame).catch(() => ({ bookmarks: [] }));
const defaultBranch = bookmarksResult.bookmarks.find(b => b.isDefault)?.name || 'main';
---

<Layout title={`Protection Rules - Settings - ${username}/${reponame} - plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}/settings`}>Settings</a>
    <span class="sep">/</span>
    <span class="current">Protection</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`}>Issues</a>
    <a href={`/${username}/${reponame}/landing`}>Landing</a>
    <a href={`/${username}/${reponame}/workflows`}>Workflows</a>
    <a href={`/${username}/${reponame}/bookmarks`}>Bookmarks</a>
    <a href={`/${username}/${reponame}/changes/${defaultBranch}`}>Changes</a>
    <a href={`/${username}/${reponame}/operations`}>Operations</a>
    <a href={`/${username}/${reponame}/settings`} class="active">Settings</a>
  </nav>

  <div class="container">
    <div class="settings-header">
      <h1 class="page-title">Bookmark Protection Rules</h1>
      <p class="subtitle">Protect bookmarks from direct pushes and require reviews before landing.</p>
    </div>

    <div class="settings-nav">
      <a href={`/${username}/${reponame}/settings`} class="settings-nav-item">General</a>
      <a href={`/${username}/${reponame}/settings/protection`} class="settings-nav-item active">Protection</a>
    </div>

    <div class="content-section">
      <h2>Add Protection Rule</h2>
      <form id="add-rule-form" class="rule-form">
        <div class="form-row">
          <div class="form-group">
            <label for="pattern">Bookmark Pattern</label>
            <input
              type="text"
              id="pattern"
              name="pattern"
              placeholder="main, release/*, feature/*"
              required
            />
            <small class="help-text">
              Enter a bookmark name or pattern. Use * as a wildcard.
            </small>
          </div>
        </div>

        <div class="form-row form-row-inline">
          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                id="require_review"
                name="require_review"
                checked
              />
              <span>Require review before landing</span>
            </label>
          </div>

          <div class="form-group">
            <label for="required_approvals">Required Approvals</label>
            <input
              type="number"
              id="required_approvals"
              name="required_approvals"
              min="0"
              max="10"
              value="1"
            />
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Add Rule</button>
        </div>
      </form>
    </div>

    <div class="content-section">
      <h2>Active Rules</h2>
      <div id="rules-list" class="rules-list">
        <div class="loading">Loading rules...</div>
      </div>
    </div>
  </div>
</Layout>

<script define:vars={{ username, reponame }}>
  // Get CSRF token from cookie
  function getCsrfToken() {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'csrf_token') {
        return value;
      }
    }
    return null;
  }

  // Helper to add CSRF token to fetch options
  function withCsrfToken(options = {}) {
    const token = getCsrfToken();
    if (token) {
      return {
        ...options,
        headers: {
          ...options.headers,
          'X-CSRF-Token': token,
        },
      };
    }
    return options;
  }

  async function loadRules() {
    const listEl = document.getElementById('rules-list');
    try {
      const res = await fetch(`/api/${username}/${reponame}/settings/protection`);
      if (!res.ok) {
        throw new Error('Failed to load rules');
      }
      const data = await res.json();

      if (data.rules.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No protection rules configured. Add one above.</div>';
        return;
      }

      listEl.innerHTML = data.rules.map(rule => `
        <div class="rule-item" data-id="${rule.id}">
          <div class="rule-info">
            <span class="rule-pattern">${escapeHtml(rule.pattern)}</span>
            <div class="rule-details">
              ${rule.requireReview
                ? `<span class="badge">Review Required</span>`
                : '<span class="badge badge-muted">No Review</span>'}
              ${rule.requiredApprovals > 0
                ? `<span class="badge">${rule.requiredApprovals} approval${rule.requiredApprovals > 1 ? 's' : ''}</span>`
                : ''}
            </div>
          </div>
          <button class="btn btn-danger btn-sm delete-rule" data-id="${rule.id}">Delete</button>
        </div>
      `).join('');

      // Add delete handlers
      listEl.querySelectorAll('.delete-rule').forEach(btn => {
        btn.addEventListener('click', () => deleteRule(btn.dataset.id));
      });
    } catch (err) {
      listEl.innerHTML = '<div class="error-state">Failed to load rules. Try refreshing the page.</div>';
      console.error('Error loading rules:', err);
    }
  }

  async function deleteRule(id) {
    if (!confirm('Are you sure you want to delete this protection rule?')) {
      return;
    }

    try {
      const res = await fetch(
        `/api/${username}/${reponame}/settings/protection/${id}`,
        withCsrfToken({ method: 'DELETE' })
      );

      if (!res.ok) {
        const error = await res.json();
        window.toast?.error(`Failed to delete rule: ${error.error}`);
        return;
      }

      window.toast?.success('Protection rule deleted');
      loadRules();
    } catch (err) {
      window.toast?.error('Failed to delete rule');
      console.error('Error deleting rule:', err);
    }
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // Form submission
  document.getElementById('add-rule-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const pattern = formData.get('pattern')?.trim();
    const requireReview = formData.get('require_review') === 'on';
    const requiredApprovals = parseInt(formData.get('required_approvals') || '1', 10);

    if (!pattern) {
      window.toast?.error('Pattern is required');
      return;
    }

    try {
      const res = await fetch(
        `/api/${username}/${reponame}/settings/protection`,
        withCsrfToken({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pattern,
            require_review: requireReview,
            required_approvals: requiredApprovals,
          }),
        })
      );

      if (!res.ok) {
        const error = await res.json();
        window.toast?.error(`Failed to add rule: ${error.error}`);
        return;
      }

      window.toast?.success('Protection rule added');
      e.target.reset();
      document.getElementById('require_review').checked = true;
      document.getElementById('required_approvals').value = '1';
      loadRules();
    } catch (err) {
      window.toast?.error('Failed to add rule');
      console.error('Error adding rule:', err);
    }
  });

  // Load rules on page load
  loadRules();
</script>

<style>
  .settings-header {
    margin-bottom: 24px;
  }

  .settings-header .subtitle {
    color: var(--gray-500);
    font-size: 14px;
    margin-top: 8px;
  }

  .settings-nav {
    display: flex;
    gap: 0;
    margin-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .settings-nav-item {
    padding: 12px 16px;
    color: var(--gray-400);
    text-decoration: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all var(--transition-fast);
  }

  .settings-nav-item:hover {
    color: var(--fg);
  }

  .settings-nav-item.active {
    color: var(--fg);
    border-bottom-color: var(--fg);
  }

  .content-section {
    margin-bottom: 32px;
  }

  .content-section h2 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--fg);
  }

  .rule-form {
    padding: 20px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg);
  }

  .form-row {
    margin-bottom: 16px;
  }

  .form-row:last-child {
    margin-bottom: 0;
  }

  .form-row-inline {
    display: flex;
    gap: 24px;
    align-items: flex-end;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .form-group label {
    font-size: 13px;
    font-weight: 500;
    color: var(--fg);
  }

  .form-group input[type="text"],
  .form-group input[type="number"] {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--gray-900);
    color: var(--fg);
    font-size: 14px;
  }

  .form-group input[type="number"] {
    width: 80px;
  }

  .form-group input:focus {
    outline: none;
    border-color: var(--border-hover);
  }

  .checkbox-group {
    justify-content: flex-end;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 14px;
    color: var(--fg);
  }

  .checkbox-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }

  .help-text {
    font-size: 12px;
    color: var(--gray-500);
  }

  .form-actions {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }

  .rules-list {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .rule-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border-bottom: 1px solid var(--border);
    background: var(--bg);
  }

  .rule-item:last-child {
    border-bottom: none;
  }

  .rule-item:hover {
    background: var(--hover);
  }

  .rule-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .rule-pattern {
    font-family: var(--font-mono);
    font-size: 14px;
    font-weight: 500;
    color: var(--fg);
  }

  .rule-details {
    display: flex;
    gap: 8px;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    font-size: 11px;
    font-weight: 500;
    border-radius: 99px;
    background: var(--gray-800);
    color: var(--gray-300);
  }

  .badge-muted {
    background: var(--gray-900);
    color: var(--gray-500);
  }

  .btn-sm {
    padding: 4px 12px;
    font-size: 12px;
  }

  .loading,
  .empty-state,
  .error-state {
    padding: 32px;
    text-align: center;
    color: var(--gray-500);
    font-size: 14px;
  }

  .error-state {
    color: var(--error);
  }
</style>
