---
import Layout from "../../../../../layouts/Layout.astro";
import Header from "../../../../../components/Header.astro";
import Markdown from "../../../../../components/Markdown.astro";
import { sql } from "../../../../../lib/db";
import type { User, Repository, PullRequest } from "../../../../../lib/types";

const { user: username, repo: reponame, number } = Astro.params;

const [user] = await sql`SELECT * FROM users WHERE username = ${username}` as User[];
if (!user) return Astro.redirect("/404");

const [repo] = await sql`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
` as Repository[];
if (!repo) return Astro.redirect("/404");

const [pr] = await sql`
  SELECT pr.*, i.*, u.username as author_username
  FROM pull_requests pr
  JOIN issues i ON pr.issue_id = i.id
  JOIN users u ON i.author_id = u.id
  WHERE i.repository_id = ${repo.id} AND i.issue_number = ${parseInt(number!, 10)}
` as PullRequest[];

if (!pr) return Astro.redirect("/404");

const reviews = await sql`
  SELECT r.*, u.username as reviewer_username
  FROM reviews r
  JOIN users u ON r.reviewer_id = u.id
  WHERE r.pull_request_id = ${pr.id}
  ORDER BY r.created_at DESC
`;

const canMerge = pr.status === 'mergeable' && !pr.has_merged && pr.state === 'open';
const canReview = pr.state === 'open' && !pr.has_merged;

const [{ issue_count }] = await sql`
  SELECT COUNT(*) as issue_count FROM issues WHERE repository_id = ${repo.id} AND state = 'open'
`;

const [{ pr_count }] = await sql`
  SELECT COUNT(*) as pr_count 
  FROM pull_requests pr_c
  JOIN issues i ON pr_c.issue_id = i.id 
  WHERE pr_c.base_repo_id = ${repo.id} AND i.state = 'open' AND pr_c.has_merged = false
`;

// Parse conflicted files properly
let conflictedFiles: string[] = [];
if (pr.conflicted_files) {
  try {
    // If it's already an array, use it directly
    if (Array.isArray(pr.conflicted_files)) {
      conflictedFiles = pr.conflicted_files;
    } else {
      // If it's a string, try to parse it
      conflictedFiles = typeof pr.conflicted_files === 'string' ? JSON.parse(pr.conflicted_files) : [];
    }
  } catch {
    // If parsing fails, treat as empty array
    conflictedFiles = [];
  }
}
---

<Layout title={`PR #${number} · ${pr.title}`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}/pulls`}>pulls</a>
    <span class="sep">/</span>
    <span class="current">#{number}</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`}>
      Issues
      {Number(issue_count) > 0 && <span class="badge">{issue_count}</span>}
    </a>
    <a href={`/${username}/${reponame}/pulls`} class="active">
      Pull Requests
      {Number(pr_count) > 0 && <span class="badge">{pr_count}</span>}
    </a>
    <a href={`/${username}/${reponame}/commits/${repo.default_branch}`}>Commits</a>
  </nav>

  <div class="container">
    <div class="pr-header">
      <h1 class="pr-title">{pr.title} <span class="pr-number">#{pr.issue_number}</span></h1>
      <div class="pr-branches">
        {pr.head_branch} → {pr.base_branch}
      </div>
      <div class="pr-status-bar">
        <span class:list={["status-badge", pr.has_merged ? "merged" : pr.status]}>
          {pr.has_merged ? "Merged" : pr.status}
        </span>
        {conflictedFiles.length > 0 && (
          <span class="conflict-warning">
            {conflictedFiles.length} conflicted files
          </span>
        )}
      </div>
    </div>

    <div class="pr-body">
      <div class="pr-description">
        <div class="author-info">
          <strong>{pr.author_username}</strong> opened this pull request
        </div>
        <Markdown content={pr.body || "No description provided."} />
      </div>

      <div class="pr-stats">
        <div class="stat">
          <span class="stat-label">Commits:</span>
          <span class="stat-value">{pr.commits_ahead}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Files changed:</span>
          <span class="stat-value">{pr.changed_files}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Additions:</span>
          <span class="stat-value add">+{pr.additions}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Deletions:</span>
          <span class="stat-value del">-{pr.deletions}</span>
        </div>
      </div>
    </div>

    <div class="pr-tabs">
      <a href={`/${username}/${reponame}/pulls/${number}`} class="tab active">Conversation</a>
      <a href={`/${username}/${reponame}/pulls/${number}/files`} class="tab">Files Changed</a>
    </div>

    <div class="reviews-section">
      <h2>Reviews</h2>
      {reviews.length === 0 ? (
        <p class="empty-reviews">No reviews yet</p>
      ) : (
        reviews.map((review: any) => (
          <div class="review-card">
            <div class="review-header">
              <strong>{review.reviewer_username}</strong>
              <span class:list={["review-type", review.type]}>
                {review.type.replace('_', ' ')}
              </span>
            </div>
            {review.content && (
              <div class="review-content">
                <Markdown content={review.content} />
              </div>
            )}
          </div>
        ))
      )}
    </div>

    {canReview && (
      <div class="review-form-section">
        <h3>Add a review</h3>
        <form method="POST" action={`/api/${username}/${reponame}/pulls/${number}/reviews`}>
          <div class="form-group">
            <label for="type">Review type:</label>
            <select name="type" id="type" required>
              <option value="">Select review type</option>
              <option value="comment">Comment</option>
              <option value="approve">Approve</option>
              <option value="request_changes">Request changes</option>
            </select>
          </div>
          <div class="form-group">
            <label for="content">Review comment:</label>
            <textarea
              name="content"
              id="content"
              rows="4"
              placeholder="Leave a comment..."
            ></textarea>
          </div>
          <input type="hidden" name="commit_id" value={pr.head_commit_id || ''} />
          <button type="submit" class="btn btn-primary">Submit review</button>
        </form>
      </div>
    )}

    {conflictedFiles.length > 0 && (
      <div class="conflicts-section">
        <h2>Conflicts</h2>
        <p>This pull request has conflicts in the following files:</p>
        <ul class="conflict-files">
          {conflictedFiles.map((file) => (
            <li><code>{file}</code></li>
          ))}
        </ul>
        <p class="conflict-help">
          These conflicts need to be resolved before the pull request can be merged.
        </p>
      </div>
    )}

    {canMerge && (
      <div class="merge-section">
        <h2>Merge Pull Request</h2>
        <form method="POST" action={`/api/${username}/${reponame}/pulls/${number}/merge`}>
          <div class="form-group">
            <label for="merge_style">Merge Strategy:</label>
            <select name="merge_style" id="merge_style" required>
              <option value="merge">Create a merge commit</option>
              <option value="squash">Squash and merge</option>
              <option value="rebase">Rebase and merge</option>
            </select>
          </div>
          <div class="form-group">
            <label for="merge_message">Commit Message:</label>
            <textarea
              name="merge_message"
              id="merge_message"
              rows="3"
              required
            >Merge pull request #{pr.issue_number} from {pr.head_branch}

{pr.title}</textarea>
          </div>
          <button type="submit" class="btn btn-success">Merge Pull Request</button>
        </form>
      </div>
    )}
  </div>
</Layout>

<style>
  .pr-header {
    margin-bottom: 2rem;
  }

  .pr-title {
    margin-bottom: 0.5rem;
  }

  .pr-number {
    color: #666;
    font-weight: normal;
  }

  .pr-branches {
    font-family: monospace;
    margin-bottom: 0.5rem;
    background: #f9f9f9;
    padding: 0.5rem;
    border: 1px solid black;
    display: inline-block;
  }

  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border: 1px solid black;
    font-size: 0.875rem;
    text-transform: uppercase;
  }

  .status-badge.mergeable {
    background: #d4edda;
  }

  .status-badge.merged {
    background: #6f42c1;
    color: white;
  }

  .status-badge.conflict {
    background: #f8d7da;
  }

  .status-badge.checking {
    background: #fff3cd;
  }

  .status-badge.error {
    background: #f8d7da;
  }

  .status-badge.empty {
    background: #d1ecf1;
  }

  .conflict-warning {
    color: #721c24;
    margin-left: 1rem;
    font-size: 0.875rem;
  }

  .pr-body {
    border: 1px solid black;
    padding: 1rem;
    margin-bottom: 2rem;
  }

  .author-info {
    margin-bottom: 1rem;
    font-size: 0.875rem;
    color: #666;
  }

  .pr-stats {
    display: flex;
    gap: 2rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid black;
  }

  .stat {
    display: flex;
    gap: 0.5rem;
  }

  .stat-label {
    font-weight: bold;
  }

  .stat-value.add {
    color: green;
  }

  .stat-value.del {
    color: red;
  }

  .reviews-section {
    margin: 2rem 0;
  }

  .empty-reviews {
    color: #666;
    font-style: italic;
  }

  .review-card {
    border: 1px solid black;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .review-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }

  .review-type {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    border: 1px solid black;
  }

  .review-type.approve {
    background: #d4edda;
  }

  .review-type.request_changes {
    background: #f8d7da;
  }

  .review-type.comment {
    background: #e2e3e5;
  }

  .review-content {
    margin-top: 0.5rem;
  }

  .review-form-section {
    border: 1px solid black;
    padding: 1rem;
    margin: 2rem 0;
    background: #f9f9f9;
  }

  .review-form-section h3 {
    margin-top: 0;
    margin-bottom: 1rem;
  }

  .conflicts-section {
    border: 1px solid #dc3545;
    padding: 1rem;
    margin: 2rem 0;
    background: #f8d7da;
  }

  .conflict-files {
    margin: 1rem 0;
    list-style: none;
    padding: 0;
  }

  .conflict-files li {
    padding: 0.25rem 0;
  }

  .conflict-help {
    font-size: 0.875rem;
    color: #721c24;
    margin-bottom: 0;
  }

  .merge-section {
    border: 1px solid black;
    padding: 1rem;
    margin-top: 2rem;
    background: #f9f9f9;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 0.25rem;
  }

  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid black;
    font-family: inherit;
  }

  .review-form-section .form-group select,
  .review-form-section .form-group textarea {
    font-family: inherit;
  }

  .merge-section .form-group select,
  .merge-section .form-group textarea {
    font-family: monospace;
  }

  .btn-primary {
    background: #007bff;
    color: white;
    border: 1px solid #007bff;
    padding: 0.5rem 1rem;
    text-decoration: none;
    cursor: pointer;
  }

  .btn-primary:hover {
    background: #0056b3;
    border-color: #0056b3;
  }

  .btn-success {
    background: #28a745;
    color: white;
    border: 1px solid #28a745;
    padding: 0.5rem 1rem;
    text-decoration: none;
    cursor: pointer;
  }

  .btn-success:hover {
    background: #218838;
    border-color: #218838;
  }

  .btn-success:disabled {
    background: #6c757d;
    border-color: #6c757d;
    cursor: not-allowed;
  }
</style>