---
import Layout from "../../../../../../layouts/Layout.astro";
import Header from "../../../../../../components/Header.astro";
import { sql } from "../../../../../../lib/db";
import { compareRefs } from "../../../../../../lib/git";
import type { User, Repository, PullRequest } from "../../../../../../lib/types";

const { user: username, repo: reponame, number } = Astro.params;

const [user] = await sql`SELECT * FROM users WHERE username = ${username}` as User[];
if (!user) return Astro.redirect("/404");

const [repo] = await sql`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
` as Repository[];
if (!repo) return Astro.redirect("/404");

const [pr] = await sql`
  SELECT pr.*, i.title
  FROM pull_requests pr
  JOIN issues i ON pr.issue_id = i.id
  WHERE i.repository_id = ${repo.id} AND i.issue_number = ${parseInt(number!, 10)}
` as PullRequest[];

if (!pr) return Astro.redirect("/404");

const compareInfo = await compareRefs(username, reponame, pr.base_branch, pr.head_branch);

const [{ issue_count }] = await sql`
  SELECT COUNT(*) as issue_count FROM issues WHERE repository_id = ${repo.id} AND state = 'open'
`;

const [{ pr_count }] = await sql`
  SELECT COUNT(*) as pr_count 
  FROM pull_requests pr_c
  JOIN issues i ON pr_c.issue_id = i.id 
  WHERE pr_c.base_repo_id = ${repo.id} AND i.state = 'open' AND pr_c.has_merged = false
`;
---

<Layout title={`Files Â· PR #${number}`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}/pulls/${number}`}>PR #{number}</a>
    <span class="sep">/</span>
    <span class="current">files</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`}>
      Issues
      {Number(issue_count) > 0 && <span class="badge">{issue_count}</span>}
    </a>
    <a href={`/${username}/${reponame}/pulls`} class="active">
      Pull Requests
      {Number(pr_count) > 0 && <span class="badge">{pr_count}</span>}
    </a>
    <a href={`/${username}/${reponame}/commits/${repo.default_branch}`}>Commits</a>
  </nav>

  <div class="container">
    <h1>{pr.title} <span class="pr-number">#{number}</span></h1>

    <div class="pr-tabs">
      <a href={`/${username}/${reponame}/pulls/${number}`} class="tab">Conversation</a>
      <a href={`/${username}/${reponame}/pulls/${number}/files`} class="tab active">Files Changed</a>
    </div>

    <div class="diff-stats">
      <strong>{compareInfo.total_files}</strong> files changed,
      <span class="add">+{compareInfo.total_additions}</span>,
      <span class="del">-{compareInfo.total_deletions}</span>
    </div>

    <div class="files-list">
      {compareInfo.files.map((file) => (
        <div class="file-diff">
          <div class="file-header">
            <span class:list={["file-status", file.status]}>{file.status}</span>
            <span class="file-name">{file.name}</span>
            <span class="file-stats">
              <span class="add">+{file.additions}</span>
              <span class="del">-{file.deletions}</span>
            </span>
          </div>

          {file.isBinary ? (
            <div class="binary-file">Binary file</div>
          ) : (
            <pre class="diff-patch"><code>{file.patch}</code></pre>
          )}
        </div>
      ))}
    </div>
  </div>
</Layout>

<style>
  .pr-number {
    color: #666;
    font-weight: normal;
  }

  .diff-stats {
    margin: 1rem 0;
    padding: 1rem;
    border: 1px solid black;
    background: #f9f9f9;
  }

  .add {
    color: green;
  }

  .del {
    color: red;
  }

  .files-list {
    margin-top: 2rem;
  }

  .file-diff {
    border: 1px solid black;
    margin-bottom: 2rem;
  }

  .file-header {
    background: #f5f5f5;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid black;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .file-status {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    border: 1px solid black;
  }

  .file-status.added {
    background: #d4edda;
  }

  .file-status.modified {
    background: #fff3cd;
  }

  .file-status.deleted {
    background: #f8d7da;
  }

  .file-status.renamed {
    background: #cce5ff;
  }

  .file-name {
    flex: 1;
    font-family: monospace;
    font-weight: bold;
  }

  .file-stats {
    font-family: monospace;
    font-size: 0.875rem;
  }

  .diff-patch {
    padding: 1rem;
    overflow-x: auto;
    font-size: 0.875rem;
    line-height: 1.5;
    background: white;
    margin: 0;
  }

  .binary-file {
    padding: 2rem;
    text-align: center;
    color: #666;
    background: #f9f9f9;
  }

  /* Syntax highlighting for diffs */
  .diff-patch code {
    color: inherit;
  }

  /* Basic diff coloring - this could be enhanced with more sophisticated parsing */
  .diff-patch :global(.line-added) {
    background: #e6ffed;
    color: #24292f;
  }

  .diff-patch :global(.line-removed) {
    background: #ffebe9;
    color: #24292f;
  }
</style>