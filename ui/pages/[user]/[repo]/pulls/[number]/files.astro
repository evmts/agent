---
import Layout from "../../../../../../layouts/Layout.astro";
import Header from "../../../../../../components/Header.astro";
import { sql } from "../../../../../../lib/db";
import { compareRefs } from "../../../../../../lib/git";
import type { User, Repository, PullRequest } from "../../../../../../lib/types";

const { user: username, repo: reponame, number } = Astro.params;

const [user] = await sql`SELECT * FROM users WHERE username = ${username}` as User[];
if (!user) return Astro.redirect("/404");

const [repo] = await sql`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
` as Repository[];
if (!repo) return Astro.redirect("/404");

const [pr] = await sql`
  SELECT pr.*, i.title
  FROM pull_requests pr
  JOIN issues i ON pr.issue_id = i.id
  WHERE i.repository_id = ${repo.id} AND i.issue_number = ${parseInt(number!, 10)}
` as PullRequest[];

if (!pr) return Astro.redirect("/404");

const compareInfo = await compareRefs(username, reponame, pr.base_branch, pr.head_branch);

const [{ issue_count }] = await sql`
  SELECT COUNT(*) as issue_count FROM issues WHERE repository_id = ${repo.id} AND state = 'open'
`;

const [{ pr_count }] = await sql`
  SELECT COUNT(*) as pr_count 
  FROM pull_requests pr_c
  JOIN issues i ON pr_c.issue_id = i.id 
  WHERE pr_c.base_repo_id = ${repo.id} AND i.state = 'open' AND pr_c.has_merged = false
`;

// Function to parse diff into lines with types
function parseDiff(patch: string) {
  const lines = patch.split('\n');
  return lines.map((line, index) => {
    if (line.startsWith('@@')) {
      return { content: line, type: 'hunk' };
    } else if (line.startsWith('+')) {
      return { content: line, type: 'addition' };
    } else if (line.startsWith('-')) {
      return { content: line, type: 'deletion' };
    } else if (line.startsWith('\\')) {
      return { content: line, type: 'meta' };
    } else {
      return { content: line, type: 'context' };
    }
  });
}
---

<Layout title={`Files Â· PR #${number}`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}/pulls/${number}`}>PR #{number}</a>
    <span class="sep">/</span>
    <span class="current">files</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`}>
      Issues
      {Number(issue_count) > 0 && <span class="badge">{issue_count}</span>}
    </a>
    <a href={`/${username}/${reponame}/pulls`} class="active">
      Pull Requests
      {Number(pr_count) > 0 && <span class="badge">{pr_count}</span>}
    </a>
    <a href={`/${username}/${reponame}/commits/${repo.default_branch}`}>Commits</a>
  </nav>

  <div class="container">
    <h1>{pr.title} <span class="pr-number">#{number}</span></h1>

    <div class="pr-tabs">
      <a href={`/${username}/${reponame}/pulls/${number}`} class="tab">Conversation</a>
      <a href={`/${username}/${reponame}/pulls/${number}/files`} class="tab active">Files Changed</a>
    </div>

    <div class="diff-stats">
      <strong>{compareInfo.total_files}</strong> file{compareInfo.total_files === 1 ? '' : 's'} changed,
      <span class="add">+{compareInfo.total_additions}</span>,
      <span class="del">-{compareInfo.total_deletions}</span>
    </div>

    <div class="files-list">
      {compareInfo.files.map((file, fileIndex) => {
        const diffLines = parseDiff(file.patch);
        return (
          <div class="file-diff" id={`file-${fileIndex}`}>
            <div class="file-header">
              <span class:list={["file-status", file.status]}>{file.status}</span>
              <span class="file-name">{file.name}</span>
              <span class="file-stats">
                {file.additions > 0 && <span class="add">+{file.additions}</span>}
                {file.deletions > 0 && <span class="del">-{file.deletions}</span>}
              </span>
            </div>

            {file.isBinary ? (
              <div class="binary-file">Binary file</div>
            ) : file.patch.trim() === '' ? (
              <div class="empty-file">Empty file or no changes</div>
            ) : (
              <div class="diff-content">
                <table class="diff-table">
                  <tbody>
                    {diffLines.map((line, lineIndex) => (
                      <tr class:list={["diff-line", `line-${line.type}`]} key={lineIndex}>
                        <td class="line-number"></td>
                        <td class="line-content">
                          <code class="diff-code">{line.content}</code>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        );
      })}
    </div>

    {compareInfo.files.length === 0 && (
      <div class="no-changes">
        <p>No file changes in this pull request.</p>
      </div>
    )}
  </div>
</Layout>

<style>
  .pr-number {
    color: #666;
    font-weight: normal;
  }

  .diff-stats {
    margin: 1rem 0;
    padding: 1rem;
    border: 1px solid black;
    background: #f9f9f9;
    font-family: monospace;
  }

  .add {
    color: #22863a;
    font-weight: bold;
  }

  .del {
    color: #cb2431;
    font-weight: bold;
  }

  .files-list {
    margin-top: 2rem;
  }

  .file-diff {
    border: 1px solid black;
    margin-bottom: 2rem;
    background: white;
  }

  .file-header {
    background: #f6f8fa;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #d0d7de;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .file-status {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    border: 1px solid black;
    font-weight: bold;
  }

  .file-status.added {
    background: #d4edda;
    color: #155724;
  }

  .file-status.modified {
    background: #fff3cd;
    color: #856404;
  }

  .file-status.deleted {
    background: #f8d7da;
    color: #721c24;
  }

  .file-status.renamed {
    background: #cce5ff;
    color: #0c5ba6;
  }

  .file-name {
    flex: 1;
    font-family: monospace;
    font-weight: bold;
    font-size: 0.875rem;
  }

  .file-stats {
    font-family: monospace;
    font-size: 0.875rem;
    display: flex;
    gap: 0.5rem;
  }

  .binary-file, .empty-file {
    padding: 2rem;
    text-align: center;
    color: #666;
    background: #f9f9f9;
    font-style: italic;
  }

  .diff-content {
    overflow-x: auto;
  }

  .diff-table {
    width: 100%;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 0.75rem;
    line-height: 1.45;
    border-collapse: collapse;
  }

  .diff-line {
    border: none;
  }

  .diff-line.line-addition {
    background-color: #e6ffed;
  }

  .diff-line.line-deletion {
    background-color: #ffebe9;
  }

  .diff-line.line-hunk {
    background-color: #f1f8ff;
  }

  .diff-line.line-meta {
    background-color: #f6f8fa;
    color: #6a737d;
  }

  .diff-line.line-context {
    background-color: white;
  }

  .line-number {
    width: 1%;
    min-width: 50px;
    padding: 0 0.5rem;
    color: #6a737d;
    text-align: right;
    font-size: 0.75rem;
    user-select: none;
    vertical-align: top;
    border-right: 1px solid #e1e4e8;
  }

  .line-content {
    padding: 0 0.5rem;
    vertical-align: top;
    white-space: pre;
    word-wrap: normal;
    overflow-wrap: normal;
  }

  .diff-code {
    font-family: inherit;
    font-size: inherit;
    background: none;
    border: none;
    padding: 0;
    white-space: pre;
  }

  /* Enhanced diff syntax highlighting */
  .line-addition .diff-code {
    color: #22863a;
  }

  .line-deletion .diff-code {
    color: #cb2431;
  }

  .line-hunk .diff-code {
    color: #005cc5;
    font-weight: bold;
  }

  .line-meta .diff-code {
    color: #6a737d;
    font-style: italic;
  }

  .no-changes {
    text-align: center;
    padding: 2rem;
    color: #666;
    border: 1px solid #d0d7de;
    background: #f6f8fa;
  }
</style>