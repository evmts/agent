---
import Layout from "../../../layouts/Layout.astro";
import Header from "../../../components/Header.astro";
import FileTree from "../../../components/FileTree.astro";
import Markdown from "../../../components/Markdown.astro";
import { sql } from "../../../lib/db";
import { getTree, getFileContent, getCloneUrl } from "../../../lib/git";
import type { User, Repository } from "../../../lib/types";

const { user: username, repo: reponame } = Astro.params;

const [user] = await sql`SELECT * FROM users WHERE username = ${username}` as User[];
if (!user) return Astro.redirect("/404");

const [repo] = await sql`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
` as Repository[];

if (!repo) return Astro.redirect("/404");

const defaultBranch = repo.default_branch || "main";
const tree = await getTree(username!, reponame!, defaultBranch);

// Try to get README
let readme = "";
const readmeFile = tree.find(
  (f) => f.name.toLowerCase().startsWith("readme") && f.type === "blob"
);
if (readmeFile) {
  readme = (await getFileContent(username!, reponame!, defaultBranch, readmeFile.name)) || "";
}

const cloneUrl = getCloneUrl(username!, reponame!);

const [{ count: issueCount }] = await sql`
  SELECT COUNT(*) as count FROM issues WHERE repository_id = ${repo.id} AND state = 'open'
`;

const [{ count: prCount }] = await sql`
  SELECT COUNT(*) as count 
  FROM pull_requests pr
  JOIN issues i ON pr.issue_id = i.id 
  WHERE pr.base_repo_id = ${repo.id} AND i.state = 'open' AND pr.has_merged = false
`;
---

<Layout title={`${username}/${reponame} Â· plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <span class="current">{reponame}</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`} class="active">Code</a>
    <a href={`/${username}/${reponame}/issues`}>
      Issues
      {Number(issueCount) > 0 && <span class="badge">{issueCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/pulls`}>
      Pull Requests
      {Number(prCount) > 0 && <span class="badge">{prCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/commits/${defaultBranch}`}>Commits</a>
  </nav>

  <div class="container">
    {repo.description && <p class="description mb-2">{repo.description}</p>}

    <div class="clone-url mb-3">
      <code>{cloneUrl}</code>
      <button class="btn btn-sm" onclick="navigator.clipboard.writeText(this.previousElementSibling.textContent)">
        Copy
      </button>
    </div>

    <FileTree tree={tree} user={username!} repo={reponame!} branch={defaultBranch} />

    {readme && (
      <div class="mt-3">
        <Markdown content={readme} />
      </div>
    )}
  </div>
</Layout>

<style>
  .description {
    font-size: 14px;
  }
</style>