---
import Layout from "../../../layouts/Layout.astro";
import Header from "../../../components/Header.astro";
import FileTree from "../../../components/FileTree.astro";
import Markdown from "../../../components/Markdown.astro";
import TopicBadge from "../../../components/TopicBadge.astro";
import { repositories } from '@plue/db';
import { getTree, getFileContent, getCloneUrl, getDefaultBookmark } from "../../../lib/jj";
import type { Repository } from "../../../lib/types";

const { user: username, repo: reponame } = Astro.params;

if (!username || !reponame) {
  return Astro.redirect('/404');
}

const repo = await repositories.getByOwnerAndName(username, reponame);
if (!repo) return Astro.redirect("/404");

const defaultBookmark = await getDefaultBookmark(username, reponame);
const tree = await getTree(username, reponame, defaultBookmark);

// Try to get README
let readme = "";
const readmeFile = tree.find(
  (f) => f.name.toLowerCase().startsWith("readme") && f.type === "blob"
);
if (readmeFile) {
  readme = (await getFileContent(username, reponame, defaultBookmark, readmeFile.name)) || "";
}

const cloneUrl = getCloneUrl(username, reponame);

const stats = await repositories.getStats(repo.id);
const issueCount = stats.issueCount;
const starCount = stats.starCount;
const landingCount = stats.landingCount;
const workflowStatus = {
  running: stats.workflowRunning,
  failing: stats.workflowFailing
};
---

<Layout title={`${username}/${reponame} ¬∑ plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">‚Ä∫</span>
    <span class="repo-icon">‚ñ™</span>
    <span class="current">{reponame}</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`} class="active">
      <span class="nav-icon">&lt;/&gt;</span>
      Code
    </a>
    <a href={`/${username}/${reponame}/issues`}>
      <span class="nav-icon">‚óã</span>
      Issues
      {Number(issueCount) > 0 && <span class="badge">{issueCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/landing`}>
      <span class="nav-icon">‚Üë</span>
      Landing
      {Number(landingCount) > 0 && <span class="badge">{landingCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/workflows`}>
      <span class="nav-icon">‚ñ∂</span>
      Workflows
      {workflowStatus.running > 0 && <span class="badge badge-running">{workflowStatus.running}</span>}
      {workflowStatus.failing > 0 && <span class="badge badge-error">{workflowStatus.failing}</span>}
    </a>
    <a href={`/${username}/${reponame}/bookmarks`}>
      <span class="nav-icon">‚óá</span>
      Bookmarks
    </a>
    <a href={`/${username}/${reponame}/changes/${defaultBookmark}`}>
      <span class="nav-icon">Œî</span>
      Changes
    </a>
    <a href={`/${username}/${reponame}/contributors`}>
      <span class="nav-icon">‚óà</span>
      Contributors
    </a>
    <a href={`/${username}/${reponame}/operations`}>
      <span class="nav-icon">‚â°</span>
      Operations
    </a>
    <a href={`/${username}/${reponame}/settings`}>
      <span class="nav-icon">‚öô</span>
      Settings
    </a>
  </nav>

  <div class="container">
    <div class="repo-header mb-3">
      <div class="repo-info">
        {repo.description && <p class="description mb-2">{repo.description}</p>}

        <div class="topics-container mb-2">
          <div class="topics">
            {repo.topics && repo.topics.length > 0 ? (
              repo.topics.map((topic) => (
                <TopicBadge topic={topic} />
              ))
            ) : (
              <span class="no-topics">No topics</span>
            )}
          </div>
          <button class="btn-edit-topics" id="edit-topics-btn" title="Edit topics">
            +
          </button>
        </div>
      </div>

      <div class="repo-actions">
        <button id="star-btn" class="btn btn-sm" data-username={username} data-repo={reponame}>
          <span id="star-icon">‚òÜ</span>
          <span id="star-text">Star</span>
          <span id="star-count" class="badge">{starCount}</span>
        </button>

        <div class="watch-dropdown">
          <button id="watch-btn" class="btn btn-sm">
            <span id="watch-icon">üëÅ</span>
            <span id="watch-text">Watch</span>
          </button>
          <div id="watch-menu" class="dropdown-menu">
            <button data-level="all">Watch all activity</button>
            <button data-level="releases">Watch releases only</button>
            <button data-level="ignore">Unwatch</button>
          </div>
        </div>
      </div>
    </div>

    <div class="clone-url-wrapper mb-3">
      <div class="clone-url-container">
        <input
          type="text"
          class="clone-url-input"
          value={cloneUrl}
          readonly
          onclick="this.select()"
        />
        <button
          class="clone-url-btn"
          id="clone-copy-btn"
          onclick="
            navigator.clipboard.writeText(this.previousElementSibling.value);
            const btn = this;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            setTimeout(() => {
              btn.textContent = originalText;
              btn.classList.remove('copied');
            }, 2000);
          "
        >
          Copy
        </button>
      </div>
      <a href="/settings/ssh-keys" class="ssh-key-link">Add SSH key</a>
    </div>

    <FileTree tree={tree} user={username} repo={reponame} branch={defaultBookmark} />

    {readme && (
      <div class="mt-3">
        <Markdown content={readme} />
      </div>
    )}
  </div>

  <!-- Topics Edit Modal -->
  <div class="modal" id="topics-modal" style="display: none;">
    <div class="modal-backdrop" data-close-modal></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Topics</h2>
        <button class="modal-close" data-close-modal>&times;</button>
      </div>
      <form id="topics-form">
        <div class="form-group">
          <label for="topics-input">Topics</label>
          <input
            type="text"
            id="topics-input"
            name="topics"
            placeholder="javascript, react, web (comma separated)"
            value={repo.topics?.join(', ') || ''}
          />
          <small>Enter topics separated by commas</small>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn" data-close-modal>Cancel</button>
          <button type="submit" class="btn btn-primary">Save Topics</button>
        </div>
      </form>
    </div>
  </div>
</Layout>

<style>
  .description {
    font-size: 14px;
  }

  .topics-container {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .topics {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .no-topics {
    font-size: 12px;
    color: var(--gray-500);
    font-style: italic;
  }

  .btn-edit-topics {
    width: 24px;
    height: 24px;
    padding: 0;
    background: var(--gray-800);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--gray-400);
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
    flex-shrink: 0;
  }

  .btn-edit-topics:hover {
    background: var(--gray-700);
    color: var(--fg);
    border-color: var(--border-hover);
  }

  /* Modal styles */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
  }

  .modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    width: 90%;
    max-width: 400px;
    padding: var(--space-5);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
  }

  .modal-header h2 {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
    text-transform: none;
    letter-spacing: normal;
    color: var(--fg);
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 20px;
    color: var(--gray-400);
    cursor: pointer;
    padding: 0;
  }

  .modal-close:hover {
    color: var(--fg);
  }

  .form-group {
    margin-bottom: var(--space-4);
  }

  .form-group label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-300);
    margin-bottom: var(--space-2);
  }

  .form-group input {
    width: 100%;
    padding: var(--space-2) var(--space-3);
    background: var(--gray-900);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--fg);
    font-size: 14px;
    font-family: inherit;
  }

  .form-group input:focus {
    outline: none;
    border-color: var(--border-hover);
  }

  .form-group small {
    display: block;
    margin-top: var(--space-1);
    font-size: 11px;
    color: var(--gray-500);
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-2);
  }

  /* Clone URL Styling */
  .clone-url-wrapper {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .clone-url-container {
    position: relative;
    display: flex;
    align-items: center;
    background: var(--gray-950);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    transition: border-color var(--transition-fast);
    overflow: hidden;
  }

  .clone-url-container:hover {
    border-color: var(--border-hover);
  }

  .clone-url-container:focus-within {
    border-color: var(--gray-400);
  }

  .clone-url-input {
    flex: 1;
    padding: var(--space-3) var(--space-3);
    background: transparent;
    border: none;
    color: var(--gray-300);
    font-family: inherit;
    font-size: 12px;
    outline: none;
    cursor: text;
    user-select: all;
  }

  .clone-url-input:hover {
    border: none;
  }

  .clone-url-input:focus {
    background: transparent;
    border: none;
  }

  .clone-url-btn {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: var(--space-3) var(--space-4);
    background: transparent;
    border: none;
    border-left: 1px solid var(--border);
    color: var(--gray-300);
    font-family: inherit;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
    min-width: 70px;
  }

  .clone-url-btn:hover {
    background: var(--hover);
    color: var(--fg);
  }

  .clone-url-btn:active {
    background: var(--active);
  }

  .clone-url-btn.copied {
    color: var(--success);
  }

  .ssh-key-link {
    font-size: 12px;
    color: var(--gray-400);
    text-decoration: none;
    transition: color var(--transition-fast);
    align-self: flex-start;
  }

  .ssh-key-link:hover {
    color: var(--fg);
    text-decoration: underline;
  }

  .repo-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-4);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--border);
  }

  .repo-info {
    flex: 1;
  }

  .repo-actions {
    display: flex;
    gap: var(--space-2);
    align-items: center;
  }

  .repo-actions .btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .repo-actions .btn #star-icon,
  .repo-actions .btn #watch-icon {
    font-size: 13px;
    line-height: 1;
  }

  .watch-dropdown {
    position: relative;
  }

  .dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: var(--space-1);
    background: var(--bg);
    border: 1px solid var(--border);
    min-width: 200px;
    z-index: 100;
  }

  .dropdown-menu.show {
    display: block;
  }

  .dropdown-menu button {
    display: block;
    width: 100%;
    padding: 0.5rem 1rem;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
  }

  .dropdown-menu button:hover {
    background: var(--bg-secondary);
  }

  #star-btn.starred #star-icon::before {
    content: "‚òÖ";
  }
</style>

<script>
  // Get CSRF token from cookie
  function getCsrfToken(): string | null {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'csrf_token') {
        return value;
      }
    }
    return null;
  }

  // Helper to add CSRF token to fetch options
  function withCsrfToken(options: RequestInit = {}): RequestInit {
    const token = getCsrfToken();
    if (token) {
      return {
        ...options,
        headers: {
          ...options.headers,
          'X-CSRF-Token': token,
        },
      };
    }
    return options;
  }

  // Star functionality
  const starBtn = document.getElementById("star-btn");
  const starIcon = document.getElementById("star-icon");
  const starText = document.getElementById("star-text");
  const starCountEl = document.getElementById("star-count");

  // Watch functionality
  const watchBtn = document.getElementById("watch-btn");
  const watchMenu = document.getElementById("watch-menu");
  const watchText = document.getElementById("watch-text");

  if (starBtn && starIcon && starText && starCountEl) {
    const username = starBtn.dataset.username;
    const repo = starBtn.dataset.repo;

    // Load initial star status
    fetch(`/${username}/${repo}/star/status`)
      .then(res => res.json())
      .then(data => {
        if (data.starred) {
          starBtn.classList.add("starred");
          starIcon.textContent = "‚òÖ";
          starText.textContent = "Unstar";
        }
        if (data.starCount !== undefined) {
          starCountEl.textContent = data.starCount;
        }
      })
      .catch(err => console.error("Failed to load star status:", err));

    // Star/unstar handler
    starBtn.addEventListener("click", async () => {
      const isStarred = starBtn.classList.contains("starred");
      const method = isStarred ? "DELETE" : "POST";

      try {
        const res = await fetch(`/${username}/${repo}/star`, { method });
        const data = await res.json();

        if (res.ok) {
          if (isStarred) {
            starBtn.classList.remove("starred");
            starIcon.textContent = "‚òÜ";
            starText.textContent = "Star";
          } else {
            starBtn.classList.add("starred");
            starIcon.textContent = "‚òÖ";
            starText.textContent = "Unstar";
          }

          if (data.starCount !== undefined) {
            starCountEl.textContent = data.starCount;
          }
        } else if (res.status === 401) {
          window.location.href = "/login";
        }
      } catch (err) {
        console.error("Failed to toggle star:", err);
      }
    });
  }

  // Watch dropdown
  if (watchBtn && watchMenu && watchText) {
    const starBtnEl = watchBtn.closest(".repo-actions")?.querySelector("#star-btn") as HTMLElement | null;
    const username = starBtnEl?.dataset.username;
    const repo = starBtnEl?.dataset.repo;

    // Load initial watch status
    if (username && repo) {
      fetch(`/${username}/${repo}/watch/status`)
        .then(res => res.json())
        .then(data => {
          if (data.watching && watchText) {
            watchText.textContent = data.level === "all" ? "Watching" : "Watching releases";
          }
        })
        .catch(err => console.error("Failed to load watch status:", err));
    }

    // Toggle dropdown
    watchBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      watchMenu.classList.toggle("show");
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", () => {
      watchMenu.classList.remove("show");
    });

    // Handle watch level selection
    watchMenu.querySelectorAll("button").forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        e.stopPropagation();
        const level = (btn as HTMLElement).dataset.level;

        if (level === "ignore") {
          // Unwatch
          try {
            const res = await fetch(`/${username}/${repo}/watch`, withCsrfToken({ method: "DELETE" }));
            if (res.ok && watchText) {
              watchText.textContent = "Watch";
              watchMenu.classList.remove("show");
            } else if (res.status === 401) {
              window.location.href = "/login";
            }
          } catch (err) {
            console.error("Failed to unwatch:", err);
          }
        } else {
          // Watch with level
          try {
            const res = await fetch(`/${username}/${repo}/watch`, withCsrfToken({
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ level }),
            }));

            if (res.ok && watchText) {
              watchText.textContent = level === "all" ? "Watching" : "Watching releases";
              watchMenu.classList.remove("show");
            } else if (res.status === 401) {
              window.location.href = "/login";
            }
          } catch (err) {
            console.error("Failed to watch:", err);
          }
        }
      });
    });
  }

  // Topics editing
  const topicsModal = document.getElementById('topics-modal');
  const editTopicsBtn = document.getElementById('edit-topics-btn');
  const topicsForm = document.getElementById('topics-form');

  // Open modal
  editTopicsBtn?.addEventListener('click', () => {
    if (topicsModal) topicsModal.style.display = 'block';
  });

  // Close modal
  document.querySelectorAll('[data-close-modal]').forEach(el => {
    el.addEventListener('click', () => {
      if (topicsModal) topicsModal.style.display = 'none';
    });
  });

  // Handle topics form submission
  topicsForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const topicsStr = formData.get('topics') as string;

    // Parse comma-separated topics
    const topics = topicsStr
      .split(',')
      .map(t => t.trim().toLowerCase().replace(/\s+/g, '-'))
      .filter(t => t.length > 0);

    // Get repo info from URL
    const pathParts = window.location.pathname.split('/');
    const username = pathParts[1];
    const repo = pathParts[2];

    try {
      const res = await fetch(`/api/${username}/${repo}/topics`, withCsrfToken({
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ topics }),
      }));

      if (res.ok) {
        window.location.reload();
      } else if (res.status === 401) {
        window.location.href = '/login';
      } else {
        const data = await res.json();
        window.toast?.error(data.error || 'Failed to update topics');
      }
    } catch (err) {
      console.error('Failed to update topics:', err);
      window.toast?.error('Failed to update topics');
    }
  });
</script>