---
import Layout from "../../../layouts/Layout.astro";
import Header from "../../../components/Header.astro";
import FileTree from "../../../components/FileTree.astro";
import Markdown from "../../../components/Markdown.astro";
import TopicBadge from "../../../components/TopicBadge.astro";
import { sql } from "../../../lib/db";
import { getTree, getFileContent, getCloneUrl, getDefaultBookmark } from "../../../lib/jj";
import type { User, Repository } from "../../../lib/types";

const { user: username, repo: reponame } = Astro.params;

if (!username || !reponame) {
  return Astro.redirect('/404');
}

const [user] = await sql<User[]>`SELECT * FROM users WHERE username = ${username}`;
if (!user) return Astro.redirect("/404");

const [repo] = await sql<Repository[]>`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
`;

if (!repo) return Astro.redirect("/404");

const defaultBookmark = await getDefaultBookmark(username, reponame);
const tree = await getTree(username, reponame, defaultBookmark);

// Try to get README
let readme = "";
const readmeFile = tree.find(
  (f) => f.name.toLowerCase().startsWith("readme") && f.type === "blob"
);
if (readmeFile) {
  readme = (await getFileContent(username, reponame, defaultBookmark, readmeFile.name)) || "";
}

const cloneUrl = getCloneUrl(username, reponame);

const [{ count: issueCount }] = await sql`
  SELECT COUNT(*) as count FROM issues WHERE repository_id = ${repo.id} AND state = 'open'
`;

// Count pending landing requests
let landingCount = 0;
try {
  const [result] = await sql`
    SELECT COUNT(*) as count
    FROM landing_queue
    WHERE repository_id = ${repo.id} AND status = 'pending'
  `;
  landingCount = result?.count || 0;
} catch {
  // landing_queue table may not exist yet
}

// Get star count
const [{ count: starCount }] = await sql`
  SELECT COUNT(*) as count FROM stars WHERE repository_id = ${repo.id}
`;
---

<Layout title={`${username}/${reponame} ¬∑ plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <span class="current">{reponame}</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`} class="active">Code</a>
    <a href={`/${username}/${reponame}/issues`}>
      Issues
      {Number(issueCount) > 0 && <span class="badge">{issueCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/landing`}>
      Landing
      {Number(landingCount) > 0 && <span class="badge">{landingCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/workflows`}>Workflows</a>
    <a href={`/${username}/${reponame}/bookmarks`}>Bookmarks</a>
    <a href={`/${username}/${reponame}/changes/${defaultBookmark}`}>Changes</a>
    <a href={`/${username}/${reponame}/operations`}>Operations</a>
    <a href={`/${username}/${reponame}/settings`}>Settings</a>
  </nav>

  <div class="container">
    <div class="repo-header mb-3">
      <div class="repo-info">
        {repo.description && <p class="description mb-2">{repo.description}</p>}

        {repo.topics && repo.topics.length > 0 && (
          <div class="topics mb-2">
            {repo.topics.map((topic) => (
              <TopicBadge topic={topic} />
            ))}
          </div>
        )}
      </div>

      <div class="repo-actions">
        <button id="star-btn" class="btn btn-sm" data-username={username} data-repo={reponame}>
          <span id="star-icon">‚òÜ</span>
          <span id="star-text">Star</span>
          <span id="star-count" class="badge">{starCount}</span>
        </button>

        <div class="watch-dropdown">
          <button id="watch-btn" class="btn btn-sm">
            <span id="watch-icon">üëÅ</span>
            <span id="watch-text">Watch</span>
          </button>
          <div id="watch-menu" class="dropdown-menu">
            <button data-level="all">Watch all activity</button>
            <button data-level="releases">Watch releases only</button>
            <button data-level="ignore">Unwatch</button>
          </div>
        </div>
      </div>
    </div>

    <div class="clone-url mb-3">
      <code>{cloneUrl}</code>
      <button class="btn btn-sm" onclick="navigator.clipboard.writeText(this.previousElementSibling.textContent)">
        Copy
      </button>
      <a href="/settings/ssh-keys" class="ssh-key-link">Add SSH key</a>
    </div>

    <FileTree tree={tree} user={username} repo={reponame} branch={defaultBookmark} />

    {readme && (
      <div class="mt-3">
        <Markdown content={readme} />
      </div>
    )}
  </div>
</Layout>

<style>
  .description {
    font-size: 14px;
  }
  .topics {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .ssh-key-link {
    margin-left: 0.5rem;
    font-size: 12px;
    color: var(--link);
  }
  .ssh-key-link:hover {
    text-decoration: underline;
  }
</style>