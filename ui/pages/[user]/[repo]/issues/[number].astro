---
import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import Markdown from "../../../../components/Markdown.astro";
import CommentCard from "../../../../components/CommentCard.astro";
import { sql } from "../../../../lib/db";
import type { User, Repository, Issue, Comment } from "../../../../lib/types";

const { user: username, repo: reponame, number: issueNumber } = Astro.params;

const [user] = await sql`SELECT * FROM users WHERE username = ${username}` as User[];
if (!user) return Astro.redirect("/404");

const [repo] = await sql`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
` as Repository[];

if (!repo) return Astro.redirect("/404");

const [issue] = await sql`
  SELECT i.*, u.username as author_username
  FROM issues i
  JOIN users u ON i.author_id = u.id
  WHERE i.repository_id = ${repo.id} AND i.issue_number = ${issueNumber}
` as Issue[];

if (!issue) return Astro.redirect("/404");

const comments = await sql`
  SELECT c.*, u.username as author_username
  FROM comments c
  JOIN users u ON c.author_id = u.id
  WHERE c.issue_id = ${issue.id}
  ORDER BY c.created_at ASC
` as Comment[];

const users = await sql`SELECT * FROM users ORDER BY username` as User[];

const [{ count: issueCount }] = await sql`
  SELECT COUNT(*) as count FROM issues WHERE repository_id = ${repo.id} AND state = 'open'
`;

const [{ count: prCount }] = await sql`
  SELECT COUNT(*) as count 
  FROM pull_requests pr
  JOIN issues i ON pr.issue_id = i.id 
  WHERE pr.base_repo_id = ${repo.id} AND i.state = 'open' AND pr.has_merged = false
`;

let error = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action") as string;

  if (action === "comment") {
    const authorId = formData.get("author_id") as string;
    const body = (formData.get("body") as string)?.trim();

    if (!authorId || !body) {
      error = "Comment cannot be empty";
    } else {
      await sql`
        INSERT INTO comments (issue_id, author_id, body)
        VALUES (${issue.id}, ${authorId}, ${body})
      `;
      await sql`UPDATE issues SET updated_at = NOW() WHERE id = ${issue.id}`;
      return Astro.redirect(Astro.url.pathname);
    }
  } else if (action === "close") {
    await sql`
      UPDATE issues
      SET state = 'closed', closed_at = NOW(), updated_at = NOW()
      WHERE id = ${issue.id}
    `;
    return Astro.redirect(Astro.url.pathname);
  } else if (action === "reopen") {
    await sql`
      UPDATE issues
      SET state = 'open', closed_at = NULL, updated_at = NOW()
      WHERE id = ${issue.id}
    `;
    return Astro.redirect(Astro.url.pathname);
  }
}

function formatDate(date: Date): string {
  return new Date(date).toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
}
---

<Layout title={`${issue.title} · Issue #${issue.issue_number} · plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}/issues`}>issues</a>
    <span class="sep">/</span>
    <span class="current">#{issue.issue_number}</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`} class="active">
      Issues
      {Number(issueCount) > 0 && <span class="badge">{issueCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/pulls`}>
      Pull Requests
      {Number(prCount) > 0 && <span class="badge">{prCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/commits/${repo.default_branch}`}>Commits</a>
  </nav>

  <div class="container">
    <div class="issue-header mb-3">
      <div class="flex-between mb-1">
        <h1 class="page-title">{issue.title}</h1>
        <span class:list={["issue-state", issue.state]}>{issue.state}</span>
      </div>
      <p class="text-muted text-sm">
        #{issue.issue_number} opened by <strong>{issue.author_username}</strong> on {formatDate(issue.created_at)}
      </p>
    </div>

    {issue.body && (
      <div class="comment">
        <div class="comment-header">
          <strong>{issue.author_username}</strong>
          <span class="time">· opened this issue</span>
        </div>
        <div class="comment-body">
          <Markdown content={issue.body} />
        </div>
      </div>
    )}

    {comments.map((comment) => (
      <CommentCard comment={comment} />
    ))}

    <div class="add-comment mt-3">
      <h2 class="mb-2">Add a comment</h2>

      {error && (
        <div class="error-banner mb-2">
          {error}
        </div>
      )}

      <form method="POST">
        <input type="hidden" name="action" value="comment" />

        <div class="form-group">
          <label for="author_id">Comment as</label>
          <select name="author_id" id="author_id" required>
            {users.map((u) => (
              <option value={u.id}>{u.username}</option>
            ))}
          </select>
        </div>

        <div class="form-group">
          <label for="body">Comment</label>
          <textarea
            name="body"
            id="body"
            required
            placeholder="Leave a comment..."
            style="min-height: 120px;"
          ></textarea>
        </div>

        <div class="flex gap-1">
          <button type="submit" class="btn btn-primary">Comment</button>

          {issue.state === "open" ? (
            <button type="submit" name="action" value="close" class="btn btn-danger">
              Close issue
            </button>
          ) : (
            <button type="submit" name="action" value="reopen" class="btn">
              Reopen issue
            </button>
          )}
        </div>
      </form>
    </div>
  </div>
</Layout>

<style>
  .issue-header {
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }

  .error-banner {
    padding: 12px 16px;
    background: rgba(255, 68, 68, 0.1);
    border: 1px solid rgba(255, 68, 68, 0.3);
    border-radius: var(--radius);
    color: var(--error);
    font-size: 13px;
  }
</style>