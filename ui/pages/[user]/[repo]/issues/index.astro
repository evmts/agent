---
import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import IssueCard from "../../../../components/IssueCard.astro";
import { sql } from "../../../../lib/db";
import { listIssues, getIssueCounts, ensureIssuesRepo } from "../../../../lib/git-issues";
import type { User, Repository } from "../../../../lib/types";

const { user: username, repo: reponame } = Astro.params;
const state = Astro.url.searchParams.get("state") || "open";

if (!username || !reponame) {
  return Astro.redirect('/404');
}

const [user] = await sql<User[]>`SELECT * FROM users WHERE username = ${username}`;
if (!user) return Astro.redirect("/404");

const [repo] = await sql<Repository[]>`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
`;

if (!repo) return Astro.redirect("/404");

// Ensure issues repo exists
await ensureIssuesRepo(username, reponame);

// Get issues from git
const gitIssues = await listIssues(username, reponame, state as "open" | "closed" | "all");
const counts = await getIssueCounts(username, reponame);

// Transform to match expected shape
const issues = gitIssues.map(issue => ({
  ...issue,
  issue_number: issue.number,
  author_username: issue.author.username,
  author_id: issue.author.id,
  repository_id: repo.id,
  created_at: new Date(issue.created_at),
  updated_at: new Date(issue.updated_at),
  closed_at: issue.closed_at ? new Date(issue.closed_at) : null,
}));

// Count pending landing requests
let landingCount = 0;
try {
  const [result] = await sql`
    SELECT COUNT(*) as count
    FROM landing_queue
    WHERE repository_id = ${repo.id} AND status = 'pending'
  `;
  landingCount = result?.count || 0;
} catch {
  // landing_queue table may not exist yet
}
---

<Layout title={`Issues · ${username}/${reponame} · plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <span class="current">issues</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`} class="active">Issues</a>
    <a href={`/${username}/${reponame}/landing`}>
      Landing
      {Number(landingCount) > 0 && <span class="badge">{landingCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/bookmarks`}>Bookmarks</a>
    <a href={`/${username}/${reponame}/changes/${repo.default_branch || 'main'}`}>Changes</a>
  </nav>

  <div class="container">
    <div class="flex-between mb-3">
      <h1 class="page-title">Issues</h1>
      <a href={`/${username}/${reponame}/issues/new`} class="btn btn-primary">New issue</a>
    </div>

    <div class="tabs">
      <a
        href={`/${username}/${reponame}/issues?state=open`}
        class:list={["tab", { active: state === "open" }]}
      >
        {counts.open} Open
      </a>
      <a
        href={`/${username}/${reponame}/issues?state=closed`}
        class:list={["tab", { active: state === "closed" }]}
      >
        {counts.closed} Closed
      </a>
    </div>

    {issues.length === 0 ? (
      <div class="empty-state">
        <p>No {state} issues</p>
        <a href={`/${username}/${reponame}/issues/new`} class="btn mt-2">Create an issue</a>
      </div>
    ) : (
      <div class="issue-list">
        {issues.map((issue) => (
          <IssueCard issue={issue} user={username} repo={reponame} />
        ))}
      </div>
    )}
  </div>
</Layout>
