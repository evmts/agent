---
import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import IssueCard from "../../../../components/IssueCard.astro";
import { getIssues, getRepoStats, getMilestones, getLabels } from "../../../../lib/api";

const { user: username, repo: reponame } = Astro.params;

// Parse filter parameters from URL
const state = Astro.url.searchParams.get("state") || "open";

if (!username || !reponame) {
  return Astro.redirect('/404');
}

// Fetch data from API
const [{ issues, counts }, stats, { milestones: availableMilestones }, { labels: availableLabels }] = await Promise.all([
  getIssues(username, reponame, state as 'open' | 'closed' | 'all'),
  getRepoStats(username, reponame),
  getMilestones(username, reponame, 'open'),
  getLabels(username, reponame),
]);

const landingCount = stats.landingCount;

// Transform issues to match expected shape for IssueCard
const transformedIssues = issues.map(issue => ({
  id: issue.id,
  repository_id: 0, // Not provided by API
  author_id: issue.author.id,
  issue_number: issue.number,
  title: issue.title,
  body: issue.body,
  state: issue.state,
  milestone_id: null,
  created_at: new Date(issue.createdAt),
  updated_at: new Date(issue.updatedAt),
  closed_at: issue.closedAt ? new Date(issue.closedAt) : null,
  author_username: issue.author.username,
  labels: issue.labels,
  due_date: issue.dueDate,
  reactions: issue.reactions,
  assignees: issue.assignees,
  is_pinned: issue.isPinned,
}));

const baseUrl = `/${username}/${reponame}/issues`;
---

<Layout title={`Issues · ${username}/${reponame} · plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <span class="current">issues</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`} class="active">Issues</a>
    <a href={`/${username}/${reponame}/labels`}>Labels</a>
    <a href={`/${username}/${reponame}/landing`}>
      Landing
      {Number(landingCount) > 0 && <span class="badge">{landingCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/bookmarks`}>Bookmarks</a>
    <a href={`/${username}/${reponame}/changes/main`}>Changes</a>
  </nav>

  <div class="container">
    <div class="flex-between mb-3">
      <h1 class="page-title">Issues</h1>
      <a href={`/${username}/${reponame}/issues/new`} class="btn btn-primary">New issue</a>
    </div>

    <div class="tabs">
      <a
        href={`/${username}/${reponame}/issues?state=open`}
        class:list={["tab", { active: state === "open" }]}
      >
        {counts.open} Open
      </a>
      <a
        href={`/${username}/${reponame}/issues?state=closed`}
        class:list={["tab", { active: state === "closed" }]}
      >
        {counts.closed} Closed
      </a>
    </div>

    <div class="issue-results-count">
      Showing {transformedIssues.length} {transformedIssues.length === 1 ? 'issue' : 'issues'}
    </div>

    {transformedIssues.length === 0 ? (
      <div class="empty-state">
        <div class="empty-state-icon">◯</div>
        <div class="empty-state-title">No {state} issues found</div>
        <div class="empty-state-description">
          There are no {state} issues in this repository yet.
        </div>
        <a href={`/${username}/${reponame}/issues/new`} class="btn btn-primary">Create an issue</a>
      </div>
    ) : (
      <div class="issue-list">
        {transformedIssues.map((issue) => (
          <IssueCard issue={issue} user={username} repo={reponame} availableLabels={availableLabels} />
        ))}
      </div>
    )}
  </div>
</Layout>

<style>
  .issue-results-count {
    font-size: 12px;
    color: var(--gray-400);
    margin-bottom: 12px;
    padding-left: 2px;
  }
</style>
