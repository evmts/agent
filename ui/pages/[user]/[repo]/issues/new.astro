---
import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import MarkdownEditor from "../../../../components/MarkdownEditor.astro";
import { sql, saveMentionsForIssue } from "../../../../../db";
import { createIssue, getIssueCounts, ensureIssuesRepo } from "../../../../lib/git-issues";
import type { User, Repository } from "../../../../lib/types";

const { user: username, repo: reponame } = Astro.params;

if (!username || !reponame) {
  return Astro.redirect('/404');
}

const [user] = await sql<User[]>`SELECT * FROM users WHERE username = ${username}`;
if (!user) return Astro.redirect("/404");

const [repo] = await sql<Repository[]>`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
`;

if (!repo) return Astro.redirect("/404");

const users = await sql<User[]>`SELECT * FROM users ORDER BY username`;

// Ensure issues repo exists and get counts
await ensureIssuesRepo(username, reponame);
const counts = await getIssueCounts(username, reponame);

// Count pending landing requests
let landingCount = 0;
try {
  const [result] = await sql`
    SELECT COUNT(*) as count
    FROM landing_queue
    WHERE repository_id = ${repo.id} AND status = 'pending'
  `;
  landingCount = result?.count || 0;
} catch {
  // landing_queue table may not exist yet
}

let error = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const authorId = formData.get("author_id") as string;
  const title = (formData.get("title") as string)?.trim();
  const body = (formData.get("body") as string) || "";

  if (!authorId || !title) {
    error = "Author and title are required";
  } else {
    try {
      // Get author info from DB
      const [author] = await sql<User[]>`SELECT * FROM users WHERE id = ${authorId}`;
      if (!author) {
        error = "Author not found";
      } else {
        // Create issue in git repo
        const issue = await createIssue(username, reponame, {
          title,
          body,
          author: {
            id: parseInt(authorId),
            username: author.username,
          },
        });

        // Save mentions to database for notifications
        try {
          await saveMentionsForIssue(repo.id, issue.number, body);
        } catch (mentionError) {
          console.error("Failed to save mentions:", mentionError);
          // Don't fail the whole request if mentions fail
        }

        return Astro.redirect(`/${username}/${reponame}/issues/${issue.number}`);
      }
    } catch (e) {
      error = (e as Error).message;
    }
  }
}
---

<Layout title={`New Issue · ${username}/${reponame} · plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}/issues`}>issues</a>
    <span class="sep">/</span>
    <span class="current">new</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`} class="active">
      Issues
      {counts.open > 0 && <span class="badge">{counts.open}</span>}
    </a>
    <a href={`/${username}/${reponame}/landing`}>
      Landing
      {Number(landingCount) > 0 && <span class="badge">{landingCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/bookmarks`}>Bookmarks</a>
    <a href={`/${username}/${reponame}/changes/${repo.default_branch || 'main'}`}>Changes</a>
  </nav>

  <div class="container">
    <h1 class="page-title mb-3">New issue</h1>

    {error && (
      <div class="error-banner mb-3">
        {error}
      </div>
    )}

    <form method="POST">
      <div class="form-group">
        <label for="author_id">Author</label>
        <select name="author_id" id="author_id" required>
          {users.map((u) => (
            <option value={u.id}>{u.username}</option>
          ))}
        </select>
      </div>

      <div class="form-group">
        <label for="title">Title</label>
        <input
          type="text"
          name="title"
          id="title"
          required
          placeholder="Issue title"
          autocomplete="off"
        />
      </div>

      <div class="form-group">
        <label for="body">Description <span class="text-muted">(optional, markdown supported)</span></label>
        <MarkdownEditor
          name="body"
          id="body"
          placeholder="Describe the issue..."
          height="300px"
        />
      </div>

      <button type="submit" class="btn btn-primary">Create issue</button>
    </form>
  </div>
</Layout>

<style>
  .error-banner {
    padding: 12px 16px;
    background: rgba(255, 68, 68, 0.1);
    border: 1px solid rgba(255, 68, 68, 0.3);
    border-radius: var(--radius);
    color: var(--error);
    font-size: 13px;
  }
</style>
