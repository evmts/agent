---
/**
 * Repository Watchers Page
 *
 * Lists all users who are watching this repository.
 */
import Layout from "../../../layouts/Layout.astro";
import Header from "../../../components/Header.astro";
import Avatar from "../../../components/Avatar.astro";
import RelativeTime from "../../../components/RelativeTime.astro";
import Pagination from "../../../components/Pagination.astro";
import { getWatchers } from "../../../lib/api";

const { user: username, repo: reponame } = Astro.params;

if (!username || !reponame) {
  return Astro.redirect('/404');
}

// Get watchers from API
const result = await getWatchers(username, reponame).catch(() => null);
if (!result) return Astro.redirect("/404");

const { watchers, total: totalCount } = result;

// Pagination (TODO: Add pagination support to API)
const PAGE_SIZE = 30;
const page = Math.max(1, parseInt(Astro.url.searchParams.get('page') || '1', 10));
const totalPages = Math.ceil(totalCount / PAGE_SIZE);

function getLevelLabel(level: string): string {
  switch (level) {
    case 'all': return 'All activity';
    case 'releases': return 'Releases only';
    case 'issues': return 'Issues only';
    case 'ignore': return 'Ignoring';
    default: return level;
  }
}
---

<Layout title={`Watchers · ${username}/${reponame}`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <span class="current">watchers</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`}>Issues</a>
    <a href={`/${username}/${reponame}/landing`}>Landing</a>
    <a href={`/${username}/${reponame}/bookmarks`}>Bookmarks</a>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1>Watchers</h1>
      <span class="count">{totalCount} {totalCount === 1 ? 'watcher' : 'watchers'}</span>
    </div>

    {watchers.length === 0 ? (
      <div class="empty-state">
        <div class="empty-state-icon">O</div>
        <div class="empty-state-title">No watchers yet</div>
        <div class="empty-state-description">
          Be the first to watch this repository for updates!
        </div>
      </div>
    ) : (
      <>
        <div class="users-grid">
          {watchers.map((watcher) => (
            <a href={`/${watcher.username}`} class="user-card">
              <Avatar user={{ username: watcher.username, avatar_url: null }} size="lg" />
              <div class="user-info">
                <div class="user-name">
                  {watcher.displayName || watcher.username}
                </div>
                <div class="user-username">@{watcher.username}</div>
                {/* TODO: API should return avatar_url and bio */}
                <div class="watch-info">
                  <span class="watch-level">{getLevelLabel(watcher.watchLevel)}</span>
                  <span class="sep">·</span>
                  <span class="watching-since">
                    Since <RelativeTime date={watcher.createdAt} />
                  </span>
                </div>
              </div>
            </a>
          ))}
        </div>

        {totalPages > 1 && (
          <Pagination
            currentPage={page}
            totalPages={totalPages}
            baseUrl={`/${username}/${reponame}/watchers`}
          />
        )}
      </>
    )}
  </div>
</Layout>

<style>
  .page-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .page-header h1 {
    margin: 0;
  }

  .count {
    font-size: 13px;
    color: var(--gray-400);
    background: var(--gray-800);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
  }

  .users-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-3);
  }

  .user-card {
    display: flex;
    gap: var(--space-3);
    padding: var(--space-4);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .user-card:hover {
    border-color: var(--border-hover);
    background: var(--hover);
  }

  .user-info {
    flex: 1;
    min-width: 0;
  }

  .user-name {
    font-size: 14px;
    font-weight: 500;
    color: var(--fg);
  }

  .user-username {
    font-size: 13px;
    color: var(--gray-400);
  }

  .user-bio {
    font-size: 12px;
    color: var(--gray-400);
    margin-top: var(--space-2);
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .watch-info {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: 11px;
    color: var(--gray-500);
    margin-top: var(--space-2);
  }

  .watch-level {
    background: var(--gray-800);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    color: var(--gray-300);
  }

  .sep {
    color: var(--gray-600);
  }
</style>
