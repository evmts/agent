---
/**
 * File Blame Page
 *
 * Shows line-by-line attribution for a file.
 * Displays who last modified each line with change/author info.
 */
import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import BlameView from "../../../../components/BlameView.astro";
import { sql } from "../../../../../db";
import { getBlame } from "../../../../lib/jj";
import type { User, Repository } from "../../../../lib/types";

const { user: username, repo: reponame, path: pathParam } = Astro.params;

if (!username || !reponame || !pathParam) {
  return Astro.redirect('/404');
}

const [user] = await sql<User[]>`SELECT * FROM users WHERE username = ${username}`;
if (!user) return Astro.redirect("/404");

const [repo] = await sql<Repository[]>`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
`;

if (!repo) return Astro.redirect("/404");

// Parse path: first part is the bookmark/change, rest is file path
const pathParts = pathParam.split("/");
const branch = pathParts[0] || repo.default_branch || "main";
const filePath = pathParts.slice(1).join("/");

if (!filePath) {
  return Astro.redirect(`/${username}/${reponame}`);
}

// Get blame information
const blameLines = await getBlame(username, reponame, branch, filePath);

if (blameLines.length === 0) {
  return Astro.redirect("/404");
}

// Build breadcrumb parts
const breadcrumbParts = filePath.split("/");
const filename = breadcrumbParts[breadcrumbParts.length - 1] || "";
const repoUrl = `/${username}/${reponame}`;
---

<Layout title={`Blame: ${filename} · ${username}/${reponame} · plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}/tree/${branch}`}>{branch}</a>
    {breadcrumbParts.map((part, i) => {
      const partPath = breadcrumbParts.slice(0, i + 1).join("/");
      const isLast = i === breadcrumbParts.length - 1;
      return (
        <>
          <span class="sep">/</span>
          {isLast ? (
            <span class="current">{part}</span>
          ) : (
            <a href={`/${username}/${reponame}/tree/${branch}/${partPath}`}>{part}</a>
          )}
        </>
      );
    })}
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`} class="active">Code</a>
    <a href={`/${username}/${reponame}/issues`}>Issues</a>
    <a href={`/${username}/${reponame}/changes/${branch}`}>Changes</a>
    <a href={`/${username}/${reponame}/bookmarks`}>Bookmarks</a>
  </nav>

  <div class="container">
    <div class="file-actions">
      <a href={`/${username}/${reponame}/blob/${branch}/${filePath}`} class="btn-secondary">
        View file
      </a>
      <a href={`/${username}/${reponame}/commits/${branch}/${filePath}`} class="btn-secondary">
        History
      </a>
    </div>
    <BlameView lines={blameLines} filename={filename} repoUrl={repoUrl} />
  </div>
</Layout>

<style>
  .file-actions {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    height: 32px;
    padding: 0 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg);
    color: var(--fg);
    font-family: inherit;
    font-size: 13px;
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
    text-decoration: none;
  }

  .btn-secondary:hover {
    background: var(--gray-900);
    border-color: var(--border-hover);
  }

  .btn-secondary:active {
    transform: scale(0.98);
    background: var(--gray-800);
  }
</style>
