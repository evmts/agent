---
import Layout from "../../../layouts/Layout.astro";
import Header from "../../../components/Header.astro";
import { sql } from "../../../lib/db";
import { getBranchCommit, listBranches } from "../../../lib/git";
import type { User, Repository, Branch } from "../../../lib/types";

const { user: username, repo: reponame } = Astro.params;

const [user] = await sql`SELECT * FROM users WHERE username = ${username}` as User[];
if (!user) return Astro.redirect("/404");

const [repo] = await sql`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
` as Repository[];

if (!repo) return Astro.redirect("/404");

// Get all branch names from git first
const gitBranches = await listBranches(username!, reponame!);

// Get or create branch records in database
const branches: (Branch & { pusher_username?: string })[] = [];

for (const branchName of gitBranches) {
  // Check if branch exists in database
  let [dbBranch] = await sql`
    SELECT b.*, u.username as pusher_username
    FROM branches b
    LEFT JOIN users u ON b.pusher_id = u.id
    WHERE b.repository_id = ${repo.id}
      AND b.name = ${branchName}
      AND b.is_deleted = false
  ` as (Branch & { pusher_username?: string })[];

  if (!dbBranch) {
    // Create missing branch record
    const commitInfo = await getBranchCommit(username!, reponame!, branchName);
    
    [dbBranch] = await sql`
      INSERT INTO branches (
        repository_id, name, commit_id, commit_message,
        commit_time, pusher_id
      )
      VALUES (
        ${repo.id}, ${branchName}, ${commitInfo.hash},
        ${commitInfo.message}, ${new Date(commitInfo.timestamp)},
        ${repo.user_id}
      )
      RETURNING *
    ` as Branch[];
    
    dbBranch.pusher_username = username;
  }

  branches.push(dbBranch);
}

// Sort branches - default branch first, then by updated date
branches.sort((a, b) => {
  if (a.name === repo.default_branch) return -1;
  if (b.name === repo.default_branch) return 1;
  return new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime();
});

const [{ count: issueCount }] = await sql`
  SELECT COUNT(*) as count FROM issues
  WHERE repository_id = ${repo.id} AND state = 'open'
`;
---

<Layout title={`Branches Â· ${username}/${reponame}`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span class="sep">/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span class="sep">/</span>
    <span class="current">branches</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>Code</a>
    <a href={`/${username}/${reponame}/issues`}>
      Issues
      {Number(issueCount) > 0 && <span class="badge">{issueCount}</span>}
    </a>
    <a href={`/${username}/${reponame}/branches`} class="active">Branches</a>
    <a href={`/${username}/${reponame}/commits/${repo.default_branch}`}>Commits</a>
  </nav>

  <div class="container">
    <div class="header-row">
      <h2>{branches.length} branches</h2>
      <button class="btn" data-action="new-branch">New branch</button>
    </div>

    <div class="branch-list">
      {branches.map((branch) => (
        <div class="branch-item">
          <div class="branch-info">
            <div class="branch-name">
              <a href={`/${username}/${reponame}/tree/${branch.name}`}>
                {branch.name}
              </a>
              {branch.name === repo.default_branch && (
                <span class="badge">default</span>
              )}
            </div>
            <div class="branch-meta">
              Updated {new Date(branch.updated_at).toLocaleDateString()} by{" "}
              {branch.pusher_username || "unknown"}
            </div>
            <div class="commit-message">{branch.commit_message || "No commit message"}</div>
          </div>

          <div class="branch-actions">
            {branch.name !== repo.default_branch && (
              <>
                <button
                  class="btn-sm"
                  data-action="rename"
                  data-branch={branch.name}
                >
                  Rename
                </button>
                <button
                  class="btn-sm btn-danger"
                  data-action="delete"
                  data-branch={branch.name}
                >
                  Delete
                </button>
              </>
            )}
          </div>
        </div>
      ))}
    </div>
  </div>

  <!-- New Branch Modal -->
  <dialog id="new-branch-modal">
    <form id="new-branch-form">
      <h3>Create new branch</h3>

      <label>
        Branch name
        <input type="text" name="name" required />
      </label>

      <label>
        Create from
        <select name="from_ref">
          {branches.map((b) => (
            <option value={b.name} selected={b.name === repo.default_branch}>
              {b.name}
            </option>
          ))}
        </select>
      </label>

      <div class="modal-actions">
        <button type="submit" class="btn">Create</button>
        <button type="button" class="btn-secondary" data-action="close-modal">
          Cancel
        </button>
      </div>
    </form>
  </dialog>

  <!-- Rename Branch Modal -->
  <dialog id="rename-branch-modal">
    <form id="rename-branch-form">
      <h3>Rename branch</h3>
      
      <input type="hidden" name="old_name" />

      <label>
        New branch name
        <input type="text" name="new_name" required />
      </label>

      <div class="modal-actions">
        <button type="submit" class="btn">Rename</button>
        <button type="button" class="btn-secondary" data-action="close-modal">
          Cancel
        </button>
      </div>
    </form>
  </dialog>
</Layout>

<style>
  .header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .branch-list {
    border: 2px solid var(--border);
  }

  .branch-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 2px solid var(--border);
  }

  .branch-item:last-child {
    border-bottom: none;
  }

  .branch-info {
    flex: 1;
  }

  .branch-name {
    font-family: var(--font-mono);
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 0.25rem;
  }

  .branch-name a {
    color: var(--text);
    text-decoration: none;
  }

  .branch-name a:hover {
    text-decoration: underline;
  }

  .branch-meta {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
  }

  .commit-message {
    font-size: 14px;
    color: var(--text-muted);
  }

  .branch-actions {
    display: flex;
    gap: 0.5rem;
  }

  dialog {
    border: 2px solid var(--border);
    padding: 2rem;
    max-width: 500px;
    background: var(--background);
  }

  dialog form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .modal-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
  }

  .badge {
    background: var(--primary);
    color: white;
    padding: 0.125rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 12px;
    margin-left: 0.5rem;
  }

  .btn-danger {
    background: #dc2626;
    color: white;
  }

  .btn-danger:hover {
    background: #b91c1c;
  }
</style>

<script>
  const username = window.location.pathname.split('/')[1];
  const reponame = window.location.pathname.split('/')[2];

  // Modal handling
  document.querySelector('[data-action="new-branch"]')?.addEventListener('click', () => {
    document.getElementById('new-branch-modal')?.showModal();
  });

  document.querySelectorAll('[data-action="close-modal"]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      (e.target as HTMLElement).closest('dialog')?.close();
    });
  });

  // Create branch
  document.getElementById('new-branch-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    
    const response = await fetch(`/api/${username}/${reponame}/branches`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: formData.get('name'),
        from_ref: formData.get('from_ref')
      })
    });

    if (response.ok) {
      window.location.reload();
    } else {
      const data = await response.json();
      alert(data.error || 'Failed to create branch');
    }
  });

  // Rename branch
  document.querySelectorAll('[data-action="rename"]').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      const branchName = (e.target as HTMLElement).dataset.branch!;
      const modal = document.getElementById('rename-branch-modal') as HTMLDialogElement;
      const form = modal.querySelector('form') as HTMLFormElement;
      
      form.elements.namedItem('old_name')!.value = branchName;
      form.elements.namedItem('new_name')!.value = branchName;
      
      modal.showModal();
    });
  });

  // Handle rename form submission
  document.getElementById('rename-branch-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const oldName = formData.get('old_name') as string;
    const newName = formData.get('new_name') as string;
    
    const response = await fetch(`/api/${username}/${reponame}/branches/${oldName}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ new_name: newName })
    });

    if (response.ok) {
      window.location.reload();
    } else {
      const data = await response.json();
      alert(data.error || 'Failed to rename branch');
    }
  });

  // Delete branch
  document.querySelectorAll('[data-action="delete"]').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      const branchName = (e.target as HTMLElement).dataset.branch!;
      
      if (!confirm(`Delete branch "${branchName}"?`)) return;

      const response = await fetch(`/api/${username}/${reponame}/branches/${branchName}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        window.location.reload();
      } else {
        const data = await response.json();
        alert(data.error || 'Failed to delete branch');
      }
    });
  });
</script>