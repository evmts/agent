---
/**
 * Avatar component
 * Displays user avatar image or fallback to initials with consistent color
 */

interface Props {
  user: {
    username: string;
    avatar_url?: string | null;
  };
  size?: 'sm' | 'md' | 'lg';
}

const { user, size = 'md' } = Astro.props;

// Generate consistent color from username
function getUserColor(username: string): string {
  let hash = 0;
  for (let i = 0; i < username.length; i++) {
    hash = username.charCodeAt(i) + ((hash << 5) - hash);
  }

  // Generate color from hash
  const colors = [
    '#ef4444', // red
    '#f97316', // orange
    '#f59e0b', // amber
    '#84cc16', // lime
    '#10b981', // emerald
    '#06b6d4', // cyan
    '#3b82f6', // blue
    '#8b5cf6', // violet
    '#ec4899', // pink
    '#6366f1', // indigo
  ];

  return colors[Math.abs(hash) % colors.length];
}

// Get user initials
function getInitials(username: string): string {
  if (!username) return '?';

  // For usernames with multiple words (separated by -, _, or space)
  const parts = username.split(/[-_\s]+/);
  if (parts.length > 1) {
    return (parts[0][0] + parts[1][0]).toUpperCase();
  }

  // Single word - use first two letters
  return username.slice(0, 2).toUpperCase();
}

const color = getUserColor(user.username);
const initials = getInitials(user.username);
const hasAvatar = user.avatar_url;
---

<div class:list={['avatar', size]} title={user.username}>
  {hasAvatar ? (
    <img src={user.avatar_url} alt={user.username} />
  ) : (
    <div class="initials" style={`background: ${color}`}>
      {initials}
    </div>
  )}
</div>

<style>
  .avatar {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    background: var(--gray-800);
  }

  .avatar.sm {
    width: 20px;
    height: 20px;
  }

  .avatar.md {
    width: 32px;
    height: 32px;
  }

  .avatar.lg {
    width: 48px;
    height: 48px;
  }

  .avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .initials {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 500;
    user-select: none;
  }

  .avatar.sm .initials {
    font-size: 10px;
  }

  .avatar.md .initials {
    font-size: 13px;
  }

  .avatar.lg .initials {
    font-size: 18px;
  }
</style>
