---
import type { TreeEntry } from "../lib/types";

interface Props {
  tree: TreeEntry[];
  user: string;
  repo: string;
  branch: string;
  path?: string;
}

const { tree, user, repo, branch, path = "" } = Astro.props;

// Sort: directories first, then files alphabetically
const sorted = [...tree].sort((a, b) => {
  if (a.type === b.type) return a.name.localeCompare(b.name);
  return a.type === "tree" ? -1 : 1;
});

function getUrl(entry: TreeEntry) {
  const basePath = path ? `${path}/${entry.name}` : entry.name;
  if (entry.type === "tree") {
    return `/${user}/${repo}/tree/${branch}/${basePath}`;
  }
  return `/${user}/${repo}/blob/${branch}/${basePath}`;
}

function getIcon(entry: TreeEntry) {
  if (entry.type === "tree") {
    return "â–¶";
  }

  // File type icons based on extension
  const ext = entry.name.split('.').pop()?.toLowerCase();

  // Programming languages
  if (['ts', 'tsx', 'js', 'jsx'].includes(ext || '')) return "â–¡";
  if (['json', 'yaml', 'yml', 'toml'].includes(ext || '')) return "{}";
  if (['md', 'mdx', 'txt'].includes(ext || '')) return "â‰¡";
  if (['css', 'scss', 'sass', 'less'].includes(ext || '')) return "â—";
  if (['html', 'htm', 'astro', 'vue', 'svelte'].includes(ext || '')) return "â—ˆ";
  if (['py', 'rb', 'go', 'rs', 'c', 'cpp', 'h'].includes(ext || '')) return "âŒ˜";
  if (['sql', 'db', 'sqlite'].includes(ext || '')) return "â—Ž";
  if (['sh', 'bash', 'zsh'].includes(ext || '')) return ">";

  // Config and system files
  if (['env', 'gitignore', 'dockerignore', 'eslintrc'].includes(ext || '')) return "âš™";
  if (entry.name.startsWith('.')) return "âš™";
  if (['lock'].includes(ext || '')) return "ðŸ”’";

  // Assets
  if (['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp', 'ico'].includes(ext || '')) return "â—‰";
  if (['mp4', 'webm', 'mov'].includes(ext || '')) return "â–¶";
  if (['mp3', 'wav', 'ogg'].includes(ext || '')) return "â™ª";
  if (['zip', 'tar', 'gz', 'rar', '7z'].includes(ext || '')) return "ðŸ“¦";

  return "Â·";
}

function getFileTypeClass(entry: TreeEntry) {
  if (entry.type === "tree") return "file-type-dir";

  const ext = entry.name.split('.').pop()?.toLowerCase();

  if (['ts', 'tsx', 'js', 'jsx'].includes(ext || '')) return "file-type-code";
  if (['json', 'yaml', 'yml', 'toml'].includes(ext || '')) return "file-type-config";
  if (['md', 'mdx', 'txt'].includes(ext || '')) return "file-type-doc";
  if (['css', 'scss', 'sass', 'less'].includes(ext || '')) return "file-type-style";
  if (['html', 'htm', 'astro', 'vue', 'svelte'].includes(ext || '')) return "file-type-markup";
  if (['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp', 'ico'].includes(ext || '')) return "file-type-image";
  if (entry.name.startsWith('.') || ['env', 'gitignore', 'lock'].includes(ext || '')) return "file-type-config";

  return "file-type-default";
}
---

<div class="file-tree">
  {sorted.length === 0 ? (
    <div class="empty-state compact">
      <div class="empty-state-icon">âˆ…</div>
      <div class="empty-state-title">No files in this directory</div>
      <div class="empty-state-description">
        This directory is empty. Files will appear here once they're added.
      </div>
    </div>
  ) : (
    sorted.map((entry) => (
      <a
        href={getUrl(entry)}
        class:list={[
          "file-tree-item",
          { directory: entry.type === "tree" },
          getFileTypeClass(entry)
        ]}
      >
        <span class="icon">{getIcon(entry)}</span>
        <span class="name">{entry.name}</span>
      </a>
    ))
  )}
</div>
