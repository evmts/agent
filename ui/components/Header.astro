---
import { getUserBySession as dbGetUserBySession } from '../lib/auth-db';

interface Props {
  currentPath?: string;
}

const { currentPath = "/" } = Astro.props;

// Check if user is authenticated - call function directly instead of HTTP fetch
let user = null;
const sessionCookie = Astro.cookies.get('session');

if (sessionCookie) {
  try {
    user = await dbGetUserBySession(sessionCookie.value);
  } catch (error) {
    console.error('Failed to fetch user:', error);
  }
}
---

<header class="site-header">
  <div class="header-left">
    <a href="/" class="logo">plue</a>
    <nav>
      <a href="/" class:list={[{ active: currentPath === "/" }]}>home</a>
      <a href="/explore" class:list={[{ active: currentPath === "/explore" }]}>explore</a>
      <a href="/users" class:list={[{ active: currentPath === "/users" }]}>users</a>
      <a href="/sessions" class:list={[{ active: currentPath === "/sessions" }]}>sessions</a>
      <a href="/new" class:list={[{ active: currentPath === "/new" }]}>new</a>
    </nav>
  </div>

  <div class="header-right">
    {user ? (
      <div class="user-menu">
        <span class="user-greeting">Signed in as <strong>{user.username}</strong></span>
        <a href={`/${user.username}`}>Profile</a>
        <a href="/settings">Settings</a>
        <button id="logout-btn" class="btn-link">Sign out</button>
      </div>
    ) : (
      <div class="auth-links">
        <a href="/login" class="btn btn-primary">Sign in</a>
      </div>
    )}
  </div>
</header>

<style>
  .header-left {
    display: flex;
    align-items: center;
    gap: var(--space-5);
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  .user-menu {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    font-size: 13px;
  }

  .user-greeting {
    color: var(--gray-400);
  }

  .user-greeting strong {
    color: var(--fg);
    font-weight: 500;
  }

  .user-menu a {
    color: var(--gray-400);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .user-menu a:hover {
    color: var(--fg);
  }

  .auth-links {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .link {
    color: var(--gray-400);
    font-size: 13px;
    transition: color var(--transition-fast);
  }

  .link:hover {
    color: var(--fg);
  }

  .btn-link {
    background: none;
    border: none;
    padding: 0;
    color: var(--gray-400);
    cursor: pointer;
    font-family: inherit;
    font-size: inherit;
    transition: color var(--transition-fast);
  }

  .btn-link:hover {
    color: var(--fg);
  }

  @media (max-width: 640px) {
    .user-menu {
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .user-greeting {
      display: none;
    }
  }
</style>

<script>
  import { logout } from '../lib/client-auth';

  const logoutBtn = document.getElementById('logout-btn');

  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      try {
        await logout();
        window.location.href = '/login';
      } catch (error) {
        console.error('Logout failed:', error);
      }
    });
  }
</script>