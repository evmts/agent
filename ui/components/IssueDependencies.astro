---
interface Props {
  issue: {
    issue_number: number;
    blocks?: number[];
    blocked_by?: number[];
  };
  allIssues: Array<{ number: number; title: string; state: 'open' | 'closed' }>;
}

const { issue, allIssues } = Astro.props;
const blocks = issue.blocks || [];
const blockedBy = issue.blocked_by || [];
---

<div class="sidebar-section">
  <h3 class="sidebar-heading">Dependencies</h3>
  <div class="sidebar-content">
    <div class="dependency-group">
      <h4 class="dependency-subheading">Blocks</h4>
      <div id="blocks-list" class="dependency-list">
        {blocks.length === 0 ? (
          <p class="text-muted text-xs" id="no-blocks">No issues blocked</p>
        ) : (
          blocks.map(issueNum => {
            const blockedIssue = allIssues.find(i => i.number === issueNum);
            return blockedIssue ? (
              <div class="dependency-item" data-issue-number={issueNum}>
                <a href={`../${issueNum}`} class="dependency-link">
                  <span class="dependency-number">#{issueNum}</span>
                  <span class={`dependency-title ${blockedIssue.state === 'closed' ? 'closed' : ''}`}>
                    {blockedIssue.title}
                  </span>
                </a>
                <button
                  type="button"
                  class="btn-remove remove-blocks"
                  data-issue-number={issueNum}
                  aria-label="Remove dependency"
                >
                  ×
                </button>
              </div>
            ) : null;
          })
        )}
      </div>
      <details class="dependency-picker">
        <summary class="sidebar-link">Add blocking issue</summary>
        <div class="picker-content">
          <input
            type="number"
            class="dependency-input"
            placeholder="Issue #"
            id="blocks-input"
            min="1"
          />
          <button
            type="button"
            class="btn-add add-blocks"
          >
            Add
          </button>
        </div>
      </details>
    </div>

    <div class="dependency-group">
      <h4 class="dependency-subheading">Blocked By</h4>
      <div id="blocked-by-list" class="dependency-list">
        {blockedBy.length === 0 ? (
          <p class="text-muted text-xs" id="no-blocked-by">Not blocked by any issues</p>
        ) : (
          blockedBy.map(issueNum => {
            const blockingIssue = allIssues.find(i => i.number === issueNum);
            return blockingIssue ? (
              <div class="dependency-item" data-issue-number={issueNum}>
                <a href={`../${issueNum}`} class="dependency-link">
                  <span class="dependency-number">#{issueNum}</span>
                  <span class={`dependency-title ${blockingIssue.state === 'closed' ? 'closed' : ''}`}>
                    {blockingIssue.title}
                  </span>
                </a>
                <button
                  type="button"
                  class="btn-remove remove-blocked-by"
                  data-issue-number={issueNum}
                  aria-label="Remove dependency"
                >
                  ×
                </button>
              </div>
            ) : null;
          })
        )}
      </div>
      <details class="dependency-picker">
        <summary class="sidebar-link">Add blocking issue</summary>
        <div class="picker-content">
          <input
            type="number"
            class="dependency-input"
            placeholder="Issue #"
            id="blocked-by-input"
            min="1"
          />
          <button
            type="button"
            class="btn-add add-blocked-by"
          >
            Add
          </button>
        </div>
      </details>
    </div>
  </div>
</div>

<style>
  .dependency-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
  }

  .dependency-group:last-child {
    margin-bottom: 0;
  }

  .dependency-subheading {
    font-size: 11px;
    font-weight: 600;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0;
  }

  .dependency-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .dependency-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    background: var(--gray-950);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    gap: 8px;
  }

  .dependency-link {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    color: var(--fg);
    font-size: 13px;
    overflow: hidden;
  }

  .dependency-link:hover {
    text-decoration: underline;
  }

  .dependency-number {
    font-weight: 600;
    color: var(--primary);
    flex-shrink: 0;
  }

  .dependency-title {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .dependency-title.closed {
    text-decoration: line-through;
    color: var(--gray-500);
  }

  .dependency-picker {
    margin-top: 4px;
  }

  .dependency-picker summary {
    cursor: pointer;
    list-style: none;
    font-size: 12px;
  }

  .dependency-picker summary::-webkit-details-marker {
    display: none;
  }

  .picker-content {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    align-items: center;
  }

  .dependency-input {
    flex: 1;
    padding: 6px 10px;
    background: var(--gray-950);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--fg);
    font-size: 13px;
    font-family: inherit;
  }

  .dependency-input:focus {
    outline: none;
    border-color: var(--primary);
  }

  .btn-add {
    padding: 6px 12px;
    background: var(--primary);
    border: none;
    border-radius: var(--radius);
    color: #fff;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity var(--transition-fast);
    font-family: inherit;
  }

  .btn-add:hover {
    opacity: 0.9;
  }

  .btn-add:active {
    transform: translateY(1px);
  }
</style>

<script>
  // Get CSRF token from cookie
  function getCsrfToken(): string | null {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'csrf_token') {
        return value;
      }
    }
    return null;
  }

  // Helper to add CSRF token to fetch options
  function withCsrfToken(options: RequestInit = {}): RequestInit {
    const token = getCsrfToken();
    if (token) {
      return {
        ...options,
        headers: {
          ...options.headers,
          'X-CSRF-Token': token,
        },
      };
    }
    return options;
  }

  // Get issue number from URL
  const pathParts = window.location.pathname.split('/');
  const issueNumber = pathParts[pathParts.length - 1];
  const reponame = pathParts[pathParts.length - 3];
  const username = pathParts[pathParts.length - 4];

  // Handle add blocks dependency
  const addBlocksBtn = document.querySelector('.add-blocks');
  if (addBlocksBtn) {
    addBlocksBtn.addEventListener('click', async () => {
      const input = document.getElementById('blocks-input') as HTMLInputElement;
      const blockedIssueNumber = parseInt(input.value, 10);

      if (isNaN(blockedIssueNumber) || blockedIssueNumber < 1) {
        alert('Please enter a valid issue number');
        return;
      }

      try {
        const response = await fetch(`/repos/${username}/${reponame}/issues/${issueNumber}/dependencies`, withCsrfToken({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ blocks: blockedIssueNumber })
        }));

        if (response.ok) {
          window.location.reload();
        } else {
          const error = await response.json();
          alert(error.error || 'Failed to add dependency');
        }
      } catch (error) {
        console.error('Failed to add dependency:', error);
        alert('Failed to add dependency');
      }
    });
  }

  // Handle remove blocks dependency
  document.querySelectorAll('.remove-blocks').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const button = e.currentTarget as HTMLButtonElement;
      const blockedNumber = button.dataset.issueNumber;

      try {
        const response = await fetch(`/repos/${username}/${reponame}/issues/${issueNumber}/dependencies/${blockedNumber}`, withCsrfToken({
          method: 'DELETE'
        }));

        if (response.ok) {
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to remove dependency:', error);
      }
    });
  });

  // Handle add blocked-by dependency
  const addBlockedByBtn = document.querySelector('.add-blocked-by');
  if (addBlockedByBtn) {
    addBlockedByBtn.addEventListener('click', async () => {
      const input = document.getElementById('blocked-by-input') as HTMLInputElement;
      const blockingIssueNumber = parseInt(input.value, 10);

      if (isNaN(blockingIssueNumber) || blockingIssueNumber < 1) {
        alert('Please enter a valid issue number');
        return;
      }

      try {
        // Create the dependency from the other issue's perspective
        const response = await fetch(`/repos/${username}/${reponame}/issues/${blockingIssueNumber}/dependencies`, withCsrfToken({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ blocks: parseInt(issueNumber) })
        }));

        if (response.ok) {
          window.location.reload();
        } else {
          const error = await response.json();
          alert(error.error || 'Failed to add dependency');
        }
      } catch (error) {
        console.error('Failed to add dependency:', error);
        alert('Failed to add dependency');
      }
    });
  }

  // Handle remove blocked-by dependency
  document.querySelectorAll('.remove-blocked-by').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const button = e.currentTarget as HTMLButtonElement;
      const blockingNumber = button.dataset.issueNumber;

      try {
        // Remove the dependency from the other issue's perspective
        const response = await fetch(`/repos/${username}/${reponame}/issues/${blockingNumber}/dependencies/${issueNumber}`, withCsrfToken({
          method: 'DELETE'
        }));

        if (response.ok) {
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to remove dependency:', error);
      }
    });
  });
</script>
