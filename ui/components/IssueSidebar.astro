---
import { formatDateForInput, getDueDateStatus } from "../lib/date-utils";

interface Props {
  issue: {
    id: number;
    issue_number: number;
    state: 'open' | 'closed';
    assignees?: string[];
    labels?: string[];
    milestone?: string | null;
    due_date?: string | null;
    blocks?: number[];
    blocked_by?: number[];
  };
  users: Array<{ id: number; username: string }>;
  availableLabels: Array<{ name: string; color: string; description?: string }>;
  milestones?: Array<{ id: number; title: string; due_date: string | null; state: string }>;
  currentMilestone?: { id: number; title: string; due_date: string | null; state: string } | null;
  allIssues?: Array<{ number: number; title: string; state: 'open' | 'closed' }>;
}

const { issue, users, availableLabels, milestones = [], currentMilestone = null, allIssues = [] } = Astro.props;

// Get assignees and labels from issue
const assignees = issue.assignees || [];
const issueLabels = issue.labels || [];

// Get dependencies
const blocks = issue.blocks || [];
const blockedBy = issue.blocked_by || [];

// Get label details from available labels
const labels = issueLabels.map(labelName =>
  availableLabels.find(l => l.name === labelName)
).filter(Boolean) as Array<{ name: string; color: string; description?: string }>;

const isSubscribed = false;

// Get due date status
const dueDate = issue.due_date || null;
const dueDateStatus = getDueDateStatus(dueDate);

function formatDate(date: string | Date | null): string {
  if (!date) return "";
  return new Date(date).toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
}
---

<aside class="issue-sidebar">
  <div class="sidebar-section">
    <h3 class="sidebar-heading">Assignees</h3>
    <div class="sidebar-content">
      <div id="assignees-list" class="assignee-list">
        {assignees.length === 0 && (
          <p class="text-muted text-xs" id="no-assignees">No one assigned</p>
        )}
        {assignees.map(username => (
          <div class="assignee-item" data-username={username}>
            <span class="assignee-name">{username}</span>
            <button
              type="button"
              class="btn-remove remove-assignee"
              data-username={username}
              aria-label="Remove assignee"
            >
              √ó
            </button>
          </div>
        ))}
      </div>
      <details class="assignee-picker">
        <summary class="sidebar-link">Add assignee</summary>
        <div class="picker-list">
          {users.map(user => (
            <button
              type="button"
              class="picker-item add-assignee"
              data-username={user.username}
              data-disabled={assignees.includes(user.username)}
            >
              {user.username}
            </button>
          ))}
        </div>
      </details>
    </div>
  </div>

  <div class="sidebar-section">
    <h3 class="sidebar-heading">Labels</h3>
    <div class="sidebar-content">
      <div id="labels-list" class="label-list">
        {labels.length === 0 && (
          <p class="text-muted text-xs" id="no-labels">None yet</p>
        )}
        {labels.map(label => (
          <div class="label-item">
            <span class="label-tag" style={`background-color: ${label.color}; color: #fff;`}>
              {label.name}
            </span>
            <button
              type="button"
              class="btn-remove remove-label"
              data-label={label.name}
              aria-label="Remove label"
            >
              √ó
            </button>
          </div>
        ))}
      </div>
      <details class="label-picker">
        <summary class="sidebar-link">Add labels</summary>
        <div class="picker-list">
          {availableLabels.map(label => (
            <button
              type="button"
              class="picker-item add-label"
              data-label={label.name}
              data-color={label.color}
              data-disabled={issueLabels.includes(label.name)}
            >
              <span class="label-preview" style={`background-color: ${label.color};`}></span>
              <span class="label-name">{label.name}</span>
              {label.description && (
                <span class="label-desc">{label.description}</span>
              )}
            </button>
          ))}
        </div>
      </details>
    </div>
  </div>

  <div class="sidebar-section">
    <h3 class="sidebar-heading">Milestone</h3>
    <div class="sidebar-content">
      <div id="milestone-container">
        {!currentMilestone ? (
          <p class="text-muted text-xs" id="no-milestone">No milestone</p>
        ) : (
          <div class="milestone-info" id="current-milestone">
            <div class="milestone-content">
              <span class="milestone-title">{currentMilestone.title}</span>
              {currentMilestone.due_date && (
                <span class="milestone-due text-xs text-muted">Due: {formatDate(currentMilestone.due_date)}</span>
              )}
            </div>
            <button
              type="button"
              class="btn-remove remove-milestone"
              aria-label="Remove milestone"
            >
              √ó
            </button>
          </div>
        )}
      </div>
      <details class="milestone-picker">
        <summary class="sidebar-link">Set milestone</summary>
        <div class="picker-list">
          {milestones.length === 0 ? (
            <p class="text-muted text-xs">No milestones available</p>
          ) : (
            milestones
              .filter(m => m.state === 'open')
              .map(milestone => (
                <button
                  type="button"
                  class="picker-item set-milestone"
                  data-milestone-id={milestone.id}
                  data-milestone-title={milestone.title}
                  data-disabled={currentMilestone?.id === milestone.id}
                >
                  <span class="milestone-name">{milestone.title}</span>
                  {milestone.due_date && (
                    <span class="milestone-due-picker text-xs text-muted">
                      {formatDate(milestone.due_date)}
                    </span>
                  )}
                </button>
              ))
          )}
        </div>
      </details>
    </div>
  </div>

  <div class="sidebar-section">
    <h3 class="sidebar-heading">Due Date</h3>
    <div class="sidebar-content">
      <div id="due-date-container">
        {!dueDate ? (
          <p class="text-muted text-xs" id="no-due-date">No due date</p>
        ) : (
          <div class="due-date-info" id="current-due-date">
            <div class="due-date-content">
              <div class:list={["due-date-display", dueDateStatus?.colorClass]}>
                <span class="due-date-icon">üìÖ</span>
                <div class="due-date-text">
                  <div class="due-date-value">{formatDate(dueDate)}</div>
                  <div class="due-date-relative">{dueDateStatus?.relativeText}</div>
                </div>
              </div>
            </div>
            <button
              type="button"
              class="btn-remove remove-due-date"
              aria-label="Remove due date"
            >
              √ó
            </button>
          </div>
        )}
      </div>
      <div class="due-date-picker" style={dueDate ? 'display: none;' : ''}>
        <form class="due-date-form" id="set-due-date-form">
          <input
            type="date"
            name="due_date"
            id="due-date-input"
            class="date-input"
            value={dueDate ? formatDateForInput(dueDate) : ''}
          />
          <button type="submit" class="btn-icon set-due-date">
            {dueDate ? '‚úèÔ∏è' : '‚ûï'}
          </button>
        </form>
      </div>
      {dueDate && (
        <button type="button" class="sidebar-link edit-due-date" id="edit-due-date-link">
          Edit due date
        </button>
      )}
    </div>
  </div>

  <div class="sidebar-section">
    <h3 class="sidebar-heading">Notifications</h3>
    <div class="sidebar-content">
      <button type="button" class="notification-toggle">
        <span class="notification-icon">{isSubscribed ? 'üîî' : 'üîï'}</span>
        <span class="notification-text">
          {isSubscribed ? 'Unsubscribe' : 'Subscribe'}
        </span>
      </button>
      <p class="text-muted text-xs mt-1">
        {isSubscribed
          ? 'You will receive notifications for this issue.'
          : 'You will not receive notifications for this issue.'}
      </p>
    </div>
  </div>
</aside>

<style>
  .issue-sidebar {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .sidebar-section {
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-section:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .sidebar-heading {
    font-size: 12px;
    font-weight: 500;
    color: var(--gray-400);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    margin-bottom: 12px;
  }

  .sidebar-content {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .sidebar-empty {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .sidebar-link {
    background: none;
    border: none;
    padding: 0;
    color: var(--gray-400);
    font-size: 12px;
    cursor: pointer;
    text-align: left;
    transition: color var(--transition-fast);
    font-family: inherit;
  }

  .sidebar-link:hover {
    color: var(--fg);
    text-decoration: underline;
  }

  /* Assignees */
  .assignee-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .assignee-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 10px;
    background: var(--gray-950);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 13px;
  }

  .assignee-name {
    color: var(--fg);
  }

  .btn-remove {
    background: none;
    border: none;
    color: var(--gray-500);
    font-size: 18px;
    line-height: 1;
    cursor: pointer;
    padding: 0 4px;
    transition: color var(--transition-fast);
    font-family: inherit;
  }

  .btn-remove:hover {
    color: var(--error);
  }

  /* Labels */
  .label-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .label-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }

  .label-tag {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    color: #fff;
    letter-spacing: 0.01em;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  }

  .label-preview {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .label-name {
    flex: 1;
    font-weight: 500;
  }

  .label-desc {
    font-size: 11px;
    color: var(--gray-500);
  }

  /* Label Picker */
  .label-picker {
    margin-top: 8px;
  }

  .label-picker summary {
    cursor: pointer;
    list-style: none;
  }

  .label-picker summary::-webkit-details-marker {
    display: none;
  }

  .label-picker .picker-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Milestone */
  .milestone-info {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--gray-950);
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }

  .milestone-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
  }

  .milestone-title {
    font-size: 13px;
    color: var(--fg);
    font-weight: 500;
  }

  .milestone-due {
    font-size: 11px;
    color: var(--gray-500);
  }

  .milestone-picker {
    margin-top: 8px;
  }

  .milestone-picker summary {
    cursor: pointer;
    list-style: none;
  }

  .milestone-picker summary::-webkit-details-marker {
    display: none;
  }

  .milestone-name {
    flex: 1;
    font-weight: 500;
    text-align: left;
  }

  .milestone-due-picker {
    font-size: 11px;
    color: var(--gray-500);
  }

  /* Notifications */
  .notification-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--gray-950);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--fg);
    font-size: 13px;
    cursor: pointer;
    transition: all var(--transition-fast);
    width: 100%;
    font-family: inherit;
  }

  .notification-toggle:hover {
    background: var(--gray-900);
    border-color: var(--border-hover);
  }

  .notification-icon {
    font-size: 16px;
  }

  .notification-text {
    flex: 1;
    text-align: left;
  }

  /* Assignee Picker */
  .assignee-picker {
    margin-top: 8px;
  }

  .assignee-picker summary {
    cursor: pointer;
    list-style: none;
  }

  .assignee-picker summary::-webkit-details-marker {
    display: none;
  }

  .picker-list {
    margin-top: 8px;
    padding: 8px;
    background: var(--gray-950);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    max-height: 200px;
    overflow-y: auto;
  }

  .picker-item {
    display: block;
    width: 100%;
    padding: 8px 12px;
    background: none;
    border: none;
    color: var(--fg);
    font-size: 13px;
    text-align: left;
    cursor: pointer;
    border-radius: var(--radius);
    transition: background var(--transition-fast);
    font-family: inherit;
  }

  .picker-item:hover:not([data-disabled="true"]) {
    background: var(--gray-900);
  }

  .picker-item[data-disabled="true"] {
    color: var(--gray-600);
    cursor: default;
  }

  /* Due Date */
  .due-date-info {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--gray-950);
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }

  .due-date-content {
    flex: 1;
  }

  .due-date-display {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .due-date-icon {
    font-size: 16px;
    flex-shrink: 0;
  }

  .due-date-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .due-date-value {
    font-size: 13px;
    color: var(--fg);
    font-weight: 500;
  }

  .due-date-relative {
    font-size: 11px;
    font-weight: 500;
  }

  /* Due date color classes */
  .due-future .due-date-relative {
    color: var(--gray-400);
  }

  .due-soon .due-date-relative {
    color: #f59e0b;
  }

  .due-overdue .due-date-relative {
    color: #ef4444;
  }

  .due-date-picker {
    margin-top: 8px;
  }

  .due-date-form {
    display: flex;
    gap: 4px;
  }

  .date-input {
    flex: 1;
    padding: 6px 10px;
    background: var(--gray-950);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--fg);
    font-size: 13px;
    font-family: inherit;
  }

  .date-input:focus {
    outline: none;
    border-color: var(--border-hover);
  }

  .btn-icon {
    padding: 6px 10px;
    background: var(--gray-900);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--fg);
    font-size: 14px;
    cursor: pointer;
    transition: all var(--transition-fast);
    font-family: inherit;
  }

  .btn-icon:hover {
    background: var(--gray-800);
    border-color: var(--border-hover);
  }

  .edit-due-date {
    margin-top: 8px;
  }
</style>

<script>
  // Get issue number from URL
  const pathParts = window.location.pathname.split('/');
  const issueNumber = pathParts[pathParts.length - 1];
  const reponame = pathParts[pathParts.length - 3];
  const username = pathParts[pathParts.length - 4];

  // Handle add assignee
  document.querySelectorAll('.add-assignee').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const button = e.currentTarget as HTMLButtonElement;
      const assigneeUsername = button.dataset.username;

      if (button.dataset.disabled === 'true') return;

      try {
        const response = await fetch(`/repos/${username}/${reponame}/issues/${issueNumber}/assignees`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: assigneeUsername })
        });

        if (response.ok) {
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to add assignee:', error);
      }
    });
  });

  // Handle remove assignee
  document.querySelectorAll('.remove-assignee').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const button = e.currentTarget as HTMLButtonElement;
      const assigneeUsername = button.dataset.username;

      try {
        const response = await fetch(`/repos/${username}/${reponame}/issues/${issueNumber}/assignees/${assigneeUsername}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to remove assignee:', error);
      }
    });
  });

  // Handle add label
  document.querySelectorAll('.add-label').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const button = e.currentTarget as HTMLButtonElement;
      const labelName = button.dataset.label;

      if (button.dataset.disabled === 'true') return;

      try {
        const response = await fetch(`/repos/${username}/${reponame}/issues/${issueNumber}/labels`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ labels: [labelName] })
        });

        if (response.ok) {
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to add label:', error);
      }
    });
  });

  // Handle remove label
  document.querySelectorAll('.remove-label').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const button = e.currentTarget as HTMLButtonElement;
      const labelName = button.dataset.label;

      try {
        const response = await fetch(`/repos/${username}/${reponame}/issues/${issueNumber}/labels/${encodeURIComponent(labelName!)}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to remove label:', error);
      }
    });
  });

  // Handle set milestone
  document.querySelectorAll('.set-milestone').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const button = e.currentTarget as HTMLButtonElement;
      const milestoneId = button.dataset.milestoneId;

      if (button.dataset.disabled === 'true') return;

      try {
        const response = await fetch(`/repos/${username}/${reponame}/issues/${issueNumber}/milestone`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ milestone_id: parseInt(milestoneId!) })
        });

        if (response.ok) {
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to set milestone:', error);
      }
    });
  });

  // Handle remove milestone
  const removeMilestoneBtn = document.querySelector('.remove-milestone');
  if (removeMilestoneBtn) {
    removeMilestoneBtn.addEventListener('click', async () => {
      try {
        const response = await fetch(`/repos/${username}/${reponame}/issues/${issueNumber}/milestone`, {
          method: 'DELETE'
        });

        if (response.ok) {
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to remove milestone:', error);
      }
    });
  }

  // Handle set due date
  const setDueDateForm = document.getElementById('set-due-date-form');
  if (setDueDateForm) {
    setDueDateForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target as HTMLFormElement;
      const dueDateInput = form.querySelector('#due-date-input') as HTMLInputElement;
      const dueDate = dueDateInput.value;

      if (!dueDate) return;

      try {
        const response = await fetch(`/repos/${username}/${reponame}/issues/${issueNumber}/due-date`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ due_date: new Date(dueDate).toISOString() })
        });

        if (response.ok) {
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to set due date:', error);
      }
    });
  }

  // Handle remove due date
  const removeDueDateBtn = document.querySelector('.remove-due-date');
  if (removeDueDateBtn) {
    removeDueDateBtn.addEventListener('click', async () => {
      try {
        const response = await fetch(`/repos/${username}/${reponame}/issues/${issueNumber}/due-date`, {
          method: 'DELETE'
        });

        if (response.ok) {
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to remove due date:', error);
      }
    });
  }

  // Handle edit due date
  const editDueDateLink = document.getElementById('edit-due-date-link');
  const dueDatePicker = document.querySelector('.due-date-picker') as HTMLElement;
  const currentDueDate = document.getElementById('current-due-date') as HTMLElement;

  if (editDueDateLink && dueDatePicker && currentDueDate) {
    editDueDateLink.addEventListener('click', () => {
      dueDatePicker.style.display = 'block';
      currentDueDate.style.display = 'none';
      editDueDateLink.style.display = 'none';
    });
  }
</script>
