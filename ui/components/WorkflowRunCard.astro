---
/**
 * Workflow run card component.
 * Displays a summary card for a workflow run.
 */

import WorkflowStatusBadge from './WorkflowStatusBadge.astro';
import RelativeTime from './RelativeTime.astro';

interface Props {
  run: {
    id: number;
    runNumber: number;
    title: string;
    triggerEvent: string;
    status: number;
    ref?: string;
    commitSha?: string;
    createdAt: string | Date;
    startedAt?: string | Date;
    stoppedAt?: string | Date;
  };
  user: string;
  repo: string;
}

const { run, user, repo } = Astro.props;

// Format duration
function formatDuration(start?: string | Date, end?: string | Date): string {
  if (!start) return '-';
  const startDate = new Date(start);
  const endDate = end ? new Date(end) : new Date();
  const diffMs = endDate.getTime() - startDate.getTime();
  const diffSec = Math.floor(diffMs / 1000);
  const diffMin = Math.floor(diffSec / 60);

  if (diffMin > 0) {
    const sec = diffSec % 60;
    return `${diffMin}m ${sec}s`;
  }
  return `${diffSec}s`;
}

const shortSha = run.commitSha?.slice(0, 7);
---

<a href={`/${user}/${repo}/workflows/${run.id}`} class="run-card">
  <div class="run-header">
    <span class="run-number">#{run.runNumber}</span>
    <WorkflowStatusBadge status={run.status} />
  </div>

  <div class="run-title">{run.title}</div>

  <div class="run-meta">
    <span class="trigger">{run.triggerEvent}</span>
    {run.ref && <span class="ref">{run.ref}</span>}
    {shortSha && <code class="sha">{shortSha}</code>}
  </div>

  <div class="run-timing">
    <span class="created"><RelativeTime date={run.createdAt} /></span>
    <span class="duration">{formatDuration(run.startedAt, run.stoppedAt)}</span>
  </div>
</a>

<style>
  .run-card {
    display: block;
    padding: 1rem;
    border: 1px solid var(--border);
    margin-bottom: 0.5rem;
    text-decoration: none;
    color: inherit;
    transition: background-color 0.1s;
  }

  .run-card:hover {
    background: var(--hover-bg, #f9fafb);
  }

  .run-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .run-number {
    font-family: var(--font-mono);
    font-size: 0.875rem;
    color: var(--muted);
  }

  .run-title {
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  .run-meta {
    display: flex;
    gap: 0.75rem;
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 0.5rem;
  }

  .trigger {
    padding: 0.125rem 0.375rem;
    background: var(--accent-bg, #dbeafe);
    border-radius: 2px;
  }

  .ref {
    padding: 0.125rem 0.375rem;
    background: var(--muted-bg, #f3f4f6);
    border-radius: 2px;
  }

  .sha {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--muted);
  }

  .run-timing {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--muted);
  }

  .duration {
    font-family: var(--font-mono);
  }
</style>
