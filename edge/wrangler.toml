# Plue Edge Worker Configuration
name = "plue-edge"
main = "index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Environment variables (set via wrangler secret or dashboard)
[vars]
ORIGIN_HOST = "origin.internal"
BUILD_VERSION = "dev"

# -----------------------------------------------------------------------------
# Durable Objects
# -----------------------------------------------------------------------------

# Durable Object declarations
[[durable_objects.bindings]]
name = "AUTH_DO"
class_name = "AuthDO"

[[durable_objects.bindings]]
name = "RATE_LIMIT_DO"
class_name = "RateLimitDO"

[[durable_objects.bindings]]
name = "METRICS_DO"
class_name = "MetricsDO"

# Migrations for Durable Objects
# Note: When adding new DO classes, create a new migration tag
[[migrations]]
tag = "v1"
new_classes = ["AuthDO", "RateLimitDO"]

[[migrations]]
tag = "v2"
new_classes = ["MetricsDO"]

# -----------------------------------------------------------------------------
# Environment: Development
# -----------------------------------------------------------------------------

[env.dev]
name = "plue-edge-dev"

[env.dev.vars]
ORIGIN_HOST = "localhost:4321"
BUILD_VERSION = "dev"
JWT_SECRET = "dev-jwt-secret-for-local-development-only"

# Dev uses same DO classes
[[env.dev.durable_objects.bindings]]
name = "AUTH_DO"
class_name = "AuthDO"

[[env.dev.durable_objects.bindings]]
name = "RATE_LIMIT_DO"
class_name = "RateLimitDO"

[[env.dev.durable_objects.bindings]]
name = "METRICS_DO"
class_name = "MetricsDO"

# -----------------------------------------------------------------------------
# Environment: Production
# -----------------------------------------------------------------------------

[env.production]
name = "plue-edge"
routes = [
  { pattern = "plue.dev/*", zone_name = "plue.dev" }
]

# Production DO bindings
[[env.production.durable_objects.bindings]]
name = "AUTH_DO"
class_name = "AuthDO"

[[env.production.durable_objects.bindings]]
name = "RATE_LIMIT_DO"
class_name = "RateLimitDO"

[[env.production.durable_objects.bindings]]
name = "METRICS_DO"
class_name = "MetricsDO"

# BUILD_VERSION is set during deploy via --var flag:
# wrangler deploy --var BUILD_VERSION:$(git rev-parse --short HEAD)
