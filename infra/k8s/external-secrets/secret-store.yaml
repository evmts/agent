# =============================================================================
# ClusterSecretStore - GCP Secret Manager Backend
# =============================================================================
# ClusterSecretStore is a cluster-wide resource that configures how ESO
# connects to external secret backends (in this case, GCP Secret Manager).
#
# How it works:
# 1. ESO controller reads this ClusterSecretStore configuration
# 2. When an ExternalSecret references this store, ESO uses these settings
# 3. ESO authenticates to GCP using Workload Identity (no keys needed)
# 4. ESO fetches secrets from the specified GCP project
#
# Refresh behavior:
# - ESO polls Secret Manager every refreshInterval (default: 1h)
# - If secret value changed, ESO updates the K8s Secret automatically
# - Pods must restart to pick up new values (or use a sidecar reloader)
#
# Security:
# - Uses Workload Identity (no service account keys)
# - ESO service account needs roles/secretmanager.secretAccessor
# - Secrets are encrypted at rest in etcd by GKE

apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: gcpsm-secret-store
  labels:
    app: plue
    managed-by: terraform
spec:
  provider:
    gcpsm:
      # GCP project where secrets are stored
      projectID: "${PROJECT_ID}"

      # Use Workload Identity for authentication (no service account keys)
      auth:
        workloadIdentity:
          clusterLocation: "${CLUSTER_REGION}"
          clusterName: "${CLUSTER_NAME}"
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets

  # Refresh secrets every hour
  refreshInterval: 1h

  # Retry configuration for transient failures
  retrySettings:
    maxRetries: 5
    retryInterval: 10s

---
# =============================================================================
# How to use this ClusterSecretStore
# =============================================================================
# Create an ExternalSecret that references this store:
#
# apiVersion: external-secrets.io/v1beta1
# kind: ExternalSecret
# metadata:
#   name: my-secret
#   namespace: plue
# spec:
#   secretStoreRef:
#     name: gcpsm-secret-store
#     kind: ClusterSecretStore
#   target:
#     name: my-k8s-secret  # Name of K8s Secret to create
#     creationPolicy: Owner
#   refreshInterval: 1h
#   data:
#   - secretKey: MY_ENV_VAR        # Key in K8s Secret
#     remoteRef:
#       key: plue-my-secret        # Secret name in GCP Secret Manager
#       version: latest            # Or specific version number
#
# ESO will:
# 1. Fetch "plue-my-secret" from GCP Secret Manager
# 2. Create a K8s Secret named "my-k8s-secret" in the "plue" namespace
# 3. Put the value in key "MY_ENV_VAR"
# 4. Update every hour if the value changes
