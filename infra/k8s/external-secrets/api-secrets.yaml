# =============================================================================
# ExternalSecret - API Application Secrets
# =============================================================================
# Syncs API secrets (Anthropic API key, JWT secret, session secret) from
# GCP Secret Manager into a Kubernetes Secret for the Plue API server.
#
# How it works:
# 1. ESO watches this ExternalSecret resource
# 2. ESO fetches secrets from GCP Secret Manager via ClusterSecretStore
# 3. ESO creates/updates K8s Secret 'plue-api-secrets' in 'plue' namespace
# 4. API pods mount this secret as environment variables
# 5. ESO refreshes every 1 hour to detect secret changes
#
# Secret rotation:
# - ANTHROPIC_API_KEY: Rotate when key is compromised or periodically
# - JWT_SECRET: Rotating invalidates all active JWTs (forces re-login)
# - SESSION_SECRET: Rotating invalidates all sessions (forces re-login)

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-secrets
  namespace: plue
  labels:
    app: plue
    component: api
    managed-by: terraform
spec:
  # Reference to GCP Secret Manager backend
  secretStoreRef:
    name: gcpsm-secret-store
    kind: ClusterSecretStore

  # Target Kubernetes Secret
  target:
    name: plue-api-secrets
    creationPolicy: Owner  # ESO owns this secret
    deletionPolicy: Retain # Keep secret if ExternalSecret is deleted

  # Refresh secrets every hour
  refreshInterval: 1h

  # Map GCP secrets to K8s Secret keys
  data:
    # ANTHROPIC_API_KEY - Claude API key for AI agent
    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: plue-anthropic-api-key
        version: latest

    # JWT_SECRET - Used to sign JWT tokens for authentication
    - secretKey: JWT_SECRET
      remoteRef:
        key: plue-jwt-secret
        version: latest

    # SESSION_SECRET - Used to encrypt session cookies
    - secretKey: SESSION_SECRET
      remoteRef:
        key: plue-session-secret
        version: latest

---
# =============================================================================
# How to create secrets in GCP Secret Manager
# =============================================================================
# Use gcloud to create the secrets this ExternalSecret references:
#
# # Anthropic API key (add manually - never commit to git)
# gcloud secrets create plue-anthropic-api-key \
#   --replication-policy=automatic \
#   --labels=app=plue,managed-by=manual
# echo -n "sk-ant-api03-..." | gcloud secrets versions add plue-anthropic-api-key --data-file=-
#
# # JWT secret (generate random 64-byte hex string)
# openssl rand -hex 64 | gcloud secrets create plue-jwt-secret \
#   --data-file=- \
#   --replication-policy=automatic \
#   --labels=app=plue,managed-by=terraform
#
# # Session secret (generate random 64-byte hex string)
# openssl rand -hex 64 | gcloud secrets create plue-session-secret \
#   --data-file=- \
#   --replication-policy=automatic \
#   --labels=app=plue,managed-by=terraform
#
# # Grant ESO access to all secrets
# for secret in plue-anthropic-api-key plue-jwt-secret plue-session-secret; do
#   gcloud secrets add-iam-policy-binding $secret \
#     --member="serviceAccount:plue-eso@PROJECT_ID.iam.gserviceaccount.com" \
#     --role="roles/secretmanager.secretAccessor"
# done

---
# =============================================================================
# How to rotate API secrets
# =============================================================================
#
# Rotate ANTHROPIC_API_KEY (safe - no side effects):
# 1. Generate new API key in Anthropic console
# 2. Add new version to Secret Manager:
#    echo -n "sk-ant-api03-NEW-KEY" | gcloud secrets versions add plue-anthropic-api-key --data-file=-
# 3. ESO syncs within 1 hour (or force: kubectl delete secret plue-api-secrets -n plue)
# 4. Rolling restart API pods:
#    kubectl rollout restart deployment/api -n plue
# 5. Verify API works, then disable old key in Anthropic console
#
# Rotate JWT_SECRET (warning: invalidates all JWTs):
# 1. Generate new secret:
#    openssl rand -hex 64 | gcloud secrets versions add plue-jwt-secret --data-file=-
# 2. ESO syncs within 1 hour
# 3. Rolling restart API pods (users will need to re-authenticate)
# 4. Old JWTs become invalid immediately
#
# Rotate SESSION_SECRET (warning: invalidates all sessions):
# 1. Generate new secret:
#    openssl rand -hex 64 | gcloud secrets versions add plue-session-secret --data-file=-
# 2. ESO syncs within 1 hour
# 3. Rolling restart API pods (users will need to re-login)
# 4. Old sessions become invalid immediately
#
# For zero-downtime JWT/Session rotation, deploy a sidecar that:
# - Accepts both old and new secrets during transition period
# - Signs with new secret, validates with both old and new
# - After all tokens expire naturally, remove old secret
