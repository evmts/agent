# =============================================================================
# ExternalSecret - Database Credentials
# =============================================================================
# Syncs database credentials from GCP Secret Manager into a Kubernetes Secret
# that can be mounted by the Plue API server.
#
# How it works:
# 1. ESO watches this ExternalSecret resource
# 2. ESO connects to GCP Secret Manager using the ClusterSecretStore
# 3. ESO fetches the secrets listed in the 'data' section
# 4. ESO creates/updates a K8s Secret named 'plue-database' in 'plue' namespace
# 5. Plue pods mount this secret as environment variables
# 6. ESO refreshes every 1 hour to pick up secret rotation
#
# Secret rotation workflow:
# 1. Update secret value in GCP Secret Manager (manual or automated)
# 2. ESO automatically syncs new value within refreshInterval (1h)
# 3. Restart pods to pick up new values:
#    kubectl rollout restart deployment/api -n plue
# 4. For zero-downtime rotation, use a sidecar like Reloader

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
  namespace: plue
  labels:
    app: plue
    component: database
    managed-by: terraform
spec:
  # Reference to the ClusterSecretStore (GCP Secret Manager backend)
  secretStoreRef:
    name: gcpsm-secret-store
    kind: ClusterSecretStore

  # Name of the Kubernetes Secret to create/update
  target:
    name: plue-database
    creationPolicy: Owner  # ESO owns this secret and will delete it if ExternalSecret is deleted
    deletionPolicy: Retain # Keep K8s Secret if ExternalSecret is deleted (safer)

  # Refresh from Secret Manager every hour
  refreshInterval: 1h

  # Map GCP secrets to K8s Secret keys
  data:
    # DATABASE_URL - Full PostgreSQL connection string
    - secretKey: DATABASE_URL
      remoteRef:
        key: plue-database-url  # Secret name in GCP Secret Manager
        version: latest         # Always use latest version

    # DATABASE_PASSWORD - Database password (if stored separately)
    - secretKey: DATABASE_PASSWORD
      remoteRef:
        key: plue-database-password
        version: latest

---
# =============================================================================
# How to create secrets in GCP Secret Manager
# =============================================================================
# Use gcloud to create the secrets that this ExternalSecret references:
#
# # Create DATABASE_URL secret
# echo -n "postgresql://user:pass@host:5432/plue" | \
#   gcloud secrets create plue-database-url \
#     --data-file=- \
#     --replication-policy=automatic \
#     --labels=app=plue,managed-by=terraform
#
# # Create DATABASE_PASSWORD secret
# echo -n "super-secret-password" | \
#   gcloud secrets create plue-database-password \
#     --data-file=- \
#     --replication-policy=automatic \
#     --labels=app=plue,managed-by=terraform
#
# # Grant ESO service account access
# gcloud secrets add-iam-policy-binding plue-database-url \
#   --member="serviceAccount:plue-eso@PROJECT_ID.iam.gserviceaccount.com" \
#   --role="roles/secretmanager.secretAccessor"
#
# gcloud secrets add-iam-policy-binding plue-database-password \
#   --member="serviceAccount:plue-eso@PROJECT_ID.iam.gserviceaccount.com" \
#   --role="roles/secretmanager.secretAccessor"

---
# =============================================================================
# How to rotate database credentials
# =============================================================================
# 1. Generate new password
# 2. Update database user password in PostgreSQL:
#    ALTER USER plue_user WITH PASSWORD 'new-password';
# 3. Update secret in GCP Secret Manager:
#    echo -n "new-password" | gcloud secrets versions add plue-database-password --data-file=-
# 4. Wait up to 1 hour for ESO to sync (or force sync by deleting the K8s Secret)
# 5. Rolling restart of pods:
#    kubectl rollout restart deployment/api -n plue
# 6. Verify connectivity, then revoke old credentials
