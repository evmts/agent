---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import RepoCard from "../../components/RepoCard.astro";
import { sql } from "../../lib/db";
import type { User, Repository } from "../../lib/types";

const { user: username } = Astro.params;

const [user] = await sql`SELECT * FROM users WHERE username = ${username}` as User[];

if (!user) {
  return Astro.redirect("/404");
}

const repos = await sql`
  SELECT r.*, u.username
  FROM repositories r
  JOIN users u ON r.user_id = u.id
  WHERE r.user_id = ${user.id} AND r.is_public = true
  ORDER BY r.updated_at DESC
` as Repository[];
---

<Layout title={`${user.username} Â· plue`}>
  <Header />
  <div class="container">
    <div class="user-profile mb-3">
      <h1 class="page-title">{user.display_name || user.username}</h1>
      {user.bio && <p class="bio">{user.bio}</p>}
    </div>

    <h2 class="mb-2">Repositories</h2>

    {repos.length === 0 ? (
      <div class="empty-state">
        <p>No repositories yet</p>
      </div>
    ) : (
      <ul class="repo-list">
        {repos.map((repo) => (
          <RepoCard repo={repo} showUser={false} />
        ))}
      </ul>
    )}
  </div>
</Layout>

<style>
  .user-profile {
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .bio {
    margin-top: 8px;
  }
</style>
