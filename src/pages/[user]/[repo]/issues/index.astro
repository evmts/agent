---
import Layout from "../../../../layouts/Layout.astro";
import Header from "../../../../components/Header.astro";
import IssueCard from "../../../../components/IssueCard.astro";
import { sql } from "../../../../lib/db";
import type { User, Repository, Issue } from "../../../../lib/types";

const { user: username, repo: reponame } = Astro.params;
const state = Astro.url.searchParams.get("state") || "open";

const [user] = await sql`SELECT * FROM users WHERE username = ${username}` as User[];
if (!user) return Astro.redirect("/404");

const [repo] = await sql`
  SELECT * FROM repositories
  WHERE user_id = ${user.id} AND name = ${reponame}
` as Repository[];

if (!repo) return Astro.redirect("/404");

const issues = await sql`
  SELECT i.*, u.username as author_username
  FROM issues i
  JOIN users u ON i.author_id = u.id
  WHERE i.repository_id = ${repo.id}
  ${state === "all" ? sql`` : sql`AND i.state = ${state}`}
  ORDER BY i.created_at DESC
` as Issue[];

const [{ open_count }] = await sql`
  SELECT COUNT(*) as open_count FROM issues WHERE repository_id = ${repo.id} AND state = 'open'
`;
const [{ closed_count }] = await sql`
  SELECT COUNT(*) as closed_count FROM issues WHERE repository_id = ${repo.id} AND state = 'closed'
`;
---

<Layout title={`Issues - ${username}/${reponame} - plue`}>
  <Header />

  <div class="breadcrumb">
    <a href={`/${username}`}>{username}</a>
    <span>/</span>
    <a href={`/${username}/${reponame}`}>{reponame}</a>
    <span>/</span>
    <span class="current">issues</span>
  </div>

  <nav class="repo-nav">
    <a href={`/${username}/${reponame}`}>code</a>
    <a href={`/${username}/${reponame}/issues`} class="active">issues ({open_count})</a>
    <a href={`/${username}/${reponame}/commits/${repo.default_branch}`}>commits</a>
  </nav>

  <div class="container">
    <div class="flex-between mb-2">
      <h1>issues</h1>
      <a href={`/${username}/${reponame}/issues/new`} class="btn">+ new issue</a>
    </div>

    <div class="flex gap-2 mb-2">
      <a
        href={`/${username}/${reponame}/issues?state=open`}
        class:list={[{ active: state === "open" }]}
        style={state === "open" ? "color: var(--fg)" : "color: var(--gray)"}
      >
        {open_count} open
      </a>
      <a
        href={`/${username}/${reponame}/issues?state=closed`}
        class:list={[{ active: state === "closed" }]}
        style={state === "closed" ? "color: var(--fg)" : "color: var(--gray)"}
      >
        {closed_count} closed
      </a>
    </div>

    {issues.length === 0 ? (
      <div class="empty-state">
        <p>No {state === "all" ? "" : state} issues.</p>
      </div>
    ) : (
      <div>
        {issues.map((issue) => (
          <IssueCard issue={issue} user={username!} repo={reponame!} />
        ))}
      </div>
    )}
  </div>
</Layout>
